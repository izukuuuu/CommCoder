<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <title>分类人工调整 GUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body class="bg-slate-100">
<div class="min-h-screen flex flex-col">
  <header class="bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-4">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-slate-900 text-white text-lg font-semibold shadow-lg">CC</span>
        <div>
          <div class="flex flex-wrap items-center gap-3">
            <h1 class="text-xl font-bold text-slate-900">分类人工调整工作台</h1>
            <span id="app_ver" class="text-xs font-medium text-slate-500 bg-slate-100 border border-slate-200 rounded-full px-3 py-1"></span>
          </div>
          <p class="text-sm text-slate-500 mt-1">在统一界面完成编码流程与结果洞察。</p>
        </div>
      </div>
      <div class="flex flex-col items-start gap-3 sm:flex-row sm:items-center">
        <div id="session_meta_summary" class="hidden md:flex items-start gap-3 px-4 py-3 rounded-2xl bg-slate-100/90 text-xs text-slate-600 shadow-inner">
          <div class="shrink-0">
            <svg class="w-6 h-6 text-slate-500" data-heroicon="clipboard-document-list" aria-hidden="true"></svg>
          </div>
          <div class="leading-tight space-y-1">
            <p id="session_meta_primary" class="text-sm font-medium text-slate-700">暂无会话</p>
            <p id="session_meta_secondary" class="text-xs text-slate-500">请上传或载入数据集</p>
          </div>
        </div>
        <code id="session_badge" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded-full">Session: —</code>
        <div class="md:hidden w-full">
          <label class="sr-only" for="mobile_page_select">页面导航</label>
          <select id="mobile_page_select" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-600 bg-white">
            <option value="page-home">主页</option>
            <option value="page-coding" data-requires-session="true">编码工作台</option>
            <option value="page-visual" data-requires-session="true">数据可视化</option>
            <option value="page-sampling" data-requires-session="true">抽样检测</option>
            <option value="page-settings">OpenAI API 设置</option>
          </select>
        </div>
      </div>
    </div>
  </header>
  <div class="flex flex-1">
    <aside id="sidebar" class="hidden md:flex border-r border-slate-200 bg-white/80 backdrop-blur-sm transition-all duration-300" data-collapsed="false">
      <div class="flex flex-col w-full h-full">
        <div class="sidebar-header px-4 pt-6 pb-4 flex items-center justify-between">
          <p class="nav-section-label text-xs font-semibold text-slate-400 uppercase tracking-wide">导航</p>
          <button id="sidebar_toggle" class="sidebar-toggle btn btn-ghost" type="button" aria-expanded="true" aria-label="收起侧边栏" title="收起侧边栏">
            <svg class="w-5 h-5" data-heroicon="chevron-left" aria-hidden="true"></svg>
          </button>
        </div>
        <nav class="flex-1 flex flex-col gap-2 px-2">
          <button class="nav-link nav-link-active" data-target="page-home" title="主页" aria-label="主页">
            <svg class="nav-icon w-5 h-5" data-heroicon="home-modern" aria-hidden="true"></svg>
            <span class="nav-label">主页</span>
          </button>
          <button class="nav-link" data-target="page-coding" data-requires-session="true" title="编码工作台" aria-label="编码工作台">
            <svg class="nav-icon w-5 h-5" data-heroicon="adjustments-horizontal" aria-hidden="true"></svg>
            <span class="nav-label">编码工作台</span>
          </button>
          <button class="nav-link" data-target="page-visual" data-requires-session="true" title="数据可视化" aria-label="数据可视化">
            <svg class="nav-icon w-5 h-5" data-heroicon="chart-pie" aria-hidden="true"></svg>
            <span class="nav-label">数据可视化</span>
          </button>
          <button class="nav-link" data-target="page-sampling" data-requires-session="true" title="抽样检测" aria-label="抽样检测">
            <svg class="nav-icon w-5 h-5" data-heroicon="clipboard-document-list" aria-hidden="true"></svg>
            <span class="nav-label">抽样检测</span>
          </button>
        </nav>
        <div class="sidebar-footer px-2 pt-4 pb-6 border-t border-slate-200">
          <button class="nav-link" data-target="page-settings" title="OpenAI API 设置" aria-label="OpenAI API 设置">
            <svg class="nav-icon w-5 h-5" data-heroicon="cog-6-tooth" aria-hidden="true"></svg>
            <span class="nav-label">OpenAI API 设置</span>
          </button>
        </div>
      </div>
    </aside>
    <div class="flex-1 overflow-y-auto">
      <main class="max-w-7xl mx-auto w-full px-6 py-8 space-y-10">
        <section id="page-home" class="page-section space-y-10">
          <div class="home-hero rounded-3xl overflow-hidden shadow">
            <div class="home-hero-flow">
              <div class="home-hero-intro">
                <p class="home-hero-eyebrow" data-i18n-key="hero.eyebrow">CommCoder Studio</p>
                <h2 class="home-hero-title" data-i18n-key="hero.title">编码协同流程总览</h2>
                <p class="home-hero-subtitle" data-i18n-key="hero.subtitle">以下流程呈现从自动化产出的原始结果，到人工覆核与统计抽样验证的完整闭环。</p>
                <button id="lang_toggle" class="lang-toggle-btn" type="button" aria-label="切换为英文" title="切换为英文">
                  <svg class="w-5 h-5" data-heroicon="globe-alt" aria-hidden="true"></svg>
                  <span id="lang_toggle_label">English</span>
                </button>
              </div>
              <div id="hero_flow_diagram" class="flow-diagram" aria-label="编码流程图">
                <div class="flow-column flow-column-left">
                  <div class="flow-step flow-step-strong flow-step-stack">
                    <span class="flow-step-title" data-i18n-key="flow.aiAuto">AI 自动编码</span>
                    <ol class="flow-step-list">
                      <li>
                        <div class="flow-substep-header">
                          <span class="flow-step-badge" aria-hidden="true">1</span>
                          <span class="flow-substep-title" data-i18n-key="flow.aiAutoStep1.title">Step 1 · GPT 生成结构化总结</span>
                        </div>
                        <p class="flow-step-list-desc" data-i18n-key="flow.aiAutoStep1.desc">题目 + 摘要 → 输出包含研究主题、研究方法、核心发现、研究意义的四段式总结。</p>
                      </li>
                      <li>
                        <div class="flow-substep-header">
                          <span class="flow-step-badge" aria-hidden="true">2</span>
                          <span class="flow-substep-title" data-i18n-key="flow.aiAutoStep2.title">Step 2 · 总结驱动议题与领域归类</span>
                        </div>
                        <p class="flow-step-list-desc" data-i18n-key="flow.aiAutoStep2.desc">依据结构化总结自动归纳研究主题（议题）与研究领域。</p>
                      </li>
                    </ol>
                  </div>
                  <div class="flow-arrow-mobile" aria-hidden="true">
                    <div class="flow-arrow-vertical"></div>
                  </div>
                </div>
                <div class="flow-bridge" aria-hidden="true">
                  <div class="flow-arrow"></div>
                </div>
                <div class="flow-column flow-column-right">
                  <div class="flow-step" data-i18n-key="flow.toWorkspace">编码结果进入工作台</div>
                  <div class="flow-branch">
                    <div class="flow-branch-column">
                      <div class="flow-branch-connector" aria-hidden="true"></div>
                      <div class="flow-step" data-i18n-key="flow.manualClassify">未识别主题人工分类</div>
                    </div>
                    <div class="flow-branch-column">
                      <div class="flow-branch-connector" aria-hidden="true"></div>
                      <div class="flow-step" data-i18n-key="flow.kmeans">K-Means 聚类</div>
                      <div class="flow-arrow-vertical" aria-hidden="true"></div>
                      <div class="flow-step" data-i18n-key="flow.outlier">离群值识别</div>
                      <div class="flow-arrow-vertical" aria-hidden="true"></div>
                      <div class="flow-step" data-i18n-key="flow.review">人工覆核调整</div>
                    </div>
                  </div>
                  <div class="flow-merge">
                    <div class="flow-merge-connector" aria-hidden="true"></div>
                    <div class="flow-horizontal">
                      <div class="flow-step" data-i18n-key="flow.integrate">多通道结果整合</div>
                      <div class="flow-arrow" aria-hidden="true"></div>
                      <div class="flow-step flow-step-strong" data-i18n-key="flow.validation">抽样验证可靠性</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="home-hero-abstract">
              <h3 class="home-hero-abstract-title" data-i18n-key="hero.abstractTitle">方法论简介</h3>
              <p data-i18n-key="hero.abstractParagraph1">本工作台以自动化模型为前端引擎，借助语义聚类与人工干预协同推进，对主题空缺与离群样本实行双轨校准。</p>
              <p data-i18n-key="hero.abstractParagraph2">流程后段强调多源整合与质量抽检，旨在确保编码结果在统计意义上的稳定性与可复现性。</p>
            </div>
          </div>

          <div class="home-launch-hub space-y-8">
            <div class="home-launch-header">
              <div>
                <p class="home-launch-eyebrow">Workspace Launch</p>
                <h2 class="home-launch-title">准备工作台</h2>
                <p class="home-launch-subtitle">上传新的数据集，或从历史会话继续，解锁编码工作台。</p>
              </div>
              <div class="home-launch-meta">
                <span>当前 Session ID</span>
                <code class="home-launch-meta-code" id="home_session_hint">—</code>
              </div>
            </div>
            <div id="home_lock_hint_wrapper" class="home-lock-banner" data-state="locked">
              <div class="home-lock-icon">
                <svg id="home_lock_icon" class="w-5 h-5" data-heroicon="lock-closed" aria-hidden="true"></svg>
              </div>
              <p id="home_lock_hint" class="home-lock-hint-text">请在下方上传数据集或载入会话以解锁编码工作台与数据可视化。</p>
            </div>
            <div class="home-card-grid">
              <section class="home-card home-card-primary">
                <div class="home-card-header">
                  <div>
                    <p class="home-card-eyebrow">新建会话</p>
                    <h3 class="home-card-title">上传文件并自动开启新会话</h3>
                    <p class="home-card-subtitle">支持 Excel 与 CSV 文件，系统将为每次上传生成独立会话。</p>
                  </div>
                  <div class="home-card-icon">
                    <svg class="w-7 h-7" data-heroicon="cloud-arrow-up" aria-hidden="true"></svg>
                  </div>
                </div>
                <div class="home-card-body space-y-6">
                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">选择表格（.xlsx/.xls/.csv）</label>
                    <input id="file_input" class="file-input" type="file" accept=".xlsx,.xls,.csv">
                  </div>
                  <div class="home-upload-actions">
                    <button id="btn_upload" class="action-btn home-upload-btn" title="上传并新建会话">
                      <svg class="w-5 h-5" data-heroicon="arrow-up-tray" aria-hidden="true"></svg>
                      <span>上传并新建会话</span>
                    </button>
                    <div class="home-progress">
                      <div class="home-progress-track">
                        <div id="up_bar" class="home-progress-bar"></div>
                      </div>
                      <span id="up_msg" class="home-progress-msg"></span>
                    </div>
                  </div>
                  <p class="home-card-footnote">上传完成后系统将自动创建新会话并刷新界面。</p>
                </div>
              </section>
              <section class="home-card home-card-secondary">
                <div class="home-card-header">
                  <div>
                    <p class="home-card-eyebrow">会话与导出</p>
                    <h3 class="home-card-title">管理当前进度与结果</h3>
                    <p class="home-card-subtitle">保存会话、导出 Excel 或下载最近一次导出文件，随时切换工作节点。</p>
                  </div>
                  <div class="home-card-icon">
                    <svg class="w-7 h-7" data-heroicon="rectangle-stack" aria-hidden="true"></svg>
                  </div>
                </div>
                <div class="home-card-body">
                  <div class="home-action-collection">
                    <article class="home-action-card" data-action="save-session">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-emerald-100 text-emerald-600">
                          <svg class="w-6 h-6" data-heroicon="cloud-arrow-up" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">保存当前会话</h4>
                          <p class="home-action-desc">写入服务器 sessions/ 目录，保障进度安全。</p>
                        </div>
                      </div>
                      <button id="btn_save_session" class="action-btn home-action-btn bg-emerald-600 text-white hover:bg-emerald-500 shadow-sm" title="将当前会话写入服务器磁盘（sessions/）">
                        <span>立即保存</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="load-session">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-slate-900/10 text-slate-900">
                          <svg class="w-6 h-6" data-heroicon="folder-arrow-down" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">载入历史会话</h4>
                          <p class="home-action-desc">浏览服务器记录，快速恢复之前的工作现场。</p>
                        </div>
                      </div>
                      <button id="btn_load_session" class="action-btn home-action-btn bg-slate-900 text-white hover:bg-slate-800 shadow-sm" title="从服务器读取会话">
                        <span>选择会话</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="export-excel">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-indigo-100 text-indigo-600">
                          <svg class="w-6 h-6" data-heroicon="document-arrow-down" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">导出为 Excel</h4>
                          <p class="home-action-desc">生成 Output/&lt;session&gt;/export_*.xlsx 供分析或交付。</p>
                        </div>
                      </div>
                      <button id="btn_save_excel" class="action-btn home-action-btn bg-indigo-600 text-white hover:bg-indigo-500 shadow-sm" title="写入 Output/&lt;session&gt;/export_*.xlsx">
                        <span>生成文件</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="export-batch">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-amber-100 text-amber-600">
                          <svg class="w-6 h-6" data-heroicon="clipboard-document-list" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">按调整分类批量导出</h4>
                          <p class="home-action-desc">可选择按调整后的议题、领域或两者拆分多个 Excel，集中写入服务器目录。</p>
                        </div>
                      </div>
                      <button id="btn_export_batch" class="action-btn home-action-btn bg-amber-500 text-white hover:bg-amber-400 shadow-sm" title="按调整后的分类批量导出多个 Excel 文件">
                        <span>生成批次</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="export-topic-year">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-cyan-100 text-cyan-600">
                          <svg class="w-6 h-6" data-heroicon="chart-pie" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">议题年份分段导出</h4>
                          <p class="home-action-desc">按每个议题的年份区间（默认10年）切割生成子 Excel。</p>
                        </div>
                      </div>
                      <button id="btn_export_topic_year" class="action-btn home-action-btn bg-cyan-500 text-white hover:bg-cyan-400 shadow-sm" title="为每个议题按年份区间拆分 Excel 文件">
                        <span>生成子表</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="download-export">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-slate-200 text-slate-700">
                          <svg class="w-6 h-6" data-heroicon="arrow-down-tray" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">下载最新导出</h4>
                          <p class="home-action-desc">一键获取最近一次导出成果，导出生成后自动激活下载。</p>
                        </div>
                      </div>
                      <button id="btn_download_last" class="action-btn home-action-btn bg-slate-600 text-white hover:bg-slate-500 shadow-sm" title="从服务器下载最近一次导出副本（可选）">
                        <span>下载文件</span>
                      </button>
                    </article>
                  </div>
                  <p class="home-card-footnote">所有操作都会作用于当前会话，未解锁时将保持禁用状态。</p>
                </div>
              </section>
            </div>
          </div>
        </section>

        <section id="page-coding" class="page-section space-y-8 hidden">
          <div class="bg-white rounded-2xl shadow p-6 space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <span class="text-sm">当前仅编辑：</span>
              <select id="op_col_select" class="border rounded px-2 py-1">
                <option value="topic">研究主题（调整）</option>
                <option value="field">研究领域（调整）</option>
              </select>
              <span id="op_col_hint" class="text-xs text-gray-500">（仅显示并可编辑：研究主题（调整））</span>

              <span class="md:ml-6 text-sm">筛选列：</span>
              <select id="filter_target" class="border rounded px-2 py-1">
                <option value="topic_orig">研究主题（原）</option>
                <option value="field_orig">研究领域（原）</option>
                <option value="topic_adj">研究主题（调整）</option>
                <option value="field_adj">研究领域（调整）</option>
              </select>
              <select id="filter_value" class="border rounded px-2 py-1"></select>
              <button id="btn_apply_filter" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">应用筛选</button>
              <button id="btn_clear_filter" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">清除筛选</button>

              <div class="flex flex-wrap items-center gap-2 basis-full md:basis-auto md:ml-6">
                <span class="text-sm">关键词搜索：</span>
                <label class="inline-flex items-center gap-1 text-sm">
                  <input type="radio" name="search_scope" value="title" checked>
                  <span>Article Title</span>
                </label>
                <label class="inline-flex items-center gap-1 text-sm">
                  <input type="radio" name="search_scope" value="summary">
                  <span>结构化总结</span>
                </label>
                <input id="search_keyword" class="border rounded px-2 py-1 w-64" type="text" placeholder="输入提示词，空格分隔多个关键词">
                <button id="btn_apply_search" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">应用搜索</button>
                <button id="btn_clear_search" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">清除搜索</button>
              </div>

              <span class="md:ml-6 text-sm">目标类别：</span>
              <select id="bulk_target" class="border rounded px-2 py-1"></select>
              <button id="btn_bulk_selected" class="btn btn-sm bg-amber-600 text-white hover:bg-amber-500">将本页勾选 → 目标类别</button>
              <button id="btn_bulk_filtered" class="btn btn-sm bg-amber-700 text-white hover:bg-amber-600">将当前筛选全部 → 目标类别</button>
              <button id="btn_select_all" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">全选本页</button>
              <button id="btn_unselect_all" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">取消全选</button>
            </div>

            <div class="flex flex-wrap items-center gap-3 text-sm">
              <button id="btn_save_all" class="btn btn-sm bg-emerald-700 text-white hover:bg-emerald-600">保存本页修改</button>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="auto_save_enable">
                <span>自动保存</span>
              </label>
              <span>间隔（分钟）</span>
              <input id="auto_save_interval" type="number" min="1" value="5" class="border rounded px-2 py-1 w-20 text-center">
              <span id="auto_save_msg" class="text-xs text-gray-500"></span>
            </div>

            <details class="bg-slate-50 border rounded p-3">
              <summary class="cursor-pointer font-semibold">智能排序（议题内重排序 & 离群定位）</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                <div>
                  <label class="block text-sm text-gray-600 mb-1">分组依据</label>
                  <select id="rank_group_by" class="border rounded px-2 py-1 w-full">
                    <option value="topic_orig">研究主题（原）</option>
                    <option value="topic_adj">研究主题（调整）</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">算法</label>
                  <select id="rank_algo" class="border rounded px-2 py-1 w-full">
                    <option value="centroid">Centroid（质心）</option>
                    <option value="kmeans">K-Means</option>
                    <option value="hdbscan">HDBSCAN（自动离群）</option>
                  </select>
                </div>
                <div id="wrap_k">
                  <label class="block text-sm text-gray-600 mb-1">K（K-Means 生效）</label>
                  <input id="rank_k" type="number" value="3" min="1" class="border rounded px-2 py-1 w-full">
                </div>
                <div id="wrap_sigma">
                  <label class="block text-sm text-gray-600 mb-1">离群阈值 σ</label>
                  <input id="rank_sigma" type="number" step="0.1" value="2.0" class="border rounded px-2 py-1 w-full">
                </div>
                <div id="wrap_min_cluster">
                  <label class="block text-sm text-gray-600 mb-1">最小簇大小（HDBSCAN）</label>
                  <input id="rank_min_cluster" type="number" step="1" min="2" value="5" class="border rounded px-2 py-1 w-full">
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">嵌入来源</label>
                  <select id="rank_emb_src" class="border rounded px-2 py-1 w-full">
                    <option value="local">本地 sentence-transformers</option>
                    <option value="openai">OpenAI Embeddings</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">排序方向</label>
                  <select id="rank_order" class="border rounded px-2 py-1 w-full">
                    <option value="asc">近的在前（分数小→大）</option>
                    <option value="desc">远的在前（分数大→小）</option>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <input id="rank_only_outliers" type="checkbox">
                  <label for="rank_only_outliers" class="text-sm">仅看离群</label>
                </div>
                <div class="md:col-span-2 flex items-center gap-4">
                  <label class="text-sm"><input id="rk_f_title" type="checkbox" checked> 标题</label>
                  <label class="text-sm"><input id="rk_f_abstract" type="checkbox" checked> 摘要</label>
                  <label class="text-sm"><input id="rk_f_summary" type="checkbox" checked> 结构化总结</label>
                </div>
                <div class="flex items-center gap-3">
                  <button id="btn_do_ranking" class="px-4 py-2 rounded bg-slate-800 text-white">计算</button>
                  <span id="rank_msg" class="text-sm text-gray-600"></span>
                </div>
              </div>
            </details>
          </div>

          <div class="flex flex-wrap items-center gap-2 mb-3">
            <span>分页：</span>
            <button id="pg_first" class="px-2 py-1 rounded bg-slate-200">« 首</button>
            <button id="pg_prev"  class="px-2 py-1 rounded bg-slate-200">‹ 前</button>
            <input id="page_input" class="border rounded px-2 py-1 w-20 text-center" type="number" value="1" min="1">
            <span>/</span>
            <span id="page_total" class="w-12 text-center">1</span>
            <button id="pg_next"  class="px-2 py-1 rounded bg-slate-200">后 ›</button>
            <button id="pg_last"  class="px-2 py-1 rounded bg-slate-200">末 »</button>
            <span class="ml-4">每页</span>
            <input id="ps_input" class="border rounded px-2 py-1 w-20 text-center" type="number" value="50" min="1" max="5000">
            <button id="btn_reload_page" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">刷新</button>
            <span class="text-sm text-gray-500 ml-2" id="page_info">—</span>
            <div class="flex items-center gap-2 ml-4">
              <span>排序</span>
              <select id="sort_select" class="border rounded px-2 py-1 text-sm">
                <option value="default">默认顺序</option>
                <option value="rank_asc" data-requires-rank="1">智能排序：近→远</option>
                <option value="rank_desc" data-requires-rank="1">智能排序：远→近</option>
              </select>
              <span id="sort_hint" class="text-xs text-gray-500"></span>
            </div>
          </div>

          <div id="table_zone" class="bg-white rounded-2xl shadow overflow-x-auto"></div>

        </section>

        <section id="page-visual" class="page-section hidden space-y-8">
          <div class="bg-white rounded-2xl shadow p-6 space-y-2">
            <h2 class="text-lg font-semibold text-slate-900">数据可视化面板</h2>
            <p class="text-sm text-slate-500">查看整体分布、筛选趋势以及排序结果的二维可视化。</p>
          </div>

          <div class="bg-white rounded-2xl shadow p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold">分类概览（点击类别即可筛选）</h3>
              <div class="text-sm text-gray-500" id="total_msg">—</div>
            </div>
            <div id="vis_panel_adj" class="vis-tab-panel" data-vis-panel="adj">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <h4 class="text-sm font-semibold">研究主题（调整后）</h4>
                    <button class="text-xs text-sky-700" id="btn_only_other_topic_adj">只看『其他议题』</button>
                  </div>
                  <div id="chips_topic_adj" class="flex flex-wrap gap-2 mt-2"></div>
                  <div class="space-y-4">
                    <div id="treemap_topic_adj" class="treemap-box" data-category-chart="topic_adj" data-chart-type="treemap" data-treemap-key="chart_topic_adj"></div>
                  </div>
                </div>
                <div class="space-y-4">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <h4 class="text-sm font-semibold">研究领域（调整后）</h4>
                    <button class="text-xs text-sky-700" id="btn_only_other_field_adj">只看『其他领域』</button>
                  </div>
                  <div id="chips_field_adj" class="flex flex-wrap gap-2 mt-2"></div>
                  <div class="space-y-4">
                    <div id="treemap_field_adj" class="treemap-box" data-category-chart="field_adj" data-chart-type="treemap" data-treemap-key="chart_field_adj"></div>
                  </div>
                </div>
              </div>
              <div class="journal-section mt-8">
                <div class="journal-header">
                  <div>
                    <h4 class="journal-title">期刊分布（调整后）</h4>
                    <p class="journal-subtitle">根据 Source Title 统计各分类的 Top 5 期刊。</p>
                  </div>
                  <div class="journal-toggle" role="group" aria-label="期刊统计维度切换">
                    <button id="btn_journal_topic" class="journal-toggle-btn journal-toggle-active" type="button" data-journal-toggle="topic" aria-pressed="true">研究主题（调整后）</button>
                    <button id="btn_journal_field" class="journal-toggle-btn" type="button" data-journal-toggle="field" aria-pressed="false">研究领域（调整后）</button>
                  </div>
                </div>
                <p id="journal_hint" class="journal-hint">Top 5 按篇数排序，括号内为分类内占比。</p>
                <div id="journal_panel_topic" class="journal-grid" data-journal-panel="topic"></div>
                <div id="journal_panel_field" class="journal-grid hidden" data-journal-panel="field"></div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6 space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-3 timeline-controls">
              <div>
                <h3 class="font-semibold">时间趋势分析</h3>
                <p class="text-sm text-slate-500">按年份区间查看发表数量趋势与累计占比。</p>
              </div>
              <div class="flex items-center gap-2 text-sm text-slate-600">
                <label class="whitespace-nowrap" for="timeline_bin_select">区间跨度</label>
                <select id="timeline_bin_select" class="border border-slate-200 rounded px-2 py-1 text-sm">
                  <option value="1">1 年</option>
                  <option value="3">3 年</option>
                  <option value="5" selected>5 年</option>
                  <option value="10">10 年</option>
                </select>
              </div>
            </div>
            <div id="timeline_summary" class="text-xs text-slate-500 hidden"></div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
              <div>
                <div class="flex items-center justify-between gap-3 mb-2 timeline-controls">
                  <h4 class="text-sm font-semibold text-slate-700">发表数量趋势</h4>
                  <div class="flex items-center gap-2">
                    <button type="button" id="btn_download_timeline_png" class="timeline-expand-btn" disabled>下载 PNG</button>
                    <button type="button" id="btn_download_timeline_svg" class="timeline-expand-btn" disabled>下载 SVG</button>
                  </div>
                </div>
                <div id="timeline_line_chart" class="timeline-chart-box">
                  <div id="timeline_line_placeholder" class="treemap-empty hidden"></div>
                  <img id="timeline_line_image" class="timeline-line-image hidden" alt="Timeline line chart" loading="lazy" />
                  <div id="timeline_line_labels" class="timeline-line-label-layer hidden" aria-hidden="true"></div>
                </div>
              </div>
              <div>
                <div class="flex flex-wrap items-center justify-between gap-3 mb-2 timeline-controls">
                  <h4 class="text-sm font-semibold text-slate-700">分类占比堆叠图</h4>
                  <div class="flex items-center gap-2">
                    <div class="timeline-stack-toggle" role="group" aria-label="时间序列分类切换">
                      <button type="button" class="timeline-stack-btn timeline-stack-btn-active" data-timeline-stack="topic_adj" aria-pressed="true">研究主题（调整后）</button>
                      <button type="button" class="timeline-stack-btn" data-timeline-stack="field_adj" aria-pressed="false">研究领域（调整后）</button>
                    </div>
                    <button type="button" id="btn_expand_timeline_stack" class="timeline-expand-btn">新标签全屏</button>
                  </div>
                </div>
                <div class="timeline-area-wrapper">
                  <div id="timeline_area_chart" class="timeline-chart-box"></div>
                  <div id="timeline_area_label" class="timeline-area-label" style="display:none;"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-2">
              <h3 class="font-semibold">排序可视化（2D 散点图）</h3>
              <button id="btn_toggle_vis" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300" aria-expanded="false">展开可视化</button>
            </div>
            <div id="rank_vis_body" class="space-y-3 hidden">
              <div class="flex items-center justify-end">
                <button id="btn_refresh_vis" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">刷新可视化</button>
              </div>
              <div id="rank_vis_msg" class="text-sm text-gray-500">等待计算后展示。</div>
              <div id="rank_vis_plot" class="w-full min-h-[320px]"></div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6 space-y-6" id="topic_viz_container">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h3 class="font-semibold text-slate-900">语义主题探索（调整后）</h3>
                <p class="text-sm text-slate-500">查看每个分类的高频关键词，并在二维空间中观察主题之间的语义距离。</p>
              </div>
              <div class="topic-viz-tab-toggle" role="tablist" aria-label="语义探索维度切换">
                <button class="topic-viz-tab topic-viz-tab-active" type="button" data-topicviz-tab="topic" aria-selected="true">研究主题（调整后）</button>
                <button class="topic-viz-tab" type="button" data-topicviz-tab="field" aria-selected="false">研究领域（调整后）</button>
              </div>
            </div>
            <div class="topic-viz-panel" data-topicviz-panel="topic">
              <div class="topic-viz-message" data-topicviz-message="topic">请先上传或载入会话以加载语义可视化。</div>
              <div class="topic-viz-layout">
                <div class="topic-viz-sidebar">
                  <div class="topic-viz-sidebar-header">
                    <h4 class="topic-viz-sidebar-title">分类列表</h4>
                    <p class="topic-viz-sidebar-hint">点击查看对应的高频关键词</p>
                  </div>
                  <div class="topic-viz-list" data-topicviz-list="topic"></div>
                </div>
                <div class="topic-viz-content">
                  <div class="topic-viz-card">
                    <div class="topic-viz-card-header">
                      <h4 class="topic-viz-card-title">高频关键词</h4>
                      <div class="topic-viz-hint" data-topicviz-keyword-hint="topic"></div>
                    </div>
                    <div id="topic_viz_words_topic" class="topic-viz-chart" data-topicviz-chart="words" data-topicviz-dim="topic"></div>
                  </div>
                  <div class="topic-viz-card">
                    <div class="topic-viz-card-header">
                      <h4 class="topic-viz-card-title">语义二维映射</h4>
                      <div class="topic-viz-hint" data-topicviz-scatter-hint="topic"></div>
                    </div>
                    <div id="topic_viz_scatter_topic" class="topic-viz-scatter" data-topicviz-chart="scatter" data-topicviz-dim="topic"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="topic-viz-panel hidden" data-topicviz-panel="field">
              <div class="topic-viz-message" data-topicviz-message="field">请先上传或载入会话以加载语义可视化。</div>
              <div class="topic-viz-layout">
                <div class="topic-viz-sidebar">
                  <div class="topic-viz-sidebar-header">
                    <h4 class="topic-viz-sidebar-title">分类列表</h4>
                    <p class="topic-viz-sidebar-hint">点击查看对应的高频关键词</p>
                  </div>
                  <div class="topic-viz-list" data-topicviz-list="field"></div>
                </div>
                <div class="topic-viz-content">
                  <div class="topic-viz-card">
                    <div class="topic-viz-card-header">
                      <h4 class="topic-viz-card-title">高频关键词</h4>
                      <div class="topic-viz-hint" data-topicviz-keyword-hint="field"></div>
                    </div>
                    <div id="topic_viz_words_field" class="topic-viz-chart" data-topicviz-chart="words" data-topicviz-dim="field"></div>
                  </div>
                  <div class="topic-viz-card">
                    <div class="topic-viz-card-header">
                      <h4 class="topic-viz-card-title">语义二维映射</h4>
                      <div class="topic-viz-hint" data-topicviz-scatter-hint="field"></div>
                    </div>
                    <div id="topic_viz_scatter_field" class="topic-viz-scatter" data-topicviz-chart="scatter" data-topicviz-dim="field"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6 space-y-5" id="word_cloud_container">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h3 class="font-semibold text-slate-900">词云速览（调整后）</h3>
                <p class="text-sm text-slate-500">点击分类查看词云图与词频明细，快速洞察每个主题或领域的核心表达。</p>
              </div>
              <div class="text-xs text-slate-500">最多展示最近提取的前 50 个高频词。</div>
            </div>
            <div class="word-cloud-panels">
              <section class="word-cloud-panel" aria-labelledby="word_cloud_topic_title">
                <div class="word-cloud-panel-header">
                  <h4 id="word_cloud_topic_title" class="word-cloud-panel-title">研究主题（调整后）</h4>
                  <p class="word-cloud-panel-hint">按主题浏览</p>
                </div>
                <div id="word_cloud_topic_message" class="word-cloud-message">请先上传或载入会话以加载词云数据。</div>
                <div id="word_cloud_topic_list" class="word-cloud-list" role="list"></div>
              </section>
              <section class="word-cloud-panel" aria-labelledby="word_cloud_field_title">
                <div class="word-cloud-panel-header">
                  <h4 id="word_cloud_field_title" class="word-cloud-panel-title">研究领域（调整后）</h4>
                  <p class="word-cloud-panel-hint">按领域浏览</p>
                </div>
                <div id="word_cloud_field_message" class="word-cloud-message">请先上传或载入会话以加载词云数据。</div>
                <div id="word_cloud_field_list" class="word-cloud-list" role="list"></div>
              </section>
            </div>
          </div>
        </section>

        <section id="page-sampling" class="page-section hidden space-y-8">
          <div class="bg-white rounded-2xl shadow p-6 space-y-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h2 class="text-lg font-semibold text-slate-900">抽样检测工作台</h2>
                <p class="text-sm text-slate-500">系统按比例随机抽样，核对员以盲选方式复核议题与领域分类结果。</p>
              </div>
              <div class="text-xs text-slate-500" id="sampling_header_hint">默认抽样比例：3%</div>
            </div>
            <p class="text-xs text-slate-400">提示：样本列表右侧默认展示 AI 分类，如认可可一键应用到选择。</p>
          </div>

          <div class="sampling-layout">
            <div class="sampling-sidebar space-y-6">
              <section class="bg-white rounded-2xl shadow p-5 space-y-4">
                <div class="space-y-2">
                  <h3 class="text-base font-semibold text-slate-900">新建抽样任务</h3>
                  <p class="text-sm text-slate-500">填写分类核对员姓名，系统将按比例自动抽取待核对样本。</p>
                </div>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm text-slate-600 mb-1" for="sampling_inspector_input">分类核对员</label>
                    <input id="sampling_inspector_input" class="sampling-input" placeholder="如：张三">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-600 mb-1" for="sampling_rate_input">抽样比例（%）</label>
                    <div class="flex items-center gap-3">
                      <input id="sampling_rate_input" type="number" min="0.1" max="100" step="0.1" class="sampling-input w-28" value="3">
                      <span class="text-xs text-slate-500">向上取整，至少抽取 1 条</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <input id="sampling_force_toggle" type="checkbox" class="sampling-checkbox">
                    <label for="sampling_force_toggle" class="text-sm text-slate-600">覆盖同名核对员的现有抽样</label>
                  </div>
                </div>
                <div class="flex flex-col gap-2">
                  <button id="btn_sampling_generate" class="btn bg-slate-800 text-white hover:bg-slate-700" type="button">生成抽样样本</button>
                  <p id="sampling_create_hint" class="text-xs text-slate-500"></p>
                </div>
              </section>
              <section class="bg-white rounded-2xl shadow p-5 space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-base font-semibold text-slate-900">抽样任务列表</h3>
                  <button id="btn_sampling_refresh" class="btn btn-sm btn-ghost text-slate-600" type="button">刷新</button>
                </div>
                <div id="sampling_list_zone" class="sampling-list-zone"></div>
              </section>
            </div>
            <div class="sampling-main">
              <section class="bg-white rounded-2xl shadow p-6 space-y-4 h-full">
                <div id="sampling_detail_zone" class="sampling-detail-empty">请在左侧选择分类核对员以查看抽样详情。</div>
                <div id="sampling_items_zone"></div>
                <div id="sampling_pager_zone" class="sampling-pager hidden"></div>
              </section>
            </div>
          </div>
        </section>

        <section id="page-settings" class="page-section hidden space-y-8">
          <div class="bg-white rounded-2xl shadow p-6 space-y-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h2 class="text-lg font-semibold text-slate-900">OpenAI 兼容 API 设置</h2>
                <p class="text-sm text-slate-500">配置 Base URL、密钥等参数，可同步保存到浏览器或服务器。</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-600 mb-1">Base URL</label>
                <input id="cfg_base_url" class="w-full border rounded px-3 py-2" placeholder="https://api.openai.com">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">API Key</label>
                <input id="cfg_api_key" class="w-full border rounded px-3 py-2" type="password" placeholder="sk-...">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Model</label>
                <input id="cfg_model" class="w-full border rounded px-3 py-2" placeholder="gpt-4o-mini">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Temperature</label>
                <input id="cfg_temp" class="w-full border rounded px-3 py-2" type="number" step="0.1" value="0.2">
              </div>
            </div>
            <div class="flex flex-wrap gap-2 pt-2">
              <button id="btn_save_cfg" class="px-4 py-2 rounded bg-slate-800 text-white">保存到浏览器</button>
              <button id="btn_save_env" class="px-4 py-2 rounded bg-emerald-700 text-white">写入 .env（默认）</button>
              <span id="cfg_msg" class="text-sm text-gray-600"></span>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow p-6 space-y-5">
            <div class="space-y-1">
              <h3 class="text-base font-semibold text-slate-900">智能分类黑名单</h3>
              <p class="text-sm text-slate-500">勾选后，智能建议在提示词中将不再包含这些分类，避免模型输出被屏蔽的选项。</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <h4 class="text-sm font-semibold text-slate-800">议题分类黑名单</h4>
                <div id="topic_blacklist_options" class="flex flex-wrap gap-2"></div>
              </div>
              <div class="space-y-2">
                <h4 class="text-sm font-semibold text-slate-800">领域分类黑名单</h4>
                <div id="field_blacklist_options" class="flex flex-wrap gap-2"></div>
              </div>
            </div>
            <p class="text-xs text-slate-400">提示：黑名单仅影响智能建议的提示词，手动调整仍可选择全部分类。</p>
          </div>
          <div class="bg-white rounded-2xl shadow p-6 space-y-5">
            <div class="space-y-1">
              <h3 class="text-base font-semibold text-slate-900">分类英文映射</h3>
              <p class="text-sm text-slate-500">为研究议题与研究领域配置英文展示名称，未映射的分类将在可视化中标记为 Unmapped。</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-slate-800">议题映射</h4>
                  <button id="btn_add_topic_mapping" class="text-xs text-slate-500 hover:text-slate-700" type="button">新增条目</button>
                </div>
                <div id="topic_label_table" class="label-mapping-table"></div>
              </div>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-slate-800">领域映射</h4>
                  <button id="btn_add_field_mapping" class="text-xs text-slate-500 hover:text-slate-700" type="button">新增条目</button>
                </div>
                <div id="field_label_table" class="label-mapping-table"></div>
              </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <button id="btn_save_label_mapping" class="px-4 py-2 rounded bg-slate-800 text-white" type="button">保存映射</button>
              <span id="label_mapping_hint" class="text-sm text-slate-500"></span>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
</div>
<div id="toast_stack" class="fixed top-6 right-6 z-[1200] flex flex-col gap-3 max-w-sm pointer-events-none"></div>
<dialog id="dlg_sessions" class="rounded-xl p-0 w-[680px] max-w-[95vw]">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="font-semibold">载入会话</h3>
    <button onclick="qs('dlg_sessions').close()" class="btn btn-sm btn-ghost text-slate-600">✕</button>
  </div>
  <div id="sess_list_zone" class="p-4 max-h-[60vh] overflow-y-auto text-sm"></div>
  <div class="p-4 border-t flex items-center justify-end">
    <button class="btn bg-slate-700 text-white hover:bg-slate-600" onclick="qs('dlg_sessions').close()">关闭</button>
  </div>
</dialog>
<dialog id="dlg_export_batch" class="rounded-xl p-0 w-[440px] max-w-[95vw]">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="font-semibold text-slate-900">按调整分类批量导出</h3>
    <button id="btn_export_batch_close" class="btn btn-sm btn-ghost text-slate-600" type="button">✕</button>
  </div>
  <div class="p-5 space-y-4 text-sm text-slate-700">
    <p class="leading-relaxed">请选择要导出的维度，系统会分别为所选分类生成 Excel 子表。默认会同时导出调整后的议题与领域。</p>
    <div class="space-y-3">
      <label class="flex items-center gap-2">
        <input id="chk_export_topic" class="h-4 w-4 rounded border-slate-300 text-slate-800" type="checkbox" name="batch_export_target" value="topic" checked>
        <span class="font-medium text-slate-800">按调整后议题分表</span>
      </label>
      <label class="flex items-center gap-2">
        <input id="chk_export_field" class="h-4 w-4 rounded border-slate-300 text-slate-800" type="checkbox" name="batch_export_target" value="field" checked>
        <span class="font-medium text-slate-800">按调整后领域分表</span>
      </label>
    </div>
    <p id="batch_export_error" class="text-xs text-rose-500 hidden">请至少选择一个导出维度。</p>
  </div>
  <div class="p-4 border-t flex items-center justify-end gap-2">
    <button id="btn_export_batch_cancel" class="btn btn-ghost text-slate-600" type="button">取消</button>
    <button id="btn_export_batch_confirm" class="btn bg-slate-800 text-white hover:bg-slate-700" type="button">生成</button>
  </div>
</dialog>
<dialog id="dlg_word_cloud" class="word-cloud-dialog">
  <div class="word-cloud-dialog-card">
    <div class="word-cloud-dialog-header">
      <div>
        <h3 id="word_cloud_dialog_title" class="word-cloud-dialog-title">词云详情</h3>
        <p id="word_cloud_dialog_meta" class="word-cloud-dialog-meta"></p>
      </div>
      <button id="btn_close_word_cloud" class="btn btn-sm btn-ghost text-slate-600" type="button">✕</button>
    </div>
    <div class="word-cloud-dialog-body">
      <div id="word_cloud_chart" class="word-cloud-chart">
        <div id="word_cloud_image_wrapper" class="word-cloud-image-wrapper" aria-live="polite">
          <img id="word_cloud_image" class="word-cloud-image hidden" alt="词云图预览" decoding="async" loading="lazy"/>
          <div id="word_cloud_image_message" class="word-cloud-image-message word-cloud-empty">请选择分类以生成词云。</div>
        </div>
        <div class="word-cloud-downloads">
          <a id="word_cloud_download_png" class="word-cloud-download-btn word-cloud-download-btn-disabled" href="#" download>下载 PNG（300 DPI）</a>
          <a id="word_cloud_download_svg" class="word-cloud-download-btn word-cloud-download-btn-disabled" href="#" download>下载 SVG</a>
        </div>
      </div>
      <div>
        <h4 class="word-cloud-table-title">词频明细</h4>
        <div id="word_cloud_table" class="word-cloud-table"></div>
      </div>
    </div>
  </div>
</dialog>
<script src="/static/heroicons.js"></script>
<script>
/* ===================== 全局状态 ===================== */
let TOPIC_LIST=[], FIELD_LIST=[], ADJ_TOPIC_COL="", ADJ_FIELD_COL="";
let TOPIC_BLACKLIST=[], FIELD_BLACKLIST=[];
const SEARCH_SCOPE_DEFAULT='title';
let SESSION_ID=""; let SESSION_META=null; let CURRENT_FILTER={target:"",value:""}; let CURRENT_SORT={by:"",order:""}; let CURRENT_SEARCH={scope:SEARCH_SCOPE_DEFAULT, keyword:""};
let ACTIVE_COL="topic"; // "topic"|"field"
const PAGER = { page:1, size:50, total:0, pages:1 };
let LAST_EXPORT_URL=""; // 可选下载地址
let SAMPLING_DEFAULT_RATE = 0.03;
const SAMPLING_PAGE_SIZE = 50;
const SAMPLING_STATE = { list: [], loading: false, activeId: '', data: new Map(), pageByInspector: new Map(), pageSize: SAMPLING_PAGE_SIZE };
const TREEMAP_PLOTS={};
const TREEMAP_STATE={};
const TREEMAP_CATEGORY_LIMIT=24;
const TREEMAP_COLORS=[
  '#2563eb','#1d4ed8','#3b82f6','#60a5fa','#93c5fd','#38bdf8','#0ea5e9','#06b6d4',
  '#14b8a6','#0d9488','#10b981','#22c55e','#84cc16','#facc15','#f59e0b','#f97316',
  '#fb7185','#f472b6','#ec4899','#a855f7','#8b5cf6','#6366f1','#4f46e5','#4338ca'
];
const BAR_CHART_PLOTS={};
const BAR_CHART_STATE={};
const JOURNAL_DATA={ topic:[], field:[] };
const JOURNAL_RENDER_STATE={ topic:[], field:[] };
const JOURNAL_CHARTS=new Map();
const JOURNAL_COLORS=['#2563eb','#1d4ed8','#38bdf8','#60a5fa','#93c5fd'];
const LABEL_MAPPING={ topic:new Map(), field:new Map() };
const LABEL_MAPPING_DEFAULTS={ topic:new Map(), field:new Map() };
let JOURNAL_DIM='topic';
let JOURNAL_SOURCE_AVAILABLE=true;
const CATEGORY_DATA={};
const CATEGORY_VIEW_STATE={
  topic_adj:'treemap',
  field_adj:'treemap'
};
const CATEGORY_CHART_CONFIG={
  topic_adj:{ treemapId:'treemap_topic_adj', treemapKey:'chart_topic_adj', barId:'barchart_topic_adj', barKey:'bar_topic_adj', kind:'topic' },
  field_adj:{ treemapId:'treemap_field_adj', treemapKey:'chart_field_adj', barId:'barchart_field_adj', barKey:'bar_field_adj', kind:'field' }
};
let RANK_VIS_EXPANDED=false;
const SCATTER_DEFAULT_HEIGHT=420;
const SCATTER_STATE={
  height:SCATTER_DEFAULT_HEIGHT,
  hasData:false,
  observer:null,
  resizeTimer:0
};
const SCATTER_CONFIG={
  displaylogo:false,
  responsive:false,
  modeBarButtonsToRemove:['autoScale2d','hoverClosestCartesian','hoverCompareCartesian'],
};
const TIMELINE_CONFIG={
  displaylogo:false,
  responsive:true,
  modeBarButtonsToRemove:['autoScale2d','select2d','lasso2d','zoomIn2d','zoomOut2d','resetScale2d'],
};
const TIMELINE_STACK_DIMENSIONS=['topic_adj','field_adj'];
const TIMELINE_STACK_LABELS={ topic_adj:'研究主题（调整后）', field_adj:'研究领域（调整后）' };
const TIMELINE_STACK_COLORS=['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
const TIMELINE_PLOTLY_IDS=['timeline_area_chart'];
let TIMELINE_BIN_SIZE=5;
let TIMELINE_DATA=null;
let TIMELINE_STACK_DIM='topic_adj';
let TIMELINE_STACK_FIGURE=null;
const TIMELINE_LINE_IMAGE=document.getElementById('timeline_line_image');
const TIMELINE_LINE_PLACEHOLDER=document.getElementById('timeline_line_placeholder');
const TIMELINE_LINE_LABEL_LAYER=document.getElementById('timeline_line_labels');
const TIMELINE_LINE_DOWNLOAD_BUTTONS={
  png:document.getElementById('btn_download_timeline_png'),
  svg:document.getElementById('btn_download_timeline_svg')
};
const TIMELINE_LINE_DOWNLOAD_URLS={ png:'', svg:'' };
let AUTO_SAVE_TIMER=null;
let AUTO_SAVE_ENABLED=false;
const TOPIC_VIZ_DIMENSIONS=['topic','field'];
const TOPIC_VIZ_LABELS={ topic:'研究主题（调整后）', field:'研究领域（调整后）' };
const TOPIC_VIZ_COLORS=['#2563eb','#1d4ed8','#0ea5e9','#10b981','#f97316','#f43f5e'];
const TOPIC_VIZ_CONFIG={
  topic:{
    listSelector:'[data-topicviz-list="topic"]',
    messageSelector:'[data-topicviz-message="topic"]',
    keywordHintSelector:'[data-topicviz-keyword-hint="topic"]',
    scatterHintSelector:'[data-topicviz-scatter-hint="topic"]',
    wordsId:'topic_viz_words_topic',
    scatterId:'topic_viz_scatter_topic'
  },
  field:{
    listSelector:'[data-topicviz-list="field"]',
    messageSelector:'[data-topicviz-message="field"]',
    keywordHintSelector:'[data-topicviz-keyword-hint="field"]',
    scatterHintSelector:'[data-topicviz-scatter-hint="field"]',
    wordsId:'topic_viz_words_field',
    scatterId:'topic_viz_scatter_field'
  }
};
const TOPIC_VIZ_STATE={
  active:'topic',
  fetchedSession:'',
  loading:false,
  data:{ topic:null, field:null },
  selected:{ topic:null, field:null }
};
const WORD_CLOUD_DIMENSIONS=['topic','field'];
const WORD_CLOUD_LABELS={ topic:'研究主题（调整后）', field:'研究领域（调整后）' };
const WORD_CLOUD_CONFIG={
  topic:{ listId:'word_cloud_topic_list', messageId:'word_cloud_topic_message', label:WORD_CLOUD_LABELS.topic },
  field:{ listId:'word_cloud_field_list', messageId:'word_cloud_field_message', label:WORD_CLOUD_LABELS.field }
};
const WORD_CLOUD_IMAGE_ID='word_cloud_image';
const WORD_CLOUD_IMAGE_MESSAGE_ID='word_cloud_image_message';
const WORD_CLOUD_DOWNLOAD_PNG_ID='word_cloud_download_png';
const WORD_CLOUD_DOWNLOAD_SVG_ID='word_cloud_download_svg';
const WORD_CLOUD_DEFAULT_HINT='请选择分类以生成词云。';
let WORD_CLOUD_REQUEST_TOKEN=0;
const KEYWORD_BAR_LIMIT=15;
const KEYWORD_COLOR_PALETTE=[
  '#2563eb','#16a34a','#f97316','#dc2626','#0891b2',
  '#9333ea','#64748b','#ef4444','#22c55e','#eab308'
];
const TOPIC_KEYWORD_CHARTS={ topic:new Map(), field:new Map() };

/* ===================== 统计与图表工具 ===================== */
function safeNumber(value){
  if(typeof value==='number' && Number.isFinite(value)) return value;
  if(typeof value==='string'){
    const cleaned=value.replace(/[,\s]/g,'');
    const num=Number(cleaned);
    if(Number.isFinite(num)) return num;
  }
  const num=Number(value);
  return Number.isFinite(num)?num:0;
}
function parsePercentValue(value){
  if(value===undefined||value===null||value==='') return null;
  if(typeof value==='number' && Number.isFinite(value)) return value;
  const text=String(value).trim();
  if(!text) return null;
  const normalized=text.endsWith('%')?text.slice(0,-1):text;
  const num=Number(normalized);
  return Number.isFinite(num)?num:null;
}
function formatPercentText(percent){
  if(percent===undefined||percent===null) return '';
  const num=Number(percent);
  if(!Number.isFinite(num)) return '';
  return `${num.toFixed(2)}%`;
}
function normalizeKeywordWeight(value){
  const num=Number(value);
  return Number.isFinite(num)?num:0;
}
function getDisplayFromSource(source){
  if(source===undefined||source===null) return '';
  if(typeof source==='string') return source.trim();
  if(typeof source==='object'){
    if(typeof source.display_label==='string') return source.display_label.trim();
    if(typeof source.displayLabel==='string') return source.displayLabel.trim();
    if(typeof source.category_display==='string') return source.category_display.trim();
    if(typeof source.categoryDisplay==='string') return source.categoryDisplay.trim();
  }
  return '';
}
function resolveDisplayText(rawLabel, displaySource, kind=''){
  const normalizedKind=(kind||'').toLowerCase();
  const labelText = String(rawLabel??'').trim();
  if(labelText){
    const map = normalizedKind.startsWith('field') ? LABEL_MAPPING.field : LABEL_MAPPING.topic;
    if(map && map instanceof Map){
      const mapped=map.get(labelText);
      if(typeof mapped==='string' && mapped.trim()){ return mapped.trim(); }
    }
  }
  const candidate=getDisplayFromSource(displaySource);
  if(candidate) return candidate;
  if(normalizedKind.startsWith('field')) return 'Unmapped Field';
  if(normalizedKind.startsWith('topic')) return 'Unmapped Topic';
  return 'Unmapped';
}
function cloneDeep(value){
  if(value===undefined||value===null){
    return value;
  }
  if(typeof structuredClone==='function'){
    try{ return structuredClone(value); }catch(e){}
  }
  try{
    return JSON.parse(JSON.stringify(value));
  }catch(e){
    return value;
  }
}
function normalizeStatItems(rawList){
  const arr=Array.isArray(rawList)?rawList:[];
  const entryMap=new Map();
  let order=0;
  arr.forEach((item,idx)=>{
    if(!item) return;
    let label=String(item.label??'').trim();
    if(!label) label=`未命名${idx+1}`;
    const count=safeNumber(item.count);
    const percent=parsePercentValue(item.percent);
    const displayRaw=getDisplayFromSource(item);
    if(!entryMap.has(label)){
      entryMap.set(label,{label,count:0,percent:percent,order:order++,display_label:displayRaw});
    }
    const entry=entryMap.get(label);
    entry.count+=count;
    if(percent!==null){ entry.percent=percent; }
    if(displayRaw){ entry.display_label=displayRaw; }
  });
  const merged=Array.from(entryMap.values()).filter(item=>safeNumber(item.count)>0);
  return merged.sort((a,b)=>a.order-b.order);
}
function buildBarChartEntries(primaryRaw, overlayRaw){
  const primary=normalizeStatItems(primaryRaw);
  const overlay=normalizeStatItems(overlayRaw);
  const primaryMap=new Map(primary.map(item=>[item.label,item]));
  const overlayMap=new Map(overlay.map(item=>[item.label,item]));
  const entryMap=new Map();
  let order=0;
  const ensureEntry=label=>{
    if(entryMap.has(label)) return entryMap.get(label);
    const entry={label,primary:0,overlay:0,order:order++,display_label:''};
    entryMap.set(label,entry);
    return entry;
  };
  primary.forEach(item=>{
    const entry=ensureEntry(item.label);
    entry.primary+=safeNumber(item.count);
  });
  overlay.forEach(item=>{
    const entry=ensureEntry(item.label);
    entry.overlay+=safeNumber(item.count);
  });
  const entries=Array.from(entryMap.values()).sort((a,b)=>a.order-b.order);
  entries.forEach(entry=>{
    const primaryItem=primaryMap.get(entry.label);
    const overlayItem=overlayMap.get(entry.label);
    const display=primaryItem?.display_label||overlayItem?.display_label||'';
    entry.display_label=display;
  });
  return { entries, primaryMap, overlayMap };
}
function limitBarEntries(entries, limit=TREEMAP_CATEGORY_LIMIT){
  if(!Array.isArray(entries)) return [];
  const maxCount=Number.isFinite(limit)&&limit>0?Math.floor(limit):TREEMAP_CATEGORY_LIMIT;
  if(entries.length<=maxCount) return entries;
  const scored=entries.map((entry,idx)=>({
    entry,
    idx,
    score:safeNumber(entry.primary)+safeNumber(entry.overlay)
  }));
  const picked=new Set(
    scored
      .sort((a,b)=>b.score-a.score||(a.idx-b.idx))
      .slice(0,maxCount)
      .map(item=>item.idx)
  );
  return entries.filter((_,idx)=>picked.has(idx));
}
let AUTO_SAVE_MINUTES=5;
let IS_BATCH_SAVING=false;
let HAS_RANKING_DATA=false;
let VISUAL_TAB='adj';

const SORT_VALUE_DEFAULT='default';
const SORT_VALUE_RANK_ASC='rank_asc';
const SORT_VALUE_RANK_DESC='rank_desc';

const qs = id=>document.getElementById(id);
const escapeHtml = s=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
const escapeAttr = s=>escapeHtml(s).replaceAll('"','&quot;');
const formatMultiline = text=>escapeHtml(text||"").replace(/\n/g,'<br>');
const LANGUAGE_TOGGLE = document.getElementById('lang_toggle');
const LANGUAGE_TOGGLE_LABEL = document.getElementById('lang_toggle_label');
const SUPPORTED_LANGS = ['zh','en'];
const I18N_STRINGS = {
  zh: {
    'hero.eyebrow': 'CommCoder Studio',
    'hero.title': '编码协同流程总览',
    'hero.subtitle': '以下流程呈现从自动化产出的原始结果，到人工覆核与统计抽样验证的完整闭环。',
    'hero.abstractTitle': '方法论简介',
    'hero.abstractParagraph1': '本工作台以自动化模型为前端引擎，借助语义聚类与人工干预协同推进，对主题空缺与离群样本实行双轨校准。',
    'hero.abstractParagraph2': '流程后段强调多源整合与质量抽检，旨在确保编码结果在统计意义上的稳定性与可复现性。',
    'flow.aiAuto': 'AI 自动编码',
    'flow.aiAutoStep1.title': 'Step 1 · GPT 生成结构化总结',
    'flow.aiAutoStep1.desc': '题目 + 摘要 → 输出包含研究主题、研究方法、核心发现、研究意义的四段式总结。',
    'flow.aiAutoStep2.title': 'Step 2 · 总结驱动议题与领域归类',
    'flow.aiAutoStep2.desc': '依据结构化总结自动归纳研究主题（议题）与研究领域。',
    'flow.toWorkspace': '编码结果进入工作台',
    'flow.manualClassify': '未识别主题人工分类',
    'flow.kmeans': 'K-Means 聚类',
    'flow.outlier': '离群值识别',
    'flow.review': '人工覆核调整',
    'flow.integrate': '多通道结果整合',
    'flow.validation': '抽样验证可靠性'
  },
  en: {
    'hero.eyebrow': 'CommCoder Studio',
    'hero.title': 'Coding Collaboration Workflow Overview',
    'hero.subtitle': 'This workflow outlines the full loop from automated outputs to human review and sampling validation.',
    'hero.abstractTitle': 'Methodology Overview',
    'hero.abstractParagraph1': 'The workspace is powered by automated models up front, pairing semantic clustering with human intervention to jointly correct topic gaps and outlier samples.',
    'hero.abstractParagraph2': 'Later stages emphasise multi-source integration and quality sampling to secure statistical stability and reproducibility.',
    'flow.aiAuto': 'AI Auto Coding',
    'flow.aiAutoStep1.title': 'Step 1 · GPT structured summary',
    'flow.aiAutoStep1.desc': 'Title + abstract → four-part summary covering research topic, method, key findings, and significance.',
    'flow.aiAutoStep2.title': 'Step 2 · Summary-led topic & field tagging',
    'flow.aiAutoStep2.desc': 'Use the structured summary to derive the research topic and research field.',
    'flow.toWorkspace': 'Results enter the workspace',
    'flow.manualClassify': 'Manual classification for unidentified topics',
    'flow.kmeans': 'K-Means clustering',
    'flow.outlier': 'Outlier detection',
    'flow.review': 'Human review & adjustment',
    'flow.integrate': 'Multi-channel result integration',
    'flow.validation': 'Sample-based reliability validation'
  }
};
const I18N_ATTR_MAP = {
  zh: {
    '#hero_flow_diagram': { 'aria-label': '编码流程图' }
  },
  en: {
    '#hero_flow_diagram': { 'aria-label': 'Coding workflow diagram' }
  }
};
let CURRENT_LANG = 'zh';

function applyLanguage(lang){
  const target = SUPPORTED_LANGS.includes(lang) ? lang : 'zh';
  CURRENT_LANG = target;
  document.documentElement.setAttribute('lang', target === 'en' ? 'en' : 'zh');
  document.querySelectorAll('[data-i18n-key]').forEach(el => {
    const key = el.dataset.i18nKey;
    const textMap = I18N_STRINGS[target] || {};
    if(key && Object.prototype.hasOwnProperty.call(textMap, key)){
      el.textContent = textMap[key];
    }
  });
  const attrEntries = I18N_ATTR_MAP[target] || {};
  Object.entries(attrEntries).forEach(([selector, attrs]) => {
    const el = document.querySelector(selector);
    if(!el){ return; }
    Object.entries(attrs || {}).forEach(([attr, value]) => {
      el.setAttribute(attr, value);
    });
  });
  if(LANGUAGE_TOGGLE_LABEL){
    LANGUAGE_TOGGLE_LABEL.textContent = target === 'zh' ? 'English' : '中文';
  }
  if(LANGUAGE_TOGGLE){
    const toggleLabel = target === 'zh' ? '切换为英文' : 'Switch to Chinese';
    LANGUAGE_TOGGLE.setAttribute('aria-label', toggleLabel);
    LANGUAGE_TOGGLE.setAttribute('title', toggleLabel);
  }
}

if(LANGUAGE_TOGGLE){
  LANGUAGE_TOGGLE.addEventListener('click', () => {
    applyLanguage(CURRENT_LANG === 'zh' ? 'en' : 'zh');
  });
}

applyLanguage('zh');

const numberFormatter = new Intl.NumberFormat('zh-CN');
const TOAST_THEMES = {
  info: "bg-slate-900/90 text-white",
  success: "bg-emerald-600 text-white",
  error: "bg-rose-600 text-white",
  warning: "bg-amber-500 text-slate-900",
};

function getToastContainer(){
  return document.getElementById('toast_stack');
}

function showToast(message, type='info', options={}){
  const container = getToastContainer();
  if(!container) return;
  const theme = TOAST_THEMES[type] || TOAST_THEMES.info;
  const toast = document.createElement('div');
  toast.className = `pointer-events-auto rounded-2xl shadow-lg shadow-slate-900/20 px-4 py-3 text-sm leading-relaxed transition duration-300 ease-out transform translate-y-2 opacity-0 ${theme}`;
  toast.textContent = message;
  container.appendChild(toast);
  requestAnimationFrame(()=>{
    toast.classList.remove('opacity-0','translate-y-2');
  });
  const duration = typeof options.duration === 'number' && options.duration>0 ? options.duration : 5000;
  setTimeout(()=>{
    toast.classList.add('opacity-0','translate-y-2');
    setTimeout(()=>{ toast.remove(); }, 300);
  }, duration);
}

window.showToast = showToast;
window.alert = (msg)=>{
  const text = String(msg ?? '');
  let type = 'info';
  if(text.includes('失败') || text.includes('错误') || text.includes('异常')){
    type = 'error';
  }else if(text.includes('已') || text.includes('成功') || text.includes('完成')){
    type = 'success';
  }
  showToast(text, type);
};
const setBadge = ()=>{
  const badge = qs('session_badge');
  if(badge){ badge.textContent = "Session: " + (SESSION_ID||"—"); }
  const homeHint = qs('home_session_hint');
  if(homeHint){ homeHint.textContent = SESSION_ID || '—'; }
};

function renderSessionMeta(meta){
  const summary = qs('session_meta_summary');
  const primary = qs('session_meta_primary');
  const secondary = qs('session_meta_secondary');
  SESSION_META = meta || null;
  if(!summary || !primary || !secondary){ return; }
  summary.dataset.state = meta ? 'active' : 'empty';
  summary.classList.toggle('opacity-60', !meta);
  if(!meta){
    resetSamplingState();
    primary.textContent = '暂无会话';
    secondary.textContent = '请上传或载入数据集';
    LAST_EXPORT_URL = '';
    refreshHomeActions();
    updateWorkspaceAccess();
    return;
  }
  const fileName = meta.origin_filename ? meta.origin_filename : '未命名数据集';
  const rowsNum = typeof meta.rows === 'number' && isFinite(meta.rows) ? numberFormatter.format(meta.rows) : '未知';
  primary.textContent = `已载入：${fileName}（${rowsNum} 行）`;
  const details = [];
  if(meta.updated_text){ details.push(`最近保存：${meta.updated_text}`); }
  if(meta.last_export_time){ details.push(`最近导出：${meta.last_export_time}`); }
  if(meta.last_split_export_time){ details.push(`批量导出：${meta.last_split_export_time}`); }
  if(meta.last_topic_year_export_time){ details.push(`议题年份导出：${meta.last_topic_year_export_time}`); }
  if(!details.length){ details.push('尚无保存或导出记录'); }
  secondary.textContent = details.join(' · ');
  if(meta.last_export_path){
    LAST_EXPORT_URL = `/file?path=${encodeURIComponent(meta.last_export_path)}`;
  }else{
    LAST_EXPORT_URL = '';
  }
  refreshHomeActions();
  updateWorkspaceAccess();
}

async function refreshSessionMeta(){
  if(!SESSION_ID){
    renderSessionMeta(null);
    return null;
  }
  try{
    const r = await fetch(`/session/info?session_id=${encodeURIComponent(SESSION_ID)}`, {cache:'no-store'});
    if(!r.ok){ throw new Error('meta not available'); }
    const j = await r.json();
    renderSessionMeta(j.meta||null);
    return j.meta||null;
  }catch(e){
    return SESSION_META;
  }
}

const PAGE_HEADER = document.querySelector('header');
const SIDEBAR = document.getElementById('sidebar');
const SIDEBAR_TOGGLE = document.getElementById('sidebar_toggle');
let SIDEBAR_COLLAPSED = false;

function updateSidebarOffset(){
  if(!PAGE_HEADER){ return; }
  const rect = PAGE_HEADER.getBoundingClientRect();
  let offset = (window.scrollY <= 0) ? PAGE_HEADER.offsetHeight : rect.bottom;
  if(!Number.isFinite(offset)){ offset = PAGE_HEADER.offsetHeight || 0; }
  offset = Math.max(0, Math.min(offset, window.innerHeight || offset));
  document.documentElement.style.setProperty('--header-offset', `${offset}px`);
}

if(PAGE_HEADER){
  window.addEventListener('scroll', updateSidebarOffset, {passive:true});
  window.addEventListener('resize', updateSidebarOffset);
  window.addEventListener('load', updateSidebarOffset);
  requestAnimationFrame(updateSidebarOffset);
}

function applySidebarState(collapsed){
  if(!SIDEBAR) return;
  SIDEBAR_COLLAPSED = collapsed;
  SIDEBAR.dataset.collapsed = collapsed ? 'true' : 'false';
  if(SIDEBAR_TOGGLE){
    SIDEBAR_TOGGLE.setAttribute('aria-expanded', (!collapsed).toString());
    SIDEBAR_TOGGLE.title = collapsed ? '展开侧边栏' : '收起侧边栏';
    SIDEBAR_TOGGLE.setAttribute('aria-label', SIDEBAR_TOGGLE.title);
    const icon = SIDEBAR_TOGGLE.querySelector('svg[data-heroicon]');
    if(icon){
      const targetIcon = collapsed ? 'chevron-right' : 'chevron-left';
      if(window.Heroicons && typeof window.Heroicons.apply === 'function'){
        window.Heroicons.apply(icon, targetIcon);
      }else{
        icon.dataset.heroicon = targetIcon;
      }
    }
  }
  try{ localStorage.setItem('sidebar_collapsed', collapsed ? '1' : '0'); }catch(e){}
}

if(SIDEBAR_TOGGLE){
  SIDEBAR_TOGGLE.addEventListener('click', ()=>{
    applySidebarState(!SIDEBAR_COLLAPSED);
  });
}

try{
  const storedState = localStorage.getItem('sidebar_collapsed');
  applySidebarState(storedState === '1');
}catch(e){
  applySidebarState(false);
}

const PAGE_SECTIONS = Array.from(document.querySelectorAll('.page-section'));
const NAV_BUTTONS = Array.from(document.querySelectorAll('.nav-link[data-target]'));
const MOBILE_PAGE_SELECT = document.getElementById('mobile_page_select');
const HOME_LOCK_WRAP = document.getElementById('home_lock_hint_wrapper');
const HOME_LOCK_HINT = document.getElementById('home_lock_hint');
const HOME_LOCK_ICON = document.getElementById('home_lock_icon');
const SESSION_REQUIRED_PAGES = new Set(['page-coding','page-visual','page-sampling']);
const HOME_ACTION_CONFIG = [
  { action: 'save-session', btnId: 'btn_save_session', requiresSession: true },
  { action: 'load-session', btnId: 'btn_load_session', requiresSession: false },
  { action: 'export-excel', btnId: 'btn_save_excel', requiresSession: true },
  { action: 'export-batch', btnId: 'btn_export_batch', requiresSession: true },
  { action: 'export-topic-year', btnId: 'btn_export_topic_year', requiresSession: true },
  { action: 'download-export', btnId: 'btn_download_last', requiresSession: true, requiresExport: true }
];
let ACTIVE_PAGE = 'page-home';
const TIMELINE_BIN_SELECT = document.getElementById('timeline_bin_select');
if(TIMELINE_BIN_SELECT){
  const initVal=parseInt(TIMELINE_BIN_SELECT.value,10);
  if(Number.isFinite(initVal) && initVal>0){
    TIMELINE_BIN_SIZE=initVal;
  }
  TIMELINE_BIN_SELECT.addEventListener('change',()=>{
    const raw=parseInt(TIMELINE_BIN_SELECT.value,10);
    if(!Number.isFinite(raw) || raw<=0) return;
    if(raw===TIMELINE_BIN_SIZE) return;
    TIMELINE_BIN_SIZE=raw;
    if(SESSION_ID){
      refreshStats();
    }else{
      clearTimelineCharts('');
    }
  });
}

const TIMELINE_STACK_TOGGLES = Array.from(document.querySelectorAll('[data-timeline-stack]'));
const TOPIC_VIZ_TAB_BUTTONS = Array.from(document.querySelectorAll('[data-topicviz-tab]'));
function updateTimelineStackToggle(){
  TIMELINE_STACK_TOGGLES.forEach(btn=>{
    const dim = btn.dataset.timelineStack;
    const isActive = dim===TIMELINE_STACK_DIM;
    btn.classList.toggle('timeline-stack-btn-active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}
TOPIC_VIZ_TAB_BUTTONS.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    setTopicVizTab(btn.dataset.topicvizTab, {force:false});
  });
});
resetTopicVizState();
setTopicVizTab(TOPIC_VIZ_STATE.active, {force:false});
function setTimelineStackDim(dim){
  if(!TIMELINE_STACK_DIMENSIONS.includes(dim)){
    dim = 'topic_adj';
  }
  if(TIMELINE_STACK_DIM === dim){
    return;
  }
  TIMELINE_STACK_DIM = dim;
  updateTimelineStackToggle();
  renderTimelineStackChart(TIMELINE_DATA);
}
TIMELINE_STACK_TOGGLES.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const dim = btn.dataset.timelineStack;
    setTimelineStackDim(dim);
  });
});
updateTimelineStackToggle();

const TIMELINE_STACK_EXPAND_BTN = document.getElementById('btn_expand_timeline_stack');
if(TIMELINE_STACK_EXPAND_BTN){
  TIMELINE_STACK_EXPAND_BTN.addEventListener('click',()=>{
    const label = TIMELINE_STACK_LABELS[TIMELINE_STACK_DIM] || '分类占比堆叠图';
    openTimelineFigureFullScreen(TIMELINE_STACK_FIGURE, label);
  });
}
Object.entries(TIMELINE_LINE_DOWNLOAD_BUTTONS).forEach(([format, btn])=>{
  if(!btn) return;
  btn.addEventListener('click',()=>{
    if(btn.disabled) return;
    const url = TIMELINE_LINE_DOWNLOAD_URLS[format] || '';
    if(!url) return;
    const anchor = document.createElement('a');
    anchor.href = url;
    const binLabel = Number.isFinite(TIMELINE_BIN_SIZE) ? `${TIMELINE_BIN_SIZE}` : 'timeline';
    anchor.download = `timeline_${binLabel}yr.${format}`;
    document.body.appendChild(anchor);
    anchor.click();
    document.body.removeChild(anchor);
  });
});
if(TIMELINE_LINE_IMAGE){
  TIMELINE_LINE_IMAGE.addEventListener('load',()=>{
    requestAnimationFrame(()=>positionTimelineLineLabels());
  });
  TIMELINE_LINE_IMAGE.addEventListener('error',()=>{
    requestAnimationFrame(()=>positionTimelineLineLabels());
  });
}

function pingHomeLock(){
  if(!HOME_LOCK_WRAP) return;
  HOME_LOCK_WRAP.classList.remove('home-lock-bounce');
  void HOME_LOCK_WRAP.offsetWidth;
  HOME_LOCK_WRAP.classList.add('home-lock-bounce');
  setTimeout(()=>{
    if(HOME_LOCK_WRAP){
      HOME_LOCK_WRAP.classList.remove('home-lock-bounce');
    }
  }, 950);
}

function updateWorkspaceAccess(){
  const hasSession = !!SESSION_ID;
  NAV_BUTTONS.forEach(btn=>{
    const target = btn.dataset.target;
    const locked = SESSION_REQUIRED_PAGES.has(target) && !hasSession;
    btn.dataset.locked = locked ? '1' : '0';
    btn.setAttribute('aria-disabled', locked ? 'true' : 'false');
    btn.classList.toggle('nav-link-disabled', locked);
    if(!btn.dataset.baseTitle && btn.title){
      btn.dataset.baseTitle = btn.title;
    }
    if(locked){
      const baseTitle = btn.dataset.baseTitle || btn.title || '';
      const lockedTitle = baseTitle ? `${baseTitle}（未解锁）` : '页面未解锁';
      btn.title = lockedTitle;
      btn.setAttribute('aria-label', lockedTitle);
    }else if(btn.dataset.baseTitle){
      btn.title = btn.dataset.baseTitle;
      btn.setAttribute('aria-label', btn.dataset.baseTitle);
    }
  });
  if(MOBILE_PAGE_SELECT){
    Array.from(MOBILE_PAGE_SELECT.options).forEach(opt=>{
      const locked = SESSION_REQUIRED_PAGES.has(opt.value) && !hasSession;
      opt.disabled = locked;
    });
    if(SESSION_REQUIRED_PAGES.has(MOBILE_PAGE_SELECT.value) && !hasSession){
      MOBILE_PAGE_SELECT.value = 'page-home';
    }
  }
  if(!hasSession && SESSION_REQUIRED_PAGES.has(ACTIVE_PAGE)){
    activatePage('page-home', {force:true});
  }
  if(HOME_LOCK_WRAP){
    HOME_LOCK_WRAP.dataset.state = hasSession ? 'ready' : 'locked';
  }
  if(HOME_LOCK_HINT){
    if(hasSession){
      const fileName = SESSION_META?.origin_filename ? SESSION_META.origin_filename : '未命名数据集';
      const rowsNum = (SESSION_META && typeof SESSION_META.rows === 'number' && isFinite(SESSION_META.rows)) ? `${numberFormatter.format(SESSION_META.rows)} 行` : '行数待获取';
      HOME_LOCK_HINT.textContent = `当前会话：${fileName} · ${rowsNum}，工作台已解锁。`;
    }else{
      HOME_LOCK_HINT.textContent = '请在下方上传数据集或载入会话以解锁编码工作台与数据可视化。';
    }
  }
  if(HOME_LOCK_ICON){
    const iconName = hasSession ? 'lock-open' : 'lock-closed';
    if(window.Heroicons && typeof window.Heroicons.apply === 'function'){
      window.Heroicons.apply(HOME_LOCK_ICON, iconName);
    }else{
      HOME_LOCK_ICON.dataset.heroicon = iconName;
    }
  }
  refreshHomeActions();
  const samplingControls=[qs('btn_sampling_generate'),qs('btn_sampling_refresh')];
  samplingControls.forEach(btn=>{ if(btn){ btn.disabled=!hasSession; }});
  const samplingInputs=[qs('sampling_inspector_input'),qs('sampling_rate_input'),qs('sampling_force_toggle')];
  samplingInputs.forEach(input=>{ if(input){ input.disabled=!hasSession; }});
}

function refreshHomeActions(){
  const hasSession = !!SESSION_ID;
  const hasExport = !!LAST_EXPORT_URL;
  HOME_ACTION_CONFIG.forEach(cfg=>{
    const btn = document.getElementById(cfg.btnId);
    const card = document.querySelector(`.home-action-card[data-action="${cfg.action}"]`);
    const disabled = (cfg.requiresSession && !hasSession) || (cfg.requiresExport && !hasExport);
    if(btn){ btn.disabled = disabled; }
    if(card){ card.dataset.disabled = disabled ? 'true' : 'false'; }
  });
}

function activatePage(targetId, options={}){
  const force = options.force === true;
  if(!force && SESSION_REQUIRED_PAGES.has(targetId) && !SESSION_ID){
    pingHomeLock();
    return;
  }
  PAGE_SECTIONS.forEach(section=>section.classList.toggle('hidden', section.id !== targetId));
  NAV_BUTTONS.forEach(btn=>{
    const isActive = btn.dataset.target === targetId;
    btn.classList.toggle('nav-link-active', isActive);
  });
  if(MOBILE_PAGE_SELECT && MOBILE_PAGE_SELECT.value !== targetId){
    MOBILE_PAGE_SELECT.value = targetId;
  }
  ACTIVE_PAGE = targetId;
}

function enterWorkspace(){
  updateWorkspaceAccess();
  activatePage('page-coding');
}

NAV_BUTTONS.forEach(btn=>btn.addEventListener('click', ()=>{
  if(btn.dataset.locked === '1'){
    pingHomeLock();
    return;
  }
  activatePage(btn.dataset.target);
}));
if(MOBILE_PAGE_SELECT){
  MOBILE_PAGE_SELECT.addEventListener('change', e=>{
    const target = e.target.value;
    if(SESSION_REQUIRED_PAGES.has(target) && !SESSION_ID){
      e.target.value = ACTIVE_PAGE;
      pingHomeLock();
      return;
    }
    activatePage(target);
  });
}

activatePage('page-home', {force:true});
updateWorkspaceAccess();

const samplingRateInput = qs('sampling_rate_input');
if(samplingRateInput){
  samplingRateInput.addEventListener('input', ()=>{ samplingRateInput.dataset.userTouched='1'; });
}
const samplingGenerateBtn = qs('btn_sampling_generate');
if(samplingGenerateBtn){
  samplingGenerateBtn.addEventListener('click', createSamplingAudit);
}
const samplingRefreshBtn = qs('btn_sampling_refresh');
if(samplingRefreshBtn){
  samplingRefreshBtn.addEventListener('click', ()=>{ loadSamplingList(); });
}
const samplingListZone = qs('sampling_list_zone');
if(samplingListZone){
  samplingListZone.addEventListener('click', e=>{
    const btn = e.target.closest('[data-sampling-id]');
    if(!btn) return;
    const targetId = btn.dataset.samplingId;
    if(targetId){ openSamplingAudit(targetId); }
  });
}
const samplingItemsZone = qs('sampling_items_zone');
if(samplingItemsZone){
  samplingItemsZone.addEventListener('change', e=>{
    const select = e.target.closest('select');
    if(select && select.tagName === 'SELECT' && select.classList.contains('sampling-select')){
      const itemId = select.dataset.itemId;
      if(itemId){ saveSamplingSelection(itemId); }
    }
  });
  samplingItemsZone.addEventListener('click', e=>{
    const applyBtn = e.target.closest('.sampling-apply-btn');
    if(!applyBtn || applyBtn.disabled) return;
    const itemId = applyBtn.dataset.itemId;
    if(!itemId) return;
    const itemEl = document.querySelector(`[data-sampling-item="${CSS.escape(itemId)}"]`);
    if(!itemEl) return;
    const aiTopic = applyBtn.dataset.aiTopic||'';
    const aiField = applyBtn.dataset.aiField||'';
    let applied = false;
    if(aiTopic){
      const topicSelect = itemEl.querySelector('select[data-kind="topic"]');
      if(topicSelect){
        const hasOption = Array.from(topicSelect.options).some(opt=>opt.value===aiTopic);
        if(hasOption){
          if(topicSelect.value !== aiTopic){
            topicSelect.value = aiTopic;
          }
          applied = true;
        }
      }
    }
    if(aiField){
      const fieldSelect = itemEl.querySelector('select[data-kind="field"]');
      if(fieldSelect){
        const hasOption = Array.from(fieldSelect.options).some(opt=>opt.value===aiField);
        if(hasOption){
          if(fieldSelect.value !== aiField){
            fieldSelect.value = aiField;
          }
          applied = true;
        }
      }
    }
    if(applied){
      saveSamplingSelection(itemId);
    }else{
      showToast('未找到匹配的 AI 分类选项', 'warning');
    }
  });
}
const samplingPagerZone = qs('sampling_pager_zone');
if(samplingPagerZone){
  samplingPagerZone.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-page]');
    if(!btn || btn.disabled) return;
    const targetPage = Number(btn.dataset.page);
    if(Number.isFinite(targetPage)){
      setSamplingPage(SAMPLING_STATE.activeId, targetPage);
    }
  });
}

/* ---- 默认兜底表 ---- */
const DEF_TOPICS = ["健康议题","经济议题","政治议题","环境议题","传播模式与行为","媒介制度与平台治理","科技议题","文化议题","宗教议题","其他议题"];
const DEF_FIELDS = [
  "广告学",
  "传播心理学",
  "传播研究方法",
  "传播伦理",
  "健康传播",
  "跨文化传播",
  "人际传播",
  "新闻学",
  "法律与政策",
  "大众传播",
  "媒介效果",
  "媒介史",
  "媒介产业",
  "媒介生产与传播",
  "媒介技术",
  "媒介理论",
  "组织传播",
  "政治传播",
  "公共关系",
  "科学传播",
  "言语传播",
  "其他领域"
];
const DEF_TOPIC_LABEL_MAP = {
  "文化议题":"Cultural Issues",
  "经济议题":"Economic Issues",
  "环境议题":"Environmental Issues",
  "健康议题":"Health Issues",
  "媒介制度与平台治理":"Media Systems",
  "政治议题":"Political Issues",
  "宗教议题":"Religious Issues",
  "科技议题":"Technological Issues",
  "传播模式与行为":"Communication Behaviors",
  "其他议题":"Other Issues",
  "未分类":"Uncategorized"
};
const DEF_FIELD_LABEL_MAP = {
  "广告学":"Advertising",
  "传播心理学":"Communication & Psychology",
  "传播研究方法":"Communication Research Methods",
  "传播伦理":"Communication Ethics",
  "健康传播":"Health Communications",
  "跨文化传播":"Intercultural Communications",
  "人际传播":"Interpersonal Communications",
  "新闻学":"Journalism",
  "法律与政策":"Law & Policy",
  "大众传播":"Mass Communication",
  "媒介效果":"Media Effects",
  "媒介史":"Media History",
  "媒介产业":"Media Industries",
  "媒介生产与传播":"Media Production & Distribution",
  "媒介技术":"Media Technology",
  "媒介理论":"Media Theory",
  "组织传播":"Organizational Communications",
  "政治传播":"Political Communications",
  "公共关系":"Public Relations",
  "科学传播":"Science Communications",
  "言语传播":"Speech Communications",
  "其他领域":"Others",
  "未分类":"Uncategorized"
};
const LABEL_MAPPING_STATE={ topic:[], field:[] };
let LABEL_MAPPING_DIRTY=false;

/* ===================== 配置加载 ===================== */
async function fetchFrontendConfig(){
  try{
    const r=await fetch("/frontend_config",{cache:"no-store"}); const j=await r.json();
    ADJ_TOPIC_COL=j.adj_topic_key||"研究主题（议题）分类_调整";
    ADJ_FIELD_COL=j.adj_field_key||"研究领域分类_调整";
    TOPIC_LIST=Array.isArray(j.topic_list)&&j.topic_list.length?j.topic_list:[...DEF_TOPICS];
    FIELD_LIST=Array.isArray(j.field_list)&&j.field_list.length?j.field_list:[...DEF_FIELDS];
    if(typeof j.sampling_default_rate==='number' && Number.isFinite(j.sampling_default_rate)){
      SAMPLING_DEFAULT_RATE = Number(j.sampling_default_rate);
    }else{
      SAMPLING_DEFAULT_RATE = 0.03;
    }
    qs('app_ver').textContent="v"+(j.app_version||"");
    applyLabelMappingConfig(j.label_mapping||{}, j.label_mapping_defaults||{});
  }catch(e){
    ADJ_TOPIC_COL="研究主题（议题）分类_调整";
    ADJ_FIELD_COL="研究领域分类_调整";
    TOPIC_LIST=[...DEF_TOPICS]; FIELD_LIST=[...DEF_FIELDS];
    SAMPLING_DEFAULT_RATE = 0.03;
    applyLabelMappingConfig({ topic:DEF_TOPIC_LABEL_MAP, field:DEF_FIELD_LABEL_MAP }, { topic:DEF_TOPIC_LABEL_MAP, field:DEF_FIELD_LABEL_MAP });
  }
  updateSamplingDefaultRateHint();
  setBlacklistSelections(TOPIC_BLACKLIST, FIELD_BLACKLIST);
}
async function fetchEnvDefaults(){
  const r=await fetch("/default_llm_config"); if(!r.ok) return;
  const j=await r.json();
  if(!localStorage.getItem("llm_cfg")){
    qs('cfg_base_url').value=j.base_url||""; qs('cfg_api_key').value=j.api_key||"";
    qs('cfg_model').value=j.model||""; qs('cfg_temp').value=j.temp??0.2;
  }
}
function renderBlacklistOptions(topicSelected=TOPIC_BLACKLIST, fieldSelected=FIELD_BLACKLIST){
  const renderGroup=(list, selected, kind)=>{
    if(!Array.isArray(list) || !list.length){
      return '<p class="text-xs text-slate-400">暂无候选分类</p>';
    }
    return list.map(name=>{
      const checked = Array.isArray(selected) && selected.includes(name);
      return `<label class="inline-flex items-center cursor-pointer select-none">
  <input type="checkbox" class="sr-only peer blacklist-input" data-kind="${kind}" value="${escapeAttr(name)}" ${checked?'checked':''}>
  <span class="px-3 py-2 rounded-full border border-slate-200 text-sm text-slate-600 bg-white transition-colors peer-checked:bg-slate-900 peer-checked:text-white peer-checked:border-slate-900">${escapeHtml(name)}</span>
</label>`;
    }).join("");
  };
  const topicWrap=qs('topic_blacklist_options');
  if(topicWrap){ topicWrap.innerHTML = renderGroup(TOPIC_LIST, topicSelected, 'topic'); }
  const fieldWrap=qs('field_blacklist_options');
  if(fieldWrap){ fieldWrap.innerHTML = renderGroup(FIELD_LIST, fieldSelected, 'field'); }
}
function setBlacklistSelections(topicList=[], fieldList=[]){
  TOPIC_BLACKLIST = Array.isArray(topicList)?topicList.filter(it=>TOPIC_LIST.includes(it)):[];
  FIELD_BLACKLIST = Array.isArray(fieldList)?fieldList.filter(it=>FIELD_LIST.includes(it)):[];
  renderBlacklistOptions(TOPIC_BLACKLIST, FIELD_BLACKLIST);
}

/* ===================== 标签映射配置 ===================== */
function sanitizeLabelMappingObject(raw){
  const result={};
  if(!raw) return result;
  let entries=[];
  if(raw instanceof Map){
    entries=Array.from(raw.entries());
  }else if(Array.isArray(raw)){
    entries=raw;
  }else if(typeof raw==='object'){
    entries=Object.entries(raw);
  }
  entries.forEach(entry=>{
    if(!entry) return;
    const keyRaw = Array.isArray(entry) ? entry[0] : entry.key ?? entry.label ?? entry.name;
    const valueRaw = Array.isArray(entry) ? entry[1] : entry.value ?? entry.display ?? entry.display_label ?? entry.displayLabel ?? entry.text;
    const key = String(keyRaw??'').trim();
    if(!key) return;
    const value = valueRaw===undefined || valueRaw===null ? '' : String(valueRaw).trim();
    result[key]=value;
  });
  return result;
}

function createLabelMappingEntry(kind, label, display, options={}){
  return {
    id:`${kind}_${Math.random().toString(36).slice(2,10)}_${Date.now().toString(36)}`,
    label:typeof label==='string'?label.trim(): (label??'').toString().trim(),
    display:typeof display==='string'?display.trim(): (display??'').toString().trim(),
    isDefault:!!options.isDefault,
    locked:!!options.locked
  };
}

function sortLabelMappingState(kind){
  const list=LABEL_MAPPING_STATE[kind];
  if(!Array.isArray(list)) return;
  list.sort((a,b)=>{
    if(!!a.isDefault !== !!b.isDefault){ return a.isDefault? -1 : 1; }
    const hasLabelA=!!(a.label&&a.label.trim());
    const hasLabelB=!!(b.label&&b.label.trim());
    if(hasLabelA!==hasLabelB){ return hasLabelA? -1 : 1; }
    const labelA=(a.label||'').trim();
    const labelB=(b.label||'').trim();
    return labelA.localeCompare(labelB,'zh-Hans-CN',{numeric:true,sensitivity:'base'});
  });
}

function rebuildLabelMappingMaps(){
  ['topic','field'].forEach(kind=>{
    const map=LABEL_MAPPING[kind];
    if(map instanceof Map){ map.clear(); }
    else{ LABEL_MAPPING[kind]=new Map(); }
    LABEL_MAPPING_STATE[kind].forEach(entry=>{
      const label=(entry.label||'').trim();
      if(!label) return;
      const display=(entry.display||'').trim();
      LABEL_MAPPING[kind].set(label, display);
    });
  });
}

function setLabelMappingHint(text='', tone='info'){
  const hint=document.getElementById('label_mapping_hint');
  if(!hint) return;
  const classes=['text-slate-500','text-red-600','text-emerald-600'];
  classes.forEach(cls=>hint.classList.remove(cls));
  if(tone==='error'){ hint.classList.add('text-red-600'); }
  else if(tone==='success'){ hint.classList.add('text-emerald-600'); }
  else { hint.classList.add('text-slate-500'); }
  hint.textContent=text||'';
}

function markLabelMappingDirty(dirty, message=''){
  LABEL_MAPPING_DIRTY=!!dirty;
  if(dirty){
    setLabelMappingHint(message||'有未保存的映射修改','error');
  }else{
    setLabelMappingHint(message||'', message? 'success':'info');
    if(message){
      setTimeout(()=>{ if(!LABEL_MAPPING_DIRTY) setLabelMappingHint('', 'info'); }, 3200);
    }
  }
}

function findLabelMappingEntry(kind, entryId){
  return LABEL_MAPPING_STATE[kind]?.find(entry=>entry.id===entryId) || null;
}

function updateLabelMappingSource(kind, entryId, value, inputEl, titleEl){
  const entry=findLabelMappingEntry(kind, entryId);
  if(!entry || entry.locked) return;
  const nextLabel=String(value||'').trim();
  if(nextLabel){
    const duplicate=LABEL_MAPPING_STATE[kind].some(item=>item!==entry && item.label===nextLabel);
    if(duplicate){
      if(inputEl){ inputEl.value=entry.label; }
      showToast(`分类「${nextLabel}」已存在，请勿重复添加。`,'warning');
      return;
    }
  }
  const prevLabel=entry.label;
  entry.label=nextLabel;
  if(titleEl){ titleEl.textContent=nextLabel||'（未命名）'; }
  if(prevLabel){ LABEL_MAPPING[kind].delete(prevLabel); }
  if(nextLabel){ LABEL_MAPPING[kind].set(nextLabel, (entry.display||'').trim()); }
  markLabelMappingDirty(true);
}

function updateLabelMappingDisplay(kind, entryId, value){
  const entry=findLabelMappingEntry(kind, entryId);
  if(!entry) return;
  entry.display=String(value??'').trim();
  const label=(entry.label||'').trim();
  if(label){ LABEL_MAPPING[kind].set(label, entry.display); }
  markLabelMappingDirty(true);
}

function removeLabelMappingEntry(kind, entryId){
  const list=LABEL_MAPPING_STATE[kind];
  if(!Array.isArray(list)) return;
  const idx=list.findIndex(entry=>entry.id===entryId);
  if(idx===-1) return;
  const entry=list[idx];
  if(entry.locked) return;
  if(entry.label){ LABEL_MAPPING[kind].delete(entry.label); }
  list.splice(idx,1);
  markLabelMappingDirty(true);
  renderLabelMappingTable(kind);
}

function focusLabelMappingInput(kind, entryId, role='display'){
  const container=document.getElementById(kind==='field'?'field_label_table':'topic_label_table');
  if(!container) return;
  const row=container.querySelector(`[data-entry-id="${CSS.escape(entryId)}"]`);
  if(!row) return;
  const target=row.querySelector(role==='source'?"input[data-role='source']":"input[data-role='display']");
  if(target){ target.focus(); target.select(); }
}

function renderLabelMappingTable(kind){
  const container=document.getElementById(kind==='field'?'field_label_table':'topic_label_table');
  if(!container) return;
  container.innerHTML='';
  const entries=LABEL_MAPPING_STATE[kind]||[];
  if(!entries.length){
    const empty=document.createElement('div');
    empty.className='label-mapping-empty';
    empty.textContent='暂无映射，点击“新增条目”添加';
    container.appendChild(empty);
    return;
  }
  entries.forEach(entry=>{
    const row=document.createElement('div');
    row.className='label-mapping-row';
    row.dataset.entryId=entry.id;
    const header=document.createElement('div');
    header.className='label-mapping-label';
    const title=document.createElement('span');
    title.className='label-mapping-title';
    title.textContent=entry.label||'（未命名）';
    header.appendChild(title);
    if(entry.locked){
      const badge=document.createElement('span');
      badge.className='text-xs text-slate-400';
      badge.textContent='默认';
      header.appendChild(badge);
    }else{
      const removeBtn=document.createElement('button');
      removeBtn.type='button';
      removeBtn.className='label-mapping-remove';
      removeBtn.textContent='移除';
      removeBtn.addEventListener('click',()=>removeLabelMappingEntry(kind, entry.id));
      header.appendChild(removeBtn);
    }
    row.appendChild(header);
    if(!entry.locked){
      const sourceWrap=document.createElement('div');
      sourceWrap.className='label-mapping-input';
      const sourceInput=document.createElement('input');
      sourceInput.type='text';
      sourceInput.placeholder='中文分类名称';
      sourceInput.value=entry.label||'';
      sourceInput.dataset.role='source';
      sourceInput.addEventListener('change',e=>updateLabelMappingSource(kind, entry.id, e.target.value, sourceInput, title));
      sourceWrap.appendChild(sourceInput);
      row.appendChild(sourceWrap);
    }
    const displayWrap=document.createElement('div');
    displayWrap.className='label-mapping-input';
    const displayInput=document.createElement('input');
    displayInput.type='text';
    const defaultPlaceholder=LABEL_MAPPING_DEFAULTS[kind].get(entry.label||'')||'英文展示名称';
    displayInput.placeholder=defaultPlaceholder||'英文展示名称';
    displayInput.value=entry.display||'';
    displayInput.dataset.role='display';
    displayInput.addEventListener('input',e=>updateLabelMappingDisplay(kind, entry.id, e.target.value));
    displayWrap.appendChild(displayInput);
    row.appendChild(displayWrap);
    container.appendChild(row);
  });
}

function renderLabelMappingTables(){
  renderLabelMappingTable('topic');
  renderLabelMappingTable('field');
}

function addLabelMappingRow(kind){
  const entry=createLabelMappingEntry(kind,'','', { isDefault:false, locked:false });
  LABEL_MAPPING_STATE[kind].push(entry);
  renderLabelMappingTable(kind);
  markLabelMappingDirty(true);
  focusLabelMappingInput(kind, entry.id, 'source');
}

function applyLabelMappingConfig(mappingPayload={}, defaultPayload={}){
  ['topic','field'].forEach(kind=>{
    const defaultsRaw = sanitizeLabelMappingObject(defaultPayload[kind]);
    const fallbackDefaults = kind==='field'? DEF_FIELD_LABEL_MAP : DEF_TOPIC_LABEL_MAP;
    const defaultsSource = Object.keys(defaultsRaw).length ? defaultsRaw : fallbackDefaults;
    LABEL_MAPPING_DEFAULTS[kind].clear();
    Object.entries(defaultsSource).forEach(([label,value])=>{
      const key=String(label||'').trim();
      if(!key) return;
      const text=value===undefined||value===null?'':String(value).trim();
      LABEL_MAPPING_DEFAULTS[kind].set(key,text);
    });
    const finalRaw = sanitizeLabelMappingObject(mappingPayload[kind]);
    const mergedEntries={};
    LABEL_MAPPING_DEFAULTS[kind].forEach((value,label)=>{ mergedEntries[label]=value; });
    Object.entries(finalRaw).forEach(([label,value])=>{
      const key=String(label||'').trim();
      if(!key) return;
      const text=value===undefined||value===null?'':String(value).trim();
      mergedEntries[key]=text;
    });
    LABEL_MAPPING_STATE[kind]=Object.entries(mergedEntries).map(([label,value])=>{
      const isDefault=LABEL_MAPPING_DEFAULTS[kind].has(label);
      return createLabelMappingEntry(kind,label,value,{ isDefault, locked:isDefault });
    });
    sortLabelMappingState(kind);
  });
  rebuildLabelMappingMaps();
  renderLabelMappingTables();
  markLabelMappingDirty(false);
}

function ingestLabelMappingCandidates(kind, labels){
  if(!Array.isArray(labels) || !labels.length) return false;
  const existing=new Set((LABEL_MAPPING_STATE[kind]||[]).map(entry=>entry.label).filter(Boolean));
  let added=false;
  labels.forEach(label=>{
    const key=String(label||'').trim();
    if(!key || existing.has(key)) return;
    const defaultDisplay=LABEL_MAPPING_DEFAULTS[kind].get(key)||'';
    const entry=createLabelMappingEntry(kind, key, LABEL_MAPPING[kind].get(key)||defaultDisplay, { isDefault: LABEL_MAPPING_DEFAULTS[kind].has(key), locked: LABEL_MAPPING_DEFAULTS[kind].has(key) });
    LABEL_MAPPING_STATE[kind].push(entry);
    existing.add(key);
    if(!LABEL_MAPPING[kind].has(key)){
      LABEL_MAPPING[kind].set(key, entry.display||'');
    }
    added=true;
  });
  if(added){
    sortLabelMappingState(kind);
    renderLabelMappingTable(kind);
  }
  return added;
}

function buildLabelMappingOverrides(kind){
  const defaults=LABEL_MAPPING_DEFAULTS[kind];
  const overrides={};
  const errors=[];
  const seen=new Set();
  LABEL_MAPPING_STATE[kind].forEach(entry=>{
    const label=String(entry.label||'').trim();
    const display=String(entry.display||'').trim();
    if(!label){
      if(display){ errors.push('存在缺少中文分类名称的映射条目'); }
      return;
    }
    if(seen.has(label)){
      errors.push(`分类「${label}」出现重复，请检查后再保存`);
      return;
    }
    seen.add(label);
    const hasDefault=defaults.has(label);
    const defaultValue=hasDefault ? (defaults.get(label)||'').trim() : '';
    if(!hasDefault || display!==defaultValue){
      overrides[label]=display;
    }
  });
  return { overrides, errors };
}

async function saveLabelMapping(){
  const topicResult=buildLabelMappingOverrides('topic');
  const fieldResult=buildLabelMappingOverrides('field');
  const allErrors=[...topicResult.errors,...fieldResult.errors];
  if(allErrors.length){
    setLabelMappingHint(allErrors[0],'error');
    showToast(allErrors[0],'warning');
    return;
  }
  setLabelMappingHint('保存中…','info');
  try{
    const payload={ topic:topicResult.overrides, field:fieldResult.overrides };
    const r=await fetch('/label_mappings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){
      const text=await r.text();
      throw new Error(text||'保存失败');
    }
    const data=await r.json();
    applyLabelMappingConfig(data.label_mapping||{}, data.label_mapping_defaults||{});
    setLabelMappingHint('映射已保存','success');
    if(SESSION_ID){
      try{ await refreshStats(); }
      catch(e){ console.error('刷新统计失败', e); }
    }
  }catch(e){
    markLabelMappingDirty(true);
    const msg=e?.message||e||'保存失败';
    setLabelMappingHint(`保存失败：${msg}`,'error');
    showToast(`保存失败：${msg}`,'error');
  }
}


/* ===================== 抽样检测 ===================== */
function samplingPercentDisplay(value){
  const num = Number(value);
  if(!Number.isFinite(num)) return '0%';
  const normalized = Math.max(0, Math.min(100, num));
  const decimals = normalized % 1 === 0 ? 0 : (normalized >= 10 ? 1 : 2);
  return normalized.toFixed(decimals).replace(/\.0+$/,'') + '%';
}
function samplingStatusLabel(status){
  switch(status){
    case 'completed': return '已完成';
    case 'in_progress': return '进行中';
    default: return '未开始';
  }
}
function samplingStatusClass(status){
  if(status==='completed') return 'sampling-status-completed';
  if(status==='in_progress') return 'sampling-status-progress';
  return 'sampling-status-pending';
}
function updateSamplingDefaultRateHint(){
  const hint = qs('sampling_header_hint');
  const percentText = samplingPercentDisplay((SAMPLING_DEFAULT_RATE||0)*100);
  if(hint){ hint.textContent = `默认抽样比例：${percentText}`; }
  const input = qs('sampling_rate_input');
  if(input && input.dataset.userTouched!=='1'){
    input.value = percentText.replace('%','');
  }
}
function resetSamplingState(){
  SAMPLING_STATE.list = [];
  SAMPLING_STATE.loading = false;
  SAMPLING_STATE.activeId = '';
  SAMPLING_STATE.data = new Map();
  SAMPLING_STATE.pageByInspector = new Map();
  SAMPLING_STATE.pageSize = SAMPLING_PAGE_SIZE;
  renderSamplingList();
  renderSamplingDetail();
}
function renderSamplingList(){
  const wrap = qs('sampling_list_zone');
  if(!wrap) return;
  if(!SESSION_ID){
    wrap.innerHTML = '<div class="sampling-empty">请先上传或载入会话</div>';
    return;
  }
  if(SAMPLING_STATE.loading){
    wrap.innerHTML = '<div class="sampling-empty">加载中…</div>';
    return;
  }
  const audits = Array.isArray(SAMPLING_STATE.list)?SAMPLING_STATE.list:[];
  if(!audits.length){
    wrap.innerHTML = '<div class="sampling-empty">暂无抽样任务</div>';
    return;
  }
  wrap.innerHTML = audits.map(a=>{
    const inspectorName = escapeHtml(a.inspector||'未命名核对员');
    const status = a.status||'pending';
    const statusClass = samplingStatusClass(status);
    const statusLabel = samplingStatusLabel(status);
    const progress = Number.isFinite(Number(a.progress_percent))?Number(a.progress_percent):((Number(a.progress)||0)*100);
    const clamped = Math.max(0, Math.min(100, progress||0));
    const progressText = samplingPercentDisplay(clamped);
    const completed = Number(a.completed)||0;
    const total = Number(a.sample_size)||0;
    const updated = escapeHtml(a.updated_at||'—');
    const active = SAMPLING_STATE.activeId === a.inspector_id;
    return `<button type="button" class="sampling-list-item ${active?'sampling-list-item-active':''}" data-sampling-id="${escapeAttr(a.inspector_id||'')}">
      <div class="sampling-list-title">
        <span class="sampling-list-name">${inspectorName}</span>
        <span class="sampling-list-status ${statusClass}">${statusLabel}</span>
      </div>
      <div class="sampling-list-meta">样本 ${completed}/${total} · 进度 ${progressText}</div>
      <div class="sampling-progress"><div class="sampling-progress-bar" style="width:${clamped}%"></div></div>
      <div class="sampling-list-updated">更新：${updated}</div>
    </button>`;
  }).join('');
}

function renderSamplingMetrics(metrics){
  if(!metrics || typeof metrics !== 'object'){ return ''; }
  const metricCards = [];
  const metricConfig = [
    { key:'topic', title:'议题准确率', subtitle:'AI 预测 vs 人工核对' },
    { key:'field', title:'领域准确率', subtitle:'AI 预测 vs 人工核对' },
    { key:'joint', title:'整体一致率', subtitle:'议题与领域均一致' },
    { key:'orig_topic', title:'原始议题一致率', subtitle:'人工 vs 原始分类' },
    { key:'orig_field', title:'原始领域一致率', subtitle:'人工 vs 原始分类' },
    { key:'orig_joint', title:'原始总体一致率', subtitle:'人工 vs 原始分类均一致' },
  ];
  metricConfig.forEach(cfg=>{
    const m = metrics[cfg.key]||{};
    const compared = Number(m.compared)||0;
    const matches = Number(m.matches)||0;
    const accuracyPercent = Number(m.accuracy_percent);
    const valueText = Number.isFinite(accuracyPercent)?samplingPercentDisplay(accuracyPercent):'—';
    const detail = compared>0?`样本 ${matches}/${compared}`:'暂无对比样本';
    const kappaValue = typeof m.kappa === 'number'?m.kappa:null;
    const kappaText = Number.isFinite(kappaValue)?kappaValue.toFixed(3):'—';
    const kappaLine = `Cohen's κ：${kappaText}`;
    metricCards.push(`<div class="sampling-metric-card">
      <p class="sampling-metric-title">${escapeHtml(cfg.title)}</p>
      <p class="sampling-metric-value">${valueText}</p>
      <p class="sampling-metric-meta">${escapeHtml(cfg.subtitle)}</p>
      <p class="sampling-metric-detail">${escapeHtml(detail)}</p>
      <p class="sampling-metric-detail">${escapeHtml(kappaLine)}</p>
    </div>`);
  });

  const distributions = [];
  const selectedTopic = metrics.selected_topic||{};
  const selectedField = metrics.selected_field||{};
  const aiTopic = metrics.ai_topic||{};
  const aiField = metrics.ai_field||{};

  const selectedTopicCard = renderSamplingDistributionCard('人工议题分布', selectedTopic.top, selectedTopic.total);
  if(selectedTopicCard){ distributions.push(selectedTopicCard); }
  const selectedFieldCard = renderSamplingDistributionCard('人工领域分布', selectedField.top, selectedField.total);
  if(selectedFieldCard){ distributions.push(selectedFieldCard); }
  const aiTopicCard = renderSamplingDistributionCard('AI 议题分布', aiTopic.top, aiTopic.total);
  if(aiTopicCard){ distributions.push(aiTopicCard); }
  const aiFieldCard = renderSamplingDistributionCard('AI 领域分布', aiField.top, aiField.total);
  if(aiFieldCard){ distributions.push(aiFieldCard); }

  const cardsHtml = metricCards.length?`<div class="sampling-metrics-grid">${metricCards.join('')}</div>`:'';
  const distributionsHtml = distributions.length?`<div class="sampling-metrics-dist-grid">${distributions.join('')}</div>`:'';
  if(!cardsHtml && !distributionsHtml){ return ''; }
  return `<section class="sampling-metrics">${cardsHtml}${distributionsHtml}</section>`;
}

function renderSamplingDistributionCard(title, entries, total){
  if(!Array.isArray(entries) || !entries.length){ return ''; }
  const safeTotal = Number(total)||0;
  const listItems = entries.map(entry=>{
    const rawLabel = entry?.label||'未分类';
    const label = escapeHtml(rawLabel);
    const labelAttr = escapeAttr(rawLabel||'未分类');
    const count = safeNumber(entry?.count||0);
    const percentVal = Number(entry?.percent);
    const percentText = Number.isFinite(percentVal)?samplingPercentDisplay(percentVal):'—';
    return `<li class="sampling-metric-dist-item">
      <span class="sampling-metric-dist-label" title="${labelAttr}">${label}</span>
      <span class="sampling-metric-dist-value"><span>${count}</span><span class="sampling-metric-dist-percent">${percentText}</span></span>
    </li>`;
  }).join('');
  return `<div class="sampling-metric-dist-card">
    <div class="sampling-metric-dist-header">
      <span class="sampling-metric-dist-title">${escapeHtml(title)}</span>
      <span class="sampling-metric-dist-total">总计 ${safeNumber(safeTotal)}</span>
    </div>
    <ul class="sampling-metric-dist-list">${listItems}</ul>
  </div>`;
}

function renderSamplingDetail(data=null){
  const detail = qs('sampling_detail_zone');
  const itemsZone = qs('sampling_items_zone');
  const pagerZone = qs('sampling_pager_zone');
  if(!detail || !itemsZone){ return; }
  detail.classList.toggle('sampling-detail-empty', !data);
  if(!data){
    detail.innerHTML = '请在左侧选择分类核对员以查看抽样详情。';
    itemsZone.innerHTML = '';
    if(pagerZone){ pagerZone.innerHTML=''; pagerZone.classList.add('hidden'); }
    return;
  }
  const audit = data.audit||{};
  const items = Array.isArray(data.items)?data.items:[];
  const inspectorName = escapeHtml(audit.inspector||'未命名核对员');
  const sampleSize = Number(audit.sample_size)||items.length||0;
  const totalRows = Number(audit.total_rows)||0;
  const progress = Number.isFinite(Number(audit.progress_percent))?Number(audit.progress_percent):((Number(audit.progress)||0)*100);
  const clamped = Math.max(0, Math.min(100, progress||0));
  const progressText = samplingPercentDisplay(clamped);
  const completed = Number(audit.completed)||0;
  const inProgress = Number(audit.in_progress)||0;
  const pending = Number(audit.pending)||0;
  const ratePercent = samplingPercentDisplay((Number(audit.sample_rate)||SAMPLING_DEFAULT_RATE)*100);
  const updated = escapeHtml(audit.updated_at||'—');
  const metricsBlock = renderSamplingMetrics(audit.metrics);
  detail.innerHTML = `<div class="sampling-detail-header">
      <div>
        <h3 class="sampling-detail-title">${inspectorName}</h3>
        <p class="sampling-detail-meta">样本 ${sampleSize} / 总 ${totalRows}（${ratePercent}）</p>
      </div>
      <div class="sampling-detail-progress">
        <div class="sampling-progress"><div class="sampling-progress-bar" style="width:${clamped}%"></div></div>
        <div class="sampling-detail-progress-text">已完成 ${completed} · 进行中 ${inProgress} · 待处理 ${pending}</div>
      </div>
    </div>
    <div class="sampling-detail-updated">最近更新：${updated}</div>
    ${metricsBlock}`;
  if(!items.length){
    itemsZone.innerHTML = '<div class="sampling-empty">暂无抽样样本</div>';
    if(pagerZone){ pagerZone.innerHTML=''; pagerZone.classList.add('hidden'); }
    return;
  }
  const inspectorId = audit.inspector_id||SAMPLING_STATE.activeId||'';
  const pageSize = Math.max(1, Number(SAMPLING_STATE.pageSize)||SAMPLING_PAGE_SIZE);
  const totalItems = items.length;
  const totalPages = Math.max(1, Math.ceil(totalItems/pageSize));
  let currentPage = Number(SAMPLING_STATE.pageByInspector.get(inspectorId))||1;
  if(currentPage>totalPages) currentPage = totalPages;
  if(currentPage<1) currentPage = 1;
  SAMPLING_STATE.pageByInspector.set(inspectorId, currentPage);
  const start = (currentPage-1)*pageSize;
  const pageItems = items.slice(start, start+pageSize);
  itemsZone.innerHTML = pageItems.map(renderSamplingItem).join('');
  renderSamplingPager({ page:currentPage, totalPages, totalItems, pageSize });
}
function renderSamplingItem(item){
  const itemId = item.item_id||'';
  const order = Number(item.sample_order)||0;
  const rowNumber = Number(item.row_number)||0;
  const headerParts = [];
  if(order) headerParts.push(`样本 ${order}`);
  if(rowNumber) headerParts.push(`原始行 ${rowNumber}`);
  const headerMeta = headerParts.join(' · ');
  const title = item.article_title?escapeHtml(item.article_title):'未提供标题';
  const summaryHtml = item.structured_summary?formatMultiline(item.structured_summary):'<span class="sampling-empty-text">暂无结构化总结</span>';
  const abstractHtml = item.abstract?`<details class="sampling-item-abstract"><summary>展开摘要</summary><div>${formatMultiline(item.abstract)}</div></details>`:'';
  const status = item.status||'pending';
  const statusLabel = samplingStatusLabel(status);
  const statusClass = samplingStatusClass(status);
  const aiTopicRaw = item.ai_topic?String(item.ai_topic):'';
  const aiFieldRaw = item.ai_field?String(item.ai_field):'';
  const aiTopic = aiTopicRaw?escapeHtml(aiTopicRaw):'—';
  const aiField = aiFieldRaw?escapeHtml(aiFieldRaw):'—';
  const origTopic = item.orig_topic?escapeHtml(item.orig_topic):'—';
  const origField = item.orig_field?escapeHtml(item.orig_field):'—';
  const topicSelect = renderSamplingSelect(TOPIC_LIST, item.selected_topic||'', itemId, 'topic');
  const fieldSelect = renderSamplingSelect(FIELD_LIST, item.selected_field||'', itemId, 'field');
  const checkedText = item.checked_at?`最近保存：${escapeHtml(item.checked_at)}`:'';
  const canApply = !!(aiTopicRaw||aiFieldRaw);
  return `<article class="sampling-item" data-sampling-item="${escapeAttr(itemId)}">
    <div class="sampling-item-header">
      <div>
        ${headerMeta?`<p class="sampling-item-meta">${headerMeta}</p>`:''}
        <h4 class="sampling-item-title">${title}</h4>
      </div>
      <span class="sampling-item-status ${statusClass}">${statusLabel}</span>
    </div>
    <div class="sampling-item-body">
      <div class="sampling-item-summary">${summaryHtml}${abstractHtml}</div>
      <div class="sampling-item-controls">
        <div class="sampling-field-group">
          <label class="sampling-field-label">议题判定</label>
          <select class="sampling-select" data-kind="topic" data-item-id="${escapeAttr(itemId)}">${topicSelect}</select>
        </div>
        <div class="sampling-field-group">
          <label class="sampling-field-label">领域判定</label>
          <select class="sampling-select" data-kind="field" data-item-id="${escapeAttr(itemId)}">${fieldSelect}</select>
        </div>
        <div class="sampling-tip-group">
          <div id="ai-${escapeAttr(itemId)}" class="sampling-ai-hint">
            <p>AI 议题：${aiTopic}</p>
            <p>AI 领域：${aiField}</p>
            <p class="sampling-ai-sub">原始议题：${origTopic}</p>
            <p class="sampling-ai-sub">原始领域：${origField}</p>
          </div>
          <button type="button" class="btn btn-sm btn-ghost sampling-apply-btn" data-item-id="${escapeAttr(itemId)}" data-ai-topic="${escapeAttr(aiTopicRaw)}" data-ai-field="${escapeAttr(aiFieldRaw)}" title="将选择更新为 AI 分类"${canApply?'':' disabled'}>采用 AI 分类</button>
        </div>
      </div>
    </div>
    <div class="sampling-item-footer">
      <span class="sampling-status-message" data-role="status">${checkedText}</span>
    </div>
  </article>`;
}
function renderSamplingPager(meta){
  const pagerZone = qs('sampling_pager_zone');
  if(!pagerZone) return;
  if(!meta || meta.totalPages<=1){
    pagerZone.innerHTML='';
    pagerZone.classList.add('hidden');
    return;
  }
  const { page, totalPages, totalItems, pageSize } = meta;
  const start = (page-1)*pageSize+1;
  const end = Math.min(totalItems, page*pageSize);
  const prevPage = Math.max(1, page-1);
  const nextPage = Math.min(totalPages, page+1);
  pagerZone.classList.remove('hidden');
  pagerZone.innerHTML = `
    <div class="sampling-pager-meta">第 ${page} / ${totalPages} 页 · 显示 ${start}-${end} / ${totalItems}</div>
    <div class="sampling-pager-buttons">
      <button type="button" class="sampling-pager-btn" data-page="1" ${page<=1?'disabled':''}>首页</button>
      <button type="button" class="sampling-pager-btn" data-page="${prevPage}" ${page<=1?'disabled':''}>上一页</button>
      <button type="button" class="sampling-pager-btn" data-page="${nextPage}" ${page>=totalPages?'disabled':''}>下一页</button>
      <button type="button" class="sampling-pager-btn" data-page="${totalPages}" ${page>=totalPages?'disabled':''}>末页</button>
    </div>`;
}

function setSamplingPage(inspectorId, page){
  if(!inspectorId) return;
  const numericPage = Number(page);
  if(!Number.isFinite(numericPage)) return;
  const dataset = SAMPLING_STATE.data.get(inspectorId);
  if(!dataset){ return; }
  const items = Array.isArray(dataset.items)?dataset.items:[];
  const pageSize = Math.max(1, Number(SAMPLING_STATE.pageSize)||SAMPLING_PAGE_SIZE);
  const totalPages = Math.max(1, Math.ceil(items.length/pageSize));
  const safePage = Math.max(1, Math.min(totalPages, Math.round(numericPage)));
  SAMPLING_STATE.pageByInspector.set(inspectorId, safePage);
  renderSamplingDetail(dataset);
}

function renderSamplingSelect(list, value, itemId, kind){
  const options=['<option value="">请选择</option>'];
  if(Array.isArray(list)){
    list.forEach(name=>{
      const selected = name===value?' selected':'';
      options.push(`<option value="${escapeAttr(name)}"${selected}>${escapeHtml(name)}</option>`);
    });
  }
  return options.join('');
}
function updateSamplingSummaryList(summary){
  if(!summary || !summary.inspector_id) return;
  const idx = SAMPLING_STATE.list.findIndex(item=>item.inspector_id===summary.inspector_id);
  if(idx>=0){
    SAMPLING_STATE.list[idx] = { ...SAMPLING_STATE.list[idx], ...summary };
  }else{
    SAMPLING_STATE.list.push(summary);
  }
  renderSamplingList();
}
async function loadSamplingList(){
  if(!SESSION_ID){
    resetSamplingState();
    return;
  }
  SAMPLING_STATE.loading = true;
  renderSamplingList();
  try{
    const resp = await fetch(`/sampling/list?session_id=${encodeURIComponent(SESSION_ID)}`, {cache:'no-store'});
    if(!resp.ok){
      throw new Error(await resp.text()||resp.statusText||'加载失败');
    }
    const data = await resp.json();
    SAMPLING_STATE.list = Array.isArray(data.audits)?data.audits:[];
  }catch(e){
    const wrap = qs('sampling_list_zone');
    if(wrap){
      wrap.innerHTML = `<div class="sampling-empty">加载失败：${escapeHtml(e.message||'未知错误')}</div>`;
    }
    SAMPLING_STATE.list = [];
  }finally{
    SAMPLING_STATE.loading = false;
  }
  renderSamplingList();
  if(!SAMPLING_STATE.list.some(item=>item.inspector_id===SAMPLING_STATE.activeId)){
    SAMPLING_STATE.activeId='';
  }
  if(SAMPLING_STATE.activeId){
    const cached = SAMPLING_STATE.data.get(SAMPLING_STATE.activeId);
    if(cached){
      renderSamplingDetail(cached);
    }else{
      openSamplingAudit(SAMPLING_STATE.activeId, {force:true});
    }
  }else if(SAMPLING_STATE.list.length){
    openSamplingAudit(SAMPLING_STATE.list[0].inspector_id);
  }else{
    renderSamplingDetail();
  }
}
async function openSamplingAudit(inspectorId, options={}){
  if(!SESSION_ID || !inspectorId) return;
  const force = options.force===true;
  SAMPLING_STATE.activeId = inspectorId;
  if(force || !SAMPLING_STATE.data.has(inspectorId)){
    SAMPLING_STATE.pageByInspector.set(inspectorId, 1);
  }
  renderSamplingList();
  if(!force && SAMPLING_STATE.data.has(inspectorId)){
    renderSamplingDetail(SAMPLING_STATE.data.get(inspectorId));
    return;
  }
  const detail = qs('sampling_detail_zone');
  const itemsZone = qs('sampling_items_zone');
  if(detail){
    detail.classList.remove('sampling-detail-empty');
    detail.innerHTML = '<div class="sampling-detail-loading">正在加载样本…</div>';
  }
  if(itemsZone){ itemsZone.innerHTML = ''; }
  try{
    const resp = await fetch(`/sampling/data?session_id=${encodeURIComponent(SESSION_ID)}&inspector_id=${encodeURIComponent(inspectorId)}`, {cache:'no-store'});
    if(!resp.ok){
      const msg = await resp.text();
      if(detail){ detail.innerHTML = `<div class="sampling-detail-error">加载失败：${escapeHtml(msg||resp.statusText||'未知错误')}</div>`; }
      return;
    }
    const data = await resp.json();
    const structured = { audit:data.audit||{}, items:Array.isArray(data.items)?data.items:[] };
    SAMPLING_STATE.data.set(inspectorId, structured);
    renderSamplingDetail(structured);
  }catch(e){
    if(detail){ detail.innerHTML = `<div class="sampling-detail-error">加载失败：${escapeHtml(e.message||'未知错误')}</div>`; }
  }
}
async function createSamplingAudit(){
  if(!SESSION_ID){
    showToast('请先上传或载入会话', 'warning');
    return;
  }
  const inspectorInput = qs('sampling_inspector_input');
  const rateInput = qs('sampling_rate_input');
  const forceToggle = qs('sampling_force_toggle');
  const hint = qs('sampling_create_hint');
  const btn = qs('btn_sampling_generate');
  const inspector = inspectorInput?.value.trim();
  if(!inspector){
    showToast('请填写分类核对员姓名', 'warning');
    inspectorInput?.focus();
    return;
  }
  let rateValue = Number(rateInput?.value);
  if(!Number.isFinite(rateValue) || rateValue<=0){
    rateValue = (SAMPLING_DEFAULT_RATE||0.03)*100;
  }
  const rateDecimal = Math.max(0.001, Math.min(1, rateValue/100));
  if(btn){ btn.disabled=true; btn.textContent='生成中…'; }
  if(hint){ hint.textContent=''; }
  try{
    const resp = await fetch('/sampling/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:SESSION_ID, inspector, sample_rate:rateDecimal, force:!!forceToggle?.checked})});
    if(!resp.ok){
      const msg = await resp.text();
      throw new Error(msg||resp.statusText||'生成失败');
    }
    const data = await resp.json();
    const status = data.status||'created';
    const audit = data.audit||{};
    if(hint){ hint.textContent = status==='created'?'抽样样本已生成。':'该核对员已存在抽样任务，已加载历史样本。'; }
    await loadSamplingList();
    if(audit.inspector_id){
      openSamplingAudit(audit.inspector_id, {force:true});
    }
    showToast(status==='created'?'抽样样本已生成':'已加载现有抽样任务', status==='created'?'success':'info');
  }catch(e){
    if(hint){ hint.textContent = `生成失败：${e.message}`; }
    showToast(`生成抽样失败：${e.message||e}`, 'error');
  }finally{
    if(btn){ btn.disabled=false; btn.textContent='生成抽样样本'; }
  }
}
async function saveSamplingSelection(itemId){
  if(!SESSION_ID || !SAMPLING_STATE.activeId) return;
  const itemEl = document.querySelector(`[data-sampling-item="${CSS.escape(itemId)}"]`);
  if(!itemEl) return;
  const topicValue = itemEl.querySelector('select[data-kind="topic"]')?.value||'';
  const fieldValue = itemEl.querySelector('select[data-kind="field"]')?.value||'';
  const statusEl = itemEl.querySelector('[data-role="status"]');
  if(statusEl){ statusEl.textContent='保存中…'; statusEl.dataset.state='saving'; }
  try{
    const resp = await fetch('/sampling/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:SESSION_ID, inspector_id:SAMPLING_STATE.activeId, item_id:itemId, topic_choice:topicValue, field_choice:fieldValue})});
    if(!resp.ok){
      const msg = await resp.text();
      throw new Error(msg||resp.statusText||'保存失败');
    }
    const data = await resp.json();
    if(data.summary){ updateSamplingSummaryList(data.summary); }
    if(data.item){
      const dataset = SAMPLING_STATE.data.get(SAMPLING_STATE.activeId);
      if(dataset){
        const idx = dataset.items.findIndex(it=>it.item_id===data.item.item_id);
        if(idx>=0){ dataset.items[idx]=data.item; }
        if(data.summary){ dataset.audit=data.summary; }
        SAMPLING_STATE.data.set(SAMPLING_STATE.activeId, dataset);
        renderSamplingDetail(dataset);
      }
      if(statusEl){
        statusEl.textContent = data.item.checked_at?`最近保存：${escapeHtml(data.item.checked_at)}`:'已清空选择';
        statusEl.dataset.state = data.item.checked_at?'saved':'empty';
      }
    }
  }catch(e){
    if(statusEl){ statusEl.textContent = `保存失败：${e.message||e}`; statusEl.dataset.state='error'; }
    showToast(`抽样保存失败：${e.message||e}`, 'error');
  }
}

function collectBlacklistSelections(){
  const topicSet=new Set();
  document.querySelectorAll('#topic_blacklist_options input[data-kind="topic"]:checked').forEach(el=>{
    const v=(el.value||"").trim(); if(v){ topicSet.add(v); }
  });
  const fieldSet=new Set();
  document.querySelectorAll('#field_blacklist_options input[data-kind="field"]:checked').forEach(el=>{
    const v=(el.value||"").trim(); if(v){ fieldSet.add(v); }
  });
  TOPIC_BLACKLIST=[...topicSet];
  FIELD_BLACKLIST=[...fieldSet];
  return { topic:[...topicSet], field:[...fieldSet] };
}
function loadCfgFromLocal(){
  const raw=localStorage.getItem("llm_cfg"); if(!raw){ setBlacklistSelections([], []); return; }
  try{
    const c=JSON.parse(raw);
    qs('cfg_base_url').value=c.base_url||"";
    qs('cfg_api_key').value=c.api_key||"";
    qs('cfg_model').value=c.model||"";
    qs('cfg_temp').value=c.temp??0.2;
    setBlacklistSelections(c.topic_blacklist, c.field_blacklist);
  }catch(e){
    setBlacklistSelections([], []);
  }
}
function saveCfgToLocal(){
  const { topic:topicBlacklist, field:fieldBlacklist } = collectBlacklistSelections();
  const c={
    base_url:qs('cfg_base_url').value.trim(),
    api_key:qs('cfg_api_key').value.trim(),
    model:qs('cfg_model').value.trim(),
    temp:parseFloat(qs('cfg_temp').value||"0.2"),
    topic_blacklist:topicBlacklist,
    field_blacklist:fieldBlacklist
  };
  localStorage.setItem("llm_cfg", JSON.stringify(c));
  qs('cfg_msg').innerText="已保存到浏览器";
}
async function saveEnvToServer(){
  const c={ base_url:qs('cfg_base_url').value.trim(), api_key:qs('cfg_api_key').value.trim(), model:qs('cfg_model').value.trim(), temp:parseFloat(qs('cfg_temp').value||"0.2") };
  const r=await fetch("/save_env",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}); if(!r.ok){ alert("写入 .env 失败："+await r.text()); return; }
  qs('cfg_msg').innerText="已写入 .env（OPENAI_BASE_URL / OPENAI_API_KEY / OPENAI_MODEL）";
}

/* ===================== 上传 ===================== */
function uploadFile(){
  const fi=qs('file_input'), btn=qs('btn_upload'), bar=qs('up_bar'), msg=qs('up_msg');
  if(!fi.files?.length){ alert("请选择文件"); return; }
  btn.disabled=true; btn.textContent="上传中..."; bar.style.width="0%"; msg.textContent="0%";
  const form=new FormData(); form.append("file", fi.files[0]);
  const xhr=new XMLHttpRequest(); xhr.open("POST","/upload");
  xhr.upload.onprogress=e=>{ if(e.lengthComputable){ const p=Math.round(e.loaded*100/e.total); bar.style.width=p+"%"; msg.textContent=p+"%"; } };
  xhr.onreadystatechange=async ()=>{ if(xhr.readyState===4){ btn.disabled=false; btn.textContent="上传并新建会话";
      if(xhr.status>=200&&xhr.status<300){ const d=JSON.parse(xhr.responseText);
        SESSION_ID=d.session_id; setBadge(); enterWorkspace(); qs('total_msg').textContent=`共 ${d.total} 行`; msg.textContent="加载成功";
        PAGER.page=1; PAGER.size=parseInt(qs('ps_input').value||"50")||50;
        LAST_EXPORT_URL=""; // 新会话清空
        refreshHomeActions();
        clearScatterPlot('等待计算后展示。');
        resetTopicVizState();
        resetSamplingState();
        await refreshSessionMeta();
        await refreshStats();
        populateFilterOptions();
        CURRENT_SEARCH={scope:SEARCH_SCOPE_DEFAULT, keyword:""};
        syncSearchControls();
        CURRENT_FILTER={target:"",value:""};
        CURRENT_SORT={by:"",order:""};
        setSortAvailability(false);
        syncSortSelect();
        await loadPage();
        await loadSamplingList();
    }else{ msg.textContent="上传失败："+xhr.responseText; alert("上传失败："+xhr.responseText); } } };
  xhr.send(form);
}

/* ===================== 统计/图表/筛选 ===================== */
function renderChips(elId,primaryRaw,targetKey,options={}){
  const el=qs(elId);
  if(!el) return;
  el.innerHTML="";
  const { entries, primaryMap, overlayMap } = buildBarChartEntries(primaryRaw, options.overlay);
  if(!entries.length){
    return;
  }
  const primaryPrefix=options.primaryLabel?`${options.primaryLabel}：`:'';
  const overlayPrefix=options.overlayLabel?`${options.overlayLabel}：`:'';
  entries.forEach(entry=>{
    const label=entry.label;
    const primaryItem=primaryMap.get(label);
    const overlayItem=overlayMap.get(label);
    const btn=document.createElement('button');
    btn.className='chip text-sm';
    const kind=targetKey.startsWith('field')?'field':'topic';
    const displayLabel=resolveDisplayText(label, entry.display_label, kind);
    const primaryParts=[`${primaryPrefix}${safeNumber(primaryItem?.count??0)}`];
    const primaryPercent=formatPercentText(primaryItem?.percent);
    if(primaryPercent) primaryParts.push(primaryPercent);
    const displayParts=[primaryParts.join(' | ')];
    if(overlayItem){
      const overlayParts=[`${overlayPrefix}${safeNumber(overlayItem.count??0)}`];
      const overlayPercent=formatPercentText(overlayItem.percent);
      if(overlayPercent) overlayParts.push(overlayPercent);
      if(overlayPrefix || safeNumber(overlayItem.count??0)!==0 || overlayPercent){
        displayParts.push(overlayParts.join(' | '));
      }
    }
    btn.textContent=`${displayLabel}（${displayParts.join(' · ')}）`;
    btn.onclick=()=>quickFilter(targetKey,label);
    el.appendChild(btn);
  });
}
function destroyTreemap(key){
  const el=TREEMAP_PLOTS[key];
  if(el && window.Plotly){
    try{ Plotly.purge(el); }catch(e){}
  }
  delete TREEMAP_PLOTS[key];
}
function cloneTreemapOptions(options){
  if(!options) return {};
  const cloned={...options};
  if(Array.isArray(options.overlay)){
    cloned.overlay=options.overlay.map(item=>({ ...(item||{}) }));
  }
  return cloned;
}
function cloneStatList(raw){
  if(!Array.isArray(raw)) return [];
  return raw.map(item=>{
    if(item && typeof item==='object'){
      return { ...item };
    }
    return {};
  });
}
function isChartHidden(el){
  if(!el) return true;
  if(typeof el.checkVisibility==='function'){
    try{
      return !el.checkVisibility({visibilityProperty:true, displayProperty:true, opacityProperty:true, contentVisibilityAuto:true});
    }catch(e){}
  }
  if(el.getClientRects().length===0) return true;
  let node=el;
  while(node && node!==document.body){
    const style=window.getComputedStyle(node);
    if(style.display==='none' || style.visibility==='hidden') return true;
    node=node.parentElement;
  }
  return false;
}
function renderTreemap(containerId,primaryRaw,key,options={},internal=false){
  const container=qs(containerId);
  if(!container){
    destroyTreemap(key);
    delete TREEMAP_STATE[key];
    return;
  }
  const optionClone=cloneTreemapOptions(options);
  const configEntry=Object.values(CATEGORY_CHART_CONFIG).find(cfg=>cfg.treemapKey===key) || null;
  const primaryClone=cloneStatList(primaryRaw);
  if(!internal){
    TREEMAP_STATE[key]={containerId, primaryRaw:primaryClone, options:optionClone};
    if(isChartHidden(container)){
      container.dataset.treemapDeferred='1';
      container.innerHTML='<div class="treemap-empty">切换标签以查看图表</div>';
      destroyTreemap(key);
      return;
    }
  }else if(isChartHidden(container)){
    return;
  }
  if(container.dataset.treemapDeferred){
    delete container.dataset.treemapDeferred;
  }
  if(!window.Plotly){
    destroyTreemap(key);
    container.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    return;
  }
  container.innerHTML='';
  const { entries } = buildBarChartEntries(primaryClone, optionClone.overlay);
  const limit = Number.isFinite(optionClone.limit)&&optionClone.limit>0?Math.floor(optionClone.limit):TREEMAP_CATEGORY_LIMIT;
  let limitedEntries = limitBarEntries(entries, limit);
  const picked=new Set(limitedEntries.map(entry=>entry.label));
  let otherPrimary=0;
  let otherOverlay=0;
  entries.forEach(entry=>{
    if(!picked.has(entry.label)){
      otherPrimary+=safeNumber(entry.primary);
      otherOverlay+=safeNumber(entry.overlay);
    }
  });
  if(otherPrimary>0){
    limitedEntries=[...limitedEntries,{label:'其他',display_label:'Other',primary:otherPrimary,overlay:otherOverlay,isOther:true,order:entries.length+1}];
  }
  if(!limitedEntries.length){
    destroyTreemap(key);
    container.innerHTML='<div class="treemap-empty">暂无数据</div>';
    return;
  }
  const hasOverlay=Array.isArray(optionClone.overlay)&&optionClone.overlay.length>0;
  const primaryList=normalizeStatItems(primaryClone);
  const overlayList=normalizeStatItems(optionClone.overlay);
  const primaryMap=new Map(primaryList.map(item=>[item.label,item]));
  const overlayMap=new Map(overlayList.map(item=>[item.label,item]));
  const primaryTotal=primaryList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const overlayTotal=overlayList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const displayedTotal=limitedEntries.reduce((sum,entry)=>sum+safeNumber(entry.primary),0);
  if(displayedTotal<=0){
    destroyTreemap(key);
    container.innerHTML='<div class="treemap-empty">暂无数据</div>';
    return;
  }
  const rootLabel=optionClone.rootLabel||optionClone.primaryLabel||'分类';
  const inferredKind=optionClone.kind || configEntry?.kind || (String(key||'').includes('field')?'field':'topic');
  const labels=[rootLabel];
  const ids=['root'];
  const parents=[''];
  const values=[displayedTotal];
  const text=[''];
  const hovers=[''];
  limitedEntries.forEach((entry,idx)=>{
    const label=entry.label;
    const displayLabel=resolveDisplayText(label, entry.display_label, inferredKind);
    const primaryValue=safeNumber(entry.primary);
    const overlayValue=safeNumber(entry.overlay);
    const primaryPercentRaw=primaryMap.get(label)?.percent;
    let primaryPercent=formatPercentText(primaryPercentRaw);
    if(!primaryPercent && primaryTotal>0 && primaryValue>0){
      primaryPercent=`${((primaryValue/primaryTotal)*100).toFixed(2)}%`;
    }
    const overlayPercentRaw=overlayMap.get(label)?.percent;
    let overlayPercent=formatPercentText(overlayPercentRaw);
    if(!overlayPercent && overlayTotal>0 && overlayValue>0){
      overlayPercent=`${((overlayValue/overlayTotal)*100).toFixed(2)}%`;
    }
    labels.push(displayLabel);
    ids.push(label);
    parents.push(rootLabel);
    values.push(primaryValue);
    const displayParts=[String(primaryValue)];
    if(primaryPercent) displayParts.push(primaryPercent);
    text.push(`${escapeHtml(displayLabel)}<br>${displayParts.join(' · ')}`);
    const hoverLines=[`<b>${escapeHtml(displayLabel)}</b>`, `${optionClone.primaryLabel||'数量'}：${primaryValue}${primaryPercent?`（${primaryPercent}）`:''}`];
    if(hasOverlay && (overlayValue>0 || overlayPercent)){
      hoverLines.push(`${optionClone.overlayLabel||'对比'}：${overlayValue}${overlayPercent?`（${overlayPercent}）`:''}`);
    }
    hovers.push(hoverLines.join('<br>'));
  });
  const colors=['rgba(148,163,184,0.18)'];
  limitedEntries.forEach((entry,idx)=>{
    const baseColor=entry.isOther?'rgba(148,163,184,0.35)':TREEMAP_COLORS[idx % TREEMAP_COLORS.length];
    colors.push(baseColor);
  });
  const trace={
    type:'treemap',
    labels,
    ids,
    parents,
    values,
    branchvalues:'total',
    text,
    textinfo:'text',
    textfont:{size:12,color:'#0f172a',family:'"Inter","Noto Sans SC","PingFang SC","Microsoft YaHei",sans-serif'},
    hoverinfo:'text',
    hovertext:hovers,
    marker:{colors,line:{color:'rgba(255,255,255,0.85)',width:1}},
    root:{color:'rgba(148,163,184,0.18)'}
  };
  const layout={
    margin:{l:4,r:4,t:4,b:4},
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    uniformtext:{minsize:12,mode:'hide'}
  };
  const width=container.clientWidth||container.offsetWidth||0;
  const widthHeight=width?Math.round(width*0.55):0;
  const countHeight=260+Math.max(0, Math.min(limitedEntries.length, limit)-6)*12;
  let desiredHeight=Math.max(widthHeight, countHeight, 260);
  desiredHeight=Math.min(desiredHeight, 520);
  if(!Number.isFinite(desiredHeight) || desiredHeight<=0){
    desiredHeight=320;
  }
  layout.height=desiredHeight;
  container.style.minHeight=`${desiredHeight}px`;
  container.style.height=`${desiredHeight}px`;
  TREEMAP_PLOTS[key]=container;
  const config={displayModeBar:false,responsive:true};
  try{
    const plotPromise=Plotly.react(container,[trace],layout,config);
    const onError=err=>{
      console.error('Treemap 渲染失败',err);
      container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
      destroyTreemap(key);
    };
    if(plotPromise && typeof plotPromise.then==='function'){
      plotPromise.then(()=>{
        if(window.Plotly){
          try{ Plotly.Plots.resize(container); }catch(e){}
        }
      }).catch(onError);
    }else if(window.Plotly){
      try{ Plotly.Plots.resize(container); }catch(e){}
    }
  }catch(err){
    console.error('Treemap 渲染失败',err);
    container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
    destroyTreemap(key);
  }
}
function renderDeferredTreemaps(){
  Object.entries(TREEMAP_STATE).forEach(([key,state])=>{
    const container=qs(state.containerId);
    if(!container) return;
    if(isChartHidden(container)) return;
    if(TREEMAP_PLOTS[key]===container){
      if(window.Plotly){
        try{ Plotly.Plots.resize(container); }catch(e){}
      }
      return;
    }
    renderTreemap(state.containerId, state.primaryRaw, key, state.options, true);
  });
}

function destroyBarChart(key){
  const el=BAR_CHART_PLOTS[key];
  if(el && window.Plotly){
    try{ Plotly.purge(el); }catch(e){}
  }
  delete BAR_CHART_PLOTS[key];
}
function renderBarChart(containerId,primaryRaw,key,options={},internal=false){
  const container=qs(containerId);
  if(!container){
    destroyBarChart(key);
    delete BAR_CHART_STATE[key];
    return;
  }
  const optionClone=cloneTreemapOptions(options);
  const configEntry=Object.values(CATEGORY_CHART_CONFIG).find(cfg=>cfg.barKey===key) || null;
  const primaryClone=cloneStatList(primaryRaw);
  if(!internal){
    BAR_CHART_STATE[key]={containerId, primaryRaw:primaryClone, options:optionClone};
    if(isChartHidden(container)){
      container.dataset.barDeferred='1';
      container.innerHTML='<div class="treemap-empty">切换标签以查看图表</div>';
      destroyBarChart(key);
      return;
    }
  }else if(isChartHidden(container)){
    return;
  }
  if(container.dataset.barDeferred){
    delete container.dataset.barDeferred;
  }
  if(!window.Plotly){
    destroyBarChart(key);
    container.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    return;
  }
  const { entries, primaryMap, overlayMap } = buildBarChartEntries(primaryClone, optionClone.overlay);
  const limit=Number.isFinite(optionClone.limit)&&optionClone.limit>0?Math.floor(optionClone.limit):TREEMAP_CATEGORY_LIMIT;
  let limitedEntries=limitBarEntries(entries, limit);
  const picked=new Set(limitedEntries.map(entry=>entry.label));
  let otherPrimary=0;
  let otherOverlay=0;
  entries.forEach(entry=>{
    if(!picked.has(entry.label)){
      otherPrimary+=safeNumber(entry.primary);
      otherOverlay+=safeNumber(entry.overlay);
    }
  });
  if(otherPrimary>0){
    limitedEntries=[...limitedEntries,{label:'其他',display_label:'Other',primary:otherPrimary,overlay:otherOverlay,isOther:true,order:entries.length+1}];
  }
  if(!limitedEntries.length){
    destroyBarChart(key);
    container.innerHTML='<div class="treemap-empty">暂无数据</div>';
    return;
  }
  const hasOverlay=Array.isArray(optionClone.overlay)&&optionClone.overlay.length>0;
  const primaryList=normalizeStatItems(primaryClone);
  const overlayList=normalizeStatItems(optionClone.overlay);
  const primaryTotal=primaryList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const overlayTotal=overlayList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const sortedEntries=[...limitedEntries].sort((a,b)=>{
    if(a.isOther && !b.isOther) return 1;
    if(!a.isOther && b.isOther) return -1;
    const diff=safeNumber(b.primary)-safeNumber(a.primary);
    if(Math.abs(diff)>0.0001) return diff;
    return a.order-b.order;
  });
  const inferredKind=optionClone.kind || configEntry?.kind || (String(key||'').includes('field')?'field':'topic');
  const rawLabels=sortedEntries.map(entry=>entry.label);
  const displayLabels=sortedEntries.map(entry=>resolveDisplayText(entry.label, entry.display_label, inferredKind));
  const yLabels=displayLabels;
  const primaryValues=sortedEntries.map(entry=>safeNumber(entry.primary));
  const overlayValues=sortedEntries.map(entry=>safeNumber(entry.overlay));
  const colors=sortedEntries.map((entry,idx)=>entry.isOther?'rgba(148,163,184,0.45)':TREEMAP_COLORS[idx%TREEMAP_COLORS.length]);
  const primaryPercents=sortedEntries.map((entry,idx)=>{
    const label=rawLabels[idx];
    const value=safeNumber(entry.primary);
    const primaryPercentRaw=primaryMap.get(label)?.percent;
    let percent=formatPercentText(primaryPercentRaw);
    if(!percent && primaryTotal>0 && value>0){
      percent=`${((value/primaryTotal)*100).toFixed(2)}%`;
    }
    return percent;
  });
  const overlayPercents=sortedEntries.map((entry,idx)=>{
    const label=rawLabels[idx];
    const value=safeNumber(entry.overlay);
    const overlayPercentRaw=overlayMap.get(label)?.percent;
    let percent=formatPercentText(overlayPercentRaw);
    if(!percent && overlayTotal>0 && value>0){
      percent=`${((value/overlayTotal)*100).toFixed(2)}%`;
    }
    return percent;
  });
  const hoverTexts=sortedEntries.map((entry,idx)=>{
    const label=rawLabels[idx];
    const displayLabel=displayLabels[idx];
    const primaryValue=primaryValues[idx];
    const overlayValue=overlayValues[idx];
    const lines=[`<b>${escapeHtml(displayLabel)}</b>`, `${optionClone.primaryLabel||'数量'}：${primaryValue}${primaryPercents[idx]?`（${primaryPercents[idx]}）`:''}`];
    if(hasOverlay && (overlayValue>0 || overlayPercents[idx])){
      lines.push(`${optionClone.overlayLabel||'对比'}：${overlayValue}${overlayPercents[idx]?`（${overlayPercents[idx]}）`:''}`);
    }
    return lines.join('<br>');
  });
  container.innerHTML='';
  const width=container.clientWidth||container.offsetWidth||0;
  const widthHeight=width?Math.round(width*0.55):0;
  const barHeight=sortedEntries.length?sortedEntries.length*56+120:260;
  let desiredHeight=Math.max(widthHeight, barHeight, 240);
  desiredHeight=Math.min(desiredHeight, 720);
  if(!Number.isFinite(desiredHeight) || desiredHeight<=0){ desiredHeight=320; }
  container.style.minHeight=`${desiredHeight}px`;
  container.style.height=`${desiredHeight}px`;
  BAR_CHART_PLOTS[key]=container;
  const primaryTrace={
    type:'bar',
    orientation:'h',
    name:optionClone.primaryLabel||'数量',
    y:yLabels,
    x:primaryValues,
    marker:{color:colors},
    text:primaryValues.map(v=>numberFormatter.format(v)),
    textposition:'auto',
    textfont:{size:12,color:'#0f172a'},
    cliponaxis:false,
    hovertext:hoverTexts,
    hovertemplate:'%{hovertext}<extra></extra>'
  };
  const traces=[primaryTrace];
  if(hasOverlay){
    const overlayHover=sortedEntries.map((entry,idx)=>{
      const displayLabel=displayLabels[idx];
      const overlayValue=overlayValues[idx];
      const lines=[`<b>${escapeHtml(displayLabel)}</b>`, `${optionClone.overlayLabel||'对比'}：${overlayValue}${overlayPercents[idx]?`（${overlayPercents[idx]}）`:''}`];
      if(primaryValues[idx]>0 || primaryPercents[idx]){
        lines.push(`${optionClone.primaryLabel||'数量'}：${primaryValues[idx]}${primaryPercents[idx]?`（${primaryPercents[idx]}）`:''}`);
      }
      return lines.join('<br>');
    });
    traces.push({
      type:'bar',
      orientation:'h',
      name:optionClone.overlayLabel||'对比',
      y:yLabels,
      x:overlayValues,
      marker:{color:'rgba(148,163,184,0.55)'},
      opacity:0.75,
      hovertext:overlayHover,
      hovertemplate:'%{hovertext}<extra></extra>',
      cliponaxis:false
    });
  }
  const longestLabelLength=yLabels.reduce((max,label)=>Math.max(max,String(label).length),0);
  const leftMargin=Math.min(260, Math.max(120, Math.round(longestLabelLength*12)));
  const layout={
    margin:{l:leftMargin,r:36,t:24,b:36},
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    barmode:hasOverlay?'group':'relative',
    bargap:hasOverlay?0.28:0.35,
    height:desiredHeight,
    yaxis:{autorange:'reversed', tickfont:{size:12,color:'#334155'}, ticklen:0},
    xaxis:{tickfont:{size:12,color:'#334155'}, gridcolor:'rgba(148,163,184,0.25)', zeroline:false}
  };
  if(hasOverlay){
    layout.legend={orientation:'h',x:0,y:1.12,yanchor:'bottom',font:{size:12,color:'#334155'}};
  }
  const config={displayModeBar:false,responsive:true};
  try{
    const plotPromise=Plotly.react(container,traces,layout,config);
    const onError=err=>{
      console.error('Bar 渲染失败',err);
      container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
      destroyBarChart(key);
    };
    if(plotPromise && typeof plotPromise.then==='function'){
      plotPromise.then(()=>{
        if(window.Plotly){
          try{ Plotly.Plots.resize(container); }catch(e){}
        }
      }).catch(onError);
    }else if(window.Plotly){
      try{ Plotly.Plots.resize(container); }catch(e){}
    }
  }catch(err){
    console.error('Bar 渲染失败',err);
    container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
    destroyBarChart(key);
  }
}
function renderDeferredBarCharts(){
  Object.entries(BAR_CHART_STATE).forEach(([key,state])=>{
    const container=qs(state.containerId);
    if(!container) return;
    if(isChartHidden(container)) return;
    if(BAR_CHART_PLOTS[key]===container){
      if(window.Plotly){
        try{ Plotly.Plots.resize(container); }catch(e){}
      }
      return;
    }
    renderBarChart(state.containerId, state.primaryRaw, key, state.options, true);
  });
}

function setJournalSourceAvailability(available){
  JOURNAL_SOURCE_AVAILABLE=!!available;
  const hint=qs('journal_hint');
  if(!hint) return;
  if(!SESSION_ID){
    hint.textContent='Top 5 按篇数排序，括号内为分类内占比。';
    hint.classList.remove('hidden');
    return;
  }
  if(!JOURNAL_SOURCE_AVAILABLE){
    hint.textContent='数据集中缺少 Source Title 列，无法统计期刊分布。';
    hint.classList.remove('hidden');
  }else{
    hint.textContent='Top 5 按篇数排序，括号内为分类内占比。';
    hint.classList.remove('hidden');
  }
}

function normalizeJournalData(rawList, kind='topic'){
  if(!Array.isArray(rawList)) return [];
  return rawList.map((entry, idx)=>{
    const categoryRaw=entry?.category;
    const category=String(categoryRaw??`分类 ${idx+1}`).trim()||`分类 ${idx+1}`;
    const displayLabel=resolveDisplayText(category, entry?.category_display??entry?.categoryDisplay, kind);
    const total=safeNumber(entry?.total);
    const uniqueRaw = entry?.unique_sources ?? entry?.uniqueSources ?? entry?.unique;
    const unique=Math.max(0, safeNumber(uniqueRaw));
    const itemsRaw=Array.isArray(entry?.items)?entry.items:[];
    const items=itemsRaw.map((item, j)=>{
      const label=String(item?.label??`期刊 ${j+1}`).trim()||`期刊 ${j+1}`;
      const count=safeNumber(item?.count);
      if(count<=0) return null;
      const percentValue=parsePercentValue(item?.percent);
      const percent=percentValue!==null?percentValue:(total>0?(count/total*100):0);
      return { label, count, percent };
    }).filter(Boolean);
    if(!items.length) return null;
    return { category, category_display:displayLabel, total, unique, items };
  }).filter(Boolean);
}

function setJournalData(dim, rawList){
  const key = dim==='field' ? 'field' : 'topic';
  JOURNAL_DATA[key]=normalizeJournalData(rawList, key);
}

function clearJournalChartsForDim(dim){
  Array.from(JOURNAL_CHARTS.entries()).forEach(([key,el])=>{
    if(!key.startsWith(`${dim}:`)) return;
    if(el && window.Plotly){
      try{ Plotly.purge(el); }catch(e){}
    }
    JOURNAL_CHARTS.delete(key);
  });
}

function renderJournalChart(dim, index, entry){
  const chartId=`journal_chart_${dim}_${index}`;
  const container=qs(chartId);
  if(!container) return;
  const key=`${dim}:${index}`;
  if(!window.Plotly){
    container.innerHTML='<div class="journal-chart-empty">Plotly 未加载</div>';
    JOURNAL_CHARTS.delete(key);
    return;
  }
  if(isChartHidden(container)){
    container.dataset.journalDeferred='1';
    container.innerHTML='<div class="journal-chart-empty">切换标签以查看图表</div>';
    JOURNAL_CHARTS.delete(key);
    return;
  }

  const labels=entry.items.map(item=>item.label);
  const counts=entry.items.map(item=>safeNumber(item.count));
  const percents=entry.items.map(item=>Number.isFinite(item.percent)?Number(item.percent):0);
  const texts=counts.map((val,idx)=>{
    const percent=percents[idx];
    const percentText=Number.isFinite(percent) && percent>0 ? `${percent.toFixed(1)}%` : '';
    const valueText=numberFormatter.format(val);
    return percentText?`${valueText}（${percentText}）`:valueText;
  });
  const hoverTexts=labels.map((label,idx)=>{
    const countText=numberFormatter.format(counts[idx]);
    const percent=percents[idx];
    const percentText=Number.isFinite(percent)?percent.toFixed(2):null;
    const lines=[`<b>${escapeHtml(label)}</b>`,`数量：${countText}`];
    if(percentText){ lines.push(`占比：${percentText}%`); }
    return lines.join('<br>');
  });

  container.innerHTML='';
  const colors=labels.map((_,idx)=>JOURNAL_COLORS[idx%JOURNAL_COLORS.length]);
  const maxCount=counts.reduce((max,val)=>{
    const num=Number.isFinite(val)?Number(val):0;
    return num>max?num:max;
  },0);
  const trace={
    type:'bar',
    orientation:'h',
    y:labels,
    x:counts,
    marker:{
      color:colors,
      line:{ color:'rgba(15,23,42,0.12)', width:1 }
    },
    text:texts,
    textposition:'outside',
    textfont:{ size:11, color:'#0f172a' },
    insidetextanchor:'middle',
    hovertext:hoverTexts,
    hovertemplate:'%{hovertext}<extra></extra>',
    cliponaxis:false,
  };
  const longestLabelLength=labels.reduce((max,label)=>Math.max(max,String(label||'').length),0);
  const leftMargin=Math.min(320, Math.max(130, Math.round(longestLabelLength*11)));
  const barHeight=Math.max(34, Math.min(52, Math.round(longestLabelLength>12?46:40)));
  const height=Math.max(260, 120 + labels.length*barHeight);
  const xRangeMax=maxCount>0?maxCount*1.15:1;
  const layout={
    margin:{ l:leftMargin, r:36, t:40, b:36 },
    height,
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    xaxis:{
      tickfont:{ size:11, color:'#334155' },
      gridcolor:'rgba(148,163,184,0.25)',
      zeroline:false,
      rangemode:'tozero',
      range:[0,xRangeMax],
      ticksuffix:'',
    },
    yaxis:{
      tickfont:{ size:11, color:'#334155' },
      gridcolor:'rgba(148,163,184,0.18)',
      zeroline:false,
      automargin:true,
      categoryorder:'array',
      categoryarray:labels,
      ticksuffix:'',
      autorange:'reversed',
    },
    showlegend:false,
    bargap:0.36,
  };
  const config={ displayModeBar:false, responsive:true };
  let plotPromise;
  try{
    plotPromise=Plotly.react(container,[trace],layout,config);
  }catch(err){
    console.error('期刊条形图渲染失败',err);
    container.innerHTML='<div class="journal-chart-empty">可视化渲染失败</div>';
    JOURNAL_CHARTS.delete(key);
    return;
  }
  JOURNAL_CHARTS.set(key, container);
  if(plotPromise && typeof plotPromise.then==='function'){
    plotPromise.then(()=>{
      if(window.Plotly){
        try{ Plotly.Plots.resize(container); }catch(e){}
      }
    }).catch(()=>{});
  }
}

function renderJournalPanel(dim){
  const key = dim==='field' ? 'field' : 'topic';
  const containerId = key==='field' ? 'journal_panel_field' : 'journal_panel_topic';
  const container=qs(containerId);
  if(!container) return;
  clearJournalChartsForDim(key);
  const data=Array.isArray(JOURNAL_DATA[key])?JOURNAL_DATA[key]:[];
  JOURNAL_RENDER_STATE[key]=data;
  if(!JOURNAL_SOURCE_AVAILABLE){
    container.innerHTML='<div class="journal-empty">缺少 Source Title 列，无法生成期刊统计。</div>';
    return;
  }
  if(!data.length){
    container.innerHTML='<div class="journal-empty">暂无期刊统计数据</div>';
    return;
  }
  const cards=data.map((entry,idx)=>{
    const chartId=`journal_chart_${key}_${idx}`;
    const category=escapeHtml(entry.category_display||entry.category||`分类 ${idx+1}`);
    const metaParts=[];
    if(entry.total>0){ metaParts.push(`共 ${numberFormatter.format(entry.total)} 篇`); }
    if(entry.unique>0){ metaParts.push(`期刊数 ${numberFormatter.format(entry.unique)}`); }
    const metaText=metaParts.length?escapeHtml(metaParts.join(' · ')):'';
    const metaHtml=metaText?`<p class="journal-card-meta">${metaText}</p>`:'';
    const tableRows=Array.isArray(entry.items)?entry.items.map((item,itemIdx)=>{
      const label=escapeHtml(item?.label||`期刊 ${itemIdx+1}`);
      const countText=numberFormatter.format(safeNumber(item?.count));
      const percentVal=Number.isFinite(item?.percent)?Number(item.percent):null;
      const percentText=percentVal!==null?`${percentVal>=10?percentVal.toFixed(1):percentVal.toFixed(2)}%`:'—';
      return `
        <tr>
          <td class="journal-table-rank">${itemIdx+1}</td>
          <td class="journal-table-label" title="${label}">${label}</td>
          <td class="journal-table-count">${countText}</td>
          <td class="journal-table-percent">${percentText}</td>
        </tr>
      `;
    }).join(''):'');
    const tableSection=tableRows?`
      <div class="journal-table-wrapper">
        <table class="journal-table" aria-label="${category} Top 5 期刊明细">
          <thead>
            <tr>
              <th scope="col" class="journal-table-rank">#</th>
              <th scope="col" class="journal-table-label">期刊</th>
              <th scope="col" class="journal-table-count">篇数</th>
              <th scope="col" class="journal-table-percent">占比</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
    `:`<div class="journal-table-wrapper"><div class="journal-table-empty">暂无 Top 5 数据</div></div>`;
    return `
      <article class="journal-card">
        <div class="journal-card-header">
          <div>
            <h5 class="journal-card-title">${category}</h5>
            ${metaHtml}
          </div>
          <span class="journal-card-badge">Top 5</span>
        </div>
        <div class="journal-chart" id="${chartId}" data-journal-dim="${key}" data-journal-index="${idx}"></div>
        ${tableSection}
        <div class="journal-card-actions">
          <button type="button" class="journal-card-open" data-journal-open="${key}" data-journal-index="${idx}">新标签页查看完整榜单</button>
        </div>
      </article>
    `;
  }).join('');
  container.innerHTML=cards;
  if(key!==JOURNAL_DIM){
    container.querySelectorAll('[data-journal-dim]').forEach(el=>{
      el.dataset.journalDeferred='1';
      el.innerHTML='<div class="journal-chart-empty">切换标签以查看图表</div>';
    });
    return;
  }
  data.forEach((entry,idx)=>{
    renderJournalChart(key, idx, entry);
  });
}

function openJournalDetail(dim,index){
  const key = dim==='field' ? 'field' : 'topic';
  const safeIndex = Number.isFinite(index)?index:parseInt(index,10)||0;
  const dataList = (JOURNAL_RENDER_STATE[key] && JOURNAL_RENDER_STATE[key].length ? JOURNAL_RENDER_STATE[key] : JOURNAL_DATA[key]) || [];
  const entry = dataList && dataList[safeIndex];
  if(!entry){
    alert('未找到期刊榜单数据。');
    return;
  }
  const detailWindow = window.open('', '_blank');
  if(!detailWindow){
    alert('无法打开新标签页，请检查浏览器的弹出窗口设置。');
    return;
  }
  const categoryRaw=entry.category_display||entry.category||`分类 ${safeIndex+1}`;
  const categoryTitle=String(categoryRaw);
  const metaParts=[];
  if(entry.total>0){ metaParts.push(`共 ${numberFormatter.format(entry.total)} 篇`); }
  if(entry.unique>0){ metaParts.push(`期刊数 ${numberFormatter.format(entry.unique)}`); }
  const items=(Array.isArray(entry.items)?entry.items:[]).map((item,idx)=>{
    const label=String(item?.label??`期刊 ${idx+1}`);
    const count=safeNumber(item?.count);
    const percentVal=Number.isFinite(item?.percent)?Number(item.percent):null;
    return { rank:idx+1, label, count, percent:percentVal };
  }).filter(item=>item.count>0);
  const resolvedLocale=(function(){
    try{
      return numberFormatter.resolvedOptions().locale||'zh-CN';
    }catch(e){
      return 'zh-CN';
    }
  })();
  const payload={
    category:categoryTitle,
    meta:metaParts,
    items,
    dimension:key==='field'?'研究领域（调整后）':'研究主题（调整后）',
    total:safeNumber(entry.total),
    unique:safeNumber(entry.unique),
    locale:resolvedLocale,
  };
  const docTitle=escapeHtml(`${categoryTitle} · Top 5 期刊`);
  const detailDoc=detailWindow.document;
  detailDoc.open();
  detailDoc.write(`<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>${docTitle}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *,*::before,*::after{box-sizing:border-box;}
    html,body{height:100%;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;background:#f1f5f9;color:#0f172a;}
    .detail-page{max-width:1200px;margin:0 auto;padding:2rem 1.5rem 3rem;display:flex;flex-direction:column;gap:1.75rem;}
    .detail-header{display:flex;flex-direction:column;gap:0.5rem;}
    .detail-dimension{font-size:0.85rem;font-weight:600;color:#475569;text-transform:uppercase;letter-spacing:0.08em;}
    .detail-title{font-size:1.75rem;font-weight:700;margin:0;color:#0f172a;}
    .detail-meta{font-size:0.85rem;color:#475569;margin:0;}
    .detail-meta.hidden{display:none!important;}
    .detail-grid{display:grid;gap:1.5rem;}
    @media (min-width:1024px){.detail-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .detail-card{background:#fff;border-radius:1.2rem;padding:1.5rem;box-shadow:0 32px 64px -48px rgba(15,23,42,0.55);border:1px solid rgba(226,232,240,0.9);display:flex;flex-direction:column;gap:1rem;}
    .detail-card h2{margin:0;font-size:1.1rem;font-weight:600;color:#0f172a;}
    .detail-card-sub{font-size:0.85rem;color:#64748b;margin:0;}
    .detail-chart-box{position:relative;width:100%;min-height:360px;border-radius:1rem;background:rgba(248,250,252,0.75);border:1px solid rgba(203,213,225,0.9);padding:0.75rem;}
    .detail-chart-empty{display:flex;align-items:center;justify-content:center;min-height:320px;font-size:0.9rem;color:#64748b;background:rgba(248,250,252,0.85);border:1px dashed rgba(148,163,184,0.45);border-radius:1rem;text-align:center;}
    .detail-chart{width:100%;height:100%;}
    .detail-table-wrapper{display:flex;flex-direction:column;gap:0.75rem;}
    .detail-table-container{border-radius:1rem;border:1px solid rgba(226,232,240,0.9);background:rgba(248,250,252,0.85);overflow:hidden;}
    .detail-table{width:100%;border-collapse:collapse;font-size:0.85rem;color:#0f172a;}
    .detail-table thead{background:rgba(226,232,240,0.85);color:#475569;text-transform:uppercase;letter-spacing:0.05em;font-size:0.75rem;}
    .detail-table th,.detail-table td{padding:0.55rem 0.85rem;text-align:left;}
    .detail-table tbody tr:nth-child(even){background:rgba(226,232,240,0.45);}
    .detail-table tbody tr:hover{background:rgba(191,219,254,0.6);}
    .detail-table-rank{width:3rem;text-align:center;font-weight:600;color:#1e3a8a;font-family:"JetBrains Mono","Fira Code",monospace;}
    .detail-table-count,.detail-table-percent{font-family:"JetBrains Mono","Fira Code",monospace;text-align:right;}
    .detail-table-empty{padding:0.75rem 1rem;font-size:0.82rem;color:#94a3b8;text-align:center;border:1px dashed rgba(148,163,184,0.4);border-radius:0.85rem;background:rgba(248,250,252,0.75);}
    .hidden{display:none!important;}
    footer{font-size:0.75rem;color:#94a3b8;text-align:center;margin-top:auto;}
  </style>
</head>
<body>
  <div class="detail-page">
    <header class="detail-header">
      <span class="detail-dimension" id="detail_dimension"></span>
      <h1 class="detail-title" id="detail_title"></h1>
      <p class="detail-meta" id="detail_meta"></p>
    </header>
    <section class="detail-grid">
      <article class="detail-card">
        <div>
          <h2>Top 5 期刊条形图</h2>
          <p class="detail-card-sub">横向条形展示 Top 5 期刊的篇数与占比，自动适配坐标轴范围。</p>
        </div>
        <div class="detail-chart-box">
          <div id="detail_chart_empty" class="detail-chart-empty hidden">暂无可视化数据。</div>
          <div id="journal_detail_chart" class="detail-chart" role="img" aria-label="期刊 Top 5 条形图"></div>
        </div>
      </article>
      <article class="detail-card">
        <div>
          <h2>Top 5 期刊明细</h2>
          <p class="detail-card-sub">包含期刊名称、篇数与分类内占比，方便导读。</p>
        </div>
        <div class="detail-table-wrapper">
          <div class="detail-table-container">
            <table class="detail-table" id="detail_table" aria-describedby="detail_title">
              <thead>
                <tr>
                  <th scope="col" class="detail-table-rank">排名</th>
                  <th scope="col">期刊</th>
                  <th scope="col" class="detail-table-count">篇数</th>
                  <th scope="col" class="detail-table-percent">占比</th>
                </tr>
              </thead>
              <tbody id="detail_table_body"></tbody>
            </table>
          </div>
          <div id="detail_table_empty" class="detail-table-empty hidden">暂无 Top 5 数据。</div>
        </div>
      </article>
    </section>
    <footer>CommCoder Studio · 期刊榜单详情</footer>
  </div>
</body>
</html>`);
  detailDoc.close();
  detailWindow.__DETAIL_PAYLOAD__ = payload;
  const plotlyScriptEl=detailDoc.createElement('script');
  plotlyScriptEl.src='https://cdn.plot.ly/plotly-2.30.0.min.js';
  plotlyScriptEl.async=true;
  plotlyScriptEl.dataset.role='plotly';
  detailDoc.head.appendChild(plotlyScriptEl);
  const bootstrapScript=detailDoc.createElement('script');
  bootstrapScript.type='module';
  bootstrapScript.textContent=`(() => {
    const payload = window.__DETAIL_PAYLOAD__ || {};
    delete window.__DETAIL_PAYLOAD__;
    const locale = typeof payload.locale === 'string' && payload.locale ? payload.locale : 'zh-CN';
    let formatter;
    try {
      formatter = new Intl.NumberFormat(locale);
    } catch (err) {
      formatter = new Intl.NumberFormat('zh-CN');
    }
    let chartResizeBound = false;
    function init(){
      applyHeader();
      renderTable();
      waitForPlotly().then(() => {
        renderChart();
      }).catch(err => {
        showChartError(err && err.message ? err.message : '可视化渲染失败');
      });
    }
    function applyHeader(){
      const dimensionEl = document.getElementById('detail_dimension');
      const titleEl = document.getElementById('detail_title');
      const metaEl = document.getElementById('detail_meta');
      const titleText = (payload.category || '分类详情') + ' · Top 5 期刊';
      if (dimensionEl) {
        dimensionEl.textContent = payload.dimension || '';
      }
      if (titleEl) {
        titleEl.textContent = titleText;
      }
      document.title = titleText;
      if (metaEl) {
        if (Array.isArray(payload.meta) && payload.meta.length) {
          metaEl.textContent = payload.meta.join(' · ');
          metaEl.classList.remove('hidden');
        } else {
          metaEl.textContent = '';
          metaEl.classList.add('hidden');
        }
      }
    }
    function renderTable(){
      const tbody = document.getElementById('detail_table_body');
      const table = document.getElementById('detail_table');
      const empty = document.getElementById('detail_table_empty');
      if (!tbody || !table || !empty) {
        return;
      }
      tbody.innerHTML = '';
      const list = Array.isArray(payload.items) ? payload.items : [];
      if (!list.length) {
        table.classList.add('hidden');
        empty.textContent = '暂无 Top 5 数据。';
        empty.classList.remove('hidden');
        return;
      }
      table.classList.remove('hidden');
      empty.classList.add('hidden');
      list.forEach(item => {
        const tr = document.createElement('tr');
        const rank = document.createElement('td');
        rank.className = 'detail-table-rank';
        rank.textContent = String(item && item.rank ? item.rank : '');
        const label = document.createElement('td');
        label.textContent = item && item.label ? item.label : '';
        const count = document.createElement('td');
        count.className = 'detail-table-count';
        const countValue = item && Number.isFinite(item.count) ? item.count : 0;
        count.textContent = formatter.format(countValue);
        const percent = document.createElement('td');
        percent.className = 'detail-table-percent';
        if (item && Number.isFinite(item.percent)) {
          const percentValue = item.percent;
          const decimals = percentValue >= 10 ? 1 : 2;
          percent.textContent = percentValue.toFixed(decimals) + '%';
        } else {
          percent.textContent = '—';
        }
        tr.append(rank, label, count, percent);
        tbody.appendChild(tr);
      });
    }
    function showChartError(message){
      const chartEl = document.getElementById('journal_detail_chart');
      const emptyEl = document.getElementById('detail_chart_empty');
      if (chartEl) {
        chartEl.classList.add('hidden');
      }
      if (emptyEl) {
        emptyEl.textContent = message || '暂无可视化数据。';
        emptyEl.classList.remove('hidden');
      }
    }
    function renderChart(){
      const chartEl = document.getElementById('journal_detail_chart');
      const emptyEl = document.getElementById('detail_chart_empty');
      const list = Array.isArray(payload.items) ? payload.items : [];
      if (!chartEl || !emptyEl) {
        return;
      }
      if (!list.length) {
        showChartError('暂无可视化数据。');
        return;
      }
      chartEl.classList.remove('hidden');
      emptyEl.classList.add('hidden');
      const labels = list.map(item => (item && item.label) ? item.label : '');
      const counts = list.map(item => (item && Number.isFinite(item.count)) ? item.count : 0);
      const percents = list.map(item => (item && Number.isFinite(item.percent)) ? item.percent : null);
      const texts = counts.map((val, idx) => {
        const percentValue = percents[idx];
        const percentText = Number.isFinite(percentValue) ? (percentValue >= 10 ? percentValue.toFixed(1) : percentValue.toFixed(2)) + '%' : '';
        const valueText = formatter.format(val);
        return percentText ? valueText + '（' + percentText + '）' : valueText;
      });
      const hoverTexts = labels.map((label, idx) => {
        const countText = formatter.format(counts[idx]);
        const percentValue = percents[idx];
        if (Number.isFinite(percentValue)) {
          return label + '<br>数量：' + countText + '<br>占比：' + percentValue.toFixed(2) + '%';
        }
        return label + '<br>数量：' + countText;
      });
      const colors = ['#1d4ed8','#0f172a','#0284c7','#2563eb','#9333ea','#f97316','#16a34a'];
      const longestLabelLength = labels.reduce((max, label) => {
        const length = String(label || '').length;
        return length > max ? length : max;
      }, 0);
      const leftMargin = Math.min(360, Math.max(150, Math.round(longestLabelLength * 12)));
      const height = Math.max(320, 140 + labels.length * 52);
      const PlotlyInstance = window.Plotly;
      if (!PlotlyInstance || !PlotlyInstance.newPlot) {
        showChartError('Plotly 未加载');
        return;
      }
      const trace = {
        type: 'bar',
        orientation: 'h',
        y: labels,
        x: counts,
        marker: {
          color: labels.map((_, idx) => colors[idx % colors.length]),
          line: { color: 'rgba(15,23,42,0.12)', width: 1 }
        },
        text: texts,
        textposition: 'outside',
        textfont: { size: 12, color: '#0f172a' },
        hovertext: hoverTexts,
        hovertemplate: '%{hovertext}<extra></extra>',
        cliponaxis: false
      };
      const maxCount = counts.reduce((m, val) => {
        if (Number.isFinite(val) && val > m) {
          return val;
        }
        return m;
      }, 0);
      const layout = {
        margin: { l: leftMargin, r: 48, t: 36, b: 40 },
        height: height,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: {
          rangemode: 'tozero',
          range: [0, maxCount > 0 ? maxCount * 1.2 : 1],
          tickfont: { size: 12, color: '#334155' },
          gridcolor: 'rgba(148,163,184,0.25)',
          zeroline: false
        },
        yaxis: {
          autorange: 'reversed',
          tickfont: { size: 12, color: '#334155' }
        },
        showlegend: false,
        bargap: 0.34
      };
      PlotlyInstance.newPlot(chartEl, [trace], layout, { displayModeBar: true, responsive: true }).then(() => {
        if (!chartResizeBound) {
          window.addEventListener('resize', () => {
            if (window.Plotly && window.Plotly.Plots && window.Plotly.Plots.resize) {
              try {
                window.Plotly.Plots.resize(chartEl);
              } catch (resizeErr) {
                console.error(resizeErr);
              }
            }
          });
          chartResizeBound = true;
        }
      }).catch(err => {
        console.error('Plotly 渲染失败', err);
        showChartError('可视化渲染失败');
      });
    }
    function waitForPlotly(){
      return new Promise((resolve, reject) => {
        if (window.Plotly) {
          resolve(window.Plotly);
          return;
        }
        const plotlyScript = document.querySelector('script[data-role="plotly"]');
        if (plotlyScript) {
          plotlyScript.addEventListener('load', () => {
            resolve(window.Plotly);
          }, { once: true });
          plotlyScript.addEventListener('error', () => {
            reject(new Error('Plotly 加载失败'));
          }, { once: true });
        }
        let attempts = 0;
        const maxAttempts = 80;
        const timer = setInterval(() => {
          if (window.Plotly) {
            clearInterval(timer);
            resolve(window.Plotly);
            return;
          }
          attempts += 1;
          if (attempts >= maxAttempts) {
            clearInterval(timer);
            reject(new Error('Plotly 加载超时'));
          }
        }, 120);
      });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  })();`;
  detailDoc.body.appendChild(bootstrapScript);
}

let JOURNAL_OPEN_HANDLER_BOUND=false;
function handleJournalOpenClick(event){
  const rawTarget = event.target;
  const target = rawTarget && typeof rawTarget.closest==='function' ? rawTarget.closest('[data-journal-open]') : null;
  if(!target) return;
  event.preventDefault();
  const dim = target.dataset?.journalOpen==='field'?'field':'topic';
  const index = parseInt(target.dataset?.journalIndex||'0',10);
  openJournalDetail(dim, Number.isFinite(index)?index:0);
}

function renderDeferredJournalCharts(){
  document.querySelectorAll('[data-journal-deferred="1"]').forEach(el=>{
    const dim = el.dataset.journalDim==='field' ? 'field' : 'topic';
    const index = parseInt(el.dataset.journalIndex||'0',10);
    const entry = JOURNAL_RENDER_STATE[dim] && JOURNAL_RENDER_STATE[dim][index];
    if(!entry) return;
    delete el.dataset.journalDeferred;
    renderJournalChart(dim, index, entry);
  });
}

function resizeVisibleJournalCharts(){
  if(!window.Plotly) return;
  JOURNAL_CHARTS.forEach((el,key)=>{
    if(!el || !el.isConnected){ JOURNAL_CHARTS.delete(key); return; }
    if(isChartHidden(el)) return;
    try{ Plotly.Plots.resize(el); }catch(e){}
  });
}

function getCategoryView(category){
  return CATEGORY_VIEW_STATE[category]||'treemap';
}
function syncCategoryToggle(category){
  const view=getCategoryView(category);
  const wrapper=document.querySelector(`[data-chart-toggle="${category}"]`);
  if(!wrapper) return;
  wrapper.querySelectorAll('[data-chart-toggle-target]').forEach(btn=>{
    const target=btn.dataset.chartToggleTarget;
    const active=target===view;
    btn.classList.toggle('chart-type-btn-active', active);
    btn.setAttribute('aria-pressed', active?'true':'false');
  });
}
function renderActiveCategoryChart(category){
  const config=CATEGORY_CHART_CONFIG[category];
  if(!config) return;
  const view=getCategoryView(category);
  syncCategoryToggle(category);
  const treemapEl=qs(config.treemapId);
  const barEl=qs(config.barId);
  const showTreemap=view==='treemap';
  const showBar=view==='bar';
  if(treemapEl){
    if(showTreemap){ treemapEl.classList.remove('hidden'); }
    else{ treemapEl.classList.add('hidden'); }
  }
  if(barEl){
    if(showBar){ barEl.classList.remove('hidden'); }
    else{ barEl.classList.add('hidden'); }
  }
  const dataset=CATEGORY_DATA[category];
  if(!dataset){
    if(showTreemap && treemapEl){
      destroyTreemap(config.treemapKey);
      treemapEl.innerHTML='<div class="treemap-empty">暂无数据</div>';
    }
    if(showBar && barEl){
      destroyBarChart(config.barKey);
      barEl.innerHTML='<div class="treemap-empty">暂无数据</div>';
    }
    return;
  }
  const { primaryRaw, options }=dataset;
  if(showTreemap){
    destroyBarChart(config.barKey);
    renderTreemap(config.treemapId, primaryRaw, config.treemapKey, options);
  }else if(showBar){
    destroyTreemap(config.treemapKey);
    renderBarChart(config.barId, primaryRaw, config.barKey, options);
  }
}
function setCategoryData(category, primaryRaw, options={}){
  CATEGORY_DATA[category]={ primaryRaw:cloneStatList(primaryRaw), options:cloneTreemapOptions(options) };
  renderActiveCategoryChart(category);
}
function setCategoryChartView(category, view){
  const normalized=view==='bar'?'bar':'treemap';
  if(CATEGORY_VIEW_STATE[category]===normalized) return;
  CATEGORY_VIEW_STATE[category]=normalized;
  renderActiveCategoryChart(category);
}

function resetTimelineLineLabels(){
  if(!TIMELINE_LINE_LABEL_LAYER) return;
  TIMELINE_LINE_LABEL_LAYER.innerHTML='';
  TIMELINE_LINE_LABEL_LAYER.classList.add('hidden');
}

function getTimelineBinLabel(bin, idx){
  if(!bin) return `区间 ${idx+1}`;
  const rawLabel = bin.label;
  if(rawLabel!==undefined && rawLabel!==null){
    const text = String(rawLabel).trim();
    if(text) return text;
  }
  const hasStart = bin.start!==undefined && bin.start!==null;
  const hasEnd = bin.end!==undefined && bin.end!==null;
  if(hasStart && hasEnd){
    return `${bin.start}-${bin.end}`;
  }
  if(hasStart){
    return `${bin.start}`;
  }
  if(hasEnd){
    return `${bin.end}`;
  }
  return `区间 ${idx+1}`;
}

function updateTimelineLineLabels(timeline){
  if(!TIMELINE_LINE_LABEL_LAYER) return;
  resetTimelineLineLabels();
  if(!timeline || !Array.isArray(timeline.bins) || !timeline.bins.length){
    return;
  }
  const bins = timeline.bins;
  const counts = bins.map(bin=>Number(bin?.count)||0);
  const maxCount = counts.length?Math.max(...counts):0;
  if(!Number.isFinite(maxCount)){
    return;
  }
  const frag=document.createDocumentFragment();
  bins.forEach((bin, idx)=>{
    const count = counts[idx]||0;
    const labelText = getTimelineBinLabel(bin, idx);
    const wrapper=document.createElement('div');
    wrapper.className='timeline-line-label';
    wrapper.dataset.index=String(idx);
    wrapper.dataset.count=String(count);
    wrapper.dataset.label=labelText;
    wrapper.setAttribute('title', `${labelText}：${numberFormatter.format(count)} 篇`);
    const countEl=document.createElement('span');
    countEl.className='timeline-line-label-count';
    countEl.textContent=numberFormatter.format(count);
    const rangeEl=document.createElement('span');
    rangeEl.className='timeline-line-label-range';
    rangeEl.textContent=labelText;
    wrapper.appendChild(countEl);
    wrapper.appendChild(rangeEl);
    frag.appendChild(wrapper);
  });
  TIMELINE_LINE_LABEL_LAYER.appendChild(frag);
  requestAnimationFrame(()=>positionTimelineLineLabels());
}

function positionTimelineLineLabels(){
  if(!TIMELINE_LINE_LABEL_LAYER) return;
  const labelEls=Array.from(TIMELINE_LINE_LABEL_LAYER.querySelectorAll('.timeline-line-label'));
  if(!labelEls.length){
    TIMELINE_LINE_LABEL_LAYER.classList.add('hidden');
    return;
  }
  const bins=(TIMELINE_DATA && Array.isArray(TIMELINE_DATA.bins))?TIMELINE_DATA.bins:[];
  if(!bins.length || bins.length!==labelEls.length){
    TIMELINE_LINE_LABEL_LAYER.classList.add('hidden');
    return;
  }
  const counts=bins.map(bin=>Number(bin?.count)||0);
  const maxCount=counts.length?Math.max(...counts):0;
  if(!Number.isFinite(maxCount)){
    TIMELINE_LINE_LABEL_LAYER.classList.add('hidden');
    return;
  }
  const layerRect=TIMELINE_LINE_LABEL_LAYER.getBoundingClientRect();
  const referenceEl=(TIMELINE_LINE_IMAGE && !TIMELINE_LINE_IMAGE.classList.contains('hidden'))?TIMELINE_LINE_IMAGE:null;
  const targetRect=referenceEl?referenceEl.getBoundingClientRect():layerRect;
  const leftOffset=Math.max(0, targetRect.left-layerRect.left);
  const rightOffset=Math.max(0, layerRect.right-targetRect.right);
  const topOffset=Math.max(0, targetRect.top-layerRect.top);
  const bottomOffset=Math.max(0, layerRect.bottom-targetRect.bottom);
  const innerWidth=Math.max(1, TIMELINE_LINE_LABEL_LAYER.clientWidth-leftOffset-rightOffset);
  const innerHeight=Math.max(1, TIMELINE_LINE_LABEL_LAYER.clientHeight-topOffset-bottomOffset);
  const minTop=topOffset+8;
  const maxTop=topOffset+innerHeight-12;
  labelEls.forEach((el, idx)=>{
    const xRatio=bins.length>1?(idx/(bins.length-1)):0.5;
    const yRatio=maxCount>0?(counts[idx]/maxCount):0;
    const left=leftOffset+(innerWidth*xRatio);
    const projectedTop=topOffset+((1-yRatio)*innerHeight)-12;
    const clampedTop=Math.min(Math.max(projectedTop, minTop), maxTop);
    el.style.left=`${left}px`;
    el.style.top=`${clampedTop}px`;
  });
  TIMELINE_LINE_LABEL_LAYER.classList.remove('hidden');
}

function clearTimelineCharts(message){
  TIMELINE_STACK_FIGURE=null;
  const summary=qs('timeline_summary');
  if(summary){
    if(message){
      summary.textContent=message;
      summary.classList.remove('hidden');
    }else{
      summary.textContent='';
      summary.classList.add('hidden');
    }
  }
  if(TIMELINE_LINE_IMAGE){
    TIMELINE_LINE_IMAGE.classList.add('hidden');
    TIMELINE_LINE_IMAGE.removeAttribute('src');
  }
  if(TIMELINE_LINE_PLACEHOLDER){
    const shouldShowMessage = message===undefined || (message!==null && String(message).trim()!=='');
    if(shouldShowMessage){
      TIMELINE_LINE_PLACEHOLDER.textContent = message===undefined ? '暂无数据' : String(message);
      TIMELINE_LINE_PLACEHOLDER.classList.remove('hidden');
    }else{
      TIMELINE_LINE_PLACEHOLDER.textContent='';
      TIMELINE_LINE_PLACEHOLDER.classList.add('hidden');
    }
  }
  Object.values(TIMELINE_LINE_DOWNLOAD_BUTTONS).forEach(btn=>{
    if(!btn) return;
    btn.disabled=true;
  });
  TIMELINE_LINE_DOWNLOAD_URLS.png='';
  TIMELINE_LINE_DOWNLOAD_URLS.svg='';
  resetTimelineLineLabels();
  TIMELINE_PLOTLY_IDS.forEach(id=>{
    const el=qs(id);
    if(!el) return;
    if(window.Plotly){
      try{ Plotly.purge(el); }catch(e){}
    }
    const shouldShowMessage = message===undefined || (message!==null && String(message).trim()!=='');
    if(shouldShowMessage){
      const text = message===undefined ? '暂无数据' : String(message);
      el.innerHTML=`<div class="treemap-empty">${escapeHtml(text)}</div>`;
    }else{
      el.innerHTML='';
    }
  });
  setTimelineAreaLabel('');
}

function setTimelineAreaLabel(text){
  const labelEl=qs('timeline_area_label');
  if(!labelEl) return;
  const content=(text||'').trim();
  labelEl.textContent=content;
  labelEl.style.display=content?'':'none';
}

function renderTimelineCharts(timeline){
  TIMELINE_DATA=timeline||null;
  updateTimelineLineLabels(timeline);
  const summary=qs('timeline_summary');
  const select=qs('timeline_bin_select');
  TIMELINE_STACK_FIGURE=null;
  if(!timeline || !Array.isArray(timeline.bins) || !timeline.bins.length){
    if(select && TIMELINE_BIN_SIZE){
      const val=String(TIMELINE_BIN_SIZE);
      if(select.value!==val) select.value=val;
    }
    updateTimelineStackToggle();
    clearTimelineCharts('暂无有效年份数据');
    return;
  }
  const binSize=Number.isFinite(timeline.bin_size)?Number(timeline.bin_size):TIMELINE_BIN_SIZE||5;
  TIMELINE_BIN_SIZE=binSize;
  if(select){
    const val=String(binSize);
    if(select.value!==val){ select.value=val; }
  }
  const total=Number(timeline.total)||0;
  const minYear=(timeline.min_year??timeline.min_year===0)?timeline.min_year:null;
  const maxYear=(timeline.max_year??timeline.max_year===0)?timeline.max_year:null;
  if(summary){
    const rangeText=(minYear!==null && maxYear!==null)?`${minYear} - ${maxYear}`:'—';
    summary.textContent=`共 ${numberFormatter.format(total)} 篇，年份范围：${rangeText}（每 ${binSize} 年一组）`;
    summary.classList.remove('hidden');
  }

  let baseUrl='';
  if(SESSION_ID){
    baseUrl=`/timeline_chart?session_id=${encodeURIComponent(SESSION_ID)}&bin_years=${encodeURIComponent(binSize)}`;
  }
  if(TIMELINE_LINE_PLACEHOLDER){
    if(baseUrl){
      TIMELINE_LINE_PLACEHOLDER.classList.add('hidden');
    }else{
      TIMELINE_LINE_PLACEHOLDER.textContent='暂无法生成图表';
      TIMELINE_LINE_PLACEHOLDER.classList.remove('hidden');
    }
  }
  if(TIMELINE_LINE_IMAGE){
    if(baseUrl){
      const displayUrl=`${baseUrl}&format=png&_=${Date.now()}`;
      TIMELINE_LINE_IMAGE.src=displayUrl;
      TIMELINE_LINE_IMAGE.alt=`Timeline of publication counts (bin size ${binSize} years)`;
      TIMELINE_LINE_IMAGE.classList.remove('hidden');
    }else{
      TIMELINE_LINE_IMAGE.classList.add('hidden');
      TIMELINE_LINE_IMAGE.removeAttribute('src');
    }
  }
  TIMELINE_LINE_DOWNLOAD_URLS.png=baseUrl?`${baseUrl}&format=png&download=true`:'';
  TIMELINE_LINE_DOWNLOAD_URLS.svg=baseUrl?`${baseUrl}&format=svg&download=true`:'';
  const hasDownloads=!!baseUrl;
  Object.values(TIMELINE_LINE_DOWNLOAD_BUTTONS).forEach(btn=>{
    if(!btn) return;
    btn.disabled=!hasDownloads;
  });

  if(!window.Plotly){
    TIMELINE_PLOTLY_IDS.forEach(id=>{
      const el=qs(id);
      if(!el) return;
      el.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    });
    return;
  }

  updateTimelineStackToggle();
  renderTimelineStackChart(timeline);
  resizeTimelineCharts();
}

function renderTimelineStackChart(timeline){
  const areaEl=qs('timeline_area_chart');
  if(!areaEl){
    return;
  }
  setTimelineAreaLabel(TIMELINE_STACK_LABELS[TIMELINE_STACK_DIM]||'');
  TIMELINE_STACK_FIGURE=null;
  if(!timeline || !Array.isArray(timeline.bins) || !timeline.bins.length){
    areaEl.innerHTML='<div class="treemap-empty">暂无分类占比数据</div>';
    return;
  }
  if(!window.Plotly){
    areaEl.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    return;
  }
  const labels=timeline.bins.map(bin=>bin.label||`${bin.start}-${bin.end}`);
  const totals=timeline.bins.map(bin=>Number(bin.count)||0);
  const stackKey = TIMELINE_STACK_DIM==='field_adj' ? 'stack_field' : 'stack_topic';
  const stackData = timeline && typeof timeline==="object" ? timeline[stackKey] : null;
  const seriesList = stackData && Array.isArray(stackData.series) ? stackData.series : [];
  if(!seriesList.length){
    areaEl.innerHTML='<div class="treemap-empty">暂无分类占比数据</div>';
    return;
  }
  const traces = [];
  seriesList.forEach((serie, idx)=>{
    if(!serie) return;
    const rawCounts = Array.isArray(serie.counts) ? serie.counts : [];
    const points = labels.map((label,i)=>{
      const count = Number(rawCounts[i])||0;
      const total = totals[i]||0;
      const percent = total>0 ? (count/total*100) : 0;
      return { label, count, total, percent };
    }).filter(point=>point.count>0 && point.total>0);
    if(!points.length){
      return;
    }
    const color = TIMELINE_STACK_COLORS[idx % TIMELINE_STACK_COLORS.length];
    const yLabelRaw = serie.label || `分类 ${idx+1}`;
    const yDisplay = resolveDisplayText(yLabelRaw, serie.display_label, stackKey==='stack_field'?'field':'topic');
    const markerSizes = points.map(point=>{
      const size = Math.sqrt(Math.max(point.percent, 0));
      return Math.max(12, Math.min(58, size*6));
    });
    const percentLabels = points.map(point=>{
      if(point.percent<=0) return '';
      return `${point.percent.toFixed(1)}%`;
    });
    const xValues = points.map(point=>point.label);
    const yValues = points.map(()=>yDisplay);
    const markerTrace={
      type:'scatter',
      mode:'markers',
      name:yDisplay,
      legendgroup:yDisplay,
      x:xValues,
      y:yValues,
      marker:{
        size:markerSizes,
        color,
        opacity:0.85,
        sizemode:'diameter',
        line:{width:1,color:'rgba(15,23,42,0.15)'}
      },
      hovertemplate:'<b>%{y}</b><br>%{x}<br>占比：%{customdata[1]:.2f}%<br>数量：%{customdata[0]}<br>总计：%{customdata[2]}<extra></extra>',
      customdata:points.map(point=>[point.count, point.percent, point.total])
    };
    traces.push(markerTrace);
    if(percentLabels.some(Boolean)){
      traces.push({
        type:'scatter',
        mode:'text',
        name:yDisplay,
        legendgroup:yDisplay,
        showlegend:false,
        x:xValues,
        y:yValues,
        text:percentLabels,
        textposition:'top center',
        textfont:{
          family:'"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif',
          color:'#0f172a',
          size:12
        },
        hoverinfo:'skip',
        cliponaxis:false
      });
    }
  });
  if(!traces.length){
    areaEl.innerHTML='<div class="treemap-empty">暂无分类占比数据</div>';
    return;
  }
  areaEl.innerHTML='';
  const categoryOrder = Array.from(new Set(traces.map(trace=>trace.name).filter(Boolean)));
  const layout={
    margin:{l:120,r:24,t:46,b:64},
    height:Math.max(260, 120 + categoryOrder.length*64),
    paper_bgcolor:'rgba(255,255,255,0)',
    plot_bgcolor:'rgba(255,255,255,0)',
    hovermode:'closest',
    legend:{orientation:'h', yanchor:'bottom', y:1.02, xanchor:'left', x:0},
    xaxis:{title:'年份区间', tickangle:-30, automargin:true},
    yaxis:{
      title:TIMELINE_STACK_LABELS[TIMELINE_STACK_DIM]||'',
      type:'category',
      automargin:true,
      categoryorder:'array',
      categoryarray:categoryOrder
    },
    font:{family:'"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif', color:'#0f172a'}
  };
  const storedData=cloneDeep(traces);
  const storedLayout=cloneDeep(layout);
  TIMELINE_STACK_FIGURE={ data: storedData, layout: storedLayout };
  try{
    Plotly.react(areaEl, cloneDeep(traces), cloneDeep(layout), {...TIMELINE_CONFIG});
  }catch(e){
    areaEl.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
    TIMELINE_STACK_FIGURE=null;
  }
}

function openTimelineFigureFullScreen(figure, fallbackTitle){
  if(!figure || !Array.isArray(figure.data) || !figure.data.length){
    window.alert('暂无可视化数据');
    return;
  }
  if(!window.Plotly){
    window.alert('Plotly 尚未加载');
    return;
  }
  const win=window.open('', '_blank');
  if(!win){
    window.alert('浏览器阻止了弹窗，请允许后重试');
    return;
  }
  const titleText=fallbackTitle||'时间趋势图表';
  const safeTitle=escapeHtml(titleText);
  win.document.open();
  win.document.write(`<!doctype html><html lang="zh"><head><meta charset="utf-8"><title>${safeTitle} - 全屏图表</title><style>html,body{margin:0;height:100%;}#plot{width:100%;height:100%;}</style></head><body><div id="plot"></div></body></html>`);
  win.document.close();
  const attach=()=>{
    if(!win.Plotly){
      win.Plotly=window.Plotly;
    }
    const container=win.document.getElementById('plot');
    if(!container || !win.Plotly){
      return;
    }
    const data=cloneDeep(figure.data)||[];
    const layout=cloneDeep(figure.layout)||{};
    if(typeof layout.title==='string'){
      layout.title={ text: layout.title };
    }
    const defaultTitle=titleText||'时间趋势图表';
    if(!layout.title){
      layout.title={ text: defaultTitle };
    }else if(!layout.title.text){
      layout.title.text=defaultTitle;
    }
    layout.title.x = layout.title.x ?? 0.03;
    layout.title.xanchor = layout.title.xanchor || 'left';
    layout.autosize=true;
    layout.height=Math.max(480, win.innerHeight);
    layout.width=Math.max(640, win.innerWidth);
    const config={...TIMELINE_CONFIG, responsive:true, displayModeBar:true};
    try{
      win.Plotly.newPlot(container, cloneDeep(data), cloneDeep(layout), config);
    }catch(e){
      console.error('全屏图表渲染失败', e);
      win.document.body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1rem;color:#dc2626;">图表渲染失败：${escapeHtml(String(e?.message||e||''))}</div>`;
      return;
    }
    const resizeHandler=()=>{
      if(!win.Plotly) return;
      layout.height=Math.max(480, win.innerHeight);
      layout.width=Math.max(640, win.innerWidth);
      try{ win.Plotly.Plots.resize(container); }catch(err){ console.error(err); }
    };
    win.addEventListener('resize', resizeHandler);
  };
  if(win.document.readyState==='complete' || win.document.readyState==='interactive'){
    attach();
  }else{
    win.addEventListener('load', attach, { once:true });
  }
}

function resizeTimelineCharts(){
  positionTimelineLineLabels();
  if(!window.Plotly) return;
  TIMELINE_PLOTLY_IDS.forEach(id=>{
    const el=qs(id);
    if(!el) return;
    if(!el.querySelector('.plotly')) return;
    try{ Plotly.Plots.resize(el); }catch(e){}
  });
}
clearTimelineCharts('');
function resizeVisibleTreemaps(){
  if(!window.Plotly) return;
  Object.values(TREEMAP_PLOTS).forEach(container=>{
    if(!container) return;
    if(isChartHidden(container)) return;
    try{ Plotly.Plots.resize(container); }catch(e){}
  });
}
function resizeVisibleBarCharts(){
  if(!window.Plotly) return;
  Object.values(BAR_CHART_PLOTS).forEach(container=>{
    if(!container) return;
    if(isChartHidden(container)) return;
    try{ Plotly.Plots.resize(container); }catch(e){}
  });
}

function getTopicVizConfig(dim){
  return TOPIC_VIZ_CONFIG[dim] || TOPIC_VIZ_CONFIG.topic;
}

function getWordCloudConfig(dim){
  return WORD_CLOUD_CONFIG[dim] || WORD_CLOUD_CONFIG.topic;
}

function getTopicVizChartEl(dim, type){
  const cfg = getTopicVizConfig(dim);
  if(!cfg) return null;
  const id = type === 'scatter' ? cfg.scatterId : cfg.wordsId;
  return document.getElementById(id);
}

function setWordCloudMessage(dim, message){
  const cfg=getWordCloudConfig(dim);
  if(!cfg) return;
  const el=document.getElementById(cfg.messageId);
  if(!el) return;
  if(message){
    el.textContent=message;
    el.classList.remove('hidden');
  }else{
    el.textContent='';
    el.classList.add('hidden');
  }
}

function clearWordCloudList(dim){
  const cfg=getWordCloudConfig(dim);
  if(!cfg) return;
  const list=document.getElementById(cfg.listId);
  if(list){ list.innerHTML=''; }
}

function resetWordCloudSection(){
  const message = SESSION_ID ? '词云数据加载中…' : WORD_CLOUD_DEFAULT_HINT;
  resetWordCloudVisual(message);
  WORD_CLOUD_DIMENSIONS.forEach(dim=>{
    clearWordCloudList(dim);
    const message = SESSION_ID ? '词云数据加载中…' : '请先上传或载入会话以加载词云数据。';
    setWordCloudMessage(dim, message);
  });
}

function setTopicVizMessage(dim, message){
  const cfg = getTopicVizConfig(dim);
  if(!cfg) return;
  const el = document.querySelector(cfg.messageSelector);
  if(!el) return;
  if(message){
    el.textContent = message;
    el.classList.remove('hidden');
  }else{
    el.textContent = '';
    el.classList.add('hidden');
  }
}

function disposeKeywordCharts(dim){
  const store=TOPIC_KEYWORD_CHARTS[dim];
  if(!store) return;
  store.forEach(chart=>{
    if(chart && typeof chart.dispose==='function'){
      try{ chart.dispose(); }catch(e){}
    }
  });
  store.clear();
}

function getKeywordDashboardData(dim){
  const dimData=TOPIC_VIZ_STATE.data[dim]||{};
  const kind=dim==='field'?'field':'topic';
  const entries=[];

  const normalizeEntry=entry=>{
    if(!entry) return null;
    const rawLabel=String(entry.label??entry.topicName??'').trim();
    const keywordsRaw=Array.isArray(entry.keywords)?entry.keywords:[];
    const weightsRaw=Array.isArray(entry.weights)?entry.weights:[];
    const countsRaw=Array.isArray(entry.counts)?entry.counts:[];
    const limitedKeywords=[];
    const limitedWeights=[];
    const limitedCounts=[];
    for(let i=0;i<keywordsRaw.length && limitedKeywords.length<KEYWORD_BAR_LIMIT;i+=1){
      const token=String(keywordsRaw[i]??'').trim();
      if(!token) continue;
      limitedKeywords.push(token);
      const weight=normalizeKeywordWeight(weightsRaw[i]);
      limitedWeights.push(weight);
      const count=countsRaw[i]!==undefined?safeNumber(countsRaw[i]):0;
      limitedCounts.push(count);
    }
    if(!limitedKeywords.length) return null;
    const displayCandidate=
      resolveDisplayText(rawLabel, entry, kind==='field'?'field':'topic')
      || String(entry.display_label??entry.displayLabel??entry.topicName??rawLabel||'未分类');
    return {
      label: rawLabel,
      displayLabel: displayCandidate,
      keywords: limitedKeywords,
      weights: limitedWeights,
      counts: limitedCounts,
      documentCount: safeNumber(entry.document_count??entry.documentCount??entry.count??0),
      totalTokens: safeNumber(entry.total_tokens??entry.totalTokens??0),
    };
  };

  const rawDashboard=Array.isArray(dimData.keyword_dashboard)?dimData.keyword_dashboard:[];
  rawDashboard.forEach(entry=>{
    const normalized=normalizeEntry(entry);
    if(normalized) entries.push(normalized);
  });
  if(entries.length){
    return entries;
  }

  const categories=Array.isArray(dimData.categories)?dimData.categories:[];
  categories.forEach(cat=>{
    if(!cat) return;
    const words=Array.isArray(cat.top_words)?cat.top_words:[];
    const keywords=[];
    const weights=[];
    const counts=[];
    for(let i=0;i<words.length && keywords.length<KEYWORD_BAR_LIMIT;i+=1){
      const word=words[i];
      if(!word) continue;
      const token=String(word.token??'').trim();
      if(!token) continue;
      keywords.push(token);
      weights.push(normalizeKeywordWeight(word.weight));
      counts.push(safeNumber(word.count??0));
    }
    const entry={
      label: cat.label??'',
      display_label: cat.display_label??'',
      keywords,
      weights,
      counts,
      document_count: cat.count??0,
      total_tokens: cat.total_tokens??0,
    };
    const normalized=normalizeEntry(entry);
    if(normalized) entries.push(normalized);
  });
  return entries;
}

function resizeKeywordCharts(dim){
  const store=TOPIC_KEYWORD_CHARTS[dim];
  if(!store) return;
  store.forEach(chart=>{
    if(!chart || typeof chart.resize!=='function') return;
    const dom=typeof chart.getDom==='function'?chart.getDom():chart._dom||chart._domRoot||chart.dom;
    if(dom && isChartHidden(dom)) return;
    try{ chart.resize(); }catch(e){}
  });
}

function clearTopicVizCharts(dim){
  ['words','scatter'].forEach(type=>{
    const el = getTopicVizChartEl(dim, type);
    if(type==='words'){
      disposeKeywordCharts(dim);
    }else if(el && window.Plotly){
      try{ Plotly.purge(el); }catch(e){}
    }
    if(el){
      el.innerHTML='';
    }
  });
  const cfg = getTopicVizConfig(dim);
  if(cfg){
    const keywordHint = document.querySelector(cfg.keywordHintSelector);
    if(keywordHint){ keywordHint.textContent=''; }
    const scatterHint = document.querySelector(cfg.scatterHintSelector);
    if(scatterHint){ scatterHint.textContent=''; }
  }
}

function disableWordCloudDownload(el){
  if(!el) return;
  el.href='#';
  el.setAttribute('aria-disabled','true');
  el.classList.add('word-cloud-download-btn-disabled');
  el.removeAttribute('download');
}

function enableWordCloudDownload(el, url, filename){
  if(!el) return;
  if(!url){
    disableWordCloudDownload(el);
    return;
  }
  el.href=url;
  if(filename){
    el.setAttribute('download', filename);
  }
  el.removeAttribute('aria-disabled');
  el.classList.remove('word-cloud-download-btn-disabled');
}

function resetWordCloudVisual(message){
  const imgEl=qs(WORD_CLOUD_IMAGE_ID);
  const msgEl=qs(WORD_CLOUD_IMAGE_MESSAGE_ID);
  const pngBtn=qs(WORD_CLOUD_DOWNLOAD_PNG_ID);
  const svgBtn=qs(WORD_CLOUD_DOWNLOAD_SVG_ID);
  if(imgEl){
    imgEl.src='';
    imgEl.classList.add('hidden');
    imgEl.alt='词云图预览';
  }
  if(msgEl){
    const text=message || WORD_CLOUD_DEFAULT_HINT;
    msgEl.textContent=text;
    msgEl.classList.remove('hidden');
  }
  disableWordCloudDownload(pngBtn);
  disableWordCloudDownload(svgBtn);
}

function resetTopicVizState(){
  TOPIC_VIZ_STATE.fetchedSession='';
  TOPIC_VIZ_STATE.loading=false;
  TOPIC_VIZ_STATE.data={ topic:null, field:null };
  TOPIC_VIZ_STATE.selected={ topic:null, field:null };
  TOPIC_VIZ_DIMENSIONS.forEach(dim=>{
    clearTopicVizCharts(dim);
    const cfg=getTopicVizConfig(dim);
    if(cfg){
      const listEl=document.querySelector(cfg.listSelector);
      if(listEl){ listEl.innerHTML=''; }
    }
    const message = SESSION_ID ? '语义可视化数据加载中…' : '请先上传或载入会话以加载语义可视化。';
    setTopicVizMessage(dim, message);
  });
  resetWordCloudSection();
}

function updateTopicVizListActive(dim){
  const cfg = getTopicVizConfig(dim);
  const list = document.querySelector(cfg.listSelector);
  if(!list) return;
  const selected = TOPIC_VIZ_STATE.selected[dim] || '';
  list.querySelectorAll('.topic-viz-item').forEach(btn=>{
    const label = btn.dataset.label || '';
    const isActive = label === selected;
    btn.classList.toggle('topic-viz-item-active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}

function renderTopicVizKeywords(dim, category){
  const cfg = getTopicVizConfig(dim);
  const chartEl = getTopicVizChartEl(dim, 'words');
  if(!chartEl) return;
  const hintEl = cfg ? document.querySelector(cfg.keywordHintSelector) : null;

  const dashboard = getKeywordDashboardData(dim);
  const targetLabel = category?.label ? String(category.label) : '';

  disposeKeywordCharts(dim);
  chartEl.innerHTML='';

  if(!dashboard.length){
    if(hintEl){ hintEl.textContent='暂无关键词数据。'; }
    chartEl.innerHTML='<div class="topic-viz-empty">暂无关键词数据。</div>';
    return;
  }

  const totalDocs = dashboard.reduce((sum,item)=>sum+safeNumber(item.documentCount||0),0);
  const summaryParts=[`分类 ${dashboard.length} 个`];
  if(totalDocs>0){ summaryParts.push(`覆盖文献 ${totalDocs}`); }
  if(hintEl){ hintEl.textContent=summaryParts.join(' · '); }

  const grid=document.createElement('div');
  grid.className='topic-keyword-grid';
  chartEl.appendChild(grid);

  const store = TOPIC_KEYWORD_CHARTS[dim] || new Map();
  if(!TOPIC_KEYWORD_CHARTS[dim]){
    TOPIC_KEYWORD_CHARTS[dim]=store;
  }

  let activeFound=false;

  dashboard.forEach((item,index)=>{
    const card=document.createElement('article');
    card.className='topic-keyword-card';
    card.dataset.keywordLabel=item.label||'';
    if(targetLabel && item.label===targetLabel){
      card.classList.add('topic-keyword-card-active');
      activeFound=true;
    }

    const header=document.createElement('div');
    header.className='topic-keyword-card-header';
    const title=document.createElement('h5');
    title.className='topic-keyword-card-title';
    title.textContent=item.displayLabel||'未分类';
    header.appendChild(title);
    const meta=document.createElement('div');
    meta.className='topic-keyword-card-meta';
    const docCount=safeNumber(item.documentCount||0);
    const tokenCount=safeNumber(item.totalTokens||0);
    const docText=`文献 <strong>${docCount}</strong> 篇`;
    const tokenText=tokenCount>0?`词频 <strong>${tokenCount}</strong>`:'词频不足';
    meta.innerHTML=`<span>${docText}</span><span>${tokenText}</span>`;
    header.appendChild(meta);
    card.appendChild(header);

    const chartContainer=document.createElement('div');
    chartContainer.className='topic-keyword-chart';
    chartContainer.id=`topic_keyword_chart_${dim}_${index}`;
    card.appendChild(chartContainer);
    grid.appendChild(card);

    if(!window.echarts){
      chartContainer.innerHTML='<div class="topic-viz-empty">ECharts 未加载</div>';
      return;
    }

    const keywords=item.keywords.slice(0, KEYWORD_BAR_LIMIT);
    const weights=item.weights.slice(0, keywords.length).map(normalizeKeywordWeight);
    const counts=Array.isArray(item.counts)?item.counts.slice(0, keywords.length).map(val=>safeNumber(val)):keywords.map(()=>0);
    const color=KEYWORD_COLOR_PALETTE[index % KEYWORD_COLOR_PALETTE.length];

    const chart=echarts.init(chartContainer);
    store.set(chartContainer.id, chart);

    chart.setOption({
      color:[color],
      animationDuration:450,
      grid:{ top:36, left:24, right:12, bottom:60 },
      tooltip:{
        trigger:'axis',
        axisPointer:{ type:'shadow' },
        formatter: params=>{
          if(!Array.isArray(params) || !params.length) return '';
          const first=params[0];
          const value=Number(first.value||0);
          const percent=value*100;
          const percentText=percent>=10?`${percent.toFixed(1)}%`:`${percent.toFixed(2)}%`;
          const countVal=Number(first.data?.count);
          const countText=Number.isFinite(countVal) && countVal>0 ? ` · 词频 ${countVal}` : '';
          return `${first.name}<br/>权重 ${percentText}${countText}`;
        },
      },
      xAxis:{
        type:'category',
        data:keywords,
        axisLabel:{ interval:0, rotate:32, color:'#475569', fontSize:11 },
        axisTick:{ alignWithLabel:true },
        axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.45)' } },
      },
      yAxis:{
        type:'value',
        axisLabel:{
          color:'#475569',
          fontSize:11,
          formatter:value=>{
            const num=Number(value)||0;
            const percent=num*100;
            return percent>=10?`${percent.toFixed(0)}%`:`${percent.toFixed(1)}%`;
          },
        },
        splitLine:{ lineStyle:{ color:'rgba(148,163,184,0.25)' } },
      },
      series:[{
        type:'bar',
        barMaxWidth:36,
        data:weights.map((val,idx)=>({ value:val, count:counts[idx], name:keywords[idx] })),
        label:{
          show:true,
          position:'top',
          fontSize:10,
          color:'#0f172a',
          formatter:params=>{
            const val=Number(params.value||0);
            if(!Number.isFinite(val) || val<=0){
              return '';
            }
            const percent=val*100;
            const percentText=percent>=10?`${percent.toFixed(1)}%`:`${percent.toFixed(2)}%`;
            const count=Number(params.data?.count);
            if(Number.isFinite(count) && count>0){
              return `${percentText}\n(${count})`;
            }
            return percentText;
          },
        },
      }],
    });

    setTimeout(()=>{
      try{ chart.resize(); }catch(e){}
    },0);
  });

  if(!activeFound){
    const firstCard=grid.querySelector('.topic-keyword-card');
    if(firstCard){
      firstCard.classList.add('topic-keyword-card-active');
    }
  }

  if(targetLabel){
    const targetCard=grid.querySelector('.topic-keyword-card-active');
    if(targetCard && typeof targetCard.scrollIntoView==='function'){
      targetCard.scrollIntoView({ behavior:'smooth', block:'nearest' });
    }
  }
}

function renderTopicVizScatter(dim){
  const cfg = getTopicVizConfig(dim);
  const chartEl = getTopicVizChartEl(dim, 'scatter');
  if(!chartEl) return;
  const hintEl = cfg ? document.querySelector(cfg.scatterHintSelector) : null;
  const scatter = TOPIC_VIZ_STATE.data[dim]?.scatter || {};
  const points = Array.isArray(scatter.points) ? scatter.points : [];
  const clusterCount = safeNumber(scatter.cluster_count||0);
  const clusterAlgoRaw = (scatter.cluster_algorithm||'').toString();
  const clusterAlgo = clusterAlgoRaw ? clusterAlgoRaw.toUpperCase() : '';
  const explained = safeNumber(scatter.explained_variance||0)*100;
  const pipelineText = (scatter.pipeline_text||'').toString();
  const docTotal = safeNumber(scatter.document_total||0);
  const summaryText = (scatter.summary||'').toString();
  const fallbackSummaryParts=[];
  if(clusterCount>1){
    fallbackSummaryParts.push(`${clusterAlgo||'聚类'} · ${clusterCount} 簇`);
  }else{
    fallbackSummaryParts.push('未进一步聚类');
  }
  if(explained>0){
    fallbackSummaryParts.push(`方差解释 ${explained.toFixed(1)}%`);
  }
  if(pipelineText){
    fallbackSummaryParts.push(`语义管线：${pipelineText}`);
  }
  if(docTotal>0){
    fallbackSummaryParts.push(`覆盖文献 ${docTotal}`);
  }
  if(hintEl){
    const text = summaryText || fallbackSummaryParts.filter(Boolean).join(' · ');
    hintEl.textContent = text;
  }

  const pngUrl = (scatter.png_data_url||'').toString();
  const svgUrl = (scatter.svg_data_url||'').toString();
  if(pngUrl){
    if(window.Plotly){
      try{ Plotly.purge(chartEl); }catch(e){}
    }
    SCATTER_STATE.hasData=false;
    chartEl.innerHTML='';
    const wrapper=document.createElement('div');
    wrapper.className='topic-viz-scatter-image-wrapper';
    const img=document.createElement('img');
    img.className='topic-viz-scatter-image';
    img.loading='lazy';
    img.src=pngUrl;
    const dimLabel=TOPIC_VIZ_LABELS[dim]||'语义二维映射';
    img.alt=`${dimLabel} 语义二维映射`;
    wrapper.appendChild(img);
    chartEl.appendChild(wrapper);

    const downloads=document.createElement('div');
    downloads.className='topic-viz-scatter-downloads';
    const pngLink=document.createElement('a');
    pngLink.className='topic-viz-keyword-download-btn';
    pngLink.href=pngUrl;
    pngLink.download=(scatter.png_filename||'semantic_map.png').toString();
    pngLink.textContent='下载 PNG';
    downloads.appendChild(pngLink);
    if(svgUrl){
      const svgLink=document.createElement('a');
      svgLink.className='topic-viz-keyword-download-btn';
      svgLink.href=svgUrl;
      svgLink.download=(scatter.svg_filename||'semantic_map.svg').toString();
      svgLink.textContent='下载 SVG';
      downloads.appendChild(svgLink);
    }
    chartEl.appendChild(downloads);
    return;
  }

  if(!window.Plotly){
    chartEl.innerHTML='<div class="topic-viz-empty">Plotly 未加载</div>';
    return;
  }
  if(!points.length){
    try{ Plotly.purge(chartEl); }catch(e){}
    chartEl.innerHTML='<div class="topic-viz-empty">语料不足，暂无法生成二维映射。</div>';
    if(hintEl){ hintEl.textContent='语料不足，暂无法生成二维映射。'; }
    return;
  }

  const sortedIndices = points.map((_,idx)=>idx).sort((a,b)=>safeNumber(points[b]?.count||0)-safeNumber(points[a]?.count||0));
  const labelCount = Math.min(12, points.length);
  const labelSet = new Set(sortedIndices.slice(0,labelCount));
  const showClusters = clusterCount>1;
  const counts = points.map(p=>Math.max(0, safeNumber(p?.count||0)));
  const kind = dim==='field' ? 'field' : 'topic';
  const displayLabels = points.map(p=>resolveDisplayText(p?.label||'', p?.display_label||getDisplayFromSource(p), kind));
  const sqrtCounts = counts.map(cnt=>Math.sqrt(cnt));
  const MIN_MARKER_SIZE = 12;
  const MAX_MARKER_SIZE = 64;
  const minSqrt = Math.min(...sqrtCounts);
  const maxSqrt = Math.max(...sqrtCounts);
  const sizeRange = MAX_MARKER_SIZE - MIN_MARKER_SIZE;
  const hasNonZeroCount = counts.some(cnt=>cnt>0);
  const markerSizes = sqrtCounts.map(val=>{
    if(!Number.isFinite(val)) return MIN_MARKER_SIZE;
    if(maxSqrt <= minSqrt){
      return hasNonZeroCount ? MIN_MARKER_SIZE + sizeRange / 2 : MIN_MARKER_SIZE;
    }
    const normalized = (val - minSqrt) / (maxSqrt - minSqrt);
    return MIN_MARKER_SIZE + normalized * sizeRange;
  });
  const trace={
    type: points.length>400 ? 'scattergl' : 'scatter',
    mode: points.length<=labelCount ? 'markers+text' : 'markers',
    x: points.map(p=>safeNumber(p?.x||0)),
    y: points.map(p=>safeNumber(p?.y||0)),
    text: points.map((p,idx)=> labelSet.has(idx) ? displayLabels[idx] : ''),
    textposition:'top center',
    marker:{
      size: markerSizes,
      color: points.map(p=>{
        if(!showClusters){ return '#2563eb'; }
        const idx = Math.abs(Number.parseInt(p?.cluster ?? 0,10)) % TOPIC_VIZ_COLORS.length;
        return TOPIC_VIZ_COLORS[idx] || '#2563eb';
      }),
      opacity:0.9,
      line:{width:1,color:'rgba(15,23,42,0.4)'}
    },
    hovertemplate: points.map((p,idx)=>{
      const label = escapeHtml(displayLabels[idx]||'Unmapped');
      const cnt = safeNumber(p?.count||0);
      const cluster = p?.cluster;
      const clusterText = showClusters ? `<br>簇：${cluster}` : '';
      return `${label}<br>文献：${cnt}${clusterText}`;
    }),
    hoverinfo:'text',
  };
  const layout={
    margin:{l:40,r:16,t:36,b:42},
    autosize:true,
    height:360,
    hovermode:'closest',
    legend:{orientation:'h',yanchor:'top',y:-0.18},
    xaxis:{title:'PC1',zeroline:false},
    yaxis:{title:'PC2',zeroline:false}
  };

  SCATTER_STATE.hasData=true;
  ensureScatterObserver();
  let plotPromise;
  try{
    plotPromise=Plotly.react(chartEl, [trace], layout, {...SCATTER_CONFIG});
  }catch(err){
    console.error('Plotly 渲染失败', err);
    chartEl.innerHTML='<div class="topic-viz-empty">可视化渲染失败</div>';
    SCATTER_STATE.hasData=false;
    return;
  }
  if(plotPromise && typeof plotPromise.then==='function'){
    plotPromise.then(()=>{ scheduleScatterResize(); }).catch(()=>{});
  }else{
    scheduleScatterResize();
  }
}

function renderTopicVizList(dim){
  const cfg = getTopicVizConfig(dim);
  const listEl = document.querySelector(cfg.listSelector);
  if(!listEl) return;
  listEl.innerHTML='';
  const data = TOPIC_VIZ_STATE.data[dim];
  const categories = Array.isArray(data?.categories) ? data.categories : [];
  if(!categories.length){
    listEl.innerHTML='<div class="topic-viz-empty">暂无分类数据。</div>';
    TOPIC_VIZ_STATE.selected[dim]=null;
    clearTopicVizCharts(dim);
    return;
  }
  categories.forEach(cat=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='topic-viz-item';
    btn.dataset.topicvizItem=dim;
    btn.dataset.label=cat.label||'';
    const displayLabel=resolveDisplayText(cat.label||'', getDisplayFromSource(cat), dim==='field'?'field':'topic');
    btn.innerHTML=`<span class="truncate flex-1 text-left">${escapeHtml(displayLabel)}</span><span class="topic-viz-item-count">${safeNumber(cat.count||0)}</span>`;
    btn.addEventListener('click',()=>selectTopicVizCategory(dim, cat.label));
    listEl.appendChild(btn);
  });
  const desired = TOPIC_VIZ_STATE.selected[dim] && categories.some(cat=>cat.label===TOPIC_VIZ_STATE.selected[dim])
    ? TOPIC_VIZ_STATE.selected[dim]
    : categories[0].label;
  selectTopicVizCategory(dim, desired);
}

function renderWordCloudList(dim){
  const cfg=getWordCloudConfig(dim);
  if(!cfg) return;
  const list=document.getElementById(cfg.listId);
  if(!list) return;
  list.innerHTML='';
  const categories = Array.isArray(TOPIC_VIZ_STATE.data[dim]?.categories) ? TOPIC_VIZ_STATE.data[dim].categories : [];
  if(!SESSION_ID){
    setWordCloudMessage(dim,'请先上传或载入会话以加载词云数据。');
    return;
  }
  if(!categories.length){
    setWordCloudMessage(dim,'暂无可展示的分类数据。');
    return;
  }
  setWordCloudMessage(dim,'点击任意分类查看词云。');
  categories.forEach(cat=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='word-cloud-item';
    btn.dataset.wordcloudDim=dim;
    btn.dataset.label=cat.label||'';
    const displayLabel=resolveDisplayText(cat.label||'', getDisplayFromSource(cat), dim==='field'?'field':'topic');
    btn.innerHTML=`<span class="word-cloud-item-label">${escapeHtml(displayLabel)}</span><span class="word-cloud-item-count">${safeNumber(cat.count||0)}</span>`;
    btn.addEventListener('click',()=>openWordCloudDialog(dim, cat.label));
    list.appendChild(btn);
  });
}

function refreshWordCloudLists(){
  WORD_CLOUD_DIMENSIONS.forEach(dim=>renderWordCloudList(dim));
}

function selectTopicVizCategory(dim, label){
  const data = TOPIC_VIZ_STATE.data[dim];
  const categories = Array.isArray(data?.categories) ? data.categories : [];
  if(!categories.length){
    TOPIC_VIZ_STATE.selected[dim]=null;
    clearTopicVizCharts(dim);
    return;
  }
  const target = categories.find(cat=>cat.label===label) || categories[0];
  TOPIC_VIZ_STATE.selected[dim] = target ? target.label : null;
  updateTopicVizListActive(dim);
  try{
    renderTopicVizKeywords(dim, target || null);
  }catch(err){
    console.error('关键词图渲染失败', err);
  }
}

function renderTopicVizPanel(dim){
  renderTopicVizList(dim);
  renderTopicVizScatter(dim);
}

function getWordCloudEntries(category){
  if(!category) return [];
  const words=Array.isArray(category.top_words)?category.top_words:[];
  return words
    .map(item=>{
      if(!item) return null;
      const name=(item.token||'').toString().trim()||'未命名';
      const count=safeNumber(item.count||0);
      const weightRaw=Number(item.weight);
      const weight=Number.isFinite(weightRaw)?weightRaw:null;
      const value=count>0?count:(weight!==null&&weight>0?weight*1000:0);
      if(value<=0) return null;
      return { name, count, weight, value };
    })
    .filter(Boolean)
    .sort((a,b)=>{
      if(b.count!==a.count) return b.count-a.count;
      if(b.value!==a.value) return b.value-a.value;
      return a.name.localeCompare(b.name,'zh-Hans');
    })
    .slice(0,50);
}

async function renderWordCloudVisual(dim, category){
  const imgEl=qs(WORD_CLOUD_IMAGE_ID);
  const msgEl=qs(WORD_CLOUD_IMAGE_MESSAGE_ID);
  const pngBtn=qs(WORD_CLOUD_DOWNLOAD_PNG_ID);
  const svgBtn=qs(WORD_CLOUD_DOWNLOAD_SVG_ID);
  resetWordCloudVisual('词云图生成中…');
  const requestToken=++WORD_CLOUD_REQUEST_TOKEN;
  if(!SESSION_ID){
    if(msgEl){ msgEl.textContent='请先上传或载入会话以加载词云数据。'; }
    return;
  }
  if(!category){
    if(msgEl){ msgEl.textContent='暂无可展示的分类数据。'; }
    return;
  }
  const entries=getWordCloudEntries(category);
  if(!entries.length){
    if(msgEl){ msgEl.textContent='该分类暂未提取出可视化所需的词频数据。'; }
    return;
  }
  if(msgEl){
    msgEl.textContent='词云图生成中…';
    msgEl.classList.remove('hidden');
  }
  const params=new URLSearchParams();
  params.set('session_id', SESSION_ID);
  params.set('dimension', dim);
  if(category?.label){ params.set('label', category.label); }
  params.set('t', Date.now().toString());
  let data=null;
  try{
    const resp=await fetch(`/word_cloud_assets?${params.toString()}`,{cache:'no-store'});
    if(!resp.ok){
      const errText=await resp.text();
      const message=errText?`词云生成失败：${errText}`:'词云生成失败。';
      if(requestToken===WORD_CLOUD_REQUEST_TOKEN && msgEl){ msgEl.textContent=message; }
      return;
    }
    data=await resp.json();
  }catch(err){
    console.error('词云生成接口异常', err);
    if(requestToken===WORD_CLOUD_REQUEST_TOKEN && msgEl){ msgEl.textContent='词云生成失败，请稍后重试。'; }
    return;
  }
  if(requestToken!==WORD_CLOUD_REQUEST_TOKEN){
    return;
  }
  if(!data || data.ok!==true){
    const fallback=(data && data.message)?data.message:'暂无词频数据。';
    if(msgEl){ msgEl.textContent=fallback; }
    return;
  }
  const pngUrl=(data.png_data_url||'').toString();
  const svgUrl=(data.svg_data_url||'').toString();
  if(!pngUrl){
    if(msgEl){ msgEl.textContent='词云生成失败，请稍后重试。'; msgEl.classList.remove('hidden'); }
    return;
  }
  if(imgEl && pngUrl){
    const displayLabel=resolveDisplayText(category?.label||'', getDisplayFromSource(category), dim==='field'?'field':'topic');
    imgEl.src=pngUrl;
    imgEl.alt=`${displayLabel||'Unmapped'} word cloud`;
    imgEl.classList.remove('hidden');
  }
  if(msgEl){
    msgEl.textContent='';
    msgEl.classList.add('hidden');
  }
  enableWordCloudDownload(pngBtn, pngUrl, data.png_filename||'wordcloud.png');
  enableWordCloudDownload(svgBtn, svgUrl, data.svg_filename||'wordcloud.svg');
  const metaEl=qs('word_cloud_dialog_meta');
  if(metaEl){
    const baseMeta=metaEl.dataset?.baseMeta || metaEl.dataset?.basemeta || metaEl.textContent || '';
    const wordsUsedRaw=Number(data.words_used);
    if(Number.isFinite(wordsUsedRaw) && wordsUsedRaw>0){
      const metaParts=baseMeta ? [baseMeta] : [];
      metaParts.push(`词条 ${wordsUsedRaw}`);
      metaEl.textContent=metaParts.join(' · ');
    }else if(baseMeta){
      metaEl.textContent=baseMeta;
    }
  }
}

function renderWordCloudTable(category){
  const container=document.getElementById('word_cloud_table');
  if(!container) return;
  container.innerHTML='';
  const entries=getWordCloudEntries(category);
  if(!entries.length){
    container.innerHTML='<div class="word-cloud-table-empty">暂无词频数据。</div>';
    return;
  }
  const rowsHtml=entries.map((item,idx)=>{
    const percentText=Number.isFinite(item.weight) && item.weight>0 ? `${(item.weight*100).toFixed(1)}%` : '—';
    return `<tr><td>${escapeHtml(item.name)}</td><td>${safeNumber(item.count||0)}</td><td>${percentText}</td></tr>`;
  }).join('');
  container.innerHTML=`<table><thead><tr><th>词条</th><th>词频</th><th>占比</th></tr></thead><tbody>${rowsHtml}</tbody></table>`;
}

function openWordCloudDialog(dim, label){
  const cfg=getWordCloudConfig(dim);
  if(!cfg) return;
  const categories=Array.isArray(TOPIC_VIZ_STATE.data[dim]?.categories)?TOPIC_VIZ_STATE.data[dim].categories:[];
  if(!categories.length){
    showToast('暂无可用的词云数据', 'info');
    return;
  }
  const target=categories.find(cat=>cat.label===label) || categories[0];
  const dialog=document.getElementById('dlg_word_cloud');
  if(!dialog){
    console.warn('词云弹窗未找到');
    return;
  }
  const titleEl=qs('word_cloud_dialog_title');
  if(titleEl){
    const displayLabel=resolveDisplayText(target?.label||'', getDisplayFromSource(target), dim==='field'?'field':'topic');
    titleEl.textContent=`${displayLabel} · ${cfg.label}`;
  }
  const metaEl=qs('word_cloud_dialog_meta');
  if(metaEl){
    const docCount=safeNumber(target?.count||0);
    const totalTokens=safeNumber(target?.total_tokens||0);
    const parts=[`文献 ${docCount} 篇`];
    if(totalTokens>0){ parts.push(`词频 ${totalTokens}`); }
    const baseMeta=parts.join(' · ');
    metaEl.textContent=baseMeta;
    metaEl.dataset.baseMeta=baseMeta;
  }
  renderWordCloudVisual(dim, target||null);
  renderWordCloudTable(target||null);
  if(typeof dialog.showModal==='function'){
    dialog.showModal();
  }else{
    dialog.setAttribute('open','true');
  }
}

function closeWordCloudDialog(){
  const dialog=document.getElementById('dlg_word_cloud');
  if(!dialog) return;
  resetWordCloudVisual();
  if(typeof dialog.close==='function'){
    dialog.close();
  }else{
    dialog.removeAttribute('open');
  }
}

async function fetchTopicVisuals(options={}){
  if(!SESSION_ID){
    resetTopicVizState();
    return;
  }
  const force = options.force === true;
  if(TOPIC_VIZ_STATE.loading) return;
  if(!force && TOPIC_VIZ_STATE.fetchedSession === SESSION_ID){
    renderTopicVizPanel(TOPIC_VIZ_STATE.active);
    return;
  }
  const currentSession = SESSION_ID;
  TOPIC_VIZ_STATE.loading=true;
  TOPIC_VIZ_DIMENSIONS.forEach(dim=>setTopicVizMessage(dim,'语义可视化数据加载中…'));
  WORD_CLOUD_DIMENSIONS.forEach(dim=>{
    clearWordCloudList(dim);
    setWordCloudMessage(dim,'词云数据加载中…');
  });
  try{
    const r=await fetch(`/topic_visuals?session_id=${encodeURIComponent(currentSession)}&t=${Date.now()}`,{cache:'no-store'});
    if(!r.ok){
      const errText = await r.text();
      const msg = errText ? `加载失败：${errText}` : `加载失败：${r.status}`;
      TOPIC_VIZ_DIMENSIONS.forEach(dim=>{
        setTopicVizMessage(dim, msg);
        clearTopicVizCharts(dim);
      });
      TOPIC_VIZ_STATE.fetchedSession='';
      return;
    }
    const data=await r.json();
    if(currentSession !== SESSION_ID){
      return;
    }
    TOPIC_VIZ_STATE.data.topic = data?.topic_adj || { categories:[], scatter:{} };
    TOPIC_VIZ_STATE.data.field = data?.field_adj || { categories:[], scatter:{} };
    TOPIC_VIZ_STATE.fetchedSession = currentSession;
    TOPIC_VIZ_DIMENSIONS.forEach(dim=>{
      const categories = Array.isArray(TOPIC_VIZ_STATE.data[dim]?.categories) ? TOPIC_VIZ_STATE.data[dim].categories : [];
      if(categories.length){
        setTopicVizMessage(dim, '');
        setWordCloudMessage(dim, '点击任意分类查看词云。');
      }else{
        setTopicVizMessage(dim, '暂无可展示的分类数据。');
        clearWordCloudList(dim);
        setWordCloudMessage(dim, '暂无可展示的分类数据。');
      }
    });
    renderTopicVizPanel(TOPIC_VIZ_STATE.active);
    refreshWordCloudLists();
    resizeTopicVizCharts();
  }catch(err){
    const msg = err?.message ? `加载失败：${err.message}` : '加载失败：未知错误';
    TOPIC_VIZ_DIMENSIONS.forEach(dim=>{
      setTopicVizMessage(dim, msg);
      clearTopicVizCharts(dim);
      clearWordCloudList(dim);
      setWordCloudMessage(dim, msg);
    });
    TOPIC_VIZ_STATE.fetchedSession='';
  }finally{
    TOPIC_VIZ_STATE.loading=false;
  }
}

async function ensureTopicVizData(dim, options={}){
  if(!SESSION_ID){
    resetTopicVizState();
    return;
  }
  const force = options.force === true;
  if(!force && TOPIC_VIZ_STATE.fetchedSession === SESSION_ID){
    renderTopicVizPanel(dim);
    return;
  }
  await fetchTopicVisuals({force});
}

function setTopicVizTab(dim, options={}){
  const target = TOPIC_VIZ_DIMENSIONS.includes(dim) ? dim : 'topic';
  const force = options.force === true;
  TOPIC_VIZ_STATE.active = target;
  document.querySelectorAll('[data-topicviz-tab]').forEach(btn=>{
    const isActive = btn.dataset.topicvizTab === target;
    btn.classList.toggle('topic-viz-tab-active', isActive);
    btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
  });
  document.querySelectorAll('[data-topicviz-panel]').forEach(panel=>{
    const isActive = panel.dataset.topicvizPanel === target;
    panel.classList.toggle('hidden', !isActive);
  });
  ensureTopicVizData(target, {force});
  setTimeout(()=>resizeTopicVizCharts(), 120);
}

function resizeTopicVizCharts(){
  TOPIC_VIZ_DIMENSIONS.forEach(dim=>{
    resizeKeywordCharts(dim);
    if(!window.Plotly) return;
    const el=getTopicVizChartEl(dim,'scatter');
    if(!el) return;
    if(isChartHidden(el)) return;
    if(!el.querySelector('.plotly')) return;
    try{ Plotly.Plots.resize(el); }catch(e){}
  });
}

window.addEventListener('resize',()=>{
  resizeVisibleTreemaps();
  resizeVisibleBarCharts();
  resizeVisibleJournalCharts();
  scheduleScatterResize();
  resizeTimelineCharts();
  resizeTopicVizCharts();
});
async function refreshStats(){
  if(!SESSION_ID) return;
  const bin=Number.isFinite(TIMELINE_BIN_SIZE)?TIMELINE_BIN_SIZE:5;
  const r=await fetch(`/stats?session_id=${encodeURIComponent(SESSION_ID)}&bin_years=${encodeURIComponent(bin)}`,{cache:"no-store"}); if(!r.ok) return;
  const d=await r.json();
  renderChips("chips_topic_adj", d.topic_adj, "topic_adj", { primaryLabel:'篇数' });
  renderChips("chips_field_adj", d.field_adj, "field_adj", { primaryLabel:'篇数' });
  setCategoryData('topic_adj', d.topic_adj, { primaryLabel:'篇数', rootLabel:'研究主题（调整）', limit:24, kind:'topic' });
  setCategoryData('field_adj', d.field_adj, { primaryLabel:'篇数', rootLabel:'研究领域（调整）', limit:24, kind:'field' });
  qs('total_msg').textContent=`行数：${d.total}`;
  renderTimelineCharts(d.timeline);
  setJournalSourceAvailability(!!d.journal_source_available);
  setJournalData('topic', d.journal_topic_adj);
  setJournalData('field', d.journal_field_adj);

  const collectLabels=arr=>Array.isArray(arr)?arr.map(x=>x.label).filter(Boolean):[];
  const topicLabels=[...collectLabels(d.topic_orig), ...collectLabels(d.topic_adj)];
  const fieldLabels=[...collectLabels(d.field_orig), ...collectLabels(d.field_adj)];
  ingestLabelMappingCandidates('topic', topicLabels);
  ingestLabelMappingCandidates('field', fieldLabels);
  TOPIC_LIST=topicLabels.length?Array.from(new Set(topicLabels)):[...DEF_TOPICS];
  FIELD_LIST=fieldLabels.length?Array.from(new Set(fieldLabels)):[...DEF_FIELDS];
  populateFilterOptions();
  await fetchTopicVisuals({force:true});
  setJournalTab(JOURNAL_DIM||'topic');
  setVisualTab();
}

function getRankPlotElement(){
  return qs('rank_vis_plot');
}

function computeScatterHeight(el){
  const plotEl=el||getRankPlotElement();
  if(!plotEl) return SCATTER_DEFAULT_HEIGHT;
  const width=plotEl.clientWidth||plotEl.offsetWidth||0;
  if(!width) return SCATTER_DEFAULT_HEIGHT;
  const desired=Math.round(width*0.6);
  return Math.max(320, Math.min(desired, 580));
}

function applyScatterHeight(plotEl, height){
  if(!plotEl) return;
  const clamped=Math.max(320, Math.round(height||SCATTER_DEFAULT_HEIGHT));
  if(plotEl.style.height!==`${clamped}px`){
    plotEl.style.height=`${clamped}px`;
  }
  SCATTER_STATE.height=clamped;
}

function scheduleScatterResize(){
  if(!RANK_VIS_EXPANDED || !SCATTER_STATE.hasData) return;
  if(!window.Plotly) return;
  const plotEl=getRankPlotElement();
  if(!plotEl) return;
  if(SCATTER_STATE.resizeTimer){
    cancelAnimationFrame(SCATTER_STATE.resizeTimer);
  }
  SCATTER_STATE.resizeTimer=requestAnimationFrame(()=>{
    SCATTER_STATE.resizeTimer=0;
    try{ Plotly.Plots.resize(plotEl); }catch(e){}
  });
}

function ensureScatterObserver(){
  const plotEl=getRankPlotElement();
  if(!plotEl) return;
  if(typeof ResizeObserver!=='function') return;
  if(SCATTER_STATE.observer){
    return;
  }
  SCATTER_STATE.observer=new ResizeObserver(entries=>{
    if(!SCATTER_STATE.hasData) return;
    for(const entry of entries){
      if(entry.target!==plotEl) continue;
      const nextHeight=computeScatterHeight(plotEl);
      if(Math.abs(nextHeight-SCATTER_STATE.height)>2){
        applyScatterHeight(plotEl,nextHeight);
        if(window.Plotly){
          try{ Plotly.relayout(plotEl,{height:SCATTER_STATE.height}); }catch(e){}
        }
      }
    }
    scheduleScatterResize();
  });
  SCATTER_STATE.observer.observe(plotEl);
}

function clearScatterPlot(message){
  const plotEl=getRankPlotElement();
  if(plotEl && window.Plotly){ try{ Plotly.purge(plotEl); }catch(e){} }
  if(plotEl){
    plotEl.innerHTML="";
    plotEl.style.height='';
  }
  if(SCATTER_STATE.resizeTimer){
    cancelAnimationFrame(SCATTER_STATE.resizeTimer);
    SCATTER_STATE.resizeTimer=0;
  }
  SCATTER_STATE.hasData=false;
  const msg=qs('rank_vis_msg'); if(msg) msg.textContent=message||'等待计算后展示。';
}

function setVisualTab(){
  const target='adj';
  VISUAL_TAB = target;
  document.querySelectorAll('[data-vis-panel]').forEach(panel=>{
    const active = panel.dataset?.visPanel===target;
    panel.classList.toggle('hidden', !active);
    if(active){ panel.classList.remove('opacity-0'); }
  });
  const activePanel=document.querySelector(`[data-vis-panel="${target}"]`);
  if(activePanel){
    activePanel.querySelectorAll('[data-treemap-key]').forEach(div=>{
      if(window.Plotly){
        try{ Plotly.Plots.resize(div); }catch(e){}
      }
    });
    activePanel.querySelectorAll('[data-bar-key]').forEach(div=>{
      if(window.Plotly && !isChartHidden(div)){
        try{ Plotly.Plots.resize(div); }catch(e){}
      }
    });
    if(target==='adj'){
      renderDeferredJournalCharts();
      resizeVisibleJournalCharts();
    }
    resizeTimelineCharts();
  }
  renderDeferredTreemaps();
  renderDeferredBarCharts();
  document.querySelectorAll('[data-vis-tab]').forEach(btn=>{
    const active = btn.dataset?.visTab===target;
    btn.classList.toggle('vis-tab-btn-active', active);
    btn.setAttribute('aria-selected', active? 'true':'false');
    btn.tabIndex = active?0:-1;
  });
}

function setJournalTab(dim){
  const target = dim==='field' ? 'field' : 'topic';
  JOURNAL_DIM = target;
  document.querySelectorAll('[data-journal-panel]').forEach(panel=>{
    const active = panel.dataset?.journalPanel===target;
    panel.classList.toggle('hidden', !active);
  });
  document.querySelectorAll('[data-journal-toggle]').forEach(btn=>{
    const active = btn.dataset?.journalToggle===target;
    btn.classList.toggle('journal-toggle-active', active);
    btn.setAttribute('aria-pressed', active?'true':'false');
  });
  renderJournalPanel(target);
  renderDeferredJournalCharts();
  resizeVisibleJournalCharts();
}

function setRankVisExpanded(expanded){
  RANK_VIS_EXPANDED=!!expanded;
  const body=qs('rank_vis_body');
  if(body){
    if(RANK_VIS_EXPANDED) body.classList.remove('hidden');
    else body.classList.add('hidden');
  }
  const btn=qs('btn_toggle_vis');
  if(btn){
    btn.textContent=RANK_VIS_EXPANDED?"收起可视化":"展开可视化";
    btn.setAttribute('aria-expanded', RANK_VIS_EXPANDED?"true":"false");
  }
  if(RANK_VIS_EXPANDED){
    const plotEl=getRankPlotElement();
    if(plotEl){
      applyScatterHeight(plotEl, computeScatterHeight(plotEl));
    }
    ensureScatterObserver();
    scheduleScatterResize();
  }
}

function toggleRankVis(){
  setRankVisExpanded(!RANK_VIS_EXPANDED);
}

function renderScatterPlot(data){
  const plotEl=getRankPlotElement(); if(!plotEl) return;
  if(!window.Plotly){
    plotEl.innerHTML='<div class="p-3 text-sm text-red-600">Plotly 未加载</div>';
    SCATTER_STATE.hasData=false;
    return;
  }
  const coords=Array.isArray(data?.coords)?data.coords:[];
  if(!coords.length){ clearScatterPlot('暂无可视化数据'); return; }

  const toNum=v=>{
    const n=Number(v);
    return Number.isFinite(n)?n:0;
  };
  const safeCoord=(idx,dim)=>{
    const row=coords[idx];
    if(!Array.isArray(row)) return 0;
    return toNum(row[dim]??0);
  };

  const rawGroups=Array.isArray(data.groups)?data.groups:(Array.isArray(data.group_labels)?data.group_labels:[]);
  const groups=coords.map((_,i)=>{
    const g=rawGroups[i];
    if(g===undefined || g===null || g==='') return '未分类';
    return String(g);
  });
  const outliers=Array.isArray(data.outliers)?data.outliers.map(Boolean):coords.map(()=>false);
  const scores=Array.isArray(data.scores)?data.scores:[];
  const clusterLabels=Array.isArray(data.cluster_labels)?data.cluster_labels:[];

  const hoverTexts=coords.map((_,i)=>{
    const groupText=escapeHtml(groups[i]||'未分类');
    const score=scores[i]!==undefined && scores[i]!==null?Number(scores[i]).toFixed(4):'';
    const scoreTxt=score?`<br>Score：${score}`:'';
    const cluster=clusterLabels[i];
    const clusterTxt=(cluster!==undefined && cluster!==null)?`<br>簇：${escapeHtml(String(cluster))}`:'';
    const status=outliers[i]?'是':'否';
    return `类别：${groupText}<br>离群：${status}${scoreTxt}${clusterTxt}`;
  });

  const palette=['#2563eb','#f97316','#10b981','#a855f7','#facc15','#ec4899','#14b8a6','#0ea5e9','#f43f5e','#6366f1'];
  const traces=[];
  const normalGroups=Array.from(new Set(groups.filter((_,i)=>!outliers[i])));
  normalGroups.forEach((g,idx)=>{
    const indexes=[];
    groups.forEach((name,i)=>{ if(!outliers[i] && name===g) indexes.push(i); });
    if(!indexes.length) return;
    traces.push({
      name:g||`簇 ${idx+1}`,
      type:'scattergl',
      mode:'markers',
      x:indexes.map(i=>safeCoord(i,0)),
      y:indexes.map(i=>safeCoord(i,1)),
      text:indexes.map(i=>hoverTexts[i]),
      hovertemplate:'%{text}<extra></extra>',
      marker:{
        size:5,
        opacity:0.88,
        color:palette[idx%palette.length]
      }
    });
  });

  const outlierIdx=[];
  outliers.forEach((flag,i)=>{ if(flag) outlierIdx.push(i); });
  if(outlierIdx.length){
    traces.push({
      name:'离群',
      type:'scattergl',
      mode:'markers',
      x:outlierIdx.map(i=>safeCoord(i,0)),
      y:outlierIdx.map(i=>safeCoord(i,1)),
      text:outlierIdx.map(i=>hoverTexts[i]),
      hovertemplate:'%{text}<extra></extra>',
      marker:{size:7, color:'#ef4444', symbol:'x', opacity:0.95}
    });
  }

  if(!traces.length){
    traces.push({
      name:'数据',
      type:'scattergl',
      mode:'markers',
      x:coords.map((_,i)=>safeCoord(i,0)),
      y:coords.map((_,i)=>safeCoord(i,1)),
      text:hoverTexts,
      hovertemplate:'%{text}<extra></extra>',
      marker:{size:5, opacity:0.88, color:'#2563eb'}
    });
  }

  const desiredHeight=computeScatterHeight(plotEl);
  applyScatterHeight(plotEl, desiredHeight);

  const layout={
    margin:{l:40,r:16,t:36,b:42},
    autosize:true,
    height:SCATTER_STATE.height,
    hovermode:'closest',
    legend:{orientation:'h',yanchor:'top',y:-0.18},
    xaxis:{title:'PC1',zeroline:false},
    yaxis:{title:'PC2',zeroline:false}
  };

  SCATTER_STATE.hasData=true;
  ensureScatterObserver();
  let plotPromise;
  try{
    plotPromise=Plotly.react(plotEl, traces, layout, SCATTER_CONFIG);
  }catch(err){
    console.error('Plotly 渲染失败', err);
    plotEl.innerHTML='<div class="p-3 text-sm text-red-600">可视化渲染失败</div>';
    SCATTER_STATE.hasData=false;
    return;
  }
  if(plotPromise && typeof plotPromise.then==='function'){
    plotPromise.then(()=>{ scheduleScatterResize(); }).catch(()=>{});
  }else{
    scheduleScatterResize();
  }

  const msg=qs('rank_vis_msg');
  if(msg){
    const outCount=outliers.filter(Boolean).length;
    msg.textContent=`算法：${data.algorithm||'-'} · 分组列：${data.group_by||'-'} · 数据点：${coords.length} · 离群：${outCount} · 更新时间：${data.timestamp||''}`;
  }
}

async function fetchScatterAndRender(showStatus=false){
  if(!SESSION_ID){ clearScatterPlot('请先上传或载入会话'); return; }
  const msg=qs('rank_vis_msg');
  if(showStatus && msg) msg.textContent='加载可视化数据中…';
  try{
    const r=await fetch(`/ranking_scatter?session_id=${encodeURIComponent(SESSION_ID)}&t=${Date.now()}`,{cache:"no-store"});
    if(!r.ok){ clearScatterPlot('暂无可视化数据'); return; }
    const data=await r.json();
    renderScatterPlot(data);
  }catch(e){
    if(msg) msg.textContent='可视化加载失败：'+(e?.message||e);
  }
}

function handleAlgoChange(){
  const algo=qs('rank_algo').value;
  const wrapK=qs('wrap_k'); if(wrapK) wrapK.style.display=(algo==='kmeans')?'':'none';
  const wrapSigma=qs('wrap_sigma'); if(wrapSigma) wrapSigma.style.display=(algo==='hdbscan')?'none':'';
  const wrapMin=qs('wrap_min_cluster'); if(wrapMin) wrapMin.style.display=(algo==='hdbscan')?'':'none';
}
function quickFilter(target,value){ CURRENT_FILTER={target,value}; syncFilterControls(); PAGER.page=1; loadPage(); }
function populateFilterOptions(){
  const tSel=qs('filter_target'), vSel=qs('filter_value'); const target=CURRENT_FILTER.target||tSel.value;
  vSel.innerHTML=""; let opts=[]; if(target.startsWith("topic")) opts=TOPIC_LIST; else if(target.startsWith("field")) opts=FIELD_LIST;
  opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; vSel.appendChild(op); });
  populateBulkTarget();
}
function populateBulkTarget(){
  const list=(ACTIVE_COL==="topic")?TOPIC_LIST:FIELD_LIST;
  const bulk=qs('bulk_target'); bulk.innerHTML=""; list.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; bulk.appendChild(op); });
}
function syncSearchControls(){
  const scope=CURRENT_SEARCH.scope||SEARCH_SCOPE_DEFAULT;
  document.querySelectorAll('input[name="search_scope"]').forEach(radio=>{
    if(radio.value===scope){ radio.checked=true; }
    else{ radio.checked=false; }
  });
  const input=qs('search_keyword');
  if(input){ input.value=CURRENT_SEARCH.keyword||""; }
}
function syncFilterControls(){
  const tSel=qs('filter_target'); if(CURRENT_FILTER.target) tSel.value=CURRENT_FILTER.target;
  populateFilterOptions(); setTimeout(()=>{ const vSel=qs('filter_value'); if(CURRENT_FILTER.value){ for(let i=0;i<vSel.options.length;i++){ if(vSel.options[i].value===CURRENT_FILTER.value){ vSel.selectedIndex=i; break; } } } },0);
}
function applySearchKeyword(){
  const input=qs('search_keyword');
  if(!input) return;
  const rawKeyword=(input.value||"").trim();
  const radio=document.querySelector('input[name="search_scope"]:checked');
  const scope=radio?.value||SEARCH_SCOPE_DEFAULT;
  CURRENT_SEARCH={ scope, keyword:rawKeyword };
  PAGER.page=1;
  loadPage();
}
function clearSearchKeyword(){
  CURRENT_SEARCH={ scope:SEARCH_SCOPE_DEFAULT, keyword:"" };
  syncSearchControls();
  PAGER.page=1;
  loadPage();
}

/* ===================== 只编辑哪一列 ===================== */
function setActiveCol(v){
  ACTIVE_COL=(v==="field")?"field":"topic";
  qs('op_col_hint').textContent = (ACTIVE_COL==="topic")?"（仅显示并可编辑：研究主题（调整））":"（仅显示并可编辑：研究领域（调整））";
  populateBulkTarget(); PAGER.page=1; loadPage();
}

/* ===================== 分页 ===================== */
function renderPagerInfo(){
  qs('page_input').value=PAGER.page; qs('ps_input').value=PAGER.size;
  qs('page_total').textContent=PAGER.pages;
  qs('page_info').textContent=`第 ${PAGER.page} / ${PAGER.pages} 页 · 每页 ${PAGER.size} · 共 ${PAGER.total} 行`;
}

function setSortAvailability(hasRank){
  HAS_RANKING_DATA=!!hasRank;
  const select=qs('sort_select');
  if(select){
    Array.from(select.options).forEach(op=>{
      if(op.dataset.requiresRank==='1'){
        op.disabled=!HAS_RANKING_DATA;
      }
    });
    if(!HAS_RANKING_DATA && CURRENT_SORT.by==='rank'){
      CURRENT_SORT={by:"",order:""};
      select.value=SORT_VALUE_DEFAULT;
    }
  }
  const hint=qs('sort_hint');
  if(hint){
    if(!SESSION_ID){
      hint.textContent='';
    }else{
      hint.textContent = HAS_RANKING_DATA ? '' : '需先计算或载入智能排序结果';
    }
  }
}

function syncSortSelect(){
  const select=qs('sort_select');
  if(!select) return;
  let targetValue=SORT_VALUE_DEFAULT;
  if(CURRENT_SORT.by==='rank'){
    targetValue = (CURRENT_SORT.order==='desc') ? SORT_VALUE_RANK_DESC : SORT_VALUE_RANK_ASC;
  }
  if(select.value!==targetValue){
    select.value=targetValue;
  }
}

function handleSortChange(){
  const select=qs('sort_select');
  if(!select) return;
  const value=select.value;
  if((value===SORT_VALUE_RANK_ASC || value===SORT_VALUE_RANK_DESC) && !HAS_RANKING_DATA){
    select.value=SORT_VALUE_DEFAULT;
    CURRENT_SORT={by:"",order:""};
    showToast('当前数据缺少智能排序分数，请先运行智能排序', 'warning');
    return;
  }
  if(value===SORT_VALUE_RANK_ASC){
    CURRENT_SORT={by:"rank", order:"asc"};
  }else if(value===SORT_VALUE_RANK_DESC){
    CURRENT_SORT={by:"rank", order:"desc"};
  }else{
    CURRENT_SORT={by:"", order:""};
  }
  PAGER.page=1;
  loadPage();
}

/* ===================== 表格 ===================== */
function renderSelect(options,value,css,dataOriginal=""){
  return `<select class="${css}" data-original="${escapeAttr(dataOriginal)}">${options.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o}</option>`).join("")}</select>`;
}
async function loadPage(){
  if(!SESSION_ID){ qs('table_zone').innerHTML='<div class="p-3 text-sm text-gray-500">请先上传或载入会话</div>'; return; }
  if(CURRENT_SORT.by==='rank' && !HAS_RANKING_DATA){
    CURRENT_SORT={by:"",order:""};
    syncSortSelect();
  }
  const p=new URLSearchParams({session_id:SESSION_ID, page:PAGER.page, page_size:PAGER.size});
  if(CURRENT_FILTER.target&&CURRENT_FILTER.value){ p.set("filter_target",CURRENT_FILTER.target); p.set("filter_value",CURRENT_FILTER.value); }
  if(CURRENT_SEARCH.keyword){ p.set("search_scope", CURRENT_SEARCH.scope||SEARCH_SCOPE_DEFAULT); p.set("search_keyword", CURRENT_SEARCH.keyword); }
  if(CURRENT_SORT.by==="rank"){ p.set("sort_by","rank"); p.set("sort_order", CURRENT_SORT.order||"asc"); p.set("only_outliers", qs('rank_only_outliers')?.checked?"1":"0"); }
  qs('table_zone').innerHTML='<div class="p-3 text-sm text-gray-500">加载中…</div>';
  const r=await fetch(`/data?${p.toString()}`,{cache:"no-store"}); if(!r.ok){ qs('table_zone').innerHTML=`<div class="p-3 text-sm text-red-600">加载失败：${await r.text()}</div>`; return; }
  const d=await r.json(); PAGER.page=d.page; PAGER.size=d.page_size; PAGER.total=d.total; PAGER.pages=d.total_pages||1; renderPagerInfo();
  const hasRank = Array.isArray(d.rows) && d.rows.some(row=>row && row['智能排序分数']!==undefined && row['智能排序分数']!==null && String(row['智能排序分数']).trim()!=='');
  setSortAvailability(hasRank);
  syncSortSelect();
  renderTable(d.rows||[]);
}
function renderTable(rows){
  if(!rows.length){ qs('table_zone').innerHTML='<div class="p-3 text-sm text-gray-500">无数据</div>'; return; }
  const showTopicAdj=(ACTIVE_COL==="topic"); const showFieldAdj=(ACTIVE_COL==="field");
  let html = `<table class="min-w-full text-sm"><thead class="bg-slate-100 sticky top-0 z-10"><tr>
    <th class="px-3 py-2"><input type="checkbox" onclick="document.querySelectorAll('.row_ck').forEach(x=>x.checked=this.checked)"></th>
    <th class="px-3 py-2 text-left w-16">行</th>
    <th class="px-3 py-2 text-left">Article Title</th>
    <th class="px-3 py-2 text-left">结构化总结</th>
    <th class="px-3 py-2 text-left">研究主题（原）</th>
    ${showTopicAdj?'<th class="px-3 py-2 text-left">研究主题（调整）</th>':''}
    <th class="px-3 py-2 text-left">研究领域（原）</th>
    ${showFieldAdj?'<th class="px-3 py-2 text-left">研究领域（调整）</th>':''}
    <th class="px-3 py-2 text-left">Publication Year</th>
    <th class="px-3 py-2 text-left">DOI</th>
    <th class="px-3 py-2 text-left">排序分数</th>
    <th class="px-3 py-2 text-left w-60">操作</th>
  </tr></thead><tbody>`;
  rows.forEach(r=>{
    const idx=r._index, diffTopic=(r[ADJ_TOPIC_COL]||"")&&(r[ADJ_TOPIC_COL]!== (r["研究主题（议题）分类"]||"")), diffField=(r[ADJ_FIELD_COL]||"")&&(r[ADJ_FIELD_COL]!== (r["研究领域分类"]||"")), isOutlier=!!r["智能排序_离群"];
    const topicAdjCell = showTopicAdj?`<td class="px-3 py-2 ${diffTopic?'cell-diff-topic':''}">${renderSelect(TOPIC_LIST, r[ADJ_TOPIC_COL]||"", "border rounded px-2 py-1 w-44 topic_sel", r[ADJ_TOPIC_COL]||"")}</td>`:'';
    const fieldAdjCell = showFieldAdj?`<td class="px-3 py-2 ${diffField?'cell-diff-field':''}">${renderSelect(FIELD_LIST, r[ADJ_FIELD_COL]||"", "border rounded px-2 py-1 w-44 field_sel", r[ADJ_FIELD_COL]||"")}</td>`:'';
    html += `<tr class="border-b align-top ${isOutlier?'cell-outlier':''}">
      <td class="px-3 py-2"><input type="checkbox" class="row_ck" data-index="${idx}"></td>
      <td class="px-3 py-2 text-gray-500">${idx+1}</td>
      <td class="px-3 py-2"><div class="font-medium">${escapeHtml(r["Article Title"]||"")}</div></td>
      <td class="px-3 py-2"><textarea class="border rounded px-2 py-1 w-80 h-20 sum_input" data-original="${escapeAttr(r["结构化总结"]||"")}">${escapeHtml(r["结构化总结"]||"")}</textarea></td>
      <td class="px-3 py-2 text-gray-600">${escapeHtml(r["研究主题（议题）分类"]||"")}</td>
      ${topicAdjCell}
      <td class="px-3 py-2 text-gray-600">${escapeHtml(r["研究领域分类"]||"")}</td>
      ${fieldAdjCell}
      <td class="px-3 py-2">${escapeHtml(String(r["Publication Year"]||""))}</td>
      <td class="px-3 py-2">${escapeHtml(String(r["DOI"]||""))}</td>
      <td class="px-3 py-2">${(r["智能排序分数"]!==undefined && r["智能排序分数"]!=="")? Number(r["智能排序分数"]).toFixed(4): ""}</td>
      <td class="px-3 py-2"><div class="flex flex-col gap-2">
        <button class="btn btn-sm bg-emerald-600 text-white hover:bg-emerald-500" onclick="saveRow(${idx}, this)">保存</button>
        <button class="btn btn-sm bg-sky-600 text-white hover:bg-sky-500" onclick="suggestRow(${idx}, this)">智能建议</button>
      </div></td></tr>`;
  });
  html += `</tbody></table>`; qs('table_zone').innerHTML=html;
}

/* ===================== 保存/建议（只作用当前列） ===================== */
async function saveRow(index, btn){
  const tr=btn.closest("tr"); const sum=tr.querySelector(".sum_input").value;
  const targetValue=(ACTIVE_COL==="topic")?(tr.querySelector(".topic_sel")?.value||""):(tr.querySelector(".field_sel")?.value||"");
  btn.disabled=true; btn.textContent="保存中...";
  try{
    const r=await fetch("/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,index,structured:sum,which_adjust:ACTIVE_COL,target_value:targetValue})});
    if(!r.ok){ alert("保存失败："+await r.text()); return; }
    const sumEl=tr.querySelector(".sum_input"); if(sumEl) sumEl.dataset.original=sum;
    const selEl=(ACTIVE_COL==="topic")?tr.querySelector(".topic_sel"):tr.querySelector(".field_sel");
    if(selEl) selEl.dataset.original=targetValue;
    await refreshStats();
    setAutoSaveMsg(`手动保存完成：${new Date().toLocaleTimeString()}（单行）`);
  }catch(e){
    alert("保存失败："+e.message);
  }finally{
    btn.textContent="保存"; btn.disabled=false;
  }
}
async function suggestRow(index, btn){
  const cfg=JSON.parse(localStorage.getItem("llm_cfg")||"{}"); // 有则用；后端已做兜底
  const { topic:topicBlacklist, field:fieldBlacklist } = collectBlacklistSelections();
  btn.disabled=true; btn.textContent="建议中...";
  let success=false;
  try{
    const resp=await fetch("/autosuggest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,index,base_url:cfg.base_url,api_key:cfg.api_key,model:cfg.model,temperature:cfg.temp??0.2,topic_blacklist:topicBlacklist,field_blacklist:fieldBlacklist})});
    if(!resp.ok){
      const msg=(await resp.text())||resp.statusText||"未知错误";
      throw new Error(`建议失败：${msg}`);
    }
    let data;
    try{
      data=await resp.json();
    }catch(err){
      throw new Error("建议失败：返回数据解析失败");
    }
    if(!data || typeof data!=='object'){
      throw new Error("建议失败：返回数据格式不正确");
    }
    const rows=document.querySelectorAll("#table_zone tbody tr");
    rows.forEach(row=>{
      const n=parseInt(row.children[1].innerText.trim())-1;
      if(n===index){
        const sumEl=row.querySelector(".sum_input");
        if(sumEl) sumEl.value=data.structured_summary||"";
        if(ACTIVE_COL==="topic"){
          const el=row.querySelector(".topic_sel");
          if(el && data.topic_suggestion) el.value=data.topic_suggestion;
        }else{
          const el=row.querySelector(".field_sel");
          if(el && data.field_suggestion) el.value=data.field_suggestion;
        }
      }
    });
    success=true;
    btn.textContent="完成";
    showToast("智能建议已更新", 'success');
    setTimeout(()=>{btn.disabled=false; btn.textContent="智能建议";}, 600);
    refreshStats();
  }catch(e){
    const msg=e?.message||e;
    showToast(msg, 'error');
  }finally{
    if(!success){
      btn.disabled=false;
      btn.textContent="智能建议";
    }
  }
}

function setAutoSaveMsg(msg){
  const el=qs('auto_save_msg');
  if(el) el.textContent=msg||"";
}

function collectPendingChanges(){
  const rows=[]; const selector=(ACTIVE_COL==="topic")?".topic_sel":".field_sel";
  document.querySelectorAll('#table_zone tbody tr').forEach(tr=>{
    const ck=tr.querySelector('.row_ck'); if(!ck) return;
    const idx=parseInt(ck.dataset.index||"-1"); if(Number.isNaN(idx)||idx<0) return;
    const sumEl=tr.querySelector('.sum_input');
    const selEl=tr.querySelector(selector);
    const sumVal=sumEl?sumEl.value:"";
    const sumOrig=sumEl?.dataset.original??"";
    const structuredChanged=!!(sumEl && sumVal!==sumOrig);
    let adjustChanged=false; let targetValue=""; let which=null;
    if(selEl){
      const cur=selEl.value||""; const orig=selEl.dataset.original??"";
      if(cur!==orig){ adjustChanged=true; targetValue=cur; which=ACTIVE_COL; }
    }
    if(structuredChanged || adjustChanged){
      rows.push({ index:idx, displayIndex:idx+1, structuredChanged, structuredValue:sumVal, adjustChanged, which, targetValue, elements:{ sumEl, selEl } });
    }
  });
  return rows;
}

async function applyChangesBatch(changes){
  if(!SESSION_ID || !Array.isArray(changes) || !changes.length){
    return {success:0, fail:0, errors:[]};
  }
  let success=0, fail=0; const errors=[];
  for(const item of changes){
    const payload={ session_id:SESSION_ID, index:item.index };
    if(item.structuredChanged){ payload.structured=item.structuredValue; }
    if(item.adjustChanged && item.which){ payload.which_adjust=item.which; payload.target_value=item.targetValue; }
    try{
      const resp=await fetch("/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(!resp.ok){
        const msg=await resp.text().catch(()=>resp.statusText||"请求失败");
        errors.push(`行 ${item.displayIndex}: ${msg}`);
        fail+=1;
        continue;
      }
      if(item.structuredChanged && item.elements.sumEl){ item.elements.sumEl.dataset.original=item.structuredValue; }
      if(item.adjustChanged && item.elements.selEl){ item.elements.selEl.dataset.original=item.targetValue; }
      success+=1;
    }catch(e){
      errors.push(`行 ${item.displayIndex}: ${e.message||e}`);
      fail+=1;
    }
  }
  if(success>0){ await refreshStats(); }
  return {success, fail, errors};
}

async function saveAllChanges(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  if(IS_BATCH_SAVING){ return; }
  const changes=collectPendingChanges();
  if(!changes.length){ alert("当前页面没有检测到修改"); return; }
  const btn=qs('btn_save_all'); const prevText=btn?btn.textContent:"保存本页修改"; const prevDisabled=btn?btn.disabled:false;
  if(btn){ btn.disabled=true; btn.textContent="保存中..."; }
  IS_BATCH_SAVING=true;
  try{
    const result=await applyChangesBatch(changes);
    if(result.fail===0){
      alert(`已保存 ${result.success} 条修改`);
      setAutoSaveMsg(`手动保存完成：${new Date().toLocaleTimeString()}（${result.success} 条）`);
    }else{
      alert(`部分保存失败：成功 ${result.success} 条，失败 ${result.fail} 条\n${result.errors.join('\n')}`);
      setAutoSaveMsg(`保存出现失败，请检查。最后时间：${new Date().toLocaleTimeString()}`);
    }
  }finally{
    if(btn){ btn.disabled=prevDisabled; btn.textContent=prevText; }
    IS_BATCH_SAVING=false;
  }
}

function clearAutoSaveTimer(){ if(AUTO_SAVE_TIMER){ clearInterval(AUTO_SAVE_TIMER); AUTO_SAVE_TIMER=null; } }

function scheduleAutoSaveTimer(){
  clearAutoSaveTimer();
  if(!AUTO_SAVE_ENABLED) return;
  const intervalMs=Math.max(1, AUTO_SAVE_MINUTES)*60*1000;
  AUTO_SAVE_TIMER=setInterval(()=>{ triggerAutoSave(); }, intervalMs);
}

function applyAutoSaveSettings(){
  const enableEl=qs('auto_save_enable'); const intervalEl=qs('auto_save_interval');
  if(!enableEl || !intervalEl) return;
  AUTO_SAVE_ENABLED=enableEl.checked;
  let mins=parseFloat(intervalEl.value||"0");
  if(!Number.isFinite(mins) || mins<=0){ mins=5; }
  AUTO_SAVE_MINUTES=mins;
  intervalEl.value=String(mins);
  localStorage.setItem('auto_save_enabled', AUTO_SAVE_ENABLED?'1':'0');
  localStorage.setItem('auto_save_minutes', String(mins));
  if(AUTO_SAVE_ENABLED){
    scheduleAutoSaveTimer();
    setAutoSaveMsg(`自动保存间隔：${mins} 分钟`);
    triggerAutoSave();
  }else{
    clearAutoSaveTimer();
    setAutoSaveMsg('自动保存已关闭');
  }
}

function restoreAutoSaveSettings(){
  const enableEl=qs('auto_save_enable'); const intervalEl=qs('auto_save_interval');
  const storedEnabled=localStorage.getItem('auto_save_enabled')==='1';
  let storedMins=parseFloat(localStorage.getItem('auto_save_minutes')||"5");
  if(!Number.isFinite(storedMins) || storedMins<=0){ storedMins=5; }
  AUTO_SAVE_ENABLED=storedEnabled;
  AUTO_SAVE_MINUTES=storedMins;
  if(enableEl) enableEl.checked=storedEnabled;
  if(intervalEl) intervalEl.value=String(storedMins);
  if(storedEnabled){
    scheduleAutoSaveTimer();
    setAutoSaveMsg(`自动保存间隔：${storedMins} 分钟`);
  }else{
    clearAutoSaveTimer();
    setAutoSaveMsg('自动保存已关闭');
  }
}

async function triggerAutoSave(){
  if(!AUTO_SAVE_ENABLED || IS_BATCH_SAVING) return;
  if(!SESSION_ID){ setAutoSaveMsg('自动保存已开启，但当前无会话'); return; }
  const changes=collectPendingChanges();
  if(!changes.length){
    setAutoSaveMsg(`自动保存：${new Date().toLocaleTimeString()}（无改动）`);
    return;
  }
  const btn=qs('btn_save_all');
  const prevText=btn?btn.textContent:"保存本页修改";
  const prevDisabled=btn?btn.disabled:false;
  if(btn){ btn.textContent="自动保存中..."; btn.disabled=true; }
  IS_BATCH_SAVING=true;
  try{
    const result=await applyChangesBatch(changes);
    if(result.fail===0){
      setAutoSaveMsg(`自动保存完成：${new Date().toLocaleTimeString()}（${result.success} 条）`);
    }else{
      setAutoSaveMsg(`自动保存失败：成功 ${result.success} 条，失败 ${result.fail} 条`);
    }
  }finally{
    if(btn){ btn.textContent=prevText; btn.disabled=prevDisabled; }
    IS_BATCH_SAVING=false;
  }
}

/* ===================== 批量 ===================== */
const collectSelectedIndices=()=>Array.from(document.querySelectorAll(".row_ck:checked")).map(x=>parseInt(x.dataset.index));
async function bulkApplySelected(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const idxs=collectSelectedIndices(); if(!idxs.length){ alert("请勾选本页要修改的行"); return; }
  const targetVal=qs('bulk_target').value;
  const r=await fetch("/bulk_update_indices",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,indices:idxs,which_adjust:ACTIVE_COL,target_value:targetVal})});
  if(!r.ok){ alert("批量失败："+await r.text()); return; }
  await loadPage(); await refreshStats(); alert("已应用到本页所选");
}
async function bulkApplyFiltered(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  if(!CURRENT_FILTER.target||!CURRENT_FILTER.value){ alert("请先设置筛选"); return; }
  const targetVal=qs('bulk_target').value;
  if(!confirm(`把当前筛选（${CURRENT_FILTER.target}=${CURRENT_FILTER.value}）全部写入『${ACTIVE_COL==='topic'?'研究主题（议题）分类_调整':'研究领域分类_调整'}』为：${targetVal}？`)) return;
  const r=await fetch("/bulk_update_filtered",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,filter_target:CURRENT_FILTER.target,filter_value:CURRENT_FILTER.value,which_adjust:ACTIVE_COL,target_value:targetVal})});
  if(!r.ok){ alert("批量失败："+await r.text()); return; }
  await loadPage(); await refreshStats(); alert("已应用到当前筛选全部");
}

/* ===================== 排序 & 进度 ===================== */
let _progressTimer=null;
function startProgressPolling(){
  stopProgressPolling();
  _progressTimer=setInterval(async ()=>{
    if(!SESSION_ID) return;
    try{
      const r=await fetch(`/progress?session_id=${encodeURIComponent(SESSION_ID)}`,{cache:"no-store"}); if(!r.ok) return;
      const s=await r.json(); const txt=(typeof s.percent==="number")?`进度 ${s.percent}% · ${s.status||""} · ${s.message||""}`:"计算中…";
      qs('rank_msg').textContent=txt; if(s.status==="done"||s.status==="error") stopProgressPolling();
    }catch(e){}
  },1000);
}
function stopProgressPolling(){ if(_progressTimer){ clearInterval(_progressTimer); _progressTimer=null; } }
async function doRanking(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const cfg=JSON.parse(localStorage.getItem("llm_cfg")||"{}");
  clearScatterPlot('可视化等待计算完成…');
  const payload={ session_id:SESSION_ID, group_by:qs('rank_group_by').value,
    fields:{ title:qs('rk_f_title').checked, abstract:qs('rk_f_abstract').checked, summary:qs('rk_f_summary').checked },
    algorithm:qs('rank_algo').value, k:parseInt(qs('rank_k').value||"3"), sigma:parseFloat(qs('rank_sigma').value||"2.0"),
    min_cluster_size:parseInt(qs('rank_min_cluster').value||"5"),
    embedding_source:qs('rank_emb_src').value, openai_base_url:cfg.base_url||"", openai_api_key:cfg.api_key||"", openai_emb_model:"text-embedding-3-large" };
  qs('rank_msg').textContent="计算已开始…"; startProgressPolling();
  try{
    const r=await fetch("/compute_ranking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const j=await r.json().catch(()=>null);
    if(!r.ok){ qs('rank_msg').textContent="失败："+(j?.detail||"未知错误"); stopProgressPolling(); return; }
    qs('rank_msg').textContent=`完成：样本 ${j.total}，离群 ${j.outliers}`;
  }catch(e){ qs('rank_msg').textContent="失败："+e.message; }
  finally{ stopProgressPolling(); }
  CURRENT_SORT={by:"rank", order:qs('rank_order').value};
  setSortAvailability(true);
  syncSortSelect();
  PAGER.page=1; await loadPage();
  await fetchScatterAndRender(true);
}

/* ===================== 会话：保存 / 载入 ===================== */
async function saveSession(){
  if(!SESSION_ID){ alert("没有可保存的会话"); return; }
  const r=await fetch("/session/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID})});
  const raw=await r.text();
  let data=null;
  try{ data = raw ? JSON.parse(raw) : null; }catch(e){ data=null; }
  if(!r.ok){
    const msg=data?.detail || raw || '未知错误';
    alert("保存失败："+msg);
    return;
  }
  if(data?.meta){ renderSessionMeta(data.meta); }
  alert("会话已保存到服务器（sessions/）");
}
async function openLoadDialog(){
  const dlg=qs('dlg_sessions'); const zone=qs('sess_list_zone');
  zone.innerHTML="加载中…";
  dlg.showModal();
  try{
    const r=await fetch("/session/list",{cache:"no-store"}); if(!r.ok){ zone.innerHTML="拉取失败"; return; }
    const j=await r.json(); const arr=j.sessions||[];
    if(!arr.length){ zone.innerHTML='<div class="text-slate-600">暂无会话</div>'; return; }
    let html='<table class="w-full text-sm"><thead><tr class="border-b bg-slate-50"><th class="text-left p-2">SessionID</th><th class="text-left p-2">来源文件</th><th class="text-left p-2">行数</th><th class="text-left p-2">最近保存</th><th class="text-left p-2 sess-table-actions">操作</th></tr></thead><tbody>';
    arr.forEach(s=>{
      html+=`<tr class="border-b">
        <td class="p-2 font-mono text-xs">${s.session_id}</td>
        <td class="p-2">${escapeHtml(s.origin_filename||"")}</td>
        <td class="p-2">${s.rows||0}</td>
        <td class="p-2">${escapeHtml(s.updated_text||"")}</td>
        <td class="p-2 sess-table-actions"><button class="px-2 py-1 rounded bg-slate-800 text-white whitespace-nowrap" onclick="loadSession('${s.session_id}')">加载</button></td>
      </tr>`;
    });
    html+='</tbody></table>'; zone.innerHTML=html;
  }catch(e){
    zone.innerHTML="加载失败："+e.message;
  }
}
async function loadSession(sid){
  const r=await fetch(`/session/load?session_id=${encodeURIComponent(sid)}`,{cache:"no-store"});
  if(!r.ok){ alert("加载失败："+await r.text()); return; }
  const j=await r.json();
  SESSION_ID=j.session_id; setBadge(); enterWorkspace(); qs('total_msg').textContent=`行数：${j.total}`;
  PAGER.page=1; PAGER.size=parseInt(qs('ps_input').value||"50")||50;
  clearScatterPlot('等待计算后展示。');
  resetTopicVizState();
  resetSamplingState();
  renderSessionMeta(j.meta||null);
  await refreshStats();
  populateFilterOptions();
  CURRENT_SEARCH={scope:SEARCH_SCOPE_DEFAULT, keyword:""};
  syncSearchControls();
  CURRENT_FILTER={target:"",value:""};
  CURRENT_SORT={by:"",order:""};
  setSortAvailability(false);
  syncSortSelect();
  await loadPage();
  await fetchScatterAndRender();
  await loadSamplingList();
  qs('dlg_sessions').close();
}

/* ===================== 导出（服务端保存） ===================== */
async function saveExcelServer(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const name=prompt("文件名（可留空自动带时间戳）",""); // 只作为建议名
  const r=await fetch("/export_excel_save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,file_name:name||undefined})});
  if(!r.ok){ alert("导出失败："+await r.text()); return; }
  const j=await r.json(); LAST_EXPORT_URL=j.download_url||"";
  refreshHomeActions();
  await refreshSessionMeta();
  alert("已保存到服务器：\n"+(j.saved_path||""));
}

function openBatchExportDialog(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const dlg = qs('dlg_export_batch');
  if(!dlg){
    exportBatchExcel();
    return;
  }
  dlg.querySelectorAll('input[name="batch_export_target"]').forEach(input=>{
    input.checked = true;
  });
  const err = qs('batch_export_error');
  if(err){ err.classList.add('hidden'); }
  dlg.showModal();
}

async function exportBatchExcel(targets){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  let cleanedTargets = [];
  if(Array.isArray(targets)){
    for(const item of targets){
      const key = String(item||"").trim().toLowerCase();
      if((key === "topic" || key === "field") && !cleanedTargets.includes(key)){
        cleanedTargets.push(key);
      }
    }
  }
  if(!cleanedTargets.length){
    cleanedTargets = ["topic","field"];
  }
  const payload = { session_id: SESSION_ID, targets: cleanedTargets };
  const r = await fetch("/export_excel_split",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(!r.ok){ alert("批量导出失败："+await r.text()); return; }
  const j = await r.json();
  const lines = [];
  lines.push(`批量导出完成，共生成 ${j.total_files||0} 个文件`);
  if(j.root_dir){ lines.push(`存储目录：${j.root_dir}`); }
  if(Array.isArray(j.targets) && j.targets.length){
    const labels = j.targets.map(t=>t==='field'? '调整后领域':'调整后议题');
    lines.push(`导出维度：${labels.join('、')}`);
  }
  if(j.summary){
    if(j.summary.topic){ lines.push(`· 按议题：${j.summary.topic.groups||0} 个分组，${j.summary.topic.rows||0} 篇`); }
    if(j.summary.field){ lines.push(`· 按领域：${j.summary.field.groups||0} 个分组，${j.summary.field.rows||0} 篇`); }
  }
  if(Array.isArray(j.files) && j.files.length){
    const preview = j.files.slice(0,5).map(f=>`${f.label||''}（${f.count||0}）`).join('，');
    if(preview){ lines.push(`示例：${preview}${j.files.length>5?' 等':''}`); }
  }
  alert(lines.join('\n'));
  await refreshSessionMeta();
}

async function exportTopicYearExcel(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const input = prompt("设置年份区间跨度（单位：年，默认10）","10");
  if(input===null){ return; }
  let span = parseInt(input.trim(),10);
  if(!Number.isFinite(span) || span<=0){ span = 10; }
  const payload = { session_id: SESSION_ID, year_span: span };
  const r = await fetch("/export_topic_year",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(!r.ok){ alert("导出失败："+await r.text()); return; }
  const j = await r.json();
  const lines = [];
  lines.push(`议题年份分段导出完成，共生成 ${j.total_files||0} 个文件`);
  if(j.root_dir){ lines.push(`存储目录：${j.root_dir}`); }
  if(j.summary){
    lines.push(`覆盖议题：${j.summary.topics||0} 个`);
    lines.push(`时间跨度：每 ${j.summary.span||span} 年一段，共 ${j.summary.buckets||0} 个区间`);
  }
  if(Array.isArray(j.files) && j.files.length){
    const preview = j.files.slice(0,5).map(f=>`${f.topic||''}-${f.bucket||''}（${f.count||0}）`).join('，');
    if(preview){ lines.push(`示例：${preview}${j.files.length>5?' 等':''}`); }
  }
  alert(lines.join('\n'));
  await refreshSessionMeta();
}
async function downloadLast(){
  if(!LAST_EXPORT_URL){
    // 尝试取会话 info 的 last_export
    try{
      const info=await fetch(`/session/info?session_id=${encodeURIComponent(SESSION_ID)}`);
      if(info.ok){
        const x=await info.json();
        renderSessionMeta(x.meta||SESSION_META);
        LAST_EXPORT_URL = x?.meta?.last_export_path ? `/file?path=${encodeURIComponent(x.meta.last_export_path)}` : "";
        refreshHomeActions();
      }
    }catch(e){}
  }
  if(!LAST_EXPORT_URL){ alert("当前会话尚无导出记录"); return; }
  const a=document.createElement("a"); a.href=LAST_EXPORT_URL; a.target="_blank"; document.body.appendChild(a); a.click(); a.remove();
}

/* ===================== 事件绑定 & 初始化 ===================== */
function bindEvents(){
  // 上传/保存/载入/导出
  qs('btn_upload').onclick=uploadFile;
  qs('btn_save_session').onclick=saveSession;
  qs('btn_load_session').onclick=openLoadDialog;
  qs('btn_save_excel').onclick=saveExcelServer;
  const btnAddTopicMapping=qs('btn_add_topic_mapping'); if(btnAddTopicMapping) btnAddTopicMapping.onclick=()=>addLabelMappingRow('topic');
  const btnAddFieldMapping=qs('btn_add_field_mapping'); if(btnAddFieldMapping) btnAddFieldMapping.onclick=()=>addLabelMappingRow('field');
  const btnSaveLabelMapping=qs('btn_save_label_mapping'); if(btnSaveLabelMapping) btnSaveLabelMapping.onclick=saveLabelMapping;
  const btnExportBatch=qs('btn_export_batch'); if(btnExportBatch) btnExportBatch.onclick=openBatchExportDialog;
  const dlgExportBatch=qs('dlg_export_batch');
  if(dlgExportBatch){
    const btnBatchClose=qs('btn_export_batch_close'); if(btnBatchClose) btnBatchClose.onclick=()=>dlgExportBatch.close();
    const btnBatchCancel=qs('btn_export_batch_cancel'); if(btnBatchCancel) btnBatchCancel.onclick=()=>dlgExportBatch.close();
    const btnBatchConfirm=qs('btn_export_batch_confirm');
    if(btnBatchConfirm){
      btnBatchConfirm.onclick=()=>{
        const selections=Array.from(dlgExportBatch.querySelectorAll('input[name="batch_export_target"]:checked')).map(el=>el.value);
        if(!selections.length){
          const err=qs('batch_export_error'); if(err){ err.classList.remove('hidden'); }
          return;
        }
        const err=qs('batch_export_error'); if(err){ err.classList.add('hidden'); }
        dlgExportBatch.close();
        exportBatchExcel(selections);
      };
    }
    dlgExportBatch.querySelectorAll('input[name="batch_export_target"]').forEach(input=>{
      input.addEventListener('change',()=>{
        const err=qs('batch_export_error'); if(err){ err.classList.add('hidden'); }
      });
    });
    dlgExportBatch.addEventListener('close',()=>{
      const err=qs('batch_export_error'); if(err){ err.classList.add('hidden'); }
    });
  }
  const btnTopicYear=qs('btn_export_topic_year'); if(btnTopicYear) btnTopicYear.onclick=exportTopicYearExcel;
  qs('btn_download_last').onclick=downloadLast;
  const btnSaveAll=qs('btn_save_all'); if(btnSaveAll) btnSaveAll.onclick=saveAllChanges;
  const autoToggle=qs('auto_save_enable'); if(autoToggle) autoToggle.addEventListener('change', applyAutoSaveSettings);
  const autoInterval=qs('auto_save_interval'); if(autoInterval) autoInterval.addEventListener('change', applyAutoSaveSettings);

  // 筛选
  const btnOtherTopicAdj=qs('btn_only_other_topic_adj'); if(btnOtherTopicAdj) btnOtherTopicAdj.onclick=()=>quickFilter('topic_adj','其他议题');
  const btnOtherFieldAdj=qs('btn_only_other_field_adj'); if(btnOtherFieldAdj) btnOtherFieldAdj.onclick=()=>quickFilter('field_adj','其他领域');
  qs('btn_apply_filter').onclick=()=>{
    CURRENT_FILTER={ target:qs('filter_target').value, value:qs('filter_value').value };
    PAGER.page=1;
    loadPage();
  };
  qs('btn_apply_search').onclick=applySearchKeyword;
  qs('btn_clear_search').onclick=clearSearchKeyword;
  document.querySelectorAll('input[name="search_scope"]').forEach(radio=>{
    radio.addEventListener('change', e=>{
      CURRENT_SEARCH.scope = e.target?.value || SEARCH_SCOPE_DEFAULT;
    });
  });
  const searchInput=qs('search_keyword');
  if(searchInput){
    searchInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        applySearchKeyword();
      }
    });
  }
  const filterTargetSel=qs('filter_target');
  if(filterTargetSel){
    filterTargetSel.addEventListener('change', e=>{
      CURRENT_FILTER={ target:e.target.value, value:"" };
      populateFilterOptions();
    });
  }
  qs('btn_clear_filter').onclick=()=>{
    CURRENT_FILTER={target:"",value:""};
    CURRENT_SORT={by:"",order:""};
    syncSortSelect();
    PAGER.page=1;
    loadPage();
  };

  // 批量
  qs('btn_bulk_selected').onclick=bulkApplySelected; qs('btn_bulk_filtered').onclick=bulkApplyFiltered;
  qs('btn_select_all').onclick=()=>document.querySelectorAll(".row_ck").forEach(x=>x.checked=true);
  qs('btn_unselect_all').onclick=()=>document.querySelectorAll(".row_ck").forEach(x=>x.checked=false);

  const btnCloseWordCloud=qs('btn_close_word_cloud');
  if(btnCloseWordCloud){ btnCloseWordCloud.addEventListener('click', closeWordCloudDialog); }
  const dlgWordCloud=document.getElementById('dlg_word_cloud');
  if(dlgWordCloud){
    dlgWordCloud.addEventListener('close', ()=>resetWordCloudVisual());
    dlgWordCloud.addEventListener('cancel', e=>{ e.preventDefault(); closeWordCloudDialog(); });
  }

  // 排序
  qs('btn_do_ranking').onclick=doRanking;
  const btnRefreshVis=qs('btn_refresh_vis'); if(btnRefreshVis) btnRefreshVis.onclick=()=>fetchScatterAndRender(true);
  const btnToggleVis=qs('btn_toggle_vis'); if(btnToggleVis) btnToggleVis.onclick=toggleRankVis;
  const journalTopicBtn=qs('btn_journal_topic'); if(journalTopicBtn) journalTopicBtn.onclick=()=>setJournalTab('topic');
  const journalFieldBtn=qs('btn_journal_field'); if(journalFieldBtn) journalFieldBtn.onclick=()=>setJournalTab('field');
  setRankVisExpanded(false);
  setVisualTab();
  setJournalTab('topic');
  if(!JOURNAL_OPEN_HANDLER_BOUND){
    document.addEventListener('click', handleJournalOpenClick);
    JOURNAL_OPEN_HANDLER_BOUND=true;
  }
  document.querySelectorAll('[data-chart-toggle]').forEach(wrapper=>{
    const category=wrapper?.dataset?.chartToggle;
    if(!category) return;
    wrapper.querySelectorAll('[data-chart-toggle-target]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const target=btn.dataset?.chartToggleTarget;
        if(!target) return;
        setCategoryChartView(category, target);
      });
    });
  });
  Object.keys(CATEGORY_VIEW_STATE).forEach(category=>syncCategoryToggle(category));
  qs('rank_algo').addEventListener('change', handleAlgoChange);
  handleAlgoChange();

  // LLM 配置
  qs('btn_save_cfg').onclick=saveCfgToLocal; qs('btn_save_env').onclick=saveEnvToServer;
  const topicWrap=qs('topic_blacklist_options');
  if(topicWrap){ topicWrap.addEventListener('change', e=>{ if(e.target?.matches('input[data-kind]')) collectBlacklistSelections(); }); }
  const fieldWrap=qs('field_blacklist_options');
  if(fieldWrap){ fieldWrap.addEventListener('change', e=>{ if(e.target?.matches('input[data-kind]')) collectBlacklistSelections(); }); }

  // 只编辑哪一列
  qs('op_col_select').addEventListener('change', e=> setActiveCol(e.target.value));

  // 分页输入与按钮
  qs('page_input').addEventListener('change', ()=>{ let v=parseInt(qs('page_input').value||"1"); if(isNaN(v)||v<1) v=1; PAGER.page=v; loadPage(); });
  qs('ps_input').addEventListener('change', ()=>{ let v=parseInt(qs('ps_input').value||"50"); if(isNaN(v)||v<1) v=1; if(v>5000) v=5000; PAGER.size=v; PAGER.page=1; loadPage(); });
  qs('btn_reload_page').onclick=loadPage;
  qs('pg_first').onclick=()=>{ PAGER.page=1; loadPage(); };
  qs('pg_prev').onclick =()=>{ PAGER.page=Math.max(1, PAGER.page-1); loadPage(); };
  qs('pg_next').onclick =()=>{ PAGER.page=Math.min(PAGER.pages, PAGER.page+1); loadPage(); };
  qs('pg_last').onclick =()=>{ PAGER.page=PAGER.pages; loadPage(); };
  const sortSelect=qs('sort_select');
  if(sortSelect){ sortSelect.addEventListener('change', handleSortChange); }
  setSortAvailability(HAS_RANKING_DATA);
  syncSortSelect();
}

(async function init(){
  try{
    await fetchFrontendConfig(); fetchEnvDefaults(); loadCfgFromLocal(); bindEvents(); restoreAutoSaveSettings();
    renderSessionMeta(null);
    setActiveCol('topic'); // 默认编辑“主题（调整）”
    PAGER.page=1; PAGER.size=parseInt(qs('ps_input').value||"50")||50;
    populateFilterOptions();
    syncSearchControls();
    clearScatterPlot('等待计算后展示。');
  }catch(e){ alert("前端初始化失败："+e.message); console.error(e); }
})();
</script>
</body>
</html>
