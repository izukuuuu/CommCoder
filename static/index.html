<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <title>分类人工调整 GUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body class="bg-slate-100">
<div class="min-h-screen flex flex-col">
  <header class="bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-4">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-slate-900 text-white text-lg font-semibold shadow-lg">CC</span>
        <div>
          <div class="flex flex-wrap items-center gap-3">
            <h1 class="text-xl font-bold text-slate-900">分类人工调整工作台</h1>
            <span id="app_ver" class="text-xs font-medium text-slate-500 bg-slate-100 border border-slate-200 rounded-full px-3 py-1"></span>
          </div>
          <p class="text-sm text-slate-500 mt-1">在统一界面完成编码流程与结果洞察。</p>
        </div>
      </div>
      <div class="flex flex-col items-start gap-3 sm:flex-row sm:items-center">
        <div id="session_meta_summary" class="hidden md:flex items-start gap-3 px-4 py-3 rounded-2xl bg-slate-100/90 text-xs text-slate-600 shadow-inner">
          <div class="shrink-0">
            <svg class="w-6 h-6 text-slate-500" data-heroicon="clipboard-document-list" aria-hidden="true"></svg>
          </div>
          <div class="leading-tight space-y-1">
            <p id="session_meta_primary" class="text-sm font-medium text-slate-700">暂无会话</p>
            <p id="session_meta_secondary" class="text-xs text-slate-500">请上传或载入数据集</p>
          </div>
        </div>
        <code id="session_badge" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded-full">Session: —</code>
        <div class="md:hidden w-full">
          <label class="sr-only" for="mobile_page_select">页面导航</label>
          <select id="mobile_page_select" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-600 bg-white">
            <option value="page-home">主页</option>
            <option value="page-coding" data-requires-session="true">编码工作台</option>
            <option value="page-visual" data-requires-session="true">数据可视化</option>
            <option value="page-settings">OpenAI API 设置</option>
          </select>
        </div>
      </div>
    </div>
  </header>
  <div class="flex flex-1">
    <aside id="sidebar" class="hidden md:flex border-r border-slate-200 bg-white/80 backdrop-blur-sm transition-all duration-300" data-collapsed="false">
      <div class="flex flex-col w-full h-full">
        <div class="sidebar-header px-4 pt-6 pb-4 flex items-center justify-between">
          <p class="nav-section-label text-xs font-semibold text-slate-400 uppercase tracking-wide">导航</p>
          <button id="sidebar_toggle" class="sidebar-toggle btn btn-ghost" type="button" aria-expanded="true" aria-label="收起侧边栏" title="收起侧边栏">
            <svg class="w-5 h-5" data-heroicon="chevron-left" aria-hidden="true"></svg>
          </button>
        </div>
        <nav class="flex-1 flex flex-col gap-2 px-2">
          <button class="nav-link nav-link-active" data-target="page-home" title="主页" aria-label="主页">
            <svg class="nav-icon w-5 h-5" data-heroicon="home-modern" aria-hidden="true"></svg>
            <span class="nav-label">主页</span>
          </button>
          <button class="nav-link" data-target="page-coding" data-requires-session="true" title="编码工作台" aria-label="编码工作台">
            <svg class="nav-icon w-5 h-5" data-heroicon="adjustments-horizontal" aria-hidden="true"></svg>
            <span class="nav-label">编码工作台</span>
          </button>
          <button class="nav-link" data-target="page-visual" data-requires-session="true" title="数据可视化" aria-label="数据可视化">
            <svg class="nav-icon w-5 h-5" data-heroicon="chart-pie" aria-hidden="true"></svg>
            <span class="nav-label">数据可视化</span>
          </button>
        </nav>
        <div class="sidebar-footer px-2 pt-4 pb-6 border-t border-slate-200">
          <button class="nav-link" data-target="page-settings" title="OpenAI API 设置" aria-label="OpenAI API 设置">
            <svg class="nav-icon w-5 h-5" data-heroicon="cog-6-tooth" aria-hidden="true"></svg>
            <span class="nav-label">OpenAI API 设置</span>
          </button>
        </div>
      </div>
    </aside>
    <div class="flex-1 overflow-y-auto">
      <main class="max-w-7xl mx-auto w-full px-6 py-8 space-y-10">
        <section id="page-home" class="page-section space-y-10">
          <div class="home-hero rounded-3xl overflow-hidden shadow">
            <div class="home-hero-flow">
              <div class="home-hero-intro">
                <p class="home-hero-eyebrow" data-i18n-key="hero.eyebrow">CommCoder Studio</p>
                <h2 class="home-hero-title" data-i18n-key="hero.title">编码协同流程总览</h2>
                <p class="home-hero-subtitle" data-i18n-key="hero.subtitle">以下流程呈现从自动化产出的原始结果，到人工覆核与统计抽样验证的完整闭环。</p>
                <button id="lang_toggle" class="lang-toggle-btn" type="button" aria-label="切换为英文" title="切换为英文">
                  <svg class="w-5 h-5" data-heroicon="globe-alt" aria-hidden="true"></svg>
                  <span id="lang_toggle_label">English</span>
                </button>
              </div>
              <div id="hero_flow_diagram" class="flow-diagram" aria-label="编码流程图">
                <div class="flow-horizontal">
                  <div class="flow-step flow-step-strong" data-i18n-key="flow.aiAuto">AI 自动编码</div>
                  <div class="flow-arrow" aria-hidden="true"></div>
                  <div class="flow-step" data-i18n-key="flow.toWorkspace">编码结果进入工作台</div>
                </div>
                <div class="flow-branch">
                  <div class="flow-branch-column">
                    <div class="flow-branch-connector" aria-hidden="true"></div>
                    <div class="flow-step" data-i18n-key="flow.manualClassify">未识别主题人工分类</div>
                  </div>
                  <div class="flow-branch-column">
                    <div class="flow-branch-connector" aria-hidden="true"></div>
                    <div class="flow-step" data-i18n-key="flow.kmeans">K-Means 聚类</div>
                    <div class="flow-arrow-vertical" aria-hidden="true"></div>
                    <div class="flow-step" data-i18n-key="flow.outlier">离群值识别</div>
                    <div class="flow-arrow-vertical" aria-hidden="true"></div>
                    <div class="flow-step" data-i18n-key="flow.review">人工覆核调整</div>
                  </div>
                </div>
                <div class="flow-merge">
                  <div class="flow-merge-connector" aria-hidden="true"></div>
                  <div class="flow-horizontal">
                    <div class="flow-step" data-i18n-key="flow.integrate">多通道结果整合</div>
                    <div class="flow-arrow" aria-hidden="true"></div>
                    <div class="flow-step flow-step-strong" data-i18n-key="flow.validation">抽样验证可靠性</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="home-hero-abstract">
              <h3 class="home-hero-abstract-title" data-i18n-key="hero.abstractTitle">方法论简介</h3>
              <p data-i18n-key="hero.abstractParagraph1">本工作台以自动化模型为前端引擎，借助语义聚类与人工干预协同推进，对主题空缺与离群样本实行双轨校准。</p>
              <p data-i18n-key="hero.abstractParagraph2">流程后段强调多源整合与质量抽检，旨在确保编码结果在统计意义上的稳定性与可复现性。</p>
            </div>
          </div>

          <div class="home-launch-hub space-y-8">
            <div class="home-launch-header">
              <div>
                <p class="home-launch-eyebrow">Workspace Launch</p>
                <h2 class="home-launch-title">准备工作台</h2>
                <p class="home-launch-subtitle">上传新的数据集，或从历史会话继续，解锁编码工作台。</p>
              </div>
              <div class="home-launch-meta">
                <span>当前 Session ID</span>
                <code class="home-launch-meta-code" id="home_session_hint">—</code>
              </div>
            </div>
            <div id="home_lock_hint_wrapper" class="home-lock-banner" data-state="locked">
              <div class="home-lock-icon">
                <svg id="home_lock_icon" class="w-5 h-5" data-heroicon="lock-closed" aria-hidden="true"></svg>
              </div>
              <p id="home_lock_hint" class="home-lock-hint-text">请在下方上传数据集或载入会话以解锁编码工作台与数据可视化。</p>
            </div>
            <div class="home-card-grid">
              <section class="home-card home-card-primary">
                <div class="home-card-header">
                  <div>
                    <p class="home-card-eyebrow">新建会话</p>
                    <h3 class="home-card-title">上传文件并自动开启新会话</h3>
                    <p class="home-card-subtitle">支持 Excel 与 CSV 文件，系统将为每次上传生成独立会话。</p>
                  </div>
                  <div class="home-card-icon">
                    <svg class="w-7 h-7" data-heroicon="cloud-arrow-up" aria-hidden="true"></svg>
                  </div>
                </div>
                <div class="home-card-body space-y-6">
                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">选择表格（.xlsx/.xls/.csv）</label>
                    <input id="file_input" class="file-input" type="file" accept=".xlsx,.xls,.csv">
                  </div>
                  <div class="home-upload-actions">
                    <button id="btn_upload" class="action-btn home-upload-btn" title="上传并新建会话">
                      <svg class="w-5 h-5" data-heroicon="arrow-up-tray" aria-hidden="true"></svg>
                      <span>上传并新建会话</span>
                    </button>
                    <div class="home-progress">
                      <div class="home-progress-track">
                        <div id="up_bar" class="home-progress-bar"></div>
                      </div>
                      <span id="up_msg" class="home-progress-msg"></span>
                    </div>
                  </div>
                  <p class="home-card-footnote">上传完成后系统将自动创建新会话并刷新界面。</p>
                </div>
              </section>
              <section class="home-card home-card-secondary">
                <div class="home-card-header">
                  <div>
                    <p class="home-card-eyebrow">会话与导出</p>
                    <h3 class="home-card-title">管理当前进度与结果</h3>
                    <p class="home-card-subtitle">保存会话、导出 Excel 或下载最近一次导出文件，随时切换工作节点。</p>
                  </div>
                  <div class="home-card-icon">
                    <svg class="w-7 h-7" data-heroicon="rectangle-stack" aria-hidden="true"></svg>
                  </div>
                </div>
                <div class="home-card-body">
                  <div class="home-action-collection">
                    <article class="home-action-card" data-action="save-session">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-emerald-100 text-emerald-600">
                          <svg class="w-6 h-6" data-heroicon="cloud-arrow-up" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">保存当前会话</h4>
                          <p class="home-action-desc">写入服务器 sessions/ 目录，保障进度安全。</p>
                        </div>
                      </div>
                      <button id="btn_save_session" class="action-btn home-action-btn bg-emerald-600 text-white hover:bg-emerald-500 shadow-sm" title="将当前会话写入服务器磁盘（sessions/）">
                        <span>立即保存</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="load-session">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-slate-900/10 text-slate-900">
                          <svg class="w-6 h-6" data-heroicon="folder-arrow-down" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">载入历史会话</h4>
                          <p class="home-action-desc">浏览服务器记录，快速恢复之前的工作现场。</p>
                        </div>
                      </div>
                      <button id="btn_load_session" class="action-btn home-action-btn bg-slate-900 text-white hover:bg-slate-800 shadow-sm" title="从服务器读取会话">
                        <span>选择会话</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="export-excel">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-indigo-100 text-indigo-600">
                          <svg class="w-6 h-6" data-heroicon="document-arrow-down" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">导出为 Excel</h4>
                          <p class="home-action-desc">生成 Output/&lt;session&gt;/export_*.xlsx 供分析或交付。</p>
                        </div>
                      </div>
                      <button id="btn_save_excel" class="action-btn home-action-btn bg-indigo-600 text-white hover:bg-indigo-500 shadow-sm" title="写入 Output/&lt;session&gt;/export_*.xlsx">
                        <span>生成文件</span>
                      </button>
                    </article>
                    <article class="home-action-card" data-action="download-export">
                      <div class="home-action-head">
                        <div class="home-action-icon bg-slate-200 text-slate-700">
                          <svg class="w-6 h-6" data-heroicon="arrow-down-tray" aria-hidden="true"></svg>
                        </div>
                        <div>
                          <h4 class="home-action-title">下载最新导出</h4>
                          <p class="home-action-desc">一键获取最近一次导出成果，导出生成后自动激活下载。</p>
                        </div>
                      </div>
                      <button id="btn_download_last" class="action-btn home-action-btn bg-slate-600 text-white hover:bg-slate-500 shadow-sm" title="从服务器下载最近一次导出副本（可选）">
                        <span>下载文件</span>
                      </button>
                    </article>
                  </div>
                  <p class="home-card-footnote">所有操作都会作用于当前会话，未解锁时将保持禁用状态。</p>
                </div>
              </section>
            </div>
          </div>
        </section>

        <section id="page-coding" class="page-section space-y-8 hidden">
          <div class="bg-white rounded-2xl shadow p-6 space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <span class="text-sm">当前仅编辑：</span>
              <select id="op_col_select" class="border rounded px-2 py-1">
                <option value="topic">研究主题（调整）</option>
                <option value="field">研究领域（调整）</option>
              </select>
              <span id="op_col_hint" class="text-xs text-gray-500">（仅显示并可编辑：研究主题（调整））</span>

              <span class="md:ml-6 text-sm">筛选列：</span>
              <select id="filter_target" class="border rounded px-2 py-1">
                <option value="topic_orig">研究主题（原）</option>
                <option value="field_orig">研究领域（原）</option>
                <option value="topic_adj">研究主题（调整）</option>
                <option value="field_adj">研究领域（调整）</option>
              </select>
              <select id="filter_value" class="border rounded px-2 py-1"></select>
              <button id="btn_apply_filter" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">应用筛选</button>
              <button id="btn_clear_filter" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">清除筛选</button>

              <div class="flex flex-wrap items-center gap-2 basis-full md:basis-auto md:ml-6">
                <span class="text-sm">关键词搜索：</span>
                <label class="inline-flex items-center gap-1 text-sm">
                  <input type="radio" name="search_scope" value="title" checked>
                  <span>Article Title</span>
                </label>
                <label class="inline-flex items-center gap-1 text-sm">
                  <input type="radio" name="search_scope" value="summary">
                  <span>结构化总结</span>
                </label>
                <input id="search_keyword" class="border rounded px-2 py-1 w-64" type="text" placeholder="输入提示词，空格分隔多个关键词">
                <button id="btn_apply_search" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">应用搜索</button>
                <button id="btn_clear_search" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">清除搜索</button>
              </div>

              <span class="md:ml-6 text-sm">目标类别：</span>
              <select id="bulk_target" class="border rounded px-2 py-1"></select>
              <button id="btn_bulk_selected" class="btn btn-sm bg-amber-600 text-white hover:bg-amber-500">将本页勾选 → 目标类别</button>
              <button id="btn_bulk_filtered" class="btn btn-sm bg-amber-700 text-white hover:bg-amber-600">将当前筛选全部 → 目标类别</button>
              <button id="btn_select_all" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">全选本页</button>
              <button id="btn_unselect_all" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300">取消全选</button>
            </div>

            <div class="flex flex-wrap items-center gap-3 text-sm">
              <button id="btn_save_all" class="btn btn-sm bg-emerald-700 text-white hover:bg-emerald-600">保存本页修改</button>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="auto_save_enable">
                <span>自动保存</span>
              </label>
              <span>间隔（分钟）</span>
              <input id="auto_save_interval" type="number" min="1" value="5" class="border rounded px-2 py-1 w-20 text-center">
              <span id="auto_save_msg" class="text-xs text-gray-500"></span>
            </div>

            <details class="bg-slate-50 border rounded p-3">
              <summary class="cursor-pointer font-semibold">智能排序（议题内重排序 & 离群定位）</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                <div>
                  <label class="block text-sm text-gray-600 mb-1">分组依据</label>
                  <select id="rank_group_by" class="border rounded px-2 py-1 w-full">
                    <option value="topic_orig">研究主题（原）</option>
                    <option value="topic_adj">研究主题（调整）</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">算法</label>
                  <select id="rank_algo" class="border rounded px-2 py-1 w-full">
                    <option value="centroid">Centroid（质心）</option>
                    <option value="kmeans">K-Means</option>
                    <option value="hdbscan">HDBSCAN（自动离群）</option>
                  </select>
                </div>
                <div id="wrap_k">
                  <label class="block text-sm text-gray-600 mb-1">K（K-Means 生效）</label>
                  <input id="rank_k" type="number" value="3" min="1" class="border rounded px-2 py-1 w-full">
                </div>
                <div id="wrap_sigma">
                  <label class="block text-sm text-gray-600 mb-1">离群阈值 σ</label>
                  <input id="rank_sigma" type="number" step="0.1" value="2.0" class="border rounded px-2 py-1 w-full">
                </div>
                <div id="wrap_min_cluster">
                  <label class="block text-sm text-gray-600 mb-1">最小簇大小（HDBSCAN）</label>
                  <input id="rank_min_cluster" type="number" step="1" min="2" value="5" class="border rounded px-2 py-1 w-full">
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">嵌入来源</label>
                  <select id="rank_emb_src" class="border rounded px-2 py-1 w-full">
                    <option value="local">本地 sentence-transformers</option>
                    <option value="openai">OpenAI Embeddings</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">排序方向</label>
                  <select id="rank_order" class="border rounded px-2 py-1 w-full">
                    <option value="asc">近的在前（分数小→大）</option>
                    <option value="desc">远的在前（分数大→小）</option>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <input id="rank_only_outliers" type="checkbox">
                  <label for="rank_only_outliers" class="text-sm">仅看离群</label>
                </div>
                <div class="md:col-span-2 flex items-center gap-4">
                  <label class="text-sm"><input id="rk_f_title" type="checkbox" checked> 标题</label>
                  <label class="text-sm"><input id="rk_f_abstract" type="checkbox" checked> 摘要</label>
                  <label class="text-sm"><input id="rk_f_summary" type="checkbox" checked> 结构化总结</label>
                </div>
                <div class="flex items-center gap-3">
                  <button id="btn_do_ranking" class="px-4 py-2 rounded bg-slate-800 text-white">计算</button>
                  <span id="rank_msg" class="text-sm text-gray-600"></span>
                </div>
              </div>
            </details>
          </div>

          <div class="flex flex-wrap items-center gap-2 mb-3">
            <span>分页：</span>
            <button id="pg_first" class="px-2 py-1 rounded bg-slate-200">« 首</button>
            <button id="pg_prev"  class="px-2 py-1 rounded bg-slate-200">‹ 前</button>
            <input id="page_input" class="border rounded px-2 py-1 w-20 text-center" type="number" value="1" min="1">
            <span>/</span>
            <span id="page_total" class="w-12 text-center">1</span>
            <button id="pg_next"  class="px-2 py-1 rounded bg-slate-200">后 ›</button>
            <button id="pg_last"  class="px-2 py-1 rounded bg-slate-200">末 »</button>
            <span class="ml-4">每页</span>
            <input id="ps_input" class="border rounded px-2 py-1 w-20 text-center" type="number" value="50" min="1" max="5000">
            <button id="btn_reload_page" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">刷新</button>
            <span class="text-sm text-gray-500 ml-2" id="page_info">—</span>
            <div class="flex items-center gap-2 ml-4">
              <span>排序</span>
              <select id="sort_select" class="border rounded px-2 py-1 text-sm">
                <option value="default">默认顺序</option>
                <option value="rank_asc" data-requires-rank="1">智能排序：近→远</option>
                <option value="rank_desc" data-requires-rank="1">智能排序：远→近</option>
              </select>
              <span id="sort_hint" class="text-xs text-gray-500"></span>
            </div>
          </div>

          <div id="table_zone" class="bg-white rounded-2xl shadow overflow-x-auto"></div>

        </section>

        <section id="page-visual" class="page-section hidden space-y-8">
          <div class="bg-white rounded-2xl shadow p-6 space-y-2">
            <h2 class="text-lg font-semibold text-slate-900">数据可视化面板</h2>
            <p class="text-sm text-slate-500">查看整体分布、筛选趋势以及排序结果的二维可视化。</p>
          </div>

          <div class="bg-white rounded-2xl shadow p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold">分类概览（点击类别即可筛选）</h3>
              <div class="text-sm text-gray-500" id="total_msg">—</div>
            </div>
            <div class="vis-tab-toggle" role="tablist">
              <button id="btn_vis_tab_orig" class="vis-tab-btn" role="tab" aria-selected="true" data-vis-tab="orig">原始分类</button>
              <button id="btn_vis_tab_adj" class="vis-tab-btn" role="tab" aria-selected="false" data-vis-tab="adj">调整后分类</button>
            </div>
            <div id="vis_panel_orig" class="vis-tab-panel" data-vis-panel="orig">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <h4 class="text-sm font-semibold">研究主题（原）</h4>
                    <div class="flex items-center gap-2">
                      <div class="chart-type-toggle" role="group" aria-label="图表展示方式" data-chart-toggle="topic_orig">
                        <button type="button" class="chart-type-btn chart-type-btn-active" aria-pressed="true" data-chart-toggle-target="treemap">树状图</button>
                        <button type="button" class="chart-type-btn" aria-pressed="false" data-chart-toggle-target="bar">条形图</button>
                      </div>
                      <button class="text-xs text-sky-700" id="btn_only_other_topic_orig">只看『其他议题』</button>
                    </div>
                  </div>
                  <div id="chips_topic_orig" class="flex flex-wrap gap-2 mt-2"></div>
                  <div class="space-y-4">
                    <div id="treemap_topic_orig" class="treemap-box" data-category-chart="topic_orig" data-chart-type="treemap" data-treemap-key="chart_topic_orig"></div>
                    <div id="barchart_topic_orig" class="bar-chart-box hidden" data-category-chart="topic_orig" data-chart-type="bar" data-bar-key="bar_topic_orig"></div>
                  </div>
                </div>
                <div class="space-y-4">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <h4 class="text-sm font-semibold">研究领域（原）</h4>
                    <div class="flex items-center gap-2">
                      <div class="chart-type-toggle" role="group" aria-label="图表展示方式" data-chart-toggle="field_orig">
                        <button type="button" class="chart-type-btn chart-type-btn-active" aria-pressed="true" data-chart-toggle-target="treemap">树状图</button>
                        <button type="button" class="chart-type-btn" aria-pressed="false" data-chart-toggle-target="bar">条形图</button>
                      </div>
                      <button class="text-xs text-sky-700" id="btn_only_other_field_orig">只看『其他领域』</button>
                    </div>
                  </div>
                  <div id="chips_field_orig" class="flex flex-wrap gap-2 mt-2"></div>
                  <div class="space-y-4">
                    <div id="treemap_field_orig" class="treemap-box" data-category-chart="field_orig" data-chart-type="treemap" data-treemap-key="chart_field_orig"></div>
                    <div id="barchart_field_orig" class="bar-chart-box hidden" data-category-chart="field_orig" data-chart-type="bar" data-bar-key="bar_field_orig"></div>
                  </div>
                </div>
              </div>
            </div>
            <div id="vis_panel_adj" class="vis-tab-panel hidden" data-vis-panel="adj">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <h4 class="text-sm font-semibold">研究主题（调整后）</h4>
                    <div class="flex items-center gap-2">
                      <div class="chart-type-toggle" role="group" aria-label="图表展示方式" data-chart-toggle="topic_adj">
                        <button type="button" class="chart-type-btn chart-type-btn-active" aria-pressed="true" data-chart-toggle-target="treemap">树状图</button>
                        <button type="button" class="chart-type-btn" aria-pressed="false" data-chart-toggle-target="bar">条形图</button>
                      </div>
                      <button class="text-xs text-sky-700" id="btn_only_other_topic_adj">只看『其他议题』</button>
                    </div>
                  </div>
                  <div id="chips_topic_adj" class="flex flex-wrap gap-2 mt-2"></div>
                  <div class="space-y-4">
                    <div id="treemap_topic_adj" class="treemap-box" data-category-chart="topic_adj" data-chart-type="treemap" data-treemap-key="chart_topic_adj"></div>
                    <div id="barchart_topic_adj" class="bar-chart-box hidden" data-category-chart="topic_adj" data-chart-type="bar" data-bar-key="bar_topic_adj"></div>
                  </div>
                </div>
                <div class="space-y-4">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <h4 class="text-sm font-semibold">研究领域（调整后）</h4>
                    <div class="flex items-center gap-2">
                      <div class="chart-type-toggle" role="group" aria-label="图表展示方式" data-chart-toggle="field_adj">
                        <button type="button" class="chart-type-btn chart-type-btn-active" aria-pressed="true" data-chart-toggle-target="treemap">树状图</button>
                        <button type="button" class="chart-type-btn" aria-pressed="false" data-chart-toggle-target="bar">条形图</button>
                      </div>
                      <button class="text-xs text-sky-700" id="btn_only_other_field_adj">只看『其他领域』</button>
                    </div>
                  </div>
                  <div id="chips_field_adj" class="flex flex-wrap gap-2 mt-2"></div>
                  <div class="space-y-4">
                    <div id="treemap_field_adj" class="treemap-box" data-category-chart="field_adj" data-chart-type="treemap" data-treemap-key="chart_field_adj"></div>
                    <div id="barchart_field_adj" class="bar-chart-box hidden" data-category-chart="field_adj" data-chart-type="bar" data-bar-key="bar_field_adj"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6 space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-3 timeline-controls">
              <div>
                <h3 class="font-semibold">时间趋势分析</h3>
                <p class="text-sm text-slate-500">按年份区间查看发表数量趋势与累计占比。</p>
              </div>
              <div class="flex items-center gap-2 text-sm text-slate-600">
                <label class="whitespace-nowrap" for="timeline_bin_select">区间跨度</label>
                <select id="timeline_bin_select" class="border border-slate-200 rounded px-2 py-1 text-sm">
                  <option value="1">1 年</option>
                  <option value="3">3 年</option>
                  <option value="5" selected>5 年</option>
                  <option value="10">10 年</option>
                </select>
              </div>
            </div>
            <div id="timeline_summary" class="text-xs text-slate-500 hidden"></div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
              <div>
                <div class="flex items-center justify-between gap-3 mb-2 timeline-controls">
                  <h4 class="text-sm font-semibold text-slate-700">发表数量趋势</h4>
                  <button type="button" id="btn_expand_timeline_line" class="timeline-expand-btn">新标签全屏</button>
                </div>
                <div id="timeline_line_chart" class="timeline-chart-box"></div>
              </div>
              <div>
                <div class="flex flex-wrap items-center justify-between gap-3 mb-2 timeline-controls">
                  <h4 class="text-sm font-semibold text-slate-700">分类占比堆叠图</h4>
                  <div class="flex items-center gap-2">
                    <div class="timeline-stack-toggle" role="group" aria-label="时间序列分类切换">
                      <button type="button" class="timeline-stack-btn timeline-stack-btn-active" data-timeline-stack="topic_adj" aria-pressed="true">研究主题（调整后）</button>
                      <button type="button" class="timeline-stack-btn" data-timeline-stack="field_adj" aria-pressed="false">研究领域（调整后）</button>
                    </div>
                    <button type="button" id="btn_expand_timeline_stack" class="timeline-expand-btn">新标签全屏</button>
                  </div>
                </div>
                <div class="timeline-area-wrapper">
                  <div id="timeline_area_chart" class="timeline-chart-box"></div>
                  <div id="timeline_area_label" class="timeline-area-label" style="display:none;"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-2">
              <h3 class="font-semibold">排序可视化（2D 散点图）</h3>
              <button id="btn_toggle_vis" class="btn btn-sm bg-slate-200 text-slate-700 hover:bg-slate-300" aria-expanded="false">展开可视化</button>
            </div>
            <div id="rank_vis_body" class="space-y-3 hidden">
              <div class="flex items-center justify-end">
                <button id="btn_refresh_vis" class="btn btn-sm bg-slate-700 text-white hover:bg-slate-600">刷新可视化</button>
              </div>
              <div id="rank_vis_msg" class="text-sm text-gray-500">等待计算后展示。</div>
              <div id="rank_vis_plot" class="w-full min-h-[320px]"></div>
            </div>
          </div>
        </section>

        <section id="page-settings" class="page-section hidden space-y-8">
          <div class="bg-white rounded-2xl shadow p-6 space-y-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h2 class="text-lg font-semibold text-slate-900">OpenAI 兼容 API 设置</h2>
                <p class="text-sm text-slate-500">配置 Base URL、密钥等参数，可同步保存到浏览器或服务器。</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-600 mb-1">Base URL</label>
                <input id="cfg_base_url" class="w-full border rounded px-3 py-2" placeholder="https://api.openai.com">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">API Key</label>
                <input id="cfg_api_key" class="w-full border rounded px-3 py-2" type="password" placeholder="sk-...">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Model</label>
                <input id="cfg_model" class="w-full border rounded px-3 py-2" placeholder="gpt-4o-mini">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Temperature</label>
                <input id="cfg_temp" class="w-full border rounded px-3 py-2" type="number" step="0.1" value="0.2">
              </div>
            </div>
            <div class="flex flex-wrap gap-2 pt-2">
              <button id="btn_save_cfg" class="px-4 py-2 rounded bg-slate-800 text-white">保存到浏览器</button>
              <button id="btn_save_env" class="px-4 py-2 rounded bg-emerald-700 text-white">写入 .env（默认）</button>
              <span id="cfg_msg" class="text-sm text-gray-600"></span>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow p-6 space-y-5">
            <div class="space-y-1">
              <h3 class="text-base font-semibold text-slate-900">智能分类黑名单</h3>
              <p class="text-sm text-slate-500">勾选后，智能建议在提示词中将不再包含这些分类，避免模型输出被屏蔽的选项。</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <h4 class="text-sm font-semibold text-slate-800">议题分类黑名单</h4>
                <div id="topic_blacklist_options" class="flex flex-wrap gap-2"></div>
              </div>
              <div class="space-y-2">
                <h4 class="text-sm font-semibold text-slate-800">领域分类黑名单</h4>
                <div id="field_blacklist_options" class="flex flex-wrap gap-2"></div>
              </div>
            </div>
            <p class="text-xs text-slate-400">提示：黑名单仅影响智能建议的提示词，手动调整仍可选择全部分类。</p>
          </div>
        </section>
      </main>
    </div>
  </div>
</div>
<div id="toast_stack" class="fixed top-6 right-6 z-[1200] flex flex-col gap-3 max-w-sm pointer-events-none"></div>
<dialog id="dlg_sessions" class="rounded-xl p-0 w-[680px] max-w-[95vw]">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="font-semibold">载入会话</h3>
    <button onclick="qs('dlg_sessions').close()" class="btn btn-sm btn-ghost text-slate-600">✕</button>
  </div>
  <div id="sess_list_zone" class="p-4 max-h-[60vh] overflow-y-auto text-sm"></div>
  <div class="p-4 border-t flex items-center justify-end">
    <button class="btn bg-slate-700 text-white hover:bg-slate-600" onclick="qs('dlg_sessions').close()">关闭</button>
  </div>
</dialog>
<script src="/static/heroicons.js"></script>
<script>
/* ===================== 全局状态 ===================== */
let TOPIC_LIST=[], FIELD_LIST=[], ADJ_TOPIC_COL="", ADJ_FIELD_COL="";
let TOPIC_BLACKLIST=[], FIELD_BLACKLIST=[];
const SEARCH_SCOPE_DEFAULT='title';
let SESSION_ID=""; let SESSION_META=null; let CURRENT_FILTER={target:"",value:""}; let CURRENT_SORT={by:"",order:""}; let CURRENT_SEARCH={scope:SEARCH_SCOPE_DEFAULT, keyword:""};
let ACTIVE_COL="topic"; // "topic"|"field"
const PAGER = { page:1, size:50, total:0, pages:1 };
let LAST_EXPORT_URL=""; // 可选下载地址
const TREEMAP_PLOTS={};
const TREEMAP_STATE={};
const TREEMAP_CATEGORY_LIMIT=24;
const TREEMAP_COLORS=[
  '#2563eb','#1d4ed8','#3b82f6','#60a5fa','#93c5fd','#38bdf8','#0ea5e9','#06b6d4',
  '#14b8a6','#0d9488','#10b981','#22c55e','#84cc16','#facc15','#f59e0b','#f97316',
  '#fb7185','#f472b6','#ec4899','#a855f7','#8b5cf6','#6366f1','#4f46e5','#4338ca'
];
const BAR_CHART_PLOTS={};
const BAR_CHART_STATE={};
const CATEGORY_DATA={};
const CATEGORY_VIEW_STATE={
  topic_orig:'treemap',
  field_orig:'treemap',
  topic_adj:'treemap',
  field_adj:'treemap'
};
const CATEGORY_CHART_CONFIG={
  topic_orig:{ treemapId:'treemap_topic_orig', treemapKey:'chart_topic_orig', barId:'barchart_topic_orig', barKey:'bar_topic_orig' },
  field_orig:{ treemapId:'treemap_field_orig', treemapKey:'chart_field_orig', barId:'barchart_field_orig', barKey:'bar_field_orig' },
  topic_adj:{ treemapId:'treemap_topic_adj', treemapKey:'chart_topic_adj', barId:'barchart_topic_adj', barKey:'bar_topic_adj' },
  field_adj:{ treemapId:'treemap_field_adj', treemapKey:'chart_field_adj', barId:'barchart_field_adj', barKey:'bar_field_adj' }
};
let RANK_VIS_EXPANDED=false;
const SCATTER_DEFAULT_HEIGHT=420;
const SCATTER_STATE={
  height:SCATTER_DEFAULT_HEIGHT,
  hasData:false,
  observer:null,
  resizeTimer:0
};
const SCATTER_CONFIG={
  displaylogo:false,
  responsive:false,
  modeBarButtonsToRemove:['autoScale2d','hoverClosestCartesian','hoverCompareCartesian'],
};
const TIMELINE_CONFIG={
  displaylogo:false,
  responsive:true,
  modeBarButtonsToRemove:['autoScale2d','select2d','lasso2d','zoomIn2d','zoomOut2d','resetScale2d'],
};
const TIMELINE_STACK_DIMENSIONS=['topic_adj','field_adj'];
const TIMELINE_STACK_LABELS={ topic_adj:'研究主题（调整后）', field_adj:'研究领域（调整后）' };
const TIMELINE_STACK_COLORS=['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
const TIMELINE_CHART_IDS=['timeline_line_chart','timeline_area_chart'];
let TIMELINE_BIN_SIZE=5;
let TIMELINE_DATA=null;
let TIMELINE_STACK_DIM='topic_adj';
let TIMELINE_LINE_FIGURE=null;
let TIMELINE_STACK_FIGURE=null;
let AUTO_SAVE_TIMER=null;
let AUTO_SAVE_ENABLED=false;

/* ===================== 统计与图表工具 ===================== */
function safeNumber(value){
  if(typeof value==='number' && Number.isFinite(value)) return value;
  if(typeof value==='string'){
    const cleaned=value.replace(/[,\s]/g,'');
    const num=Number(cleaned);
    if(Number.isFinite(num)) return num;
  }
  const num=Number(value);
  return Number.isFinite(num)?num:0;
}
function parsePercentValue(value){
  if(value===undefined||value===null||value==='') return null;
  if(typeof value==='number' && Number.isFinite(value)) return value;
  const text=String(value).trim();
  if(!text) return null;
  const normalized=text.endsWith('%')?text.slice(0,-1):text;
  const num=Number(normalized);
  return Number.isFinite(num)?num:null;
}
function formatPercentText(percent){
  if(percent===undefined||percent===null) return '';
  const num=Number(percent);
  if(!Number.isFinite(num)) return '';
  return `${num.toFixed(2)}%`;
}
function cloneDeep(value){
  if(value===undefined||value===null){
    return value;
  }
  if(typeof structuredClone==='function'){
    try{ return structuredClone(value); }catch(e){}
  }
  try{
    return JSON.parse(JSON.stringify(value));
  }catch(e){
    return value;
  }
}
function normalizeStatItems(rawList){
  const arr=Array.isArray(rawList)?rawList:[];
  const entryMap=new Map();
  let order=0;
  arr.forEach((item,idx)=>{
    if(!item) return;
    let label=String(item.label??'').trim();
    if(!label) label=`未命名${idx+1}`;
    const count=safeNumber(item.count);
    const percent=parsePercentValue(item.percent);
    if(!entryMap.has(label)){
      entryMap.set(label,{label,count:0,percent:percent,order:order++});
    }
    const entry=entryMap.get(label);
    entry.count+=count;
    if(percent!==null){ entry.percent=percent; }
  });
  return Array.from(entryMap.values()).sort((a,b)=>a.order-b.order);
}
function buildBarChartEntries(primaryRaw, overlayRaw){
  const primary=normalizeStatItems(primaryRaw);
  const overlay=normalizeStatItems(overlayRaw);
  const primaryMap=new Map(primary.map(item=>[item.label,item]));
  const overlayMap=new Map(overlay.map(item=>[item.label,item]));
  const entryMap=new Map();
  let order=0;
  const ensureEntry=label=>{
    if(entryMap.has(label)) return entryMap.get(label);
    const entry={label,primary:0,overlay:0,order:order++};
    entryMap.set(label,entry);
    return entry;
  };
  primary.forEach(item=>{
    const entry=ensureEntry(item.label);
    entry.primary+=safeNumber(item.count);
  });
  overlay.forEach(item=>{
    const entry=ensureEntry(item.label);
    entry.overlay+=safeNumber(item.count);
  });
  const entries=Array.from(entryMap.values()).sort((a,b)=>a.order-b.order);
  return { entries, primaryMap, overlayMap };
}
function limitBarEntries(entries, limit=TREEMAP_CATEGORY_LIMIT){
  if(!Array.isArray(entries)) return [];
  const maxCount=Number.isFinite(limit)&&limit>0?Math.floor(limit):TREEMAP_CATEGORY_LIMIT;
  if(entries.length<=maxCount) return entries;
  const scored=entries.map((entry,idx)=>({
    entry,
    idx,
    score:safeNumber(entry.primary)+safeNumber(entry.overlay)
  }));
  const picked=new Set(
    scored
      .sort((a,b)=>b.score-a.score||(a.idx-b.idx))
      .slice(0,maxCount)
      .map(item=>item.idx)
  );
  return entries.filter((_,idx)=>picked.has(idx));
}
let AUTO_SAVE_MINUTES=5;
let IS_BATCH_SAVING=false;
let HAS_RANKING_DATA=false;
let VISUAL_TAB='orig';

const SORT_VALUE_DEFAULT='default';
const SORT_VALUE_RANK_ASC='rank_asc';
const SORT_VALUE_RANK_DESC='rank_desc';

const qs = id=>document.getElementById(id);
const escapeHtml = s=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
const escapeAttr = s=>escapeHtml(s).replaceAll('"','&quot;');
const LANGUAGE_TOGGLE = document.getElementById('lang_toggle');
const LANGUAGE_TOGGLE_LABEL = document.getElementById('lang_toggle_label');
const SUPPORTED_LANGS = ['zh','en'];
const I18N_STRINGS = {
  zh: {
    'hero.eyebrow': 'CommCoder Studio',
    'hero.title': '编码协同流程总览',
    'hero.subtitle': '以下流程呈现从自动化产出的原始结果，到人工覆核与统计抽样验证的完整闭环。',
    'hero.abstractTitle': '方法论简介',
    'hero.abstractParagraph1': '本工作台以自动化模型为前端引擎，借助语义聚类与人工干预协同推进，对主题空缺与离群样本实行双轨校准。',
    'hero.abstractParagraph2': '流程后段强调多源整合与质量抽检，旨在确保编码结果在统计意义上的稳定性与可复现性。',
    'flow.aiAuto': 'AI 自动编码',
    'flow.toWorkspace': '编码结果进入工作台',
    'flow.manualClassify': '未识别主题人工分类',
    'flow.kmeans': 'K-Means 聚类',
    'flow.outlier': '离群值识别',
    'flow.review': '人工覆核调整',
    'flow.integrate': '多通道结果整合',
    'flow.validation': '抽样验证可靠性'
  },
  en: {
    'hero.eyebrow': 'CommCoder Studio',
    'hero.title': 'Coding Collaboration Workflow Overview',
    'hero.subtitle': 'This workflow outlines the full loop from automated outputs to human review and sampling validation.',
    'hero.abstractTitle': 'Methodology Overview',
    'hero.abstractParagraph1': 'The workspace is powered by automated models up front, pairing semantic clustering with human intervention to jointly correct topic gaps and outlier samples.',
    'hero.abstractParagraph2': 'Later stages emphasise multi-source integration and quality sampling to secure statistical stability and reproducibility.',
    'flow.aiAuto': 'AI Auto Coding',
    'flow.toWorkspace': 'Results enter the workspace',
    'flow.manualClassify': 'Manual classification for unidentified topics',
    'flow.kmeans': 'K-Means clustering',
    'flow.outlier': 'Outlier detection',
    'flow.review': 'Human review & adjustment',
    'flow.integrate': 'Multi-channel result integration',
    'flow.validation': 'Sample-based reliability validation'
  }
};
const I18N_ATTR_MAP = {
  zh: {
    '#hero_flow_diagram': { 'aria-label': '编码流程图' }
  },
  en: {
    '#hero_flow_diagram': { 'aria-label': 'Coding workflow diagram' }
  }
};
let CURRENT_LANG = 'zh';

function applyLanguage(lang){
  const target = SUPPORTED_LANGS.includes(lang) ? lang : 'zh';
  CURRENT_LANG = target;
  document.documentElement.setAttribute('lang', target === 'en' ? 'en' : 'zh');
  document.querySelectorAll('[data-i18n-key]').forEach(el => {
    const key = el.dataset.i18nKey;
    const textMap = I18N_STRINGS[target] || {};
    if(key && Object.prototype.hasOwnProperty.call(textMap, key)){
      el.textContent = textMap[key];
    }
  });
  const attrEntries = I18N_ATTR_MAP[target] || {};
  Object.entries(attrEntries).forEach(([selector, attrs]) => {
    const el = document.querySelector(selector);
    if(!el){ return; }
    Object.entries(attrs || {}).forEach(([attr, value]) => {
      el.setAttribute(attr, value);
    });
  });
  if(LANGUAGE_TOGGLE_LABEL){
    LANGUAGE_TOGGLE_LABEL.textContent = target === 'zh' ? 'English' : '中文';
  }
  if(LANGUAGE_TOGGLE){
    const toggleLabel = target === 'zh' ? '切换为英文' : 'Switch to Chinese';
    LANGUAGE_TOGGLE.setAttribute('aria-label', toggleLabel);
    LANGUAGE_TOGGLE.setAttribute('title', toggleLabel);
  }
}

if(LANGUAGE_TOGGLE){
  LANGUAGE_TOGGLE.addEventListener('click', () => {
    applyLanguage(CURRENT_LANG === 'zh' ? 'en' : 'zh');
  });
}

applyLanguage('zh');

const numberFormatter = new Intl.NumberFormat('zh-CN');
const TOAST_THEMES = {
  info: "bg-slate-900/90 text-white",
  success: "bg-emerald-600 text-white",
  error: "bg-rose-600 text-white",
  warning: "bg-amber-500 text-slate-900",
};

function getToastContainer(){
  return document.getElementById('toast_stack');
}

function showToast(message, type='info', options={}){
  const container = getToastContainer();
  if(!container) return;
  const theme = TOAST_THEMES[type] || TOAST_THEMES.info;
  const toast = document.createElement('div');
  toast.className = `pointer-events-auto rounded-2xl shadow-lg shadow-slate-900/20 px-4 py-3 text-sm leading-relaxed transition duration-300 ease-out transform translate-y-2 opacity-0 ${theme}`;
  toast.textContent = message;
  container.appendChild(toast);
  requestAnimationFrame(()=>{
    toast.classList.remove('opacity-0','translate-y-2');
  });
  const duration = typeof options.duration === 'number' && options.duration>0 ? options.duration : 5000;
  setTimeout(()=>{
    toast.classList.add('opacity-0','translate-y-2');
    setTimeout(()=>{ toast.remove(); }, 300);
  }, duration);
}

window.showToast = showToast;
window.alert = (msg)=>{
  const text = String(msg ?? '');
  let type = 'info';
  if(text.includes('失败') || text.includes('错误') || text.includes('异常')){
    type = 'error';
  }else if(text.includes('已') || text.includes('成功') || text.includes('完成')){
    type = 'success';
  }
  showToast(text, type);
};
const setBadge = ()=>{
  const badge = qs('session_badge');
  if(badge){ badge.textContent = "Session: " + (SESSION_ID||"—"); }
  const homeHint = qs('home_session_hint');
  if(homeHint){ homeHint.textContent = SESSION_ID || '—'; }
};

function renderSessionMeta(meta){
  const summary = qs('session_meta_summary');
  const primary = qs('session_meta_primary');
  const secondary = qs('session_meta_secondary');
  SESSION_META = meta || null;
  if(!summary || !primary || !secondary){ return; }
  summary.dataset.state = meta ? 'active' : 'empty';
  summary.classList.toggle('opacity-60', !meta);
  if(!meta){
    primary.textContent = '暂无会话';
    secondary.textContent = '请上传或载入数据集';
    LAST_EXPORT_URL = '';
    refreshHomeActions();
    updateWorkspaceAccess();
    return;
  }
  const fileName = meta.origin_filename ? meta.origin_filename : '未命名数据集';
  const rowsNum = typeof meta.rows === 'number' && isFinite(meta.rows) ? numberFormatter.format(meta.rows) : '未知';
  primary.textContent = `已载入：${fileName}（${rowsNum} 行）`;
  const details = [];
  if(meta.updated_text){ details.push(`最近保存：${meta.updated_text}`); }
  if(meta.last_export_time){ details.push(`最近导出：${meta.last_export_time}`); }
  if(!details.length){ details.push('尚无保存或导出记录'); }
  secondary.textContent = details.join(' · ');
  if(meta.last_export_path){
    LAST_EXPORT_URL = `/file?path=${encodeURIComponent(meta.last_export_path)}`;
  }else{
    LAST_EXPORT_URL = '';
  }
  refreshHomeActions();
  updateWorkspaceAccess();
}

async function refreshSessionMeta(){
  if(!SESSION_ID){
    renderSessionMeta(null);
    return null;
  }
  try{
    const r = await fetch(`/session/info?session_id=${encodeURIComponent(SESSION_ID)}`, {cache:'no-store'});
    if(!r.ok){ throw new Error('meta not available'); }
    const j = await r.json();
    renderSessionMeta(j.meta||null);
    return j.meta||null;
  }catch(e){
    return SESSION_META;
  }
}

const PAGE_HEADER = document.querySelector('header');
const SIDEBAR = document.getElementById('sidebar');
const SIDEBAR_TOGGLE = document.getElementById('sidebar_toggle');
let SIDEBAR_COLLAPSED = false;

function updateSidebarOffset(){
  if(!PAGE_HEADER){ return; }
  const rect = PAGE_HEADER.getBoundingClientRect();
  let offset = (window.scrollY <= 0) ? PAGE_HEADER.offsetHeight : rect.bottom;
  if(!Number.isFinite(offset)){ offset = PAGE_HEADER.offsetHeight || 0; }
  offset = Math.max(0, Math.min(offset, window.innerHeight || offset));
  document.documentElement.style.setProperty('--header-offset', `${offset}px`);
}

if(PAGE_HEADER){
  window.addEventListener('scroll', updateSidebarOffset, {passive:true});
  window.addEventListener('resize', updateSidebarOffset);
  window.addEventListener('load', updateSidebarOffset);
  requestAnimationFrame(updateSidebarOffset);
}

function applySidebarState(collapsed){
  if(!SIDEBAR) return;
  SIDEBAR_COLLAPSED = collapsed;
  SIDEBAR.dataset.collapsed = collapsed ? 'true' : 'false';
  if(SIDEBAR_TOGGLE){
    SIDEBAR_TOGGLE.setAttribute('aria-expanded', (!collapsed).toString());
    SIDEBAR_TOGGLE.title = collapsed ? '展开侧边栏' : '收起侧边栏';
    SIDEBAR_TOGGLE.setAttribute('aria-label', SIDEBAR_TOGGLE.title);
    const icon = SIDEBAR_TOGGLE.querySelector('svg[data-heroicon]');
    if(icon){
      const targetIcon = collapsed ? 'chevron-right' : 'chevron-left';
      if(window.Heroicons && typeof window.Heroicons.apply === 'function'){
        window.Heroicons.apply(icon, targetIcon);
      }else{
        icon.dataset.heroicon = targetIcon;
      }
    }
  }
  try{ localStorage.setItem('sidebar_collapsed', collapsed ? '1' : '0'); }catch(e){}
}

if(SIDEBAR_TOGGLE){
  SIDEBAR_TOGGLE.addEventListener('click', ()=>{
    applySidebarState(!SIDEBAR_COLLAPSED);
  });
}

try{
  const storedState = localStorage.getItem('sidebar_collapsed');
  applySidebarState(storedState === '1');
}catch(e){
  applySidebarState(false);
}

const PAGE_SECTIONS = Array.from(document.querySelectorAll('.page-section'));
const NAV_BUTTONS = Array.from(document.querySelectorAll('.nav-link[data-target]'));
const MOBILE_PAGE_SELECT = document.getElementById('mobile_page_select');
const HOME_LOCK_WRAP = document.getElementById('home_lock_hint_wrapper');
const HOME_LOCK_HINT = document.getElementById('home_lock_hint');
const HOME_LOCK_ICON = document.getElementById('home_lock_icon');
const SESSION_REQUIRED_PAGES = new Set(['page-coding','page-visual']);
const HOME_ACTION_CONFIG = [
  { action: 'save-session', btnId: 'btn_save_session', requiresSession: true },
  { action: 'load-session', btnId: 'btn_load_session', requiresSession: false },
  { action: 'export-excel', btnId: 'btn_save_excel', requiresSession: true },
  { action: 'download-export', btnId: 'btn_download_last', requiresSession: true, requiresExport: true }
];
let ACTIVE_PAGE = 'page-home';
const TIMELINE_BIN_SELECT = document.getElementById('timeline_bin_select');
if(TIMELINE_BIN_SELECT){
  const initVal=parseInt(TIMELINE_BIN_SELECT.value,10);
  if(Number.isFinite(initVal) && initVal>0){
    TIMELINE_BIN_SIZE=initVal;
  }
  TIMELINE_BIN_SELECT.addEventListener('change',()=>{
    const raw=parseInt(TIMELINE_BIN_SELECT.value,10);
    if(!Number.isFinite(raw) || raw<=0) return;
    if(raw===TIMELINE_BIN_SIZE) return;
    TIMELINE_BIN_SIZE=raw;
    if(SESSION_ID){
      refreshStats();
    }else{
      clearTimelineCharts('');
    }
  });
}

const TIMELINE_STACK_TOGGLES = Array.from(document.querySelectorAll('[data-timeline-stack]'));
function updateTimelineStackToggle(){
  TIMELINE_STACK_TOGGLES.forEach(btn=>{
    const dim = btn.dataset.timelineStack;
    const isActive = dim===TIMELINE_STACK_DIM;
    btn.classList.toggle('timeline-stack-btn-active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}
function setTimelineStackDim(dim){
  if(!TIMELINE_STACK_DIMENSIONS.includes(dim)){
    dim = 'topic_adj';
  }
  if(TIMELINE_STACK_DIM === dim){
    return;
  }
  TIMELINE_STACK_DIM = dim;
  updateTimelineStackToggle();
  renderTimelineStackChart(TIMELINE_DATA);
}
TIMELINE_STACK_TOGGLES.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const dim = btn.dataset.timelineStack;
    setTimelineStackDim(dim);
  });
});
updateTimelineStackToggle();

const TIMELINE_LINE_EXPAND_BTN = document.getElementById('btn_expand_timeline_line');
if(TIMELINE_LINE_EXPAND_BTN){
  TIMELINE_LINE_EXPAND_BTN.addEventListener('click',()=>{
    openTimelineFigureFullScreen(TIMELINE_LINE_FIGURE, '发表数量趋势');
  });
}
const TIMELINE_STACK_EXPAND_BTN = document.getElementById('btn_expand_timeline_stack');
if(TIMELINE_STACK_EXPAND_BTN){
  TIMELINE_STACK_EXPAND_BTN.addEventListener('click',()=>{
    const label = TIMELINE_STACK_LABELS[TIMELINE_STACK_DIM] || '分类占比堆叠图';
    openTimelineFigureFullScreen(TIMELINE_STACK_FIGURE, label);
  });
}

function pingHomeLock(){
  if(!HOME_LOCK_WRAP) return;
  HOME_LOCK_WRAP.classList.remove('home-lock-bounce');
  void HOME_LOCK_WRAP.offsetWidth;
  HOME_LOCK_WRAP.classList.add('home-lock-bounce');
  setTimeout(()=>{
    if(HOME_LOCK_WRAP){
      HOME_LOCK_WRAP.classList.remove('home-lock-bounce');
    }
  }, 950);
}

function updateWorkspaceAccess(){
  const hasSession = !!SESSION_ID;
  NAV_BUTTONS.forEach(btn=>{
    const target = btn.dataset.target;
    const locked = SESSION_REQUIRED_PAGES.has(target) && !hasSession;
    btn.dataset.locked = locked ? '1' : '0';
    btn.setAttribute('aria-disabled', locked ? 'true' : 'false');
    btn.classList.toggle('nav-link-disabled', locked);
    if(!btn.dataset.baseTitle && btn.title){
      btn.dataset.baseTitle = btn.title;
    }
    if(locked){
      const baseTitle = btn.dataset.baseTitle || btn.title || '';
      const lockedTitle = baseTitle ? `${baseTitle}（未解锁）` : '页面未解锁';
      btn.title = lockedTitle;
      btn.setAttribute('aria-label', lockedTitle);
    }else if(btn.dataset.baseTitle){
      btn.title = btn.dataset.baseTitle;
      btn.setAttribute('aria-label', btn.dataset.baseTitle);
    }
  });
  if(MOBILE_PAGE_SELECT){
    Array.from(MOBILE_PAGE_SELECT.options).forEach(opt=>{
      const locked = SESSION_REQUIRED_PAGES.has(opt.value) && !hasSession;
      opt.disabled = locked;
    });
    if(SESSION_REQUIRED_PAGES.has(MOBILE_PAGE_SELECT.value) && !hasSession){
      MOBILE_PAGE_SELECT.value = 'page-home';
    }
  }
  if(!hasSession && SESSION_REQUIRED_PAGES.has(ACTIVE_PAGE)){
    activatePage('page-home', {force:true});
  }
  if(HOME_LOCK_WRAP){
    HOME_LOCK_WRAP.dataset.state = hasSession ? 'ready' : 'locked';
  }
  if(HOME_LOCK_HINT){
    if(hasSession){
      const fileName = SESSION_META?.origin_filename ? SESSION_META.origin_filename : '未命名数据集';
      const rowsNum = (SESSION_META && typeof SESSION_META.rows === 'number' && isFinite(SESSION_META.rows)) ? `${numberFormatter.format(SESSION_META.rows)} 行` : '行数待获取';
      HOME_LOCK_HINT.textContent = `当前会话：${fileName} · ${rowsNum}，工作台已解锁。`;
    }else{
      HOME_LOCK_HINT.textContent = '请在下方上传数据集或载入会话以解锁编码工作台与数据可视化。';
    }
  }
  if(HOME_LOCK_ICON){
    const iconName = hasSession ? 'lock-open' : 'lock-closed';
    if(window.Heroicons && typeof window.Heroicons.apply === 'function'){
      window.Heroicons.apply(HOME_LOCK_ICON, iconName);
    }else{
      HOME_LOCK_ICON.dataset.heroicon = iconName;
    }
  }
  refreshHomeActions();
}

function refreshHomeActions(){
  const hasSession = !!SESSION_ID;
  const hasExport = !!LAST_EXPORT_URL;
  HOME_ACTION_CONFIG.forEach(cfg=>{
    const btn = document.getElementById(cfg.btnId);
    const card = document.querySelector(`.home-action-card[data-action="${cfg.action}"]`);
    const disabled = (cfg.requiresSession && !hasSession) || (cfg.requiresExport && !hasExport);
    if(btn){ btn.disabled = disabled; }
    if(card){ card.dataset.disabled = disabled ? 'true' : 'false'; }
  });
}

function activatePage(targetId, options={}){
  const force = options.force === true;
  if(!force && SESSION_REQUIRED_PAGES.has(targetId) && !SESSION_ID){
    pingHomeLock();
    return;
  }
  PAGE_SECTIONS.forEach(section=>section.classList.toggle('hidden', section.id !== targetId));
  NAV_BUTTONS.forEach(btn=>{
    const isActive = btn.dataset.target === targetId;
    btn.classList.toggle('nav-link-active', isActive);
  });
  if(MOBILE_PAGE_SELECT && MOBILE_PAGE_SELECT.value !== targetId){
    MOBILE_PAGE_SELECT.value = targetId;
  }
  ACTIVE_PAGE = targetId;
}

function enterWorkspace(){
  updateWorkspaceAccess();
  activatePage('page-coding');
}

NAV_BUTTONS.forEach(btn=>btn.addEventListener('click', ()=>{
  if(btn.dataset.locked === '1'){
    pingHomeLock();
    return;
  }
  activatePage(btn.dataset.target);
}));
if(MOBILE_PAGE_SELECT){
  MOBILE_PAGE_SELECT.addEventListener('change', e=>{
    const target = e.target.value;
    if(SESSION_REQUIRED_PAGES.has(target) && !SESSION_ID){
      e.target.value = ACTIVE_PAGE;
      pingHomeLock();
      return;
    }
    activatePage(target);
  });
}

activatePage('page-home', {force:true});
updateWorkspaceAccess();

/* ---- 默认兜底表 ---- */
const DEF_TOPICS = ["健康议题","经济议题","政治议题","环境议题","传播模式与行为","媒介制度与平台治理","科技议题","文化议题","宗教议题","其他议题"];
const DEF_FIELDS = ["政治传播","健康传播","大众传播","新闻学","跨文化传播","人际传播","科学传播","法律与政策","公共关系","组织传播","媒介效果","传播心理学","传播伦理","传播理论","广告学","传播研究方法","媒介史","媒介技术","言语传播","教育传播","计算传播","网络与新媒体","其他领域"];

/* ===================== 配置加载 ===================== */
async function fetchFrontendConfig(){
  try{
    const r=await fetch("/frontend_config",{cache:"no-store"}); const j=await r.json();
    ADJ_TOPIC_COL=j.adj_topic_key||"研究主题（议题）分类_调整";
    ADJ_FIELD_COL=j.adj_field_key||"研究领域分类_调整";
    TOPIC_LIST=Array.isArray(j.topic_list)&&j.topic_list.length?j.topic_list:[...DEF_TOPICS];
    FIELD_LIST=Array.isArray(j.field_list)&&j.field_list.length?j.field_list:[...DEF_FIELDS];
    qs('app_ver').textContent="v"+(j.app_version||"");
  }catch(e){
    ADJ_TOPIC_COL="研究主题（议题）分类_调整";
    ADJ_FIELD_COL="研究领域分类_调整";
    TOPIC_LIST=[...DEF_TOPICS]; FIELD_LIST=[...DEF_FIELDS];
  }
  setBlacklistSelections(TOPIC_BLACKLIST, FIELD_BLACKLIST);
}
async function fetchEnvDefaults(){
  const r=await fetch("/default_llm_config"); if(!r.ok) return;
  const j=await r.json();
  if(!localStorage.getItem("llm_cfg")){
    qs('cfg_base_url').value=j.base_url||""; qs('cfg_api_key').value=j.api_key||"";
    qs('cfg_model').value=j.model||""; qs('cfg_temp').value=j.temp??0.2;
  }
}
function renderBlacklistOptions(topicSelected=TOPIC_BLACKLIST, fieldSelected=FIELD_BLACKLIST){
  const renderGroup=(list, selected, kind)=>{
    if(!Array.isArray(list) || !list.length){
      return '<p class="text-xs text-slate-400">暂无候选分类</p>';
    }
    return list.map(name=>{
      const checked = Array.isArray(selected) && selected.includes(name);
      return `<label class="inline-flex items-center cursor-pointer select-none">
  <input type="checkbox" class="sr-only peer blacklist-input" data-kind="${kind}" value="${escapeAttr(name)}" ${checked?'checked':''}>
  <span class="px-3 py-2 rounded-full border border-slate-200 text-sm text-slate-600 bg-white transition-colors peer-checked:bg-slate-900 peer-checked:text-white peer-checked:border-slate-900">${escapeHtml(name)}</span>
</label>`;
    }).join("");
  };
  const topicWrap=qs('topic_blacklist_options');
  if(topicWrap){ topicWrap.innerHTML = renderGroup(TOPIC_LIST, topicSelected, 'topic'); }
  const fieldWrap=qs('field_blacklist_options');
  if(fieldWrap){ fieldWrap.innerHTML = renderGroup(FIELD_LIST, fieldSelected, 'field'); }
}
function setBlacklistSelections(topicList=[], fieldList=[]){
  TOPIC_BLACKLIST = Array.isArray(topicList)?topicList.filter(it=>TOPIC_LIST.includes(it)):[];
  FIELD_BLACKLIST = Array.isArray(fieldList)?fieldList.filter(it=>FIELD_LIST.includes(it)):[];
  renderBlacklistOptions(TOPIC_BLACKLIST, FIELD_BLACKLIST);
}
function collectBlacklistSelections(){
  const topicSet=new Set();
  document.querySelectorAll('#topic_blacklist_options input[data-kind="topic"]:checked').forEach(el=>{
    const v=(el.value||"").trim(); if(v){ topicSet.add(v); }
  });
  const fieldSet=new Set();
  document.querySelectorAll('#field_blacklist_options input[data-kind="field"]:checked').forEach(el=>{
    const v=(el.value||"").trim(); if(v){ fieldSet.add(v); }
  });
  TOPIC_BLACKLIST=[...topicSet];
  FIELD_BLACKLIST=[...fieldSet];
  return { topic:[...topicSet], field:[...fieldSet] };
}
function loadCfgFromLocal(){
  const raw=localStorage.getItem("llm_cfg"); if(!raw){ setBlacklistSelections([], []); return; }
  try{
    const c=JSON.parse(raw);
    qs('cfg_base_url').value=c.base_url||"";
    qs('cfg_api_key').value=c.api_key||"";
    qs('cfg_model').value=c.model||"";
    qs('cfg_temp').value=c.temp??0.2;
    setBlacklistSelections(c.topic_blacklist, c.field_blacklist);
  }catch(e){
    setBlacklistSelections([], []);
  }
}
function saveCfgToLocal(){
  const { topic:topicBlacklist, field:fieldBlacklist } = collectBlacklistSelections();
  const c={
    base_url:qs('cfg_base_url').value.trim(),
    api_key:qs('cfg_api_key').value.trim(),
    model:qs('cfg_model').value.trim(),
    temp:parseFloat(qs('cfg_temp').value||"0.2"),
    topic_blacklist:topicBlacklist,
    field_blacklist:fieldBlacklist
  };
  localStorage.setItem("llm_cfg", JSON.stringify(c));
  qs('cfg_msg').innerText="已保存到浏览器";
}
async function saveEnvToServer(){
  const c={ base_url:qs('cfg_base_url').value.trim(), api_key:qs('cfg_api_key').value.trim(), model:qs('cfg_model').value.trim(), temp:parseFloat(qs('cfg_temp').value||"0.2") };
  const r=await fetch("/save_env",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}); if(!r.ok){ alert("写入 .env 失败："+await r.text()); return; }
  qs('cfg_msg').innerText="已写入 .env（OPENAI_BASE_URL / OPENAI_API_KEY / OPENAI_MODEL）";
}

/* ===================== 上传 ===================== */
function uploadFile(){
  const fi=qs('file_input'), btn=qs('btn_upload'), bar=qs('up_bar'), msg=qs('up_msg');
  if(!fi.files?.length){ alert("请选择文件"); return; }
  btn.disabled=true; btn.textContent="上传中..."; bar.style.width="0%"; msg.textContent="0%";
  const form=new FormData(); form.append("file", fi.files[0]);
  const xhr=new XMLHttpRequest(); xhr.open("POST","/upload");
  xhr.upload.onprogress=e=>{ if(e.lengthComputable){ const p=Math.round(e.loaded*100/e.total); bar.style.width=p+"%"; msg.textContent=p+"%"; } };
  xhr.onreadystatechange=async ()=>{ if(xhr.readyState===4){ btn.disabled=false; btn.textContent="上传并新建会话";
      if(xhr.status>=200&&xhr.status<300){ const d=JSON.parse(xhr.responseText);
        SESSION_ID=d.session_id; setBadge(); enterWorkspace(); qs('total_msg').textContent=`共 ${d.total} 行`; msg.textContent="加载成功";
        PAGER.page=1; PAGER.size=parseInt(qs('ps_input').value||"50")||50;
        LAST_EXPORT_URL=""; // 新会话清空
        refreshHomeActions();
        clearScatterPlot('等待计算后展示。');
        await refreshSessionMeta();
        await refreshStats();
        populateFilterOptions();
        CURRENT_SEARCH={scope:SEARCH_SCOPE_DEFAULT, keyword:""};
        syncSearchControls();
        CURRENT_FILTER={target:"",value:""};
        CURRENT_SORT={by:"",order:""};
        setSortAvailability(false);
        syncSortSelect();
        await loadPage();
    }else{ msg.textContent="上传失败："+xhr.responseText; alert("上传失败："+xhr.responseText); } } };
  xhr.send(form);
}

/* ===================== 统计/图表/筛选 ===================== */
function renderChips(elId,primaryRaw,targetKey,options={}){
  const el=qs(elId);
  if(!el) return;
  el.innerHTML="";
  const { entries, primaryMap, overlayMap } = buildBarChartEntries(primaryRaw, options.overlay);
  if(!entries.length){
    return;
  }
  const primaryPrefix=options.primaryLabel?`${options.primaryLabel}：`:'';
  const overlayPrefix=options.overlayLabel?`${options.overlayLabel}：`:'';
  entries.forEach(entry=>{
    const label=entry.label;
    const primaryItem=primaryMap.get(label);
    const overlayItem=overlayMap.get(label);
    const btn=document.createElement('button');
    btn.className='chip text-sm';
    const primaryParts=[`${primaryPrefix}${safeNumber(primaryItem?.count??0)}`];
    const primaryPercent=formatPercentText(primaryItem?.percent);
    if(primaryPercent) primaryParts.push(primaryPercent);
    const displayParts=[primaryParts.join(' | ')];
    if(overlayItem){
      const overlayParts=[`${overlayPrefix}${safeNumber(overlayItem.count??0)}`];
      const overlayPercent=formatPercentText(overlayItem.percent);
      if(overlayPercent) overlayParts.push(overlayPercent);
      if(overlayPrefix || safeNumber(overlayItem.count??0)!==0 || overlayPercent){
        displayParts.push(overlayParts.join(' | '));
      }
    }
    btn.textContent=`${label}（${displayParts.join(' · ')}）`;
    btn.onclick=()=>quickFilter(targetKey,label);
    el.appendChild(btn);
  });
}
function destroyTreemap(key){
  const el=TREEMAP_PLOTS[key];
  if(el && window.Plotly){
    try{ Plotly.purge(el); }catch(e){}
  }
  delete TREEMAP_PLOTS[key];
}
function cloneTreemapOptions(options){
  if(!options) return {};
  const cloned={...options};
  if(Array.isArray(options.overlay)){
    cloned.overlay=options.overlay.map(item=>({ ...(item||{}) }));
  }
  return cloned;
}
function cloneStatList(raw){
  if(!Array.isArray(raw)) return [];
  return raw.map(item=>{
    if(item && typeof item==='object'){
      return { ...item };
    }
    return {};
  });
}
function isChartHidden(el){
  if(!el) return true;
  if(typeof el.checkVisibility==='function'){
    try{
      return !el.checkVisibility({visibilityProperty:true, displayProperty:true, opacityProperty:true, contentVisibilityAuto:true});
    }catch(e){}
  }
  if(el.getClientRects().length===0) return true;
  let node=el;
  while(node && node!==document.body){
    const style=window.getComputedStyle(node);
    if(style.display==='none' || style.visibility==='hidden') return true;
    node=node.parentElement;
  }
  return false;
}
function renderTreemap(containerId,primaryRaw,key,options={},internal=false){
  const container=qs(containerId);
  if(!container){
    destroyTreemap(key);
    delete TREEMAP_STATE[key];
    return;
  }
  const optionClone=cloneTreemapOptions(options);
  const primaryClone=cloneStatList(primaryRaw);
  if(!internal){
    TREEMAP_STATE[key]={containerId, primaryRaw:primaryClone, options:optionClone};
    if(isChartHidden(container)){
      container.dataset.treemapDeferred='1';
      container.innerHTML='<div class="treemap-empty">切换标签以查看图表</div>';
      destroyTreemap(key);
      return;
    }
  }else if(isChartHidden(container)){
    return;
  }
  if(container.dataset.treemapDeferred){
    delete container.dataset.treemapDeferred;
  }
  if(!window.Plotly){
    destroyTreemap(key);
    container.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    return;
  }
  container.innerHTML='';
  const { entries } = buildBarChartEntries(primaryClone, optionClone.overlay);
  const limit = Number.isFinite(optionClone.limit)&&optionClone.limit>0?Math.floor(optionClone.limit):TREEMAP_CATEGORY_LIMIT;
  let limitedEntries = limitBarEntries(entries, limit);
  const picked=new Set(limitedEntries.map(entry=>entry.label));
  let otherPrimary=0;
  let otherOverlay=0;
  entries.forEach(entry=>{
    if(!picked.has(entry.label)){
      otherPrimary+=safeNumber(entry.primary);
      otherOverlay+=safeNumber(entry.overlay);
    }
  });
  if(otherPrimary>0){
    limitedEntries=[...limitedEntries,{label:'其他',primary:otherPrimary,overlay:otherOverlay,isOther:true,order:entries.length+1}];
  }
  if(!limitedEntries.length){
    destroyTreemap(key);
    container.innerHTML='<div class="treemap-empty">暂无数据</div>';
    return;
  }
  const hasOverlay=Array.isArray(optionClone.overlay)&&optionClone.overlay.length>0;
  const primaryList=normalizeStatItems(primaryClone);
  const overlayList=normalizeStatItems(optionClone.overlay);
  const primaryMap=new Map(primaryList.map(item=>[item.label,item]));
  const overlayMap=new Map(overlayList.map(item=>[item.label,item]));
  const primaryTotal=primaryList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const overlayTotal=overlayList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const displayedTotal=limitedEntries.reduce((sum,entry)=>sum+safeNumber(entry.primary),0);
  if(displayedTotal<=0){
    destroyTreemap(key);
    container.innerHTML='<div class="treemap-empty">暂无数据</div>';
    return;
  }
  const rootLabel=optionClone.rootLabel||optionClone.primaryLabel||'分类';
  const labels=[rootLabel];
  const parents=[''];
  const values=[displayedTotal];
  const text=[''];
  const hovers=[''];
  limitedEntries.forEach((entry,idx)=>{
    const label=entry.label;
    const primaryValue=safeNumber(entry.primary);
    const overlayValue=safeNumber(entry.overlay);
    const primaryPercentRaw=primaryMap.get(label)?.percent;
    let primaryPercent=formatPercentText(primaryPercentRaw);
    if(!primaryPercent && primaryTotal>0 && primaryValue>0){
      primaryPercent=`${((primaryValue/primaryTotal)*100).toFixed(2)}%`;
    }
    const overlayPercentRaw=overlayMap.get(label)?.percent;
    let overlayPercent=formatPercentText(overlayPercentRaw);
    if(!overlayPercent && overlayTotal>0 && overlayValue>0){
      overlayPercent=`${((overlayValue/overlayTotal)*100).toFixed(2)}%`;
    }
    labels.push(label);
    parents.push(rootLabel);
    values.push(primaryValue);
    const displayParts=[String(primaryValue)];
    if(primaryPercent) displayParts.push(primaryPercent);
    text.push(`${label}<br>${displayParts.join(' · ')}`);
    const hoverLines=[`<b>${label}</b>`, `${optionClone.primaryLabel||'数量'}：${primaryValue}${primaryPercent?`（${primaryPercent}）`:''}`];
    if(hasOverlay && (overlayValue>0 || overlayPercent)){
      hoverLines.push(`${optionClone.overlayLabel||'对比'}：${overlayValue}${overlayPercent?`（${overlayPercent}）`:''}`);
    }
    hovers.push(hoverLines.join('<br>'));
  });
  const colors=['rgba(148,163,184,0.18)'];
  limitedEntries.forEach((entry,idx)=>{
    const baseColor=entry.isOther?'rgba(148,163,184,0.35)':TREEMAP_COLORS[idx % TREEMAP_COLORS.length];
    colors.push(baseColor);
  });
  const trace={
    type:'treemap',
    labels,
    parents,
    values,
    branchvalues:'total',
    text,
    textinfo:'text',
    textfont:{size:12,color:'#0f172a',family:'"Inter","Noto Sans SC","PingFang SC","Microsoft YaHei",sans-serif'},
    hoverinfo:'text',
    hovertext:hovers,
    marker:{colors,line:{color:'rgba(255,255,255,0.85)',width:1}},
    root:{color:'rgba(148,163,184,0.18)'}
  };
  const layout={
    margin:{l:4,r:4,t:4,b:4},
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    uniformtext:{minsize:12,mode:'hide'}
  };
  const width=container.clientWidth||container.offsetWidth||0;
  const widthHeight=width?Math.round(width*0.55):0;
  const countHeight=260+Math.max(0, Math.min(limitedEntries.length, limit)-6)*12;
  let desiredHeight=Math.max(widthHeight, countHeight, 260);
  desiredHeight=Math.min(desiredHeight, 520);
  if(!Number.isFinite(desiredHeight) || desiredHeight<=0){
    desiredHeight=320;
  }
  layout.height=desiredHeight;
  container.style.minHeight=`${desiredHeight}px`;
  container.style.height=`${desiredHeight}px`;
  TREEMAP_PLOTS[key]=container;
  const config={displayModeBar:false,responsive:true};
  try{
    const plotPromise=Plotly.react(container,[trace],layout,config);
    const onError=err=>{
      console.error('Treemap 渲染失败',err);
      container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
      destroyTreemap(key);
    };
    if(plotPromise && typeof plotPromise.then==='function'){
      plotPromise.then(()=>{
        if(window.Plotly){
          try{ Plotly.Plots.resize(container); }catch(e){}
        }
      }).catch(onError);
    }else if(window.Plotly){
      try{ Plotly.Plots.resize(container); }catch(e){}
    }
  }catch(err){
    console.error('Treemap 渲染失败',err);
    container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
    destroyTreemap(key);
  }
}
function renderDeferredTreemaps(){
  Object.entries(TREEMAP_STATE).forEach(([key,state])=>{
    const container=qs(state.containerId);
    if(!container) return;
    if(isChartHidden(container)) return;
    if(TREEMAP_PLOTS[key]===container){
      if(window.Plotly){
        try{ Plotly.Plots.resize(container); }catch(e){}
      }
      return;
    }
    renderTreemap(state.containerId, state.primaryRaw, key, state.options, true);
  });
}

function destroyBarChart(key){
  const el=BAR_CHART_PLOTS[key];
  if(el && window.Plotly){
    try{ Plotly.purge(el); }catch(e){}
  }
  delete BAR_CHART_PLOTS[key];
}
function renderBarChart(containerId,primaryRaw,key,options={},internal=false){
  const container=qs(containerId);
  if(!container){
    destroyBarChart(key);
    delete BAR_CHART_STATE[key];
    return;
  }
  const optionClone=cloneTreemapOptions(options);
  const primaryClone=cloneStatList(primaryRaw);
  if(!internal){
    BAR_CHART_STATE[key]={containerId, primaryRaw:primaryClone, options:optionClone};
    if(isChartHidden(container)){
      container.dataset.barDeferred='1';
      container.innerHTML='<div class="treemap-empty">切换标签以查看图表</div>';
      destroyBarChart(key);
      return;
    }
  }else if(isChartHidden(container)){
    return;
  }
  if(container.dataset.barDeferred){
    delete container.dataset.barDeferred;
  }
  if(!window.Plotly){
    destroyBarChart(key);
    container.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    return;
  }
  const { entries, primaryMap, overlayMap } = buildBarChartEntries(primaryClone, optionClone.overlay);
  const limit=Number.isFinite(optionClone.limit)&&optionClone.limit>0?Math.floor(optionClone.limit):TREEMAP_CATEGORY_LIMIT;
  let limitedEntries=limitBarEntries(entries, limit);
  const picked=new Set(limitedEntries.map(entry=>entry.label));
  let otherPrimary=0;
  let otherOverlay=0;
  entries.forEach(entry=>{
    if(!picked.has(entry.label)){
      otherPrimary+=safeNumber(entry.primary);
      otherOverlay+=safeNumber(entry.overlay);
    }
  });
  if(otherPrimary>0){
    limitedEntries=[...limitedEntries,{label:'其他',primary:otherPrimary,overlay:otherOverlay,isOther:true,order:entries.length+1}];
  }
  if(!limitedEntries.length){
    destroyBarChart(key);
    container.innerHTML='<div class="treemap-empty">暂无数据</div>';
    return;
  }
  const hasOverlay=Array.isArray(optionClone.overlay)&&optionClone.overlay.length>0;
  const primaryList=normalizeStatItems(primaryClone);
  const overlayList=normalizeStatItems(optionClone.overlay);
  const primaryTotal=primaryList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const overlayTotal=overlayList.reduce((sum,item)=>sum+safeNumber(item.count),0);
  const sortedEntries=[...limitedEntries].sort((a,b)=>{
    if(a.isOther && !b.isOther) return 1;
    if(!a.isOther && b.isOther) return -1;
    const diff=safeNumber(b.primary)-safeNumber(a.primary);
    if(Math.abs(diff)>0.0001) return diff;
    return a.order-b.order;
  });
  const yLabels=sortedEntries.map(entry=>entry.label);
  const primaryValues=sortedEntries.map(entry=>safeNumber(entry.primary));
  const overlayValues=sortedEntries.map(entry=>safeNumber(entry.overlay));
  const colors=sortedEntries.map((entry,idx)=>entry.isOther?'rgba(148,163,184,0.45)':TREEMAP_COLORS[idx%TREEMAP_COLORS.length]);
  const primaryPercents=sortedEntries.map(entry=>{
    const label=entry.label;
    const value=safeNumber(entry.primary);
    const primaryPercentRaw=primaryMap.get(label)?.percent;
    let percent=formatPercentText(primaryPercentRaw);
    if(!percent && primaryTotal>0 && value>0){
      percent=`${((value/primaryTotal)*100).toFixed(2)}%`;
    }
    return percent;
  });
  const overlayPercents=sortedEntries.map(entry=>{
    const label=entry.label;
    const value=safeNumber(entry.overlay);
    const overlayPercentRaw=overlayMap.get(label)?.percent;
    let percent=formatPercentText(overlayPercentRaw);
    if(!percent && overlayTotal>0 && value>0){
      percent=`${((value/overlayTotal)*100).toFixed(2)}%`;
    }
    return percent;
  });
  const hoverTexts=sortedEntries.map((entry,idx)=>{
    const label=entry.label;
    const primaryValue=primaryValues[idx];
    const overlayValue=overlayValues[idx];
    const lines=[`<b>${label}</b>`, `${optionClone.primaryLabel||'数量'}：${primaryValue}${primaryPercents[idx]?`（${primaryPercents[idx]}）`:''}`];
    if(hasOverlay && (overlayValue>0 || overlayPercents[idx])){
      lines.push(`${optionClone.overlayLabel||'对比'}：${overlayValue}${overlayPercents[idx]?`（${overlayPercents[idx]}）`:''}`);
    }
    return lines.join('<br>');
  });
  container.innerHTML='';
  const width=container.clientWidth||container.offsetWidth||0;
  const widthHeight=width?Math.round(width*0.55):0;
  const barHeight=sortedEntries.length?sortedEntries.length*56+120:260;
  let desiredHeight=Math.max(widthHeight, barHeight, 240);
  desiredHeight=Math.min(desiredHeight, 720);
  if(!Number.isFinite(desiredHeight) || desiredHeight<=0){ desiredHeight=320; }
  container.style.minHeight=`${desiredHeight}px`;
  container.style.height=`${desiredHeight}px`;
  BAR_CHART_PLOTS[key]=container;
  const primaryTrace={
    type:'bar',
    orientation:'h',
    name:optionClone.primaryLabel||'数量',
    y:yLabels,
    x:primaryValues,
    marker:{color:colors},
    text:primaryValues.map(v=>numberFormatter.format(v)),
    textposition:'auto',
    textfont:{size:12,color:'#0f172a'},
    cliponaxis:false,
    hovertext:hoverTexts,
    hovertemplate:'%{hovertext}<extra></extra>'
  };
  const traces=[primaryTrace];
  if(hasOverlay){
    const overlayHover=sortedEntries.map((entry,idx)=>{
      const label=entry.label;
      const overlayValue=overlayValues[idx];
      const lines=[`<b>${label}</b>`, `${optionClone.overlayLabel||'对比'}：${overlayValue}${overlayPercents[idx]?`（${overlayPercents[idx]}）`:''}`];
      if(primaryValues[idx]>0 || primaryPercents[idx]){
        lines.push(`${optionClone.primaryLabel||'数量'}：${primaryValues[idx]}${primaryPercents[idx]?`（${primaryPercents[idx]}）`:''}`);
      }
      return lines.join('<br>');
    });
    traces.push({
      type:'bar',
      orientation:'h',
      name:optionClone.overlayLabel||'对比',
      y:yLabels,
      x:overlayValues,
      marker:{color:'rgba(148,163,184,0.55)'},
      opacity:0.75,
      hovertext:overlayHover,
      hovertemplate:'%{hovertext}<extra></extra>',
      cliponaxis:false
    });
  }
  const longestLabelLength=yLabels.reduce((max,label)=>Math.max(max,String(label).length),0);
  const leftMargin=Math.min(260, Math.max(120, Math.round(longestLabelLength*12)));
  const layout={
    margin:{l:leftMargin,r:36,t:24,b:36},
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    barmode:hasOverlay?'group':'relative',
    bargap:hasOverlay?0.28:0.35,
    height:desiredHeight,
    yaxis:{autorange:'reversed', tickfont:{size:12,color:'#334155'}, ticklen:0},
    xaxis:{tickfont:{size:12,color:'#334155'}, gridcolor:'rgba(148,163,184,0.25)', zeroline:false}
  };
  if(hasOverlay){
    layout.legend={orientation:'h',x:0,y:1.12,yanchor:'bottom',font:{size:12,color:'#334155'}};
  }
  const config={displayModeBar:false,responsive:true};
  try{
    const plotPromise=Plotly.react(container,traces,layout,config);
    const onError=err=>{
      console.error('Bar 渲染失败',err);
      container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
      destroyBarChart(key);
    };
    if(plotPromise && typeof plotPromise.then==='function'){
      plotPromise.then(()=>{
        if(window.Plotly){
          try{ Plotly.Plots.resize(container); }catch(e){}
        }
      }).catch(onError);
    }else if(window.Plotly){
      try{ Plotly.Plots.resize(container); }catch(e){}
    }
  }catch(err){
    console.error('Bar 渲染失败',err);
    container.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
    destroyBarChart(key);
  }
}
function renderDeferredBarCharts(){
  Object.entries(BAR_CHART_STATE).forEach(([key,state])=>{
    const container=qs(state.containerId);
    if(!container) return;
    if(isChartHidden(container)) return;
    if(BAR_CHART_PLOTS[key]===container){
      if(window.Plotly){
        try{ Plotly.Plots.resize(container); }catch(e){}
      }
      return;
    }
    renderBarChart(state.containerId, state.primaryRaw, key, state.options, true);
  });
}

function getCategoryView(category){
  return CATEGORY_VIEW_STATE[category]||'treemap';
}
function syncCategoryToggle(category){
  const view=getCategoryView(category);
  const wrapper=document.querySelector(`[data-chart-toggle="${category}"]`);
  if(!wrapper) return;
  wrapper.querySelectorAll('[data-chart-toggle-target]').forEach(btn=>{
    const target=btn.dataset.chartToggleTarget;
    const active=target===view;
    btn.classList.toggle('chart-type-btn-active', active);
    btn.setAttribute('aria-pressed', active?'true':'false');
  });
}
function renderActiveCategoryChart(category){
  const config=CATEGORY_CHART_CONFIG[category];
  if(!config) return;
  const view=getCategoryView(category);
  syncCategoryToggle(category);
  const treemapEl=qs(config.treemapId);
  const barEl=qs(config.barId);
  const showTreemap=view==='treemap';
  const showBar=view==='bar';
  if(treemapEl){
    if(showTreemap){ treemapEl.classList.remove('hidden'); }
    else{ treemapEl.classList.add('hidden'); }
  }
  if(barEl){
    if(showBar){ barEl.classList.remove('hidden'); }
    else{ barEl.classList.add('hidden'); }
  }
  const dataset=CATEGORY_DATA[category];
  if(!dataset){
    if(showTreemap && treemapEl){
      destroyTreemap(config.treemapKey);
      treemapEl.innerHTML='<div class="treemap-empty">暂无数据</div>';
    }
    if(showBar && barEl){
      destroyBarChart(config.barKey);
      barEl.innerHTML='<div class="treemap-empty">暂无数据</div>';
    }
    return;
  }
  const { primaryRaw, options }=dataset;
  if(showTreemap){
    destroyBarChart(config.barKey);
    renderTreemap(config.treemapId, primaryRaw, config.treemapKey, options);
  }else if(showBar){
    destroyTreemap(config.treemapKey);
    renderBarChart(config.barId, primaryRaw, config.barKey, options);
  }
}
function setCategoryData(category, primaryRaw, options={}){
  CATEGORY_DATA[category]={ primaryRaw:cloneStatList(primaryRaw), options:cloneTreemapOptions(options) };
  renderActiveCategoryChart(category);
}
function setCategoryChartView(category, view){
  const normalized=view==='bar'?'bar':'treemap';
  if(CATEGORY_VIEW_STATE[category]===normalized) return;
  CATEGORY_VIEW_STATE[category]=normalized;
  renderActiveCategoryChart(category);
}

function clearTimelineCharts(message){
  TIMELINE_LINE_FIGURE=null;
  TIMELINE_STACK_FIGURE=null;
  const summary=qs('timeline_summary');
  if(summary){
    if(message){
      summary.textContent=message;
      summary.classList.remove('hidden');
    }else{
      summary.textContent='';
      summary.classList.add('hidden');
    }
  }
  TIMELINE_CHART_IDS.forEach(id=>{
    const el=qs(id);
    if(!el) return;
    if(window.Plotly){
      try{ Plotly.purge(el); }catch(e){}
    }
    const shouldShowMessage = message===undefined || (message!==null && String(message).trim()!=='');
    if(shouldShowMessage){
      const text = message===undefined ? '暂无数据' : String(message);
      el.innerHTML=`<div class="treemap-empty">${escapeHtml(text)}</div>`;
    }else{
      el.innerHTML='';
    }
  });
  setTimelineAreaLabel('');
}

function setTimelineAreaLabel(text){
  const labelEl=qs('timeline_area_label');
  if(!labelEl) return;
  const content=(text||'').trim();
  labelEl.textContent=content;
  labelEl.style.display=content?'':'none';
}

function renderTimelineCharts(timeline){
  TIMELINE_DATA=timeline||null;
  const summary=qs('timeline_summary');
  const select=qs('timeline_bin_select');
  TIMELINE_LINE_FIGURE=null;
  TIMELINE_STACK_FIGURE=null;
  if(!timeline || !Array.isArray(timeline.bins) || !timeline.bins.length){
    if(select && TIMELINE_BIN_SIZE){
      const val=String(TIMELINE_BIN_SIZE);
      if(select.value!==val) select.value=val;
    }
    updateTimelineStackToggle();
    clearTimelineCharts('暂无有效年份数据');
    return;
  }
  const binSize=Number.isFinite(timeline.bin_size)?Number(timeline.bin_size):TIMELINE_BIN_SIZE||5;
  TIMELINE_BIN_SIZE=binSize;
  if(select){
    const val=String(binSize);
    if(select.value!==val){ select.value=val; }
  }
  const total=Number(timeline.total)||0;
  const minYear=(timeline.min_year??timeline.min_year===0)?timeline.min_year:null;
  const maxYear=(timeline.max_year??timeline.max_year===0)?timeline.max_year:null;
  if(summary){
    const rangeText=(minYear!==null && maxYear!==null)?`${minYear} - ${maxYear}`:'—';
    summary.textContent=`共 ${numberFormatter.format(total)} 篇，年份范围：${rangeText}（每 ${binSize} 年一组）`;
    summary.classList.remove('hidden');
  }
  if(!window.Plotly){
    TIMELINE_CHART_IDS.forEach(id=>{
      const el=qs(id);
      if(!el) return;
      el.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    });
    return;
  }

  const labels=timeline.bins.map(bin=>bin.label||`${bin.start}-${bin.end}`);
  const counts=timeline.bins.map(bin=>Number(bin.count)||0);

  const lineEl=qs('timeline_line_chart');
  if(lineEl){
    lineEl.innerHTML='';
    const lineTrace={
      x:labels,
      y:counts,
      type:'scatter',
      mode:'lines+markers',
      line:{shape:'spline', color:'#2563eb', width:3, smoothing:0.6},
      marker:{size:8, color:'#1d4ed8', line:{color:'#ffffff', width:1}},
      hovertemplate:'<b>%{x}</b><br>篇数：%{y}<extra></extra>',
    };
    const lineLayout={
      margin:{l:56,r:20,t:40,b:56},
      height:320,
      paper_bgcolor:'rgba(255,255,255,0)',
      plot_bgcolor:'rgba(255,255,255,0)',
      xaxis:{title:'年份区间', tickangle:-30},
      yaxis:{title:'篇数', rangemode:'tozero', zerolinecolor:'rgba(148,163,184,0.45)'},
      hovermode:'x unified',
      showlegend:false,
      font:{family:'"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif', color:'#0f172a'},
    };
    const lineData=[lineTrace];
    const storedData=cloneDeep(lineData);
    const storedLayout=cloneDeep(lineLayout);
    TIMELINE_LINE_FIGURE={ data: storedData, layout: storedLayout };
    try{ Plotly.react(lineEl, cloneDeep(lineData), cloneDeep(lineLayout), {...TIMELINE_CONFIG}); }catch(e){
      lineEl.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
      TIMELINE_LINE_FIGURE=null;
    }
  }
  updateTimelineStackToggle();
  renderTimelineStackChart(timeline);
  resizeTimelineCharts();
}

function renderTimelineStackChart(timeline){
  const areaEl=qs('timeline_area_chart');
  if(!areaEl){
    return;
  }
  setTimelineAreaLabel(TIMELINE_STACK_LABELS[TIMELINE_STACK_DIM]||'');
  TIMELINE_STACK_FIGURE=null;
  if(!timeline || !Array.isArray(timeline.bins) || !timeline.bins.length){
    areaEl.innerHTML='<div class="treemap-empty">暂无分类占比数据</div>';
    return;
  }
  if(!window.Plotly){
    areaEl.innerHTML='<div class="treemap-empty">Plotly 未加载</div>';
    return;
  }
  const labels=timeline.bins.map(bin=>bin.label||`${bin.start}-${bin.end}`);
  const totals=timeline.bins.map(bin=>Number(bin.count)||0);
  const stackKey = TIMELINE_STACK_DIM==='field_adj' ? 'stack_field' : 'stack_topic';
  const stackData = timeline && typeof timeline==="object" ? timeline[stackKey] : null;
  const seriesList = stackData && Array.isArray(stackData.series) ? stackData.series : [];
  if(!seriesList.length){
    areaEl.innerHTML='<div class="treemap-empty">暂无分类占比数据</div>';
    return;
  }
  const traces = [];
  seriesList.forEach((serie, idx)=>{
    if(!serie) return;
    const rawCounts = Array.isArray(serie.counts) ? serie.counts : [];
    const counts = labels.map((_,i)=>Number(rawCounts[i])||0);
    const color = TIMELINE_STACK_COLORS[idx % TIMELINE_STACK_COLORS.length];
    const customdata = counts.map((val,i)=>{
      const total = totals[i]||0;
      const percent = total>0 ? (val/total*100) : 0;
      return [val, percent, total];
    });
    traces.push({
      x:labels,
      y:counts,
      type:'scatter',
      mode:'lines',
      name:serie.label||`分类 ${idx+1}`,
      stackgroup:'one',
      groupnorm:'percent',
      line:{shape:'spline', smoothing:0.6, width:1.8, color},
      fill:'tonexty',
      hovertemplate:'<b>%{fullData.name}</b><br>%{x}<br>数量：%{customdata[0]}<br>占比：%{customdata[1]:.2f}%<br>总计：%{customdata[2]}<extra></extra>',
      customdata,
    });
  });
  if(!traces.length){
    areaEl.innerHTML='<div class="treemap-empty">暂无分类占比数据</div>';
    return;
  }
  areaEl.innerHTML='';
  traces[0].fill='tozeroy';
  const layout={
    margin:{l:64,r:24,t:46,b:60},
    height:320,
    paper_bgcolor:'rgba(255,255,255,0)',
    plot_bgcolor:'rgba(255,255,255,0)',
    hovermode:'x unified',
    legend:{orientation:'h', yanchor:'bottom', y:1.02, xanchor:'left', x:0},
    xaxis:{title:'年份区间', tickangle:-30},
    yaxis:{title:'占比（%）', range:[0,100], ticksuffix:'%', rangemode:'tozero'},
    font:{family:'"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif', color:'#0f172a'}
  };
  const storedData=cloneDeep(traces);
  const storedLayout=cloneDeep(layout);
  TIMELINE_STACK_FIGURE={ data: storedData, layout: storedLayout };
  try{
    Plotly.react(areaEl, cloneDeep(traces), cloneDeep(layout), {...TIMELINE_CONFIG});
  }catch(e){
    areaEl.innerHTML='<div class="treemap-empty">可视化渲染失败</div>';
    TIMELINE_STACK_FIGURE=null;
  }
}

function openTimelineFigureFullScreen(figure, fallbackTitle){
  if(!figure || !Array.isArray(figure.data) || !figure.data.length){
    window.alert('暂无可视化数据');
    return;
  }
  if(!window.Plotly){
    window.alert('Plotly 尚未加载');
    return;
  }
  const win=window.open('', '_blank');
  if(!win){
    window.alert('浏览器阻止了弹窗，请允许后重试');
    return;
  }
  const titleText=fallbackTitle||'时间趋势图表';
  const safeTitle=escapeHtml(titleText);
  win.document.open();
  win.document.write(`<!doctype html><html lang="zh"><head><meta charset="utf-8"><title>${safeTitle} - 全屏图表</title><style>html,body{margin:0;height:100%;background:#fff;font-family:"Inter","Noto Sans SC","PingFang SC","Microsoft YaHei",sans-serif;}#plot_container{width:100%;height:100%;padding:1.5rem;box-sizing:border-box;background:linear-gradient(135deg,rgba(248,250,252,0.8) 0%,rgba(226,232,240,0.6) 100%);}#plot{width:100%;height:100%;border-radius:1rem;background:#fff;box-shadow:0 35px 65px -50px rgba(15,23,42,0.55);padding:1rem;box-sizing:border-box;}</style></head><body><div id="plot_container"><div id="plot"></div></div></body></html>`);
  win.document.close();
  const attach=()=>{
    if(!win.Plotly){
      win.Plotly=window.Plotly;
    }
    const container=win.document.getElementById('plot');
    if(!container || !win.Plotly){
      return;
    }
    const data=cloneDeep(figure.data)||[];
    const layout=cloneDeep(figure.layout)||{};
    if(typeof layout.title==='string'){
      layout.title={ text: layout.title };
    }
    const defaultTitle=titleText||'时间趋势图表';
    if(!layout.title){
      layout.title={ text: defaultTitle };
    }else if(!layout.title.text){
      layout.title.text=defaultTitle;
    }
    layout.title.x = layout.title.x ?? 0.03;
    layout.title.xanchor = layout.title.xanchor || 'left';
    layout.autosize=true;
    layout.height=Math.max(480, win.innerHeight-120);
    layout.width=Math.max(640, win.innerWidth-120);
    const config={...TIMELINE_CONFIG, responsive:true, displayModeBar:true};
    try{
      win.Plotly.newPlot(container, cloneDeep(data), cloneDeep(layout), config);
    }catch(e){
      console.error('全屏图表渲染失败', e);
      win.document.body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1rem;color:#dc2626;">图表渲染失败：${escapeHtml(String(e?.message||e||''))}</div>`;
      return;
    }
    const resizeHandler=()=>{
      if(!win.Plotly) return;
      layout.height=Math.max(480, win.innerHeight-120);
      layout.width=Math.max(640, win.innerWidth-120);
      try{ win.Plotly.Plots.resize(container); }catch(err){ console.error(err); }
    };
    win.addEventListener('resize', resizeHandler);
  };
  if(win.document.readyState==='complete' || win.document.readyState==='interactive'){
    attach();
  }else{
    win.addEventListener('load', attach, { once:true });
  }
}

function resizeTimelineCharts(){
  if(!window.Plotly) return;
  TIMELINE_CHART_IDS.forEach(id=>{
    const el=qs(id);
    if(!el) return;
    if(!el.querySelector('.plotly')) return;
    try{ Plotly.Plots.resize(el); }catch(e){}
  });
}
clearTimelineCharts('');
function resizeVisibleTreemaps(){
  if(!window.Plotly) return;
  Object.values(TREEMAP_PLOTS).forEach(container=>{
    if(!container) return;
    if(isChartHidden(container)) return;
    try{ Plotly.Plots.resize(container); }catch(e){}
  });
}
function resizeVisibleBarCharts(){
  if(!window.Plotly) return;
  Object.values(BAR_CHART_PLOTS).forEach(container=>{
    if(!container) return;
    if(isChartHidden(container)) return;
    try{ Plotly.Plots.resize(container); }catch(e){}
  });
}
window.addEventListener('resize',()=>{
  resizeVisibleTreemaps();
  resizeVisibleBarCharts();
  scheduleScatterResize();
  resizeTimelineCharts();
});
async function refreshStats(){
  if(!SESSION_ID) return;
  const bin=Number.isFinite(TIMELINE_BIN_SIZE)?TIMELINE_BIN_SIZE:5;
  const r=await fetch(`/stats?session_id=${encodeURIComponent(SESSION_ID)}&bin_years=${encodeURIComponent(bin)}`,{cache:"no-store"}); if(!r.ok) return;
  const d=await r.json();
  renderChips("chips_topic_orig", d.topic_orig, "topic_orig");
  renderChips("chips_field_orig", d.field_orig, "field_orig");
  renderChips("chips_topic_adj", d.topic_adj, "topic_adj", { overlay:d.topic_orig, primaryLabel:'调整后', overlayLabel:'原始' });
  renderChips("chips_field_adj", d.field_adj, "field_adj", { overlay:d.field_orig, primaryLabel:'调整后', overlayLabel:'原始' });
  setCategoryData('topic_orig', d.topic_orig, { primaryLabel:'原始分类', rootLabel:'研究主题（原）', limit:24 });
  setCategoryData('field_orig', d.field_orig, { primaryLabel:'原始分类', rootLabel:'研究领域（原）', limit:24 });
  setCategoryData('topic_adj', d.topic_adj, { overlay:d.topic_orig, primaryLabel:'调整后', overlayLabel:'原始', rootLabel:'研究主题（调整）', limit:24 });
  setCategoryData('field_adj', d.field_adj, { overlay:d.field_orig, primaryLabel:'调整后', overlayLabel:'原始', rootLabel:'研究领域（调整）', limit:24 });
  qs('total_msg').textContent=`行数：${d.total}`;
  renderTimelineCharts(d.timeline);

  const collectLabels=arr=>Array.isArray(arr)?arr.map(x=>x.label).filter(Boolean):[];
  const topicLabels=[...collectLabels(d.topic_orig), ...collectLabels(d.topic_adj)];
  const fieldLabels=[...collectLabels(d.field_orig), ...collectLabels(d.field_adj)];
  TOPIC_LIST=topicLabels.length?Array.from(new Set(topicLabels)):[...DEF_TOPICS];
  FIELD_LIST=fieldLabels.length?Array.from(new Set(fieldLabels)):[...DEF_FIELDS];
  populateFilterOptions();
  setVisualTab(VISUAL_TAB||'orig');
}

function getRankPlotElement(){
  return qs('rank_vis_plot');
}

function computeScatterHeight(el){
  const plotEl=el||getRankPlotElement();
  if(!plotEl) return SCATTER_DEFAULT_HEIGHT;
  const width=plotEl.clientWidth||plotEl.offsetWidth||0;
  if(!width) return SCATTER_DEFAULT_HEIGHT;
  const desired=Math.round(width*0.6);
  return Math.max(320, Math.min(desired, 580));
}

function applyScatterHeight(plotEl, height){
  if(!plotEl) return;
  const clamped=Math.max(320, Math.round(height||SCATTER_DEFAULT_HEIGHT));
  if(plotEl.style.height!==`${clamped}px`){
    plotEl.style.height=`${clamped}px`;
  }
  SCATTER_STATE.height=clamped;
}

function scheduleScatterResize(){
  if(!RANK_VIS_EXPANDED || !SCATTER_STATE.hasData) return;
  if(!window.Plotly) return;
  const plotEl=getRankPlotElement();
  if(!plotEl) return;
  if(SCATTER_STATE.resizeTimer){
    cancelAnimationFrame(SCATTER_STATE.resizeTimer);
  }
  SCATTER_STATE.resizeTimer=requestAnimationFrame(()=>{
    SCATTER_STATE.resizeTimer=0;
    try{ Plotly.Plots.resize(plotEl); }catch(e){}
  });
}

function ensureScatterObserver(){
  const plotEl=getRankPlotElement();
  if(!plotEl) return;
  if(typeof ResizeObserver!=='function') return;
  if(SCATTER_STATE.observer){
    return;
  }
  SCATTER_STATE.observer=new ResizeObserver(entries=>{
    if(!SCATTER_STATE.hasData) return;
    for(const entry of entries){
      if(entry.target!==plotEl) continue;
      const nextHeight=computeScatterHeight(plotEl);
      if(Math.abs(nextHeight-SCATTER_STATE.height)>2){
        applyScatterHeight(plotEl,nextHeight);
        if(window.Plotly){
          try{ Plotly.relayout(plotEl,{height:SCATTER_STATE.height}); }catch(e){}
        }
      }
    }
    scheduleScatterResize();
  });
  SCATTER_STATE.observer.observe(plotEl);
}

function clearScatterPlot(message){
  const plotEl=getRankPlotElement();
  if(plotEl && window.Plotly){ try{ Plotly.purge(plotEl); }catch(e){} }
  if(plotEl){
    plotEl.innerHTML="";
    plotEl.style.height='';
  }
  if(SCATTER_STATE.resizeTimer){
    cancelAnimationFrame(SCATTER_STATE.resizeTimer);
    SCATTER_STATE.resizeTimer=0;
  }
  SCATTER_STATE.hasData=false;
  const msg=qs('rank_vis_msg'); if(msg) msg.textContent=message||'等待计算后展示。';
}

function setVisualTab(tab){
  const target = tab==='adj' ? 'adj' : 'orig';
  VISUAL_TAB = target;
  document.querySelectorAll('[data-vis-panel]').forEach(panel=>{
    const active = panel.dataset?.visPanel===target;
    panel.classList.toggle('hidden', !active);
    if(active){ panel.classList.remove('opacity-0'); }
  });
  const activePanel=document.querySelector(`[data-vis-panel="${target}"]`);
  if(activePanel){
    activePanel.querySelectorAll('[data-treemap-key]').forEach(div=>{
      if(window.Plotly){
        try{ Plotly.Plots.resize(div); }catch(e){}
      }
    });
    activePanel.querySelectorAll('[data-bar-key]').forEach(div=>{
      if(window.Plotly && !isChartHidden(div)){
        try{ Plotly.Plots.resize(div); }catch(e){}
      }
    });
    resizeTimelineCharts();
  }
  renderDeferredTreemaps();
  renderDeferredBarCharts();
  document.querySelectorAll('[data-vis-tab]').forEach(btn=>{
    const active = btn.dataset?.visTab===target;
    btn.classList.toggle('vis-tab-btn-active', active);
    btn.setAttribute('aria-selected', active? 'true':'false');
    btn.tabIndex = active?0:-1;
  });
}

function setRankVisExpanded(expanded){
  RANK_VIS_EXPANDED=!!expanded;
  const body=qs('rank_vis_body');
  if(body){
    if(RANK_VIS_EXPANDED) body.classList.remove('hidden');
    else body.classList.add('hidden');
  }
  const btn=qs('btn_toggle_vis');
  if(btn){
    btn.textContent=RANK_VIS_EXPANDED?"收起可视化":"展开可视化";
    btn.setAttribute('aria-expanded', RANK_VIS_EXPANDED?"true":"false");
  }
  if(RANK_VIS_EXPANDED){
    const plotEl=getRankPlotElement();
    if(plotEl){
      applyScatterHeight(plotEl, computeScatterHeight(plotEl));
    }
    ensureScatterObserver();
    scheduleScatterResize();
  }
}

function toggleRankVis(){
  setRankVisExpanded(!RANK_VIS_EXPANDED);
}

function renderScatterPlot(data){
  const plotEl=getRankPlotElement(); if(!plotEl) return;
  if(!window.Plotly){
    plotEl.innerHTML='<div class="p-3 text-sm text-red-600">Plotly 未加载</div>';
    SCATTER_STATE.hasData=false;
    return;
  }
  const coords=Array.isArray(data?.coords)?data.coords:[];
  if(!coords.length){ clearScatterPlot('暂无可视化数据'); return; }

  const toNum=v=>{
    const n=Number(v);
    return Number.isFinite(n)?n:0;
  };
  const safeCoord=(idx,dim)=>{
    const row=coords[idx];
    if(!Array.isArray(row)) return 0;
    return toNum(row[dim]??0);
  };

  const rawGroups=Array.isArray(data.groups)?data.groups:(Array.isArray(data.group_labels)?data.group_labels:[]);
  const groups=coords.map((_,i)=>{
    const g=rawGroups[i];
    if(g===undefined || g===null || g==='') return '未分类';
    return String(g);
  });
  const outliers=Array.isArray(data.outliers)?data.outliers.map(Boolean):coords.map(()=>false);
  const scores=Array.isArray(data.scores)?data.scores:[];
  const clusterLabels=Array.isArray(data.cluster_labels)?data.cluster_labels:[];

  const hoverTexts=coords.map((_,i)=>{
    const groupText=escapeHtml(groups[i]||'未分类');
    const score=scores[i]!==undefined && scores[i]!==null?Number(scores[i]).toFixed(4):'';
    const scoreTxt=score?`<br>Score：${score}`:'';
    const cluster=clusterLabels[i];
    const clusterTxt=(cluster!==undefined && cluster!==null)?`<br>簇：${escapeHtml(String(cluster))}`:'';
    const status=outliers[i]?'是':'否';
    return `类别：${groupText}<br>离群：${status}${scoreTxt}${clusterTxt}`;
  });

  const palette=['#2563eb','#f97316','#10b981','#a855f7','#facc15','#ec4899','#14b8a6','#0ea5e9','#f43f5e','#6366f1'];
  const traces=[];
  const normalGroups=Array.from(new Set(groups.filter((_,i)=>!outliers[i])));
  normalGroups.forEach((g,idx)=>{
    const indexes=[];
    groups.forEach((name,i)=>{ if(!outliers[i] && name===g) indexes.push(i); });
    if(!indexes.length) return;
    traces.push({
      name:g||`簇 ${idx+1}`,
      type:'scattergl',
      mode:'markers',
      x:indexes.map(i=>safeCoord(i,0)),
      y:indexes.map(i=>safeCoord(i,1)),
      text:indexes.map(i=>hoverTexts[i]),
      hovertemplate:'%{text}<extra></extra>',
      marker:{
        size:5,
        opacity:0.88,
        color:palette[idx%palette.length]
      }
    });
  });

  const outlierIdx=[];
  outliers.forEach((flag,i)=>{ if(flag) outlierIdx.push(i); });
  if(outlierIdx.length){
    traces.push({
      name:'离群',
      type:'scattergl',
      mode:'markers',
      x:outlierIdx.map(i=>safeCoord(i,0)),
      y:outlierIdx.map(i=>safeCoord(i,1)),
      text:outlierIdx.map(i=>hoverTexts[i]),
      hovertemplate:'%{text}<extra></extra>',
      marker:{size:7, color:'#ef4444', symbol:'x', opacity:0.95}
    });
  }

  if(!traces.length){
    traces.push({
      name:'数据',
      type:'scattergl',
      mode:'markers',
      x:coords.map((_,i)=>safeCoord(i,0)),
      y:coords.map((_,i)=>safeCoord(i,1)),
      text:hoverTexts,
      hovertemplate:'%{text}<extra></extra>',
      marker:{size:5, opacity:0.88, color:'#2563eb'}
    });
  }

  const desiredHeight=computeScatterHeight(plotEl);
  applyScatterHeight(plotEl, desiredHeight);

  const layout={
    margin:{l:40,r:16,t:36,b:42},
    autosize:true,
    height:SCATTER_STATE.height,
    hovermode:'closest',
    legend:{orientation:'h',yanchor:'top',y:-0.18},
    xaxis:{title:'PC1',zeroline:false},
    yaxis:{title:'PC2',zeroline:false}
  };

  SCATTER_STATE.hasData=true;
  ensureScatterObserver();
  let plotPromise;
  try{
    plotPromise=Plotly.react(plotEl, traces, layout, SCATTER_CONFIG);
  }catch(err){
    console.error('Plotly 渲染失败', err);
    plotEl.innerHTML='<div class="p-3 text-sm text-red-600">可视化渲染失败</div>';
    SCATTER_STATE.hasData=false;
    return;
  }
  if(plotPromise && typeof plotPromise.then==='function'){
    plotPromise.then(()=>{ scheduleScatterResize(); }).catch(()=>{});
  }else{
    scheduleScatterResize();
  }

  const msg=qs('rank_vis_msg');
  if(msg){
    const outCount=outliers.filter(Boolean).length;
    msg.textContent=`算法：${data.algorithm||'-'} · 分组列：${data.group_by||'-'} · 数据点：${coords.length} · 离群：${outCount} · 更新时间：${data.timestamp||''}`;
  }
}

async function fetchScatterAndRender(showStatus=false){
  if(!SESSION_ID){ clearScatterPlot('请先上传或载入会话'); return; }
  const msg=qs('rank_vis_msg');
  if(showStatus && msg) msg.textContent='加载可视化数据中…';
  try{
    const r=await fetch(`/ranking_scatter?session_id=${encodeURIComponent(SESSION_ID)}&t=${Date.now()}`,{cache:"no-store"});
    if(!r.ok){ clearScatterPlot('暂无可视化数据'); return; }
    const data=await r.json();
    renderScatterPlot(data);
  }catch(e){
    if(msg) msg.textContent='可视化加载失败：'+(e?.message||e);
  }
}

function handleAlgoChange(){
  const algo=qs('rank_algo').value;
  const wrapK=qs('wrap_k'); if(wrapK) wrapK.style.display=(algo==='kmeans')?'':'none';
  const wrapSigma=qs('wrap_sigma'); if(wrapSigma) wrapSigma.style.display=(algo==='hdbscan')?'none':'';
  const wrapMin=qs('wrap_min_cluster'); if(wrapMin) wrapMin.style.display=(algo==='hdbscan')?'':'none';
}
function quickFilter(target,value){ CURRENT_FILTER={target,value}; syncFilterControls(); PAGER.page=1; loadPage(); }
function populateFilterOptions(){
  const tSel=qs('filter_target'), vSel=qs('filter_value'); const target=CURRENT_FILTER.target||tSel.value;
  vSel.innerHTML=""; let opts=[]; if(target.startsWith("topic")) opts=TOPIC_LIST; else if(target.startsWith("field")) opts=FIELD_LIST;
  opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; vSel.appendChild(op); });
  populateBulkTarget();
}
function populateBulkTarget(){
  const list=(ACTIVE_COL==="topic")?TOPIC_LIST:FIELD_LIST;
  const bulk=qs('bulk_target'); bulk.innerHTML=""; list.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; bulk.appendChild(op); });
}
function syncSearchControls(){
  const scope=CURRENT_SEARCH.scope||SEARCH_SCOPE_DEFAULT;
  document.querySelectorAll('input[name="search_scope"]').forEach(radio=>{
    if(radio.value===scope){ radio.checked=true; }
    else{ radio.checked=false; }
  });
  const input=qs('search_keyword');
  if(input){ input.value=CURRENT_SEARCH.keyword||""; }
}
function syncFilterControls(){
  const tSel=qs('filter_target'); if(CURRENT_FILTER.target) tSel.value=CURRENT_FILTER.target;
  populateFilterOptions(); setTimeout(()=>{ const vSel=qs('filter_value'); if(CURRENT_FILTER.value){ for(let i=0;i<vSel.options.length;i++){ if(vSel.options[i].value===CURRENT_FILTER.value){ vSel.selectedIndex=i; break; } } } },0);
}
function applySearchKeyword(){
  const input=qs('search_keyword');
  if(!input) return;
  const rawKeyword=(input.value||"").trim();
  const radio=document.querySelector('input[name="search_scope"]:checked');
  const scope=radio?.value||SEARCH_SCOPE_DEFAULT;
  CURRENT_SEARCH={ scope, keyword:rawKeyword };
  PAGER.page=1;
  loadPage();
}
function clearSearchKeyword(){
  CURRENT_SEARCH={ scope:SEARCH_SCOPE_DEFAULT, keyword:"" };
  syncSearchControls();
  PAGER.page=1;
  loadPage();
}

/* ===================== 只编辑哪一列 ===================== */
function setActiveCol(v){
  ACTIVE_COL=(v==="field")?"field":"topic";
  qs('op_col_hint').textContent = (ACTIVE_COL==="topic")?"（仅显示并可编辑：研究主题（调整））":"（仅显示并可编辑：研究领域（调整））";
  populateBulkTarget(); PAGER.page=1; loadPage();
}

/* ===================== 分页 ===================== */
function renderPagerInfo(){
  qs('page_input').value=PAGER.page; qs('ps_input').value=PAGER.size;
  qs('page_total').textContent=PAGER.pages;
  qs('page_info').textContent=`第 ${PAGER.page} / ${PAGER.pages} 页 · 每页 ${PAGER.size} · 共 ${PAGER.total} 行`;
}

function setSortAvailability(hasRank){
  HAS_RANKING_DATA=!!hasRank;
  const select=qs('sort_select');
  if(select){
    Array.from(select.options).forEach(op=>{
      if(op.dataset.requiresRank==='1'){
        op.disabled=!HAS_RANKING_DATA;
      }
    });
    if(!HAS_RANKING_DATA && CURRENT_SORT.by==='rank'){
      CURRENT_SORT={by:"",order:""};
      select.value=SORT_VALUE_DEFAULT;
    }
  }
  const hint=qs('sort_hint');
  if(hint){
    if(!SESSION_ID){
      hint.textContent='';
    }else{
      hint.textContent = HAS_RANKING_DATA ? '' : '需先计算或载入智能排序结果';
    }
  }
}

function syncSortSelect(){
  const select=qs('sort_select');
  if(!select) return;
  let targetValue=SORT_VALUE_DEFAULT;
  if(CURRENT_SORT.by==='rank'){
    targetValue = (CURRENT_SORT.order==='desc') ? SORT_VALUE_RANK_DESC : SORT_VALUE_RANK_ASC;
  }
  if(select.value!==targetValue){
    select.value=targetValue;
  }
}

function handleSortChange(){
  const select=qs('sort_select');
  if(!select) return;
  const value=select.value;
  if((value===SORT_VALUE_RANK_ASC || value===SORT_VALUE_RANK_DESC) && !HAS_RANKING_DATA){
    select.value=SORT_VALUE_DEFAULT;
    CURRENT_SORT={by:"",order:""};
    showToast('当前数据缺少智能排序分数，请先运行智能排序', 'warning');
    return;
  }
  if(value===SORT_VALUE_RANK_ASC){
    CURRENT_SORT={by:"rank", order:"asc"};
  }else if(value===SORT_VALUE_RANK_DESC){
    CURRENT_SORT={by:"rank", order:"desc"};
  }else{
    CURRENT_SORT={by:"", order:""};
  }
  PAGER.page=1;
  loadPage();
}

/* ===================== 表格 ===================== */
function renderSelect(options,value,css,dataOriginal=""){
  return `<select class="${css}" data-original="${escapeAttr(dataOriginal)}">${options.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o}</option>`).join("")}</select>`;
}
async function loadPage(){
  if(!SESSION_ID){ qs('table_zone').innerHTML='<div class="p-3 text-sm text-gray-500">请先上传或载入会话</div>'; return; }
  if(CURRENT_SORT.by==='rank' && !HAS_RANKING_DATA){
    CURRENT_SORT={by:"",order:""};
    syncSortSelect();
  }
  const p=new URLSearchParams({session_id:SESSION_ID, page:PAGER.page, page_size:PAGER.size});
  if(CURRENT_FILTER.target&&CURRENT_FILTER.value){ p.set("filter_target",CURRENT_FILTER.target); p.set("filter_value",CURRENT_FILTER.value); }
  if(CURRENT_SEARCH.keyword){ p.set("search_scope", CURRENT_SEARCH.scope||SEARCH_SCOPE_DEFAULT); p.set("search_keyword", CURRENT_SEARCH.keyword); }
  if(CURRENT_SORT.by==="rank"){ p.set("sort_by","rank"); p.set("sort_order", CURRENT_SORT.order||"asc"); p.set("only_outliers", qs('rank_only_outliers')?.checked?"1":"0"); }
  qs('table_zone').innerHTML='<div class="p-3 text-sm text-gray-500">加载中…</div>';
  const r=await fetch(`/data?${p.toString()}`,{cache:"no-store"}); if(!r.ok){ qs('table_zone').innerHTML=`<div class="p-3 text-sm text-red-600">加载失败：${await r.text()}</div>`; return; }
  const d=await r.json(); PAGER.page=d.page; PAGER.size=d.page_size; PAGER.total=d.total; PAGER.pages=d.total_pages||1; renderPagerInfo();
  const hasRank = Array.isArray(d.rows) && d.rows.some(row=>row && row['智能排序分数']!==undefined && row['智能排序分数']!==null && String(row['智能排序分数']).trim()!=='');
  setSortAvailability(hasRank);
  syncSortSelect();
  renderTable(d.rows||[]);
}
function renderTable(rows){
  if(!rows.length){ qs('table_zone').innerHTML='<div class="p-3 text-sm text-gray-500">无数据</div>'; return; }
  const showTopicAdj=(ACTIVE_COL==="topic"); const showFieldAdj=(ACTIVE_COL==="field");
  let html = `<table class="min-w-full text-sm"><thead class="bg-slate-100 sticky top-0 z-10"><tr>
    <th class="px-3 py-2"><input type="checkbox" onclick="document.querySelectorAll('.row_ck').forEach(x=>x.checked=this.checked)"></th>
    <th class="px-3 py-2 text-left w-16">行</th>
    <th class="px-3 py-2 text-left">Article Title</th>
    <th class="px-3 py-2 text-left">结构化总结</th>
    <th class="px-3 py-2 text-left">研究主题（原）</th>
    ${showTopicAdj?'<th class="px-3 py-2 text-left">研究主题（调整）</th>':''}
    <th class="px-3 py-2 text-left">研究领域（原）</th>
    ${showFieldAdj?'<th class="px-3 py-2 text-left">研究领域（调整）</th>':''}
    <th class="px-3 py-2 text-left">Publication Year</th>
    <th class="px-3 py-2 text-left">DOI</th>
    <th class="px-3 py-2 text-left">排序分数</th>
    <th class="px-3 py-2 text-left w-60">操作</th>
  </tr></thead><tbody>`;
  rows.forEach(r=>{
    const idx=r._index, diffTopic=(r[ADJ_TOPIC_COL]||"")&&(r[ADJ_TOPIC_COL]!== (r["研究主题（议题）分类"]||"")), diffField=(r[ADJ_FIELD_COL]||"")&&(r[ADJ_FIELD_COL]!== (r["研究领域分类"]||"")), isOutlier=!!r["智能排序_离群"];
    const topicAdjCell = showTopicAdj?`<td class="px-3 py-2 ${diffTopic?'cell-diff-topic':''}">${renderSelect(TOPIC_LIST, r[ADJ_TOPIC_COL]||"", "border rounded px-2 py-1 w-44 topic_sel", r[ADJ_TOPIC_COL]||"")}</td>`:'';
    const fieldAdjCell = showFieldAdj?`<td class="px-3 py-2 ${diffField?'cell-diff-field':''}">${renderSelect(FIELD_LIST, r[ADJ_FIELD_COL]||"", "border rounded px-2 py-1 w-44 field_sel", r[ADJ_FIELD_COL]||"")}</td>`:'';
    html += `<tr class="border-b align-top ${isOutlier?'cell-outlier':''}">
      <td class="px-3 py-2"><input type="checkbox" class="row_ck" data-index="${idx}"></td>
      <td class="px-3 py-2 text-gray-500">${idx+1}</td>
      <td class="px-3 py-2"><div class="font-medium">${escapeHtml(r["Article Title"]||"")}</div></td>
      <td class="px-3 py-2"><textarea class="border rounded px-2 py-1 w-80 h-20 sum_input" data-original="${escapeAttr(r["结构化总结"]||"")}">${escapeHtml(r["结构化总结"]||"")}</textarea></td>
      <td class="px-3 py-2 text-gray-600">${escapeHtml(r["研究主题（议题）分类"]||"")}</td>
      ${topicAdjCell}
      <td class="px-3 py-2 text-gray-600">${escapeHtml(r["研究领域分类"]||"")}</td>
      ${fieldAdjCell}
      <td class="px-3 py-2">${escapeHtml(String(r["Publication Year"]||""))}</td>
      <td class="px-3 py-2">${escapeHtml(String(r["DOI"]||""))}</td>
      <td class="px-3 py-2">${(r["智能排序分数"]!==undefined && r["智能排序分数"]!=="")? Number(r["智能排序分数"]).toFixed(4): ""}</td>
      <td class="px-3 py-2"><div class="flex flex-col gap-2">
        <button class="btn btn-sm bg-emerald-600 text-white hover:bg-emerald-500" onclick="saveRow(${idx}, this)">保存</button>
        <button class="btn btn-sm bg-sky-600 text-white hover:bg-sky-500" onclick="suggestRow(${idx}, this)">智能建议</button>
      </div></td></tr>`;
  });
  html += `</tbody></table>`; qs('table_zone').innerHTML=html;
}

/* ===================== 保存/建议（只作用当前列） ===================== */
async function saveRow(index, btn){
  const tr=btn.closest("tr"); const sum=tr.querySelector(".sum_input").value;
  const targetValue=(ACTIVE_COL==="topic")?(tr.querySelector(".topic_sel")?.value||""):(tr.querySelector(".field_sel")?.value||"");
  btn.disabled=true; btn.textContent="保存中...";
  try{
    const r=await fetch("/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,index,structured:sum,which_adjust:ACTIVE_COL,target_value:targetValue})});
    if(!r.ok){ alert("保存失败："+await r.text()); return; }
    const sumEl=tr.querySelector(".sum_input"); if(sumEl) sumEl.dataset.original=sum;
    const selEl=(ACTIVE_COL==="topic")?tr.querySelector(".topic_sel"):tr.querySelector(".field_sel");
    if(selEl) selEl.dataset.original=targetValue;
    await refreshStats();
    setAutoSaveMsg(`手动保存完成：${new Date().toLocaleTimeString()}（单行）`);
  }catch(e){
    alert("保存失败："+e.message);
  }finally{
    btn.textContent="保存"; btn.disabled=false;
  }
}
async function suggestRow(index, btn){
  const cfg=JSON.parse(localStorage.getItem("llm_cfg")||"{}"); // 有则用；后端已做兜底
  const { topic:topicBlacklist, field:fieldBlacklist } = collectBlacklistSelections();
  btn.disabled=true; btn.textContent="建议中...";
  let success=false;
  try{
    const resp=await fetch("/autosuggest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,index,base_url:cfg.base_url,api_key:cfg.api_key,model:cfg.model,temperature:cfg.temp??0.2,topic_blacklist:topicBlacklist,field_blacklist:fieldBlacklist})});
    if(!resp.ok){
      const msg=(await resp.text())||resp.statusText||"未知错误";
      throw new Error(`建议失败：${msg}`);
    }
    let data;
    try{
      data=await resp.json();
    }catch(err){
      throw new Error("建议失败：返回数据解析失败");
    }
    if(!data || typeof data!=='object'){
      throw new Error("建议失败：返回数据格式不正确");
    }
    const rows=document.querySelectorAll("#table_zone tbody tr");
    rows.forEach(row=>{
      const n=parseInt(row.children[1].innerText.trim())-1;
      if(n===index){
        const sumEl=row.querySelector(".sum_input");
        if(sumEl) sumEl.value=data.structured_summary||"";
        if(ACTIVE_COL==="topic"){
          const el=row.querySelector(".topic_sel");
          if(el && data.topic_suggestion) el.value=data.topic_suggestion;
        }else{
          const el=row.querySelector(".field_sel");
          if(el && data.field_suggestion) el.value=data.field_suggestion;
        }
      }
    });
    success=true;
    btn.textContent="完成";
    showToast("智能建议已更新", 'success');
    setTimeout(()=>{btn.disabled=false; btn.textContent="智能建议";}, 600);
    refreshStats();
  }catch(e){
    const msg=e?.message||e;
    showToast(msg, 'error');
  }finally{
    if(!success){
      btn.disabled=false;
      btn.textContent="智能建议";
    }
  }
}

function setAutoSaveMsg(msg){
  const el=qs('auto_save_msg');
  if(el) el.textContent=msg||"";
}

function collectPendingChanges(){
  const rows=[]; const selector=(ACTIVE_COL==="topic")?".topic_sel":".field_sel";
  document.querySelectorAll('#table_zone tbody tr').forEach(tr=>{
    const ck=tr.querySelector('.row_ck'); if(!ck) return;
    const idx=parseInt(ck.dataset.index||"-1"); if(Number.isNaN(idx)||idx<0) return;
    const sumEl=tr.querySelector('.sum_input');
    const selEl=tr.querySelector(selector);
    const sumVal=sumEl?sumEl.value:"";
    const sumOrig=sumEl?.dataset.original??"";
    const structuredChanged=!!(sumEl && sumVal!==sumOrig);
    let adjustChanged=false; let targetValue=""; let which=null;
    if(selEl){
      const cur=selEl.value||""; const orig=selEl.dataset.original??"";
      if(cur!==orig){ adjustChanged=true; targetValue=cur; which=ACTIVE_COL; }
    }
    if(structuredChanged || adjustChanged){
      rows.push({ index:idx, displayIndex:idx+1, structuredChanged, structuredValue:sumVal, adjustChanged, which, targetValue, elements:{ sumEl, selEl } });
    }
  });
  return rows;
}

async function applyChangesBatch(changes){
  if(!SESSION_ID || !Array.isArray(changes) || !changes.length){
    return {success:0, fail:0, errors:[]};
  }
  let success=0, fail=0; const errors=[];
  for(const item of changes){
    const payload={ session_id:SESSION_ID, index:item.index };
    if(item.structuredChanged){ payload.structured=item.structuredValue; }
    if(item.adjustChanged && item.which){ payload.which_adjust=item.which; payload.target_value=item.targetValue; }
    try{
      const resp=await fetch("/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(!resp.ok){
        const msg=await resp.text().catch(()=>resp.statusText||"请求失败");
        errors.push(`行 ${item.displayIndex}: ${msg}`);
        fail+=1;
        continue;
      }
      if(item.structuredChanged && item.elements.sumEl){ item.elements.sumEl.dataset.original=item.structuredValue; }
      if(item.adjustChanged && item.elements.selEl){ item.elements.selEl.dataset.original=item.targetValue; }
      success+=1;
    }catch(e){
      errors.push(`行 ${item.displayIndex}: ${e.message||e}`);
      fail+=1;
    }
  }
  if(success>0){ await refreshStats(); }
  return {success, fail, errors};
}

async function saveAllChanges(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  if(IS_BATCH_SAVING){ return; }
  const changes=collectPendingChanges();
  if(!changes.length){ alert("当前页面没有检测到修改"); return; }
  const btn=qs('btn_save_all'); const prevText=btn?btn.textContent:"保存本页修改"; const prevDisabled=btn?btn.disabled:false;
  if(btn){ btn.disabled=true; btn.textContent="保存中..."; }
  IS_BATCH_SAVING=true;
  try{
    const result=await applyChangesBatch(changes);
    if(result.fail===0){
      alert(`已保存 ${result.success} 条修改`);
      setAutoSaveMsg(`手动保存完成：${new Date().toLocaleTimeString()}（${result.success} 条）`);
    }else{
      alert(`部分保存失败：成功 ${result.success} 条，失败 ${result.fail} 条\n${result.errors.join('\n')}`);
      setAutoSaveMsg(`保存出现失败，请检查。最后时间：${new Date().toLocaleTimeString()}`);
    }
  }finally{
    if(btn){ btn.disabled=prevDisabled; btn.textContent=prevText; }
    IS_BATCH_SAVING=false;
  }
}

function clearAutoSaveTimer(){ if(AUTO_SAVE_TIMER){ clearInterval(AUTO_SAVE_TIMER); AUTO_SAVE_TIMER=null; } }

function scheduleAutoSaveTimer(){
  clearAutoSaveTimer();
  if(!AUTO_SAVE_ENABLED) return;
  const intervalMs=Math.max(1, AUTO_SAVE_MINUTES)*60*1000;
  AUTO_SAVE_TIMER=setInterval(()=>{ triggerAutoSave(); }, intervalMs);
}

function applyAutoSaveSettings(){
  const enableEl=qs('auto_save_enable'); const intervalEl=qs('auto_save_interval');
  if(!enableEl || !intervalEl) return;
  AUTO_SAVE_ENABLED=enableEl.checked;
  let mins=parseFloat(intervalEl.value||"0");
  if(!Number.isFinite(mins) || mins<=0){ mins=5; }
  AUTO_SAVE_MINUTES=mins;
  intervalEl.value=String(mins);
  localStorage.setItem('auto_save_enabled', AUTO_SAVE_ENABLED?'1':'0');
  localStorage.setItem('auto_save_minutes', String(mins));
  if(AUTO_SAVE_ENABLED){
    scheduleAutoSaveTimer();
    setAutoSaveMsg(`自动保存间隔：${mins} 分钟`);
    triggerAutoSave();
  }else{
    clearAutoSaveTimer();
    setAutoSaveMsg('自动保存已关闭');
  }
}

function restoreAutoSaveSettings(){
  const enableEl=qs('auto_save_enable'); const intervalEl=qs('auto_save_interval');
  const storedEnabled=localStorage.getItem('auto_save_enabled')==='1';
  let storedMins=parseFloat(localStorage.getItem('auto_save_minutes')||"5");
  if(!Number.isFinite(storedMins) || storedMins<=0){ storedMins=5; }
  AUTO_SAVE_ENABLED=storedEnabled;
  AUTO_SAVE_MINUTES=storedMins;
  if(enableEl) enableEl.checked=storedEnabled;
  if(intervalEl) intervalEl.value=String(storedMins);
  if(storedEnabled){
    scheduleAutoSaveTimer();
    setAutoSaveMsg(`自动保存间隔：${storedMins} 分钟`);
  }else{
    clearAutoSaveTimer();
    setAutoSaveMsg('自动保存已关闭');
  }
}

async function triggerAutoSave(){
  if(!AUTO_SAVE_ENABLED || IS_BATCH_SAVING) return;
  if(!SESSION_ID){ setAutoSaveMsg('自动保存已开启，但当前无会话'); return; }
  const changes=collectPendingChanges();
  if(!changes.length){
    setAutoSaveMsg(`自动保存：${new Date().toLocaleTimeString()}（无改动）`);
    return;
  }
  const btn=qs('btn_save_all');
  const prevText=btn?btn.textContent:"保存本页修改";
  const prevDisabled=btn?btn.disabled:false;
  if(btn){ btn.textContent="自动保存中..."; btn.disabled=true; }
  IS_BATCH_SAVING=true;
  try{
    const result=await applyChangesBatch(changes);
    if(result.fail===0){
      setAutoSaveMsg(`自动保存完成：${new Date().toLocaleTimeString()}（${result.success} 条）`);
    }else{
      setAutoSaveMsg(`自动保存失败：成功 ${result.success} 条，失败 ${result.fail} 条`);
    }
  }finally{
    if(btn){ btn.textContent=prevText; btn.disabled=prevDisabled; }
    IS_BATCH_SAVING=false;
  }
}

/* ===================== 批量 ===================== */
const collectSelectedIndices=()=>Array.from(document.querySelectorAll(".row_ck:checked")).map(x=>parseInt(x.dataset.index));
async function bulkApplySelected(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const idxs=collectSelectedIndices(); if(!idxs.length){ alert("请勾选本页要修改的行"); return; }
  const targetVal=qs('bulk_target').value;
  const r=await fetch("/bulk_update_indices",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,indices:idxs,which_adjust:ACTIVE_COL,target_value:targetVal})});
  if(!r.ok){ alert("批量失败："+await r.text()); return; }
  await loadPage(); await refreshStats(); alert("已应用到本页所选");
}
async function bulkApplyFiltered(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  if(!CURRENT_FILTER.target||!CURRENT_FILTER.value){ alert("请先设置筛选"); return; }
  const targetVal=qs('bulk_target').value;
  if(!confirm(`把当前筛选（${CURRENT_FILTER.target}=${CURRENT_FILTER.value}）全部写入『${ACTIVE_COL==='topic'?'研究主题（议题）分类_调整':'研究领域分类_调整'}』为：${targetVal}？`)) return;
  const r=await fetch("/bulk_update_filtered",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,filter_target:CURRENT_FILTER.target,filter_value:CURRENT_FILTER.value,which_adjust:ACTIVE_COL,target_value:targetVal})});
  if(!r.ok){ alert("批量失败："+await r.text()); return; }
  await loadPage(); await refreshStats(); alert("已应用到当前筛选全部");
}

/* ===================== 排序 & 进度 ===================== */
let _progressTimer=null;
function startProgressPolling(){
  stopProgressPolling();
  _progressTimer=setInterval(async ()=>{
    if(!SESSION_ID) return;
    try{
      const r=await fetch(`/progress?session_id=${encodeURIComponent(SESSION_ID)}`,{cache:"no-store"}); if(!r.ok) return;
      const s=await r.json(); const txt=(typeof s.percent==="number")?`进度 ${s.percent}% · ${s.status||""} · ${s.message||""}`:"计算中…";
      qs('rank_msg').textContent=txt; if(s.status==="done"||s.status==="error") stopProgressPolling();
    }catch(e){}
  },1000);
}
function stopProgressPolling(){ if(_progressTimer){ clearInterval(_progressTimer); _progressTimer=null; } }
async function doRanking(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const cfg=JSON.parse(localStorage.getItem("llm_cfg")||"{}");
  clearScatterPlot('可视化等待计算完成…');
  const payload={ session_id:SESSION_ID, group_by:qs('rank_group_by').value,
    fields:{ title:qs('rk_f_title').checked, abstract:qs('rk_f_abstract').checked, summary:qs('rk_f_summary').checked },
    algorithm:qs('rank_algo').value, k:parseInt(qs('rank_k').value||"3"), sigma:parseFloat(qs('rank_sigma').value||"2.0"),
    min_cluster_size:parseInt(qs('rank_min_cluster').value||"5"),
    embedding_source:qs('rank_emb_src').value, openai_base_url:cfg.base_url||"", openai_api_key:cfg.api_key||"", openai_emb_model:"text-embedding-3-large" };
  qs('rank_msg').textContent="计算已开始…"; startProgressPolling();
  try{
    const r=await fetch("/compute_ranking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const j=await r.json().catch(()=>null);
    if(!r.ok){ qs('rank_msg').textContent="失败："+(j?.detail||"未知错误"); stopProgressPolling(); return; }
    qs('rank_msg').textContent=`完成：样本 ${j.total}，离群 ${j.outliers}`;
  }catch(e){ qs('rank_msg').textContent="失败："+e.message; }
  finally{ stopProgressPolling(); }
  CURRENT_SORT={by:"rank", order:qs('rank_order').value};
  setSortAvailability(true);
  syncSortSelect();
  PAGER.page=1; await loadPage();
  await fetchScatterAndRender(true);
}

/* ===================== 会话：保存 / 载入 ===================== */
async function saveSession(){
  if(!SESSION_ID){ alert("没有可保存的会话"); return; }
  const r=await fetch("/session/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID})});
  const raw=await r.text();
  let data=null;
  try{ data = raw ? JSON.parse(raw) : null; }catch(e){ data=null; }
  if(!r.ok){
    const msg=data?.detail || raw || '未知错误';
    alert("保存失败："+msg);
    return;
  }
  if(data?.meta){ renderSessionMeta(data.meta); }
  alert("会话已保存到服务器（sessions/）");
}
async function openLoadDialog(){
  const dlg=qs('dlg_sessions'); const zone=qs('sess_list_zone');
  zone.innerHTML="加载中…";
  dlg.showModal();
  try{
    const r=await fetch("/session/list",{cache:"no-store"}); if(!r.ok){ zone.innerHTML="拉取失败"; return; }
    const j=await r.json(); const arr=j.sessions||[];
    if(!arr.length){ zone.innerHTML='<div class="text-slate-600">暂无会话</div>'; return; }
    let html='<table class="w-full text-sm"><thead><tr class="border-b bg-slate-50"><th class="text-left p-2">SessionID</th><th class="text-left p-2">来源文件</th><th class="text-left p-2">行数</th><th class="text-left p-2">最近保存</th><th class="text-left p-2 sess-table-actions">操作</th></tr></thead><tbody>';
    arr.forEach(s=>{
      html+=`<tr class="border-b">
        <td class="p-2 font-mono text-xs">${s.session_id}</td>
        <td class="p-2">${escapeHtml(s.origin_filename||"")}</td>
        <td class="p-2">${s.rows||0}</td>
        <td class="p-2">${escapeHtml(s.updated_text||"")}</td>
        <td class="p-2 sess-table-actions"><button class="px-2 py-1 rounded bg-slate-800 text-white whitespace-nowrap" onclick="loadSession('${s.session_id}')">加载</button></td>
      </tr>`;
    });
    html+='</tbody></table>'; zone.innerHTML=html;
  }catch(e){
    zone.innerHTML="加载失败："+e.message;
  }
}
async function loadSession(sid){
  const r=await fetch(`/session/load?session_id=${encodeURIComponent(sid)}`,{cache:"no-store"});
  if(!r.ok){ alert("加载失败："+await r.text()); return; }
  const j=await r.json();
  SESSION_ID=j.session_id; setBadge(); enterWorkspace(); qs('total_msg').textContent=`行数：${j.total}`;
  PAGER.page=1; PAGER.size=parseInt(qs('ps_input').value||"50")||50;
  clearScatterPlot('等待计算后展示。');
  renderSessionMeta(j.meta||null);
  await refreshStats();
  populateFilterOptions();
  CURRENT_SEARCH={scope:SEARCH_SCOPE_DEFAULT, keyword:""};
  syncSearchControls();
  CURRENT_FILTER={target:"",value:""};
  CURRENT_SORT={by:"",order:""};
  setSortAvailability(false);
  syncSortSelect();
  await loadPage();
  await fetchScatterAndRender();
  qs('dlg_sessions').close();
}

/* ===================== 导出（服务端保存） ===================== */
async function saveExcelServer(){
  if(!SESSION_ID){ alert("请先上传/载入会话"); return; }
  const name=prompt("文件名（可留空自动带时间戳）",""); // 只作为建议名
  const r=await fetch("/export_excel_save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:SESSION_ID,file_name:name||undefined})});
  if(!r.ok){ alert("导出失败："+await r.text()); return; }
  const j=await r.json(); LAST_EXPORT_URL=j.download_url||"";
  refreshHomeActions();
  await refreshSessionMeta();
  alert("已保存到服务器：\n"+(j.saved_path||""));
}
async function downloadLast(){
  if(!LAST_EXPORT_URL){
    // 尝试取会话 info 的 last_export
    try{
      const info=await fetch(`/session/info?session_id=${encodeURIComponent(SESSION_ID)}`);
      if(info.ok){
        const x=await info.json();
        renderSessionMeta(x.meta||SESSION_META);
        LAST_EXPORT_URL = x?.meta?.last_export_path ? `/file?path=${encodeURIComponent(x.meta.last_export_path)}` : "";
        refreshHomeActions();
      }
    }catch(e){}
  }
  if(!LAST_EXPORT_URL){ alert("当前会话尚无导出记录"); return; }
  const a=document.createElement("a"); a.href=LAST_EXPORT_URL; a.target="_blank"; document.body.appendChild(a); a.click(); a.remove();
}

/* ===================== 事件绑定 & 初始化 ===================== */
function bindEvents(){
  // 上传/保存/载入/导出
  qs('btn_upload').onclick=uploadFile;
  qs('btn_save_session').onclick=saveSession;
  qs('btn_load_session').onclick=openLoadDialog;
  qs('btn_save_excel').onclick=saveExcelServer;
  qs('btn_download_last').onclick=downloadLast;
  const btnSaveAll=qs('btn_save_all'); if(btnSaveAll) btnSaveAll.onclick=saveAllChanges;
  const autoToggle=qs('auto_save_enable'); if(autoToggle) autoToggle.addEventListener('change', applyAutoSaveSettings);
  const autoInterval=qs('auto_save_interval'); if(autoInterval) autoInterval.addEventListener('change', applyAutoSaveSettings);

  // 筛选
  const btnOtherTopicOrig=qs('btn_only_other_topic_orig'); if(btnOtherTopicOrig) btnOtherTopicOrig.onclick=()=>quickFilter('topic_orig','其他议题');
  const btnOtherFieldOrig=qs('btn_only_other_field_orig'); if(btnOtherFieldOrig) btnOtherFieldOrig.onclick=()=>quickFilter('field_orig','其他领域');
  const btnOtherTopicAdj=qs('btn_only_other_topic_adj'); if(btnOtherTopicAdj) btnOtherTopicAdj.onclick=()=>quickFilter('topic_adj','其他议题');
  const btnOtherFieldAdj=qs('btn_only_other_field_adj'); if(btnOtherFieldAdj) btnOtherFieldAdj.onclick=()=>quickFilter('field_adj','其他领域');
  qs('btn_apply_filter').onclick=()=>{
    CURRENT_FILTER={ target:qs('filter_target').value, value:qs('filter_value').value };
    PAGER.page=1;
    loadPage();
  };
  qs('btn_apply_search').onclick=applySearchKeyword;
  qs('btn_clear_search').onclick=clearSearchKeyword;
  document.querySelectorAll('input[name="search_scope"]').forEach(radio=>{
    radio.addEventListener('change', e=>{
      CURRENT_SEARCH.scope = e.target?.value || SEARCH_SCOPE_DEFAULT;
    });
  });
  const searchInput=qs('search_keyword');
  if(searchInput){
    searchInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        applySearchKeyword();
      }
    });
  }
  const filterTargetSel=qs('filter_target');
  if(filterTargetSel){
    filterTargetSel.addEventListener('change', e=>{
      CURRENT_FILTER={ target:e.target.value, value:"" };
      populateFilterOptions();
    });
  }
  qs('btn_clear_filter').onclick=()=>{
    CURRENT_FILTER={target:"",value:""};
    CURRENT_SORT={by:"",order:""};
    syncSortSelect();
    PAGER.page=1;
    loadPage();
  };

  // 批量
  qs('btn_bulk_selected').onclick=bulkApplySelected; qs('btn_bulk_filtered').onclick=bulkApplyFiltered;
  qs('btn_select_all').onclick=()=>document.querySelectorAll(".row_ck").forEach(x=>x.checked=true);
  qs('btn_unselect_all').onclick=()=>document.querySelectorAll(".row_ck").forEach(x=>x.checked=false);

  // 排序
  qs('btn_do_ranking').onclick=doRanking;
  const btnRefreshVis=qs('btn_refresh_vis'); if(btnRefreshVis) btnRefreshVis.onclick=()=>fetchScatterAndRender(true);
  const btnToggleVis=qs('btn_toggle_vis'); if(btnToggleVis) btnToggleVis.onclick=toggleRankVis;
  const tabOrig=qs('btn_vis_tab_orig'); if(tabOrig) tabOrig.onclick=()=>setVisualTab('orig');
  const tabAdj=qs('btn_vis_tab_adj'); if(tabAdj) tabAdj.onclick=()=>setVisualTab('adj');
  setRankVisExpanded(false);
  setVisualTab('orig');
  document.querySelectorAll('[data-chart-toggle]').forEach(wrapper=>{
    const category=wrapper?.dataset?.chartToggle;
    if(!category) return;
    wrapper.querySelectorAll('[data-chart-toggle-target]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const target=btn.dataset?.chartToggleTarget;
        if(!target) return;
        setCategoryChartView(category, target);
      });
    });
  });
  Object.keys(CATEGORY_VIEW_STATE).forEach(category=>syncCategoryToggle(category));
  qs('rank_algo').addEventListener('change', handleAlgoChange);
  handleAlgoChange();

  // LLM 配置
  qs('btn_save_cfg').onclick=saveCfgToLocal; qs('btn_save_env').onclick=saveEnvToServer;
  const topicWrap=qs('topic_blacklist_options');
  if(topicWrap){ topicWrap.addEventListener('change', e=>{ if(e.target?.matches('input[data-kind]')) collectBlacklistSelections(); }); }
  const fieldWrap=qs('field_blacklist_options');
  if(fieldWrap){ fieldWrap.addEventListener('change', e=>{ if(e.target?.matches('input[data-kind]')) collectBlacklistSelections(); }); }

  // 只编辑哪一列
  qs('op_col_select').addEventListener('change', e=> setActiveCol(e.target.value));

  // 分页输入与按钮
  qs('page_input').addEventListener('change', ()=>{ let v=parseInt(qs('page_input').value||"1"); if(isNaN(v)||v<1) v=1; PAGER.page=v; loadPage(); });
  qs('ps_input').addEventListener('change', ()=>{ let v=parseInt(qs('ps_input').value||"50"); if(isNaN(v)||v<1) v=1; if(v>5000) v=5000; PAGER.size=v; PAGER.page=1; loadPage(); });
  qs('btn_reload_page').onclick=loadPage;
  qs('pg_first').onclick=()=>{ PAGER.page=1; loadPage(); };
  qs('pg_prev').onclick =()=>{ PAGER.page=Math.max(1, PAGER.page-1); loadPage(); };
  qs('pg_next').onclick =()=>{ PAGER.page=Math.min(PAGER.pages, PAGER.page+1); loadPage(); };
  qs('pg_last').onclick =()=>{ PAGER.page=PAGER.pages; loadPage(); };
  const sortSelect=qs('sort_select');
  if(sortSelect){ sortSelect.addEventListener('change', handleSortChange); }
  setSortAvailability(HAS_RANKING_DATA);
  syncSortSelect();
}

(async function init(){
  try{
    await fetchFrontendConfig(); fetchEnvDefaults(); loadCfgFromLocal(); bindEvents(); restoreAutoSaveSettings();
    renderSessionMeta(null);
    setActiveCol('topic'); // 默认编辑“主题（调整）”
    PAGER.page=1; PAGER.size=parseInt(qs('ps_input').value||"50")||50;
    populateFilterOptions();
    syncSearchControls();
    clearScatterPlot('等待计算后展示。');
  }catch(e){ alert("前端初始化失败："+e.message); console.error(e); }
})();
</script>
</body>
</html>
